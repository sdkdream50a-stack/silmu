<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²¬ì ì„œ ê²€í†  ì‹œìŠ¤í…œ</title>
  <style>
    @page { size: A4; margin: 15mm; }
    * { box-sizing: border-box; }
    body { font-family: 'ë§‘ì€ ê³ ë”•', 'Malgun Gothic', sans-serif; font-size: 12pt; line-height: 1.6; margin: 0; padding: 0; background: #f0f4f8; }
    .toolbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
    .toolbar-left { display: flex; align-items: center; gap: 20px; }
    .toolbar h2 { margin: 0; font-size: 16pt; }
    .toolbar-nav { display: flex; gap: 5px; }
    .toolbar-nav a { color: rgba(255,255,255,0.8); text-decoration: none; padding: 6px 12px; border-radius: 6px; font-size: 10pt; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .toolbar-nav a:hover { background: rgba(255,255,255,0.2); color: white; }
    .toolbar-nav a svg { width: 16px; height: 16px; }
    .toolbar-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.3); }
    .toolbar-buttons { display: flex; gap: 10px; }
    .toolbar button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 11pt; font-weight: 500; }
    .btn-analyze { background: #10b981; color: white; }
    .btn-clear { background: #ef4444; color: white; }
    .btn-print { background: #f59e0b; color: white; }
    .btn-download { background: #8b5cf6; color: white; }

    .main-container { display: flex; min-height: calc(100vh - 60px); }

    /* ì™¼ìª½: ê²¬ì ì„œ ì—…ë¡œë“œ/ë·°ì–´ */
    .viewer-panel { width: 50%; background: #1f2937; padding: 20px; overflow-y: auto; }
    .upload-zone { border: 3px dashed #4b5563; border-radius: 16px; padding: 60px 40px; text-align: center; background: #374151; cursor: pointer; transition: all 0.3s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #8b5cf6; background: #4b5563; }
    .upload-zone svg { width: 80px; height: 80px; color: #9ca3af; margin-bottom: 20px; }
    .upload-zone h3 { color: white; margin: 0 0 10px 0; font-size: 18pt; }
    .upload-zone p { color: #9ca3af; margin: 0; }
    .upload-zone input { display: none; }

    .preview-container { display: none; }
    .preview-container.show { display: block; }
    .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .preview-header h3 { color: white; margin: 0; }
    .preview-header button { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
    .preview-image { width: 100%; border-radius: 8px; background: white; }
    .preview-pdf { width: 100%; height: calc(100vh - 180px); border: none; border-radius: 8px; }
    .preview-excel { background: white; border-radius: 8px; padding: 15px; max-height: calc(100vh - 180px); overflow: auto; }
    .preview-excel h4 { margin: 0 0 15px 0; color: #059669; display: flex; align-items: center; gap: 10px; }
    .preview-excel h4 svg { width: 24px; height: 24px; }
    .excel-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
    .excel-table th, .excel-table td { border: 1px solid #d1d5db; padding: 6px 10px; text-align: left; }
    .excel-table th { background: #ecfdf5; color: #065f46; font-weight: 600; position: sticky; top: 0; }
    .excel-table tr:nth-child(even) { background: #f9fafb; }
    .excel-table tr:hover { background: #f0fdf4; }
    .excel-info { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .excel-info span { background: #e5e7eb; padding: 4px 12px; border-radius: 20px; font-size: 10pt; color: #374151; }
    .sheet-tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
    .sheet-tab { padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 10pt; }
    .sheet-tab.active { background: #10b981; color: white; }

    /* ì˜¤ë¥¸ìª½: ì…ë ¥ ë° ë¶„ì„ */
    .input-panel { width: 50%; padding: 20px; overflow-y: auto; max-height: calc(100vh - 60px); }
    .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .card h3 { margin-top: 0; color: #4c1d95; border-bottom: 2px solid #e9d5ff; padding-bottom: 10px; }
    .card.highlight { border: 2px solid #8b5cf6; background: linear-gradient(to bottom right, #faf5ff, #f3e8ff); }

    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #374151; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 12pt; transition: border-color 0.3s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #8b5cf6; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group .hint { font-size: 10pt; color: #6b7280; margin-top: 4px; }

    .quick-input { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
    .quick-input button { padding: 10px; background: #f3e8ff; border: 2px solid #e9d5ff; border-radius: 8px; cursor: pointer; font-size: 11pt; transition: all 0.2s; }
    .quick-input button:hover { background: #e9d5ff; border-color: #8b5cf6; }

    /* ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
    .report { display: none; }
    .report.show { display: block; }
    .report-header { text-align: center; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0; margin: -25px -25px 25px -25px; }
    .report-header h2 { margin: 0 0 10px 0; font-size: 24pt; }
    .report-header p { margin: 0; opacity: 0.9; }
    .report-section { margin-bottom: 25px; padding: 20px; background: #faf5ff; border-radius: 10px; border-left: 4px solid #8b5cf6; }
    .report-section h4 { margin: 0 0 15px 0; color: #5b21b6; font-size: 14pt; }
    .check-item { display: flex; align-items: flex-start; padding: 12px; margin-bottom: 10px; border-radius: 8px; background: white; }
    .check-icon { font-size: 20pt; margin-right: 15px; flex-shrink: 0; }
    .check-pass { color: #10b981; }
    .check-warn { color: #f59e0b; }
    .check-fail { color: #ef4444; }
    .check-info { color: #3b82f6; }
    .check-content { flex: 1; }
    .check-content strong { display: block; margin-bottom: 5px; }
    .check-content p { margin: 0; color: #6b7280; font-size: 11pt; }

    .summary-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
    .summary-item { text-align: center; padding: 20px; border-radius: 10px; }
    .summary-item.pass { background: #dcfce7; color: #166534; }
    .summary-item.warn { background: #fef3c7; color: #92400e; }
    .summary-item.fail { background: #fee2e2; color: #991b1b; }
    .summary-item .number { font-size: 28pt; font-weight: bold; }
    .summary-item .label { font-size: 10pt; }

    .grade-box { text-align: center; padding: 30px; border-radius: 15px; margin-bottom: 25px; }
    .grade-box.A { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .grade-box.B { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
    .grade-box.C { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .grade-box.D { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .grade-letter { font-size: 60pt; font-weight: bold; }
    .grade-text { font-size: 14pt; margin-top: 10px; }

    .recommendation { background: #eff6ff; border: 2px solid #3b82f6; border-radius: 10px; padding: 20px; }
    .recommendation h4 { color: #1e40af; margin-top: 0; }
    .recommendation ul { margin: 0; padding-left: 20px; }
    .recommendation li { margin-bottom: 8px; }

    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; opacity: 0; transition: opacity 0.3s; z-index: 1000; background: #8b5cf6; }
    .toast.show { opacity: 1; }

    .step-indicator { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .step { display: flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 30px; background: #e5e7eb; color: #6b7280; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .step:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .step.active { background: #8b5cf6; color: white; }
    .step.done { background: #10b981; color: white; }
    .step.disabled { opacity: 0.5; cursor: not-allowed; }
    .step.disabled:hover { transform: none; box-shadow: none; }
    .step-number { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 12pt; }

    @media print {
      .toolbar, .viewer-panel, .card:not(.report-card), .toast, .step-indicator { display: none !important; }
      body { background: white; }
      .main-container { display: block; }
      .input-panel { width: 100%; max-height: none; padding: 0; }
      .report { display: block !important; }
      .card { box-shadow: none; break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="toolbar-left">
      <nav class="toolbar-nav">
        <a href="/">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
          í™ˆ
        </a>
        <a href="/topics/private-contract">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          ìˆ˜ì˜ê³„ì•½ ê°€ì´ë“œ
        </a>
      </nav>
      <div class="toolbar-divider"></div>
      <h2>ê²¬ì ì„œ ê²€í†  ì‹œìŠ¤í…œ</h2>
    </div>
    <div class="toolbar-buttons">
      <button class="btn-analyze" onclick="analyzeQuotation()">ë¶„ì„í•˜ê¸°</button>
      <button class="btn-print" onclick="window.print()">ë¦¬í¬íŠ¸ ì¸ì‡„</button>
      <button class="btn-download" onclick="downloadReport()">Word ì €ì¥</button>
      <button class="btn-clear" onclick="clearAll()">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="main-container">
    <!-- ì™¼ìª½: ê²¬ì ì„œ ì—…ë¡œë“œ/ë·°ì–´ -->
    <div class="viewer-panel">
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <h3>ê²¬ì ì„œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
        <p>ì´ë¯¸ì§€(JPG, PNG), PDF, Excel(.xlsx, .xls) íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
        <input type="file" id="file-input" accept="image/*,.pdf,.xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" onchange="handleFileSelect(event)">
      </div>

      <div class="preview-container" id="preview-container">
        <div class="preview-header">
          <h3>ğŸ“„ ì—…ë¡œë“œëœ ê²¬ì ì„œ</h3>
          <button onclick="removeFile()">ì‚­ì œ</button>
        </div>
        <div id="preview-content"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì…ë ¥ ë° ë¶„ì„ -->
    <div class="input-panel">
      <div class="step-indicator">
        <div class="step active" id="step1" onclick="goToStep(1)">
          <span class="step-number">1</span>
          <span>ê²¬ì ì„œ ì—…ë¡œë“œ</span>
        </div>
        <div class="step" id="step2" onclick="goToStep(2)">
          <span class="step-number">2</span>
          <span>ì •ë³´ ì…ë ¥</span>
        </div>
        <div class="step disabled" id="step3" onclick="goToStep(3)">
          <span class="step-number">3</span>
          <span>ë¶„ì„ ê²°ê³¼</span>
        </div>
      </div>

      <!-- Step 1: ì•ˆë‚´ ì¹´ë“œ -->
      <div class="card" id="welcome-card">
        <div style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 60pt; margin-bottom: 20px;">ğŸ“„</div>
          <h3 style="border: none; color: #374151; font-size: 18pt;">ê²¬ì ì„œë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</h3>
          <p style="color: #6b7280; margin-bottom: 30px;">
            ì™¼ìª½ ì˜ì—­ì— ê²¬ì ì„œ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜<br>
            í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”
          </p>
          <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
            <span style="background: #dbeafe; color: #1e40af; padding: 8px 16px; border-radius: 20px; font-size: 11pt;">ğŸ“· ì´ë¯¸ì§€ (JPG, PNG)</span>
            <span style="background: #fce7f3; color: #9d174d; padding: 8px 16px; border-radius: 20px; font-size: 11pt;">ğŸ“‘ PDF</span>
            <span style="background: #dcfce7; color: #166534; padding: 8px 16px; border-radius: 20px; font-size: 11pt;">ğŸ“Š Excel (xlsx, xls)</span>
          </div>
        </div>
      </div>

      <!-- Step 2: ì •ë³´ ì…ë ¥ ì¹´ë“œ -->
      <div class="card highlight" id="input-card" style="display: none;">
        <h3>ğŸ“ ê²¬ì ì„œ í•µì‹¬ ì •ë³´ ì…ë ¥</h3>
        <p style="color: #6b7280; margin-top: -5px; margin-bottom: 20px;">ì—…ë¡œë“œí•œ ê²¬ì ì„œë¥¼ ë³´ë©´ì„œ ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>

        <div class="form-grid">
          <div class="form-group">
            <label>ê³„ì•½ êµ¬ë¶„ *</label>
            <select id="contract_type">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option value="goods">ë¬¼í’ˆêµ¬ë§¤</option>
              <option value="service">ìš©ì—­</option>
              <option value="construction">ê³µì‚¬</option>
            </select>
          </div>
          <div class="form-group">
            <label>ì—…ì²´ëª… *</label>
            <input type="text" id="company_name" placeholder="(ì£¼)OOìƒì‚¬">
          </div>
          <div class="form-group">
            <label>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
            <input type="text" id="biz_number" placeholder="123-45-67890">
          </div>
          <div class="form-group">
            <label>ê²¬ì ì¼ì</label>
            <input type="date" id="quote_date">
          </div>
          <div class="form-group full">
            <label>ê³„ì•½ê±´ëª…</label>
            <input type="text" id="contract_name" placeholder="2026ë…„ë„ ì‚¬ë¬´ìš©í’ˆ êµ¬ë§¤">
          </div>
        </div>

        <h4 style="margin-top: 25px; color: #5b21b6;">ğŸ’° ê¸ˆì•¡ ì •ë³´</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>ê²¬ì  ì´ì•¡ (VAT í¬í•¨) *</label>
            <input type="number" id="total_price" placeholder="11000000" onchange="formatPriceDisplay()">
            <div class="hint" id="total_display"></div>
          </div>
          <div class="form-group">
            <label>ì¶”ì •ê°€ê²© (ë¹„êµìš©)</label>
            <input type="number" id="estimated_price" placeholder="10000000">
            <div class="hint">ì¶”ì •ê°€ê²©ì„ ì…ë ¥í•˜ë©´ ì ì •ì„± ë¹„êµ ê°€ëŠ¥</div>
          </div>
        </div>

        <div class="quick-input">
          <button onclick="setPrice(5000000)">500ë§Œì›</button>
          <button onclick="setPrice(10000000)">1,000ë§Œì›</button>
          <button onclick="setPrice(22000000)">2,200ë§Œì›</button>
          <button onclick="setPrice(50000000)">5,000ë§Œì›</button>
          <button onclick="setPrice(80000000)">8,000ë§Œì›</button>
          <button onclick="setPrice(100000000)">1ì–µì›</button>
        </div>

        <h4 style="margin-top: 25px; color: #5b21b6;">ğŸ“‹ ì¶”ê°€ ì •ë³´ (ì„ íƒ)</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>ê²¬ì  ìœ íš¨ê¸°ê°„</label>
            <input type="text" id="valid_period" placeholder="30ì¼">
          </div>
          <div class="form-group">
            <label>ë‚©í’ˆ ê¸°í•œ</label>
            <input type="text" id="delivery_date" placeholder="ê³„ì•½ í›„ 7ì¼ ì´ë‚´">
          </div>
          <div class="form-group full">
            <label>íŠ¹ì´ì‚¬í•­ / ë¹„ê³ </label>
            <textarea id="remarks" rows="2" placeholder="ê²¬ì ì„œì— íŠ¹ì´ì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          </div>
        </div>

        <button class="btn-analyze" style="width: 100%; padding: 15px; font-size: 14pt; margin-top: 20px;" onclick="analyzeQuotation()">
          ğŸ” ê²¬ì ì„œ ë¶„ì„í•˜ê¸°
        </button>
      </div>

      <!-- ë¶„ì„ ë¦¬í¬íŠ¸ -->
      <div class="card report report-card" id="report-section">
        <div class="report-header">
          <h2>ê²¬ì ì„œ ê²€í†  ë¦¬í¬íŠ¸</h2>
          <p id="report-date"></p>
        </div>

        <div id="grade-container"></div>

        <div class="summary-box" id="summary-box"></div>

        <div class="report-section" id="basic-check">
          <h4>1. ê¸°ë³¸ ì ì •ì„± ê²€í† </h4>
          <div id="basic-check-items"></div>
        </div>

        <div class="report-section" id="price-check">
          <h4>2. ê°€ê²© ì ì •ì„± ê²€í† </h4>
          <div id="price-check-items"></div>
        </div>

        <div class="report-section" id="legal-check">
          <h4>3. ë²•ê·œ ì¤€ìˆ˜ ê²€í† </h4>
          <div id="legal-check-items"></div>
        </div>

        <div class="report-section" id="contract-check">
          <h4>4. ê³„ì•½ ë°©ë²• ê²€í† </h4>
          <div id="contract-check-items"></div>
        </div>

        <div class="recommendation" id="recommendation">
          <h4>ê²€í†  ì˜ê²¬ ë° ê¶Œê³ ì‚¬í•­</h4>
          <ul id="recommendation-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script>
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    const uploadZone = document.getElementById('upload-zone');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => uploadZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('dragover'), false);
    });

    uploadZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    let excelData = null; // ì—‘ì…€ ë°ì´í„° ì €ì¥

    function handleFile(file) {
      const previewContainer = document.getElementById('preview-container');
      const previewContent = document.getElementById('preview-content');
      const uploadZone = document.getElementById('upload-zone');

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewContent.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="ê²¬ì ì„œ">`;
          uploadZone.style.display = 'none';
          previewContainer.classList.add('show');
          updateStep(2);
          updateVisibility(2);
          showToast('ê²¬ì ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        };
        reader.readAsDataURL(file);
      } else if (file.type === 'application/pdf') {
        const url = URL.createObjectURL(file);
        previewContent.innerHTML = `<iframe src="${url}" class="preview-pdf"></iframe>`;
        uploadZone.style.display = 'none';
        previewContainer.classList.add('show');
        updateStep(2);
        updateVisibility(2);
        showToast('ê²¬ì ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') ||
                 file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                 file.type === 'application/vnd.ms-excel') {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            excelData = workbook;

            renderExcelPreview(workbook, file.name);
            uploadZone.style.display = 'none';
            previewContainer.classList.add('show');
            updateStep(2);
            updateVisibility(2);
            showToast('ì—‘ì…€ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          } catch (err) {
            alert('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            console.error(err);
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        alert('ì´ë¯¸ì§€(JPG, PNG), PDF ë˜ëŠ” Excel íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      }
    }

    function renderExcelPreview(workbook, fileName) {
      const previewContent = document.getElementById('preview-content');
      const sheetNames = workbook.SheetNames;

      let html = `
        <div class="preview-excel">
          <h4>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            ${fileName}
          </h4>
          <div class="excel-info">
            <span>ì‹œíŠ¸ ${sheetNames.length}ê°œ</span>
          </div>
      `;

      // ì‹œíŠ¸ íƒ­
      if (sheetNames.length > 1) {
        html += `<div class="sheet-tabs">`;
        sheetNames.forEach((name, idx) => {
          html += `<button class="sheet-tab ${idx === 0 ? 'active' : ''}" onclick="showSheet(${idx})">${name}</button>`;
        });
        html += `</div>`;
      }

      // ê° ì‹œíŠ¸ ë‚´ìš©
      sheetNames.forEach((name, idx) => {
        const sheet = workbook.Sheets[name];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

        html += `<div class="sheet-content" id="sheet-${idx}" style="${idx > 0 ? 'display:none;' : ''}">`;

        if (jsonData.length > 0) {
          html += `<table class="excel-table"><thead><tr>`;

          // í—¤ë” (ì²« ë²ˆì§¸ í–‰)
          const headerRow = jsonData[0] || [];
          const maxCols = Math.min(Math.max(...jsonData.map(r => r.length)), 15); // ìµœëŒ€ 15ì—´

          for (let c = 0; c < maxCols; c++) {
            html += `<th>${headerRow[c] !== undefined ? headerRow[c] : ''}</th>`;
          }
          html += `</tr></thead><tbody>`;

          // ë°ì´í„° í–‰ (ìµœëŒ€ 100í–‰)
          const maxRows = Math.min(jsonData.length, 100);
          for (let r = 1; r < maxRows; r++) {
            const row = jsonData[r] || [];
            html += `<tr>`;
            for (let c = 0; c < maxCols; c++) {
              let cellValue = row[c] !== undefined ? row[c] : '';
              // ìˆ«ì í¬ë§·íŒ…
              if (typeof cellValue === 'number' && cellValue > 1000) {
                cellValue = formatNumber(Math.round(cellValue));
              }
              html += `<td>${cellValue}</td>`;
            }
            html += `</tr>`;
          }
          html += `</tbody></table>`;

          if (jsonData.length > 100) {
            html += `<p style="color: #6b7280; font-size: 10pt; margin-top: 10px;">* ${jsonData.length - 100}ê°œ í–‰ì´ ë” ìˆìŠµë‹ˆë‹¤.</p>`;
          }
        } else {
          html += `<p style="color: #6b7280;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }

        html += `</div>`;
      });

      html += `</div>`;
      previewContent.innerHTML = html;

      // ì—‘ì…€ì—ì„œ ê¸ˆì•¡ ìë™ ì¶”ì¶œ ì‹œë„
      tryExtractFromExcel(workbook);
    }

    function showSheet(idx) {
      document.querySelectorAll('.sheet-content').forEach((el, i) => {
        el.style.display = i === idx ? 'block' : 'none';
      });
      document.querySelectorAll('.sheet-tab').forEach((el, i) => {
        el.classList.toggle('active', i === idx);
      });
    }

    function tryExtractFromExcel(workbook) {
      // ì²« ë²ˆì§¸ ì‹œíŠ¸ì—ì„œ ê¸ˆì•¡ ì •ë³´ ì¶”ì¶œ ì‹œë„
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

      let totalFound = 0;
      let companyFound = '';

      // ê¸ˆì•¡ í‚¤ì›Œë“œ ì°¾ê¸°
      const priceKeywords = ['í•©ê³„', 'ì´ì•¡', 'ì´ê³„', 'ê²¬ì ê¸ˆì•¡', 'ê³µê¸‰ê°€ì•¡', 'total', 'ê³„'];
      const companyKeywords = ['ìƒí˜¸', 'ì—…ì²´ëª…', 'íšŒì‚¬ëª…', 'ê³µê¸‰ì'];

      jsonData.forEach(row => {
        row.forEach((cell, idx) => {
          const cellStr = String(cell).toLowerCase();

          // ê¸ˆì•¡ ì°¾ê¸°
          priceKeywords.forEach(keyword => {
            if (cellStr.includes(keyword) && row[idx + 1]) {
              const nextCell = row[idx + 1];
              if (typeof nextCell === 'number' && nextCell > 10000) {
                if (nextCell > totalFound) totalFound = nextCell;
              }
            }
          });

          // ì—…ì²´ëª… ì°¾ê¸°
          companyKeywords.forEach(keyword => {
            if (cellStr.includes(keyword) && row[idx + 1]) {
              const nextCell = String(row[idx + 1]).trim();
              if (nextCell && nextCell.length > 1 && !companyFound) {
                companyFound = nextCell;
              }
            }
          });
        });
      });

      // ì°¾ì€ ê°’ ìë™ ì…ë ¥
      if (totalFound > 0) {
        document.getElementById('total_price').value = Math.round(totalFound);
        formatPriceDisplay();
        showToast(`ê¸ˆì•¡ ${formatNumber(Math.round(totalFound))}ì›ì´ ìë™ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      if (companyFound) {
        document.getElementById('company_name').value = companyFound;
      }
    }

    function removeFile() {
      document.getElementById('preview-container').classList.remove('show');
      document.getElementById('upload-zone').style.display = 'block';
      document.getElementById('preview-content').innerHTML = '';
      document.getElementById('file-input').value = '';
      excelData = null;
      updateStep(1);
      updateVisibility(1);
    }

    let currentStep = 1;
    let analysisComplete = false;

    function updateStep(step) {
      currentStep = step;
      document.querySelectorAll('.step').forEach((el, idx) => {
        el.classList.remove('active', 'done', 'disabled');
        if (idx + 1 < step) {
          el.classList.add('done');
        } else if (idx + 1 === step) {
          el.classList.add('active');
        } else if (idx + 1 === 3 && !analysisComplete) {
          el.classList.add('disabled');
        }
      });
    }

    function goToStep(step) {
      // Step 3ì€ ë¶„ì„ ì™„ë£Œ í›„ì—ë§Œ ì´ë™ ê°€ëŠ¥
      if (step === 3 && !analysisComplete) {
        showToast('ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      updateStep(step);
      updateVisibility(step);
    }

    function updateVisibility(step) {
      const welcomeCard = document.getElementById('welcome-card');
      const inputCard = document.getElementById('input-card');
      const reportSection = document.getElementById('report-section');

      if (step === 1) {
        welcomeCard.style.display = 'block';
        inputCard.style.display = 'none';
        reportSection.classList.remove('show');
      } else if (step === 2) {
        welcomeCard.style.display = 'none';
        inputCard.style.display = 'block';
        reportSection.classList.remove('show');
        inputCard.scrollIntoView({ behavior: 'smooth' });
      } else if (step === 3) {
        welcomeCard.style.display = 'none';
        inputCard.style.display = 'none';
        reportSection.classList.add('show');
        reportSection.scrollIntoView({ behavior: 'smooth' });
      }
    }

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function setPrice(amount) {
      document.getElementById('total_price').value = amount;
      formatPriceDisplay();
    }

    function formatPriceDisplay() {
      const price = parseInt(document.getElementById('total_price').value) || 0;
      document.getElementById('total_display').textContent = price > 0 ? `= ${formatNumber(price)}ì›` : '';
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function clearAll() {
      if (confirm('ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        removeFile();
        document.querySelectorAll('input, select, textarea').forEach(el => el.value = '');
        document.getElementById('total_display').textContent = '';
        document.getElementById('report-section').classList.remove('show');
        analysisComplete = false;
        document.getElementById('step3').classList.add('disabled');
        updateStep(1);
        showToast('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    function analyzeQuotation() {
      const contractType = document.getElementById('contract_type').value;
      const totalPrice = parseInt(document.getElementById('total_price').value) || 0;
      const estimatedPrice = parseInt(document.getElementById('estimated_price').value) || totalPrice;
      const companyName = document.getElementById('company_name').value;
      const bizNumber = document.getElementById('biz_number').value;
      const contractName = document.getElementById('contract_name').value;
      const quoteDate = document.getElementById('quote_date').value;

      if (!contractType || !totalPrice || !companyName) {
        alert('ê³„ì•½ êµ¬ë¶„, ì—…ì²´ëª…, ê²¬ì  ì´ì•¡ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
      }

      // ë¶„ì„ ê²°ê³¼ ì €ì¥
      const results = { pass: [], warn: [], fail: [], info: [] };

      // 1. ê¸°ë³¸ ì ì •ì„± ê²€í† 
      const basicChecks = [];

      // ì—…ì²´ ì •ë³´ í™•ì¸
      if (companyName && bizNumber) {
        basicChecks.push({ status: 'pass', title: 'ì—…ì²´ ì •ë³´ í™•ì¸', desc: 'ìƒí˜¸ëª… ë° ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.' });
        results.pass.push('ì—…ì²´ì •ë³´');
      } else if (companyName) {
        basicChecks.push({ status: 'warn', title: 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ë¯¸í™•ì¸', desc: 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‚¬ì—…ìë“±ë¡ì¦ ì‚¬ë³¸ì„ ì§•êµ¬í•˜ì„¸ìš”.' });
        results.warn.push('ì‚¬ì—…ìë²ˆí˜¸');
      } else {
        basicChecks.push({ status: 'fail', title: 'ì—…ì²´ ì •ë³´ ë¯¸ë¹„', desc: 'ì—…ì²´ ì •ë³´ê°€ í™•ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' });
        results.fail.push('ì—…ì²´ì •ë³´');
      }

      // ê²¬ì ì¼ì í™•ì¸
      if (quoteDate) {
        const daysDiff = Math.floor((new Date() - new Date(quoteDate)) / (1000 * 60 * 60 * 24));
        if (daysDiff <= 30) {
          basicChecks.push({ status: 'pass', title: 'ê²¬ì ì¼ì ìœ íš¨', desc: `ê²¬ì ì¼ë¡œë¶€í„° ${daysDiff}ì¼ ê²½ê³¼ (ìœ íš¨ê¸°ê°„ ë‚´)` });
          results.pass.push('ê²¬ì ì¼ì');
        } else {
          basicChecks.push({ status: 'warn', title: 'ê²¬ì ì¼ì ê²½ê³¼', desc: `ê²¬ì ì¼ë¡œë¶€í„° ${daysDiff}ì¼ ê²½ê³¼. ìœ íš¨ê¸°ê°„ í™•ì¸ ë˜ëŠ” ì¬ê²¬ì ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.` });
          results.warn.push('ê²¬ì ì¼ì');
        }
      } else {
        basicChecks.push({ status: 'warn', title: 'ê²¬ì ì¼ì ë¯¸í™•ì¸', desc: 'ê²¬ì ì¼ìë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' });
        results.warn.push('ê²¬ì ì¼ì');
      }

      // 2. ê°€ê²© ì ì •ì„± ê²€í† 
      const priceChecks = [];

      // ì¶”ì •ê°€ê²© ëŒ€ë¹„ ê²¬ì ê°€ê²© ë¹„êµ
      if (estimatedPrice !== totalPrice) {
        const priceRatio = (totalPrice / estimatedPrice * 100).toFixed(1);
        if (priceRatio >= 95 && priceRatio <= 105) {
          priceChecks.push({ status: 'pass', title: 'ê²¬ì ê°€ê²© ì ì •', desc: `ì¶”ì •ê°€ê²© ëŒ€ë¹„ ${priceRatio}%ë¡œ ì ì • ë²”ìœ„ì…ë‹ˆë‹¤.` });
          results.pass.push('ê°€ê²©ì ì •');
        } else if (priceRatio > 105 && priceRatio <= 120) {
          priceChecks.push({ status: 'warn', title: 'ê²¬ì ê°€ê²© ë‹¤ì†Œ ë†’ìŒ', desc: `ì¶”ì •ê°€ê²© ëŒ€ë¹„ ${priceRatio}%ì…ë‹ˆë‹¤. ê°€ê²© í˜‘ìƒ ë˜ëŠ” ì¶”ê°€ ê²¬ì  ê²€í† ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.` });
          results.warn.push('ê°€ê²©ë†’ìŒ');
        } else if (priceRatio > 120) {
          priceChecks.push({ status: 'fail', title: 'ê²¬ì ê°€ê²© ê³¼ë‹¤', desc: `ì¶”ì •ê°€ê²© ëŒ€ë¹„ ${priceRatio}%ë¡œ ê³¼ë‹¤ ê³„ìƒë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ê²¬ì  ë˜ëŠ” ì‚¬ìœ  í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.` });
          results.fail.push('ê°€ê²©ê³¼ë‹¤');
        } else if (priceRatio < 80) {
          priceChecks.push({ status: 'warn', title: 'ê²¬ì ê°€ê²© ì €ê°€', desc: `ì¶”ì •ê°€ê²© ëŒ€ë¹„ ${priceRatio}%ë¡œ ì €ê°€ì…ë‹ˆë‹¤. í’ˆì§ˆ ë° ì´í–‰ ê°€ëŠ¥ì„± í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.` });
          results.warn.push('ì €ê°€ê²¬ì ');
        } else {
          priceChecks.push({ status: 'pass', title: 'ê²¬ì ê°€ê²© ì ì •', desc: `ì¶”ì •ê°€ê²© ëŒ€ë¹„ ${priceRatio}%ì…ë‹ˆë‹¤.` });
          results.pass.push('ê°€ê²©ì ì •');
        }
      } else {
        priceChecks.push({ status: 'info', title: 'ê°€ê²© ë¹„êµ ë¶ˆê°€', desc: 'ì¶”ì •ê°€ê²©ì´ ì…ë ¥ë˜ì§€ ì•Šì•„ ë¹„êµ ë¶„ì„ì´ ì œí•œë©ë‹ˆë‹¤.' });
        results.info.push('ê°€ê²©ë¯¸ë¹„êµ');
      }

      // ê¸ˆì•¡ ê·œëª¨ ì•ˆë‚´
      priceChecks.push({ status: 'info', title: 'ê²¬ì  ì´ì•¡', desc: `${formatNumber(totalPrice)}ì› (VAT í¬í•¨)` });

      // 3. ë²•ê·œ ì¤€ìˆ˜ ê²€í† 
      const legalChecks = [];
      let contractMethod = '';
      let methodThreshold = 0;

      if (contractType === 'goods') {
        methodThreshold = 22000000;
        if (totalPrice <= methodThreshold) {
          contractMethod = 'ìˆ˜ì˜ê³„ì•½';
          legalChecks.push({ status: 'pass', title: 'ìˆ˜ì˜ê³„ì•½ ê°€ëŠ¥', desc: `ë¬¼í’ˆêµ¬ë§¤ ${formatNumber(methodThreshold)}ì› ì´í•˜ë¡œ ìˆ˜ì˜ê³„ì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì§€ë°©ê³„ì•½ë²• ì‹œí–‰ë ¹ ì œ25ì¡°)` });
          results.pass.push('ê³„ì•½ë°©ë²•');
        } else if (totalPrice <= 100000000) {
          contractMethod = 'ì§€ëª…ê²½ìŸì…ì°°';
          legalChecks.push({ status: 'warn', title: 'ê²½ìŸì…ì°° ê²€í†  í•„ìš”', desc: `ë¬¼í’ˆêµ¬ë§¤ ${formatNumber(methodThreshold)}ì› ì´ˆê³¼ë¡œ ê²½ìŸì…ì°° ì§„í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.` });
          results.warn.push('ê³„ì•½ë°©ë²•');
        } else {
          contractMethod = 'ì¼ë°˜ê²½ìŸì…ì°°';
          legalChecks.push({ status: 'warn', title: 'ì¼ë°˜ê²½ìŸì…ì°° í•„ìš”', desc: `1ì–µì› ì´ˆê³¼ë¡œ ì¼ë°˜ê²½ìŸì…ì°°ì„ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.` });
          results.warn.push('ê³„ì•½ë°©ë²•');
        }
      } else if (contractType === 'service') {
        methodThreshold = 22000000;
        if (totalPrice <= methodThreshold) {
          contractMethod = 'ìˆ˜ì˜ê³„ì•½';
          legalChecks.push({ status: 'pass', title: 'ìˆ˜ì˜ê³„ì•½ ê°€ëŠ¥', desc: `ìš©ì—­ ${formatNumber(methodThreshold)}ì› ì´í•˜ë¡œ ìˆ˜ì˜ê³„ì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.` });
          results.pass.push('ê³„ì•½ë°©ë²•');
        } else {
          contractMethod = 'ê²½ìŸì…ì°°';
          legalChecks.push({ status: 'warn', title: 'ê²½ìŸì…ì°° ê²€í†  í•„ìš”', desc: `ìš©ì—­ ${formatNumber(methodThreshold)}ì› ì´ˆê³¼ë¡œ ê²½ìŸì…ì°° ì§„í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤.` });
          results.warn.push('ê³„ì•½ë°©ë²•');
        }
      } else if (contractType === 'construction') {
        methodThreshold = 80000000;
        if (totalPrice <= methodThreshold) {
          contractMethod = 'ìˆ˜ì˜ê³„ì•½';
          legalChecks.push({ status: 'pass', title: 'ìˆ˜ì˜ê³„ì•½ ê°€ëŠ¥', desc: `ê³µì‚¬ ${formatNumber(methodThreshold)}ì› ì´í•˜ë¡œ ìˆ˜ì˜ê³„ì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.` });
          results.pass.push('ê³„ì•½ë°©ë²•');
        } else {
          contractMethod = 'ê²½ìŸì…ì°°';
          legalChecks.push({ status: 'warn', title: 'ê²½ìŸì…ì°° í•„ìš”', desc: `ê³µì‚¬ ${formatNumber(methodThreshold)}ì› ì´ˆê³¼ë¡œ ê²½ìŸì…ì°°ì´ í•„ìš”í•©ë‹ˆë‹¤.` });
          results.warn.push('ê³„ì•½ë°©ë²•');
        }
      }
      results.info.push(contractMethod);

      // 2ì¸ ì´ìƒ ê²¬ì  ê¶Œì¥
      if (contractMethod === 'ìˆ˜ì˜ê³„ì•½' && totalPrice > 5000000) {
        legalChecks.push({ status: 'warn', title: 'ë³µìˆ˜ ê²¬ì  ê¶Œì¥', desc: 'ì¶”ì •ê°€ê²© 500ë§Œì› ì´ˆê³¼ ì‹œ 2ê°œ ì´ìƒ ì—…ì²´ì˜ ê²¬ì  ë¹„êµë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.' });
        results.warn.push('ë³µìˆ˜ê²¬ì ');
      }

      // 4. ê³„ì•½ ë°©ë²• ê²€í† 
      const contractChecks = [];

      if (contractMethod === 'ìˆ˜ì˜ê³„ì•½') {
        contractChecks.push({ status: 'pass', title: 'ìˆ˜ì˜ê³„ì•½ ì§„í–‰ ê°€ëŠ¥', desc: `ê¸ˆì•¡ ê¸°ì¤€ ìˆ˜ì˜ê³„ì•½ ìš”ê±´ì„ ì¶©ì¡±í•©ë‹ˆë‹¤.` });
        contractChecks.push({ status: 'info', title: 'í•„ìš” ì„œë¥˜ ì•ˆë‚´', desc: 'ìˆ˜ì˜ê³„ì•½ì‚¬ìœ ì„œ, ì˜ˆì •ê°€ê²©ì¡°ì„œ, ê²¬ì ì„œ, ì‚¬ì—…ìë“±ë¡ì¦ ì‚¬ë³¸ì„ ì¤€ë¹„í•˜ì„¸ìš”.' });
      } else {
        contractChecks.push({ status: 'info', title: 'ê²½ìŸì…ì°° ì§„í–‰ í•„ìš”', desc: `ê¸ˆì•¡ ê¸°ì¤€ìœ¼ë¡œ ê²½ìŸì…ì°° ì§„í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤. ê³„ì•½ ë‹´ë‹¹ë¶€ì„œì™€ í˜‘ì˜í•˜ì„¸ìš”.` });
      }

      // ê²¬ì  ìœ íš¨ê¸°ê°„ í™•ì¸
      const validPeriod = document.getElementById('valid_period').value;
      if (validPeriod) {
        contractChecks.push({ status: 'pass', title: 'ê²¬ì  ìœ íš¨ê¸°ê°„ í™•ì¸', desc: `ê²¬ì  ìœ íš¨ê¸°ê°„: ${validPeriod}` });
        results.pass.push('ìœ íš¨ê¸°ê°„');
      } else {
        contractChecks.push({ status: 'warn', title: 'ê²¬ì  ìœ íš¨ê¸°ê°„ ë¯¸í™•ì¸', desc: 'ê²¬ì  ìœ íš¨ê¸°ê°„ì„ ì—…ì²´ì— í™•ì¸í•˜ì„¸ìš”.' });
        results.warn.push('ìœ íš¨ê¸°ê°„');
      }

      // ë“±ê¸‰ ì‚°ì •
      let grade, gradeText;
      if (results.fail.length === 0 && results.warn.length <= 1) {
        grade = 'A';
        gradeText = 'ìš°ìˆ˜ - ê²¬ì ì„œê°€ ì ì •í•˜ê²Œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
      } else if (results.fail.length === 0 && results.warn.length <= 3) {
        grade = 'B';
        gradeText = 'ì–‘í˜¸ - ì¼ë¶€ í™•ì¸ ì‚¬í•­ì´ ìˆìœ¼ë‚˜ ì§„í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
      } else if (results.fail.length <= 1) {
        grade = 'C';
        gradeText = 'ë³´í†µ - ìˆ˜ì • ë˜ëŠ” ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤.';
      } else {
        grade = 'D';
        gradeText = 'ë¯¸í¡ - ì¬ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
      }

      // ê¶Œê³ ì‚¬í•­ ìƒì„±
      const recommendations = [];
      if (results.warn.includes('ì‚¬ì—…ìë²ˆí˜¸')) {
        recommendations.push('ì‚¬ì—…ìë“±ë¡ì¦ ì‚¬ë³¸ì„ ì§•êµ¬í•˜ì—¬ ì—…ì²´ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }
      if (results.fail.includes('ê°€ê²©ê³¼ë‹¤')) {
        recommendations.push('ê²¬ì ê°€ê²©ì´ ì¶”ì •ê°€ê²©ì„ í¬ê²Œ ì´ˆê³¼í•©ë‹ˆë‹¤. ê°€ê²© ì¡°ì •ì„ ìš”ì²­í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì—…ì²´ ê²¬ì ì„ ë°›ì•„ ë¹„êµí•˜ì„¸ìš”.');
      }
      if (results.warn.includes('ê°€ê²©ë†’ìŒ')) {
        recommendations.push('ê²¬ì ê°€ê²©ì´ ë‹¤ì†Œ ë†’ìŠµë‹ˆë‹¤. ê°€ê²© í˜‘ìƒì„ ì‹œë„í•´ë³´ì„¸ìš”.');
      }
      if (results.warn.includes('ë³µìˆ˜ê²¬ì ')) {
        recommendations.push('ìˆ˜ì˜ê³„ì•½ ì‹œì—ë„ 2ê°œ ì´ìƒ ì—…ì²´ì˜ ê²¬ì ì„ ë¹„êµí•˜ë©´ ê°€ê²© ì ì •ì„± í™•ë³´ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.');
      }
      if (results.warn.includes('ìœ íš¨ê¸°ê°„')) {
        recommendations.push('ê²¬ì  ìœ íš¨ê¸°ê°„ì„ í™•ì¸í•˜ì—¬ ê³„ì•½ ì§„í–‰ ì¼ì •ì„ ê³„íší•˜ì„¸ìš”.');
      }
      if (contractMethod !== 'ìˆ˜ì˜ê³„ì•½') {
        recommendations.push('ê¸ˆì•¡ ê¸°ì¤€ìœ¼ë¡œ ê²½ìŸì…ì°°ì´ í•„ìš”í•©ë‹ˆë‹¤. ê³„ì•½ ë‹´ë‹¹ë¶€ì„œì™€ í˜‘ì˜í•˜ì„¸ìš”.');
      }
      if (recommendations.length === 0) {
        recommendations.push('ê²¬ì ì„œê°€ ì ì •í•˜ê²Œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì•½ ì§„í–‰ì„ ì¶”ì§„í•˜ì„¸ìš”.');
        recommendations.push('ì˜ˆì •ê°€ê²©ì¡°ì„œì™€ ìˆ˜ì˜ê³„ì•½ì‚¬ìœ ì„œë¥¼ ì‘ì„±í•˜ì—¬ ê²°ì¬ë¥¼ ë°›ìœ¼ì„¸ìš”.');
      }

      // ë¦¬í¬íŠ¸ ë Œë”ë§
      renderReport({
        date: new Date().toLocaleDateString('ko-KR'),
        contractName,
        companyName,
        totalPrice,
        grade,
        gradeText,
        results,
        basicChecks,
        priceChecks,
        legalChecks,
        contractChecks,
        recommendations
      });

      analysisComplete = true;
      updateStep(3);
      updateVisibility(3);
      showToast('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function renderReport(data) {
      document.getElementById('report-date').textContent = `${data.contractName || 'ê²¬ì ì„œ'} | ${data.companyName} | ê²€í† ì¼: ${data.date}`;

      document.getElementById('grade-container').innerHTML = `
        <div class="grade-box ${data.grade}">
          <div class="grade-letter">${data.grade}</div>
          <div class="grade-text">${data.gradeText}</div>
        </div>
      `;

      document.getElementById('summary-box').innerHTML = `
        <div class="summary-item pass">
          <div class="number">${data.results.pass.length}</div>
          <div class="label">ì í•© í•­ëª©</div>
        </div>
        <div class="summary-item warn">
          <div class="number">${data.results.warn.length}</div>
          <div class="label">í™•ì¸ í•„ìš”</div>
        </div>
        <div class="summary-item fail">
          <div class="number">${data.results.fail.length}</div>
          <div class="label">ë¶€ì í•©</div>
        </div>
      `;

      renderCheckItems('basic-check-items', data.basicChecks);
      renderCheckItems('price-check-items', data.priceChecks);
      renderCheckItems('legal-check-items', data.legalChecks);
      renderCheckItems('contract-check-items', data.contractChecks);

      document.getElementById('recommendation-list').innerHTML =
        data.recommendations.map(r => `<li>${r}</li>`).join('');
    }

    function renderCheckItems(containerId, items) {
      const container = document.getElementById(containerId);
      container.innerHTML = items.map(item => `
        <div class="check-item">
          <span class="check-icon check-${item.status}">
            ${item.status === 'pass' ? 'âœ“' : item.status === 'warn' ? 'âš ' : item.status === 'fail' ? 'âœ—' : 'â„¹'}
          </span>
          <div class="check-content">
            <strong>${item.title}</strong>
            <p>${item.desc}</p>
          </div>
        </div>
      `).join('');
    }

    async function downloadReport() {
      if (!document.getElementById('report-section').classList.contains('show')) {
        alert('ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      const { Document, Packer, Paragraph, TextRun, AlignmentType } = docx;
      const contractName = document.getElementById('contract_name').value || 'ê²¬ì ì„œ';
      const companyName = document.getElementById('company_name').value || '';
      const date = new Date().toLocaleDateString('ko-KR');

      const doc = new Document({
        sections: [{
          properties: {},
          children: [
            new Paragraph({
              children: [new TextRun({ text: 'ê²¬ì ì„œ ê²€í†  ë¦¬í¬íŠ¸', bold: true, size: 40 })],
              alignment: AlignmentType.CENTER,
              spacing: { after: 200 }
            }),
            new Paragraph({
              children: [new TextRun({ text: `${contractName} | ${companyName} | ê²€í† ì¼: ${date}`, size: 22 })],
              alignment: AlignmentType.CENTER,
              spacing: { after: 400 }
            }),
            new Paragraph({
              children: [new TextRun({ text: document.querySelector('.grade-box').textContent.trim(), bold: true, size: 28 })],
              alignment: AlignmentType.CENTER,
              spacing: { after: 400 }
            }),
            new Paragraph({
              children: [new TextRun({ text: 'ê²€í†  ê²°ê³¼', bold: true, size: 26 })],
              spacing: { after: 200 }
            }),
            ...Array.from(document.querySelectorAll('.check-item')).map(item =>
              new Paragraph({
                children: [new TextRun({
                  text: `${item.querySelector('.check-icon').textContent.trim()} ${item.querySelector('strong').textContent}: ${item.querySelector('p').textContent}`,
                  size: 22
                })],
                spacing: { after: 100 }
              })
            ),
            new Paragraph({
              children: [new TextRun({ text: 'ê¶Œê³ ì‚¬í•­', bold: true, size: 26 })],
              spacing: { before: 300, after: 200 }
            }),
            ...Array.from(document.querySelectorAll('#recommendation-list li')).map(li =>
              new Paragraph({
                children: [new TextRun({ text: `â€¢ ${li.textContent}`, size: 22 })],
                spacing: { after: 100 }
              })
            )
          ]
        }]
      });

      const blob = await Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ê²¬ì ì„œê²€í† _${contractName}_${companyName}.docx`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ë¦¬í¬íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
  </script>
</body>
</html>
