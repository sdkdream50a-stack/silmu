name: ë²•ê·œì • ìë™ ê²€ì¦

on:
  # ìë™ ì‹¤í–‰ ë¹„í™œì„±í™” (ë¹„ìš© ì ˆê°)
  # schedule:
  #   - cron: '0 0 * * 1'  # UTC 00:00 = KST 09:00

  # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      topic_slug:
        description: 'íŠ¹ì • í† í”½ë§Œ ê²€ì¦ (ë¹„ì›Œë‘ë©´ ì „ì²´)'
        required: false
        default: ''

env:
  RAILS_ENV: production
  RUBY_VERSION: '3.3.6'

jobs:
  verify:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: silmu_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ruby ì„¤ì •
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: PostgreSQL í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜
        run: sudo apt-get install -y postgresql-client

      - name: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/silmu_test
        run: |
          bundle exec rails db:create db:schema:load

      - name: í”„ë¡œë•ì…˜ DB ë³µì› (ìµœì‹  ë°±ì—…)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/silmu_test
        run: |
          LATEST_BACKUP=$(ls -t db/backups/*.sql 2>/dev/null | head -1)
          if [ -n "$LATEST_BACKUP" ]; then
            echo "ë°±ì—… íŒŒì¼ ë³µì›: $LATEST_BACKUP"
            psql $DATABASE_URL < $LATEST_BACKUP
          else
            echo "ë°±ì—… íŒŒì¼ ì—†ìŒ, ì‹œë“œ ë°ì´í„° ì‚¬ìš©"
            bundle exec rails db:seed
          fi

      - name: ë²•ê·œì • ê²€ì¦ ì‹¤í–‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/silmu_test
        run: |
          if [ -n "${{ github.event.inputs.topic_slug }}" ]; then
            bundle exec rails "verify:topic[${{ github.event.inputs.topic_slug }}]"
          else
            bundle exec rails verify:regulations
          fi

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„±
        if: steps.check_changes.outputs.changes == 'true'
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/silmu_test
        run: |
          mkdir -p db/backups
          BACKUP_FILE="db/backups/backup_$(date +%Y%m%d_%H%M%S).sql"
          pg_dump $DATABASE_URL > $BACKUP_FILE
          echo "ë°±ì—… ìƒì„±: $BACKUP_FILE"

      - name: Git ì„¤ì •
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git add -A
          git commit -m "fix: ë²•ê·œì • ìë™ ê²€ì¦ ë° ìˆ˜ì • ($(date +%Y-%m-%d))

          ğŸ¤– GitHub Actions ìë™ ê²€ì¦ì— ì˜í•´ ìˆ˜ì •ë¨
          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push

      - name: ê²€ì¦ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v7
        with:
          name: regulation-reports
          path: log/regulation_reports/
          retention-days: 30

      - name: ìŠ¬ë™ ì•Œë¦¼ (ë³€ê²½ì‚¬í•­ ìˆìŒ)
        if: steps.check_changes.outputs.changes == 'true' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸ”„ ë²•ê·œì • ìë™ ê²€ì¦ ì™„ë£Œ: ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤."}' \
            $SLACK_WEBHOOK_URL

      - name: ì™„ë£Œ ë©”ì‹œì§€
        run: |
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "âœ… ê²€ì¦ ì™„ë£Œ: ìˆ˜ì •ì‚¬í•­ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… ê²€ì¦ ì™„ë£Œ: ëª¨ë“  ë‚´ìš©ì´ í˜„í–‰ ê·œì •ê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤."
          fi
