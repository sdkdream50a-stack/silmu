#!/usr/bin/env ruby
# ë²•ë ¹ ê²€ì¦ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
#
# ì‚¬ìš©ë²•:
#   bin/legal_check           - ê²€ì¦ë§Œ ìˆ˜í–‰
#   bin/legal_check --update  - ê²€ì¦ ë° ìë™ ìˆ˜ì •
#   bin/legal_check --commit  - ê²€ì¦, ìˆ˜ì •, ì»¤ë°‹, í‘¸ì‹œê¹Œì§€ ìë™ ìˆ˜í–‰
#   bin/legal_check --help    - ë„ì›€ë§

require 'optparse'
require 'open3'

APP_ROOT = File.expand_path('..', __dir__)
Dir.chdir(APP_ROOT)

options = {
  update: false,
  commit: false,
  push: false,
  verbose: false
}

OptionParser.new do |opts|
  opts.banner = "ì‚¬ìš©ë²•: bin/legal_check [ì˜µì…˜]"

  opts.on("-u", "--update", "ìë™ ìˆ˜ì • ìˆ˜í–‰") do
    options[:update] = true
  end

  opts.on("-c", "--commit", "ìˆ˜ì • í›„ ìë™ ì»¤ë°‹") do
    options[:update] = true
    options[:commit] = true
  end

  opts.on("-p", "--push", "ì»¤ë°‹ í›„ ìë™ í‘¸ì‹œ") do
    options[:update] = true
    options[:commit] = true
    options[:push] = true
  end

  opts.on("-v", "--verbose", "ìƒì„¸ ì¶œë ¥") do
    options[:verbose] = true
  end

  opts.on("-h", "--help", "ë„ì›€ë§ í‘œì‹œ") do
    puts opts
    puts <<~HELP

      ì˜ˆì‹œ:
        bin/legal_check                    # ê²€ì¦ë§Œ
        bin/legal_check --update           # ê²€ì¦ + ìë™ ìˆ˜ì •
        bin/legal_check --commit           # ê²€ì¦ + ìˆ˜ì • + ì»¤ë°‹
        bin/legal_check --push             # ê²€ì¦ + ìˆ˜ì • + ì»¤ë°‹ + í‘¸ì‹œ (ì „ì²´ ìë™í™”)

      ë²•ë ¹ ê¸°ì¤€ íŒŒì¼:
        config/legal_standards.yml

      ê´€ë ¨ rake ëª…ë ¹:
        rake legal:check    - ê²€ì¦
        rake legal:update   - ê²€ì¦ ë° ìˆ˜ì •
        rake legal:report   - ë³´ê³ ì„œ ìƒì„±
        rake legal:sources  - ë²•ë ¹ ì¶œì²˜ í™•ì¸
    HELP
    exit
  end
end.parse!

def run_command(cmd, description, verbose: false)
  puts "â–¶ #{description}..." if verbose
  stdout, stderr, status = Open3.capture3(cmd)

  if verbose || !status.success?
    puts stdout unless stdout.empty?
    puts stderr unless stderr.empty?
  end

  [status.success?, stdout, stderr]
end

def colored(text, color)
  colors = {
    green: "\e[32m",
    red: "\e[31m",
    yellow: "\e[33m",
    blue: "\e[34m",
    reset: "\e[0m"
  }
  "#{colors[color]}#{text}#{colors[:reset]}"
end

puts colored("=" * 60, :blue)
puts colored("  ë²•ë ¹ ìë™ ê²€ì¦ ì‹œìŠ¤í…œ", :blue)
puts colored("=" * 60, :blue)
puts

# 1. ê²€ì¦ ìˆ˜í–‰
task = options[:update] ? "legal:update" : "legal:check"
success, output, error = run_command(
  "bundle exec rake #{task}",
  "ë²•ë ¹ ê¸°ì¤€ ê²€ì¦",
  verbose: options[:verbose]
)

puts output

unless success
  if options[:update]
    puts colored("\nâš ï¸  ì¼ë¶€ í•­ëª© ìë™ ìˆ˜ì • ì‹¤íŒ¨. ìˆ˜ë™ í™•ì¸ í•„ìš”.", :yellow)
  else
    puts colored("\nâŒ ê²€ì¦ ì‹¤íŒ¨. --update ì˜µì…˜ìœ¼ë¡œ ìë™ ìˆ˜ì •ì„ ì‹œë„í•˜ì„¸ìš”.", :red)
    exit 1
  end
end

# 2. ë³€ê²½ì‚¬í•­ í™•ì¸
if options[:commit]
  _, diff_output, _ = run_command("git diff --name-only", "ë³€ê²½ íŒŒì¼ í™•ì¸")

  if diff_output.strip.empty?
    puts colored("\nâœ… ë³€ê²½ì‚¬í•­ ì—†ìŒ. ëª¨ë“  íŒŒì¼ì´ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤.", :green)
    exit 0
  end

  puts "\nğŸ“ ë³€ê²½ëœ íŒŒì¼:"
  diff_output.each_line { |line| puts "  - #{line}" }

  # 3. ì»¤ë°‹
  run_command("git add -A", "ìŠ¤í…Œì´ì§•")

  commit_msg = "auto: ë²•ë ¹ ê¸°ì¤€ ìë™ ì—…ë°ì´íŠ¸ (#{Time.now.strftime('%Y-%m-%d')})\n\nCo-Authored-By: Legal Check Bot <noreply@example.com>"
  success, _, _ = run_command(
    "git commit -m '#{commit_msg}'",
    "ì»¤ë°‹ ìƒì„±",
    verbose: options[:verbose]
  )

  if success
    puts colored("\nâœ… ì»¤ë°‹ ì™„ë£Œ", :green)
  else
    puts colored("\nâŒ ì»¤ë°‹ ì‹¤íŒ¨", :red)
    exit 1
  end

  # 4. í‘¸ì‹œ
  if options[:push]
    success, _, _ = run_command(
      "git push origin HEAD",
      "ì›ê²© ì €ì¥ì†Œ í‘¸ì‹œ",
      verbose: options[:verbose]
    )

    if success
      puts colored("âœ… í‘¸ì‹œ ì™„ë£Œ", :green)
    else
      puts colored("âŒ í‘¸ì‹œ ì‹¤íŒ¨", :red)
      exit 1
    end
  end
end

puts colored("\nğŸ‰ ë²•ë ¹ ê²€ì¦ ì™„ë£Œ!", :green)
