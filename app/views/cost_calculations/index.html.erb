<%# 원가계산서 검토 가이드 %>

<style>
.cc-step-card { background:#fff; border-radius:16px; border:1px solid #e5e7eb; padding:32px; margin-bottom:24px; display:none; }
.cc-step-card.active { display:block; }
.cc-type-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:14px; }
.cc-type-btn { background:#fff; border:2px solid #e5e7eb; border-radius:14px; padding:22px 16px; text-align:center; cursor:pointer; transition:all .2s; }
.cc-type-btn:hover { border-color:#7c3aed; background:#f5f3ff; }
.cc-type-btn.selected { border-color:#7c3aed; background:#f5f3ff; box-shadow:0 0 0 3px rgba(124,58,237,.15); }
.cc-type-btn .cc-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; background:#f1f5f9; }
.cc-type-btn.selected .cc-icon { background:#7c3aed; }
.cc-type-btn.selected .cc-icon .material-symbols-outlined { color:#fff; }
.cc-type-btn .cc-type-name { font-weight:700; color:#1e293b; font-size:14px; }
.cc-type-btn .cc-type-desc { font-size:12px; color:#64748b; margin-top:3px; }

.cc-form-group { margin-bottom:16px; }
.cc-form-group label { display:block; font-weight:600; font-size:14px; color:#334155; margin-bottom:6px; }
.cc-form-group .cc-sublabel { font-size:12px; color:#94a3b8; font-weight:400; margin-left:4px; }
.cc-form-group input { width:100%; border:1px solid #d1d5db; border-radius:10px; padding:10px 14px; font-size:14px; }
.cc-form-group input:focus { outline:none; border-color:#7c3aed; box-shadow:0 0 0 3px rgba(124,58,237,.1); }

.cc-input-row { display:grid; grid-template-columns:1fr auto 1fr; gap:12px; align-items:end; margin-bottom:12px; }
.cc-input-row .cc-equals { padding-bottom:12px; color:#94a3b8; font-weight:600; }

.cc-cost-table { width:100%; border-collapse:collapse; margin:16px 0; }
.cc-cost-table th { background:#f8fafc; padding:10px 14px; text-align:left; border-bottom:2px solid #e2e8f0; font-size:13px; color:#475569; font-weight:600; }
.cc-cost-table td { padding:10px 14px; border-bottom:1px solid #f1f5f9; font-size:14px; }
.cc-cost-table td input { width:100%; border:1px solid #e5e7eb; border-radius:8px; padding:8px 12px; font-size:14px; text-align:right; }
.cc-cost-table td input:focus { outline:none; border-color:#7c3aed; }
.cc-cost-table .label-cell { font-weight:600; color:#334155; }
.cc-cost-table .note-cell { font-size:12px; color:#94a3b8; }
.cc-cost-table .total-row td { border-top:2px solid #e2e8f0; font-weight:700; font-size:15px; background:#f8fafc; }

.cc-quick-bar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; padding:10px 0; }
.cc-quick-btn { display:inline-flex; align-items:center; padding:6px 14px; border-radius:20px; border:1px solid #d1d5db; background:#fff; font-size:13px; font-weight:600; color:#475569; cursor:pointer; transition:all .15s; white-space:nowrap; }
.cc-quick-btn:hover { background:#f5f3ff; border-color:#c4b5fd; color:#6d28d9; }
.cc-quick-btn.cc-reset { background:#fef3c7; border-color:#fcd34d; color:#b45309; margin-left:auto; }
.cc-quick-btn.cc-reset:hover { background:#fde68a; border-color:#f59e0b; }
.cc-quick-focus-hint { font-size:12px; color:#94a3b8; width:100%; margin-bottom:2px; }

.cc-btn { display:inline-flex; align-items:center; gap:6px; padding:12px 28px; border-radius:12px; font-weight:600; font-size:15px; border:none; cursor:pointer; transition:all .2s; }
.cc-btn-primary { background:#7c3aed; color:#fff; }
.cc-btn-primary:hover { background:#6d28d9; }
.cc-btn-secondary { background:#f1f5f9; color:#475569; }
.cc-btn-secondary:hover { background:#e2e8f0; }
.cc-btn-success { background:#059669; color:#fff; }
.cc-btn-success:hover { background:#047857; }
.cc-btn:disabled { opacity:.5; cursor:not-allowed; }

.cc-step-indicator { display:flex; gap:8px; margin-bottom:28px; }
.cc-step-dot { width:10px; height:10px; border-radius:50%; background:#e2e8f0; transition:all .2s; }
.cc-step-dot.active { background:#7c3aed; width:28px; border-radius:5px; }
.cc-step-dot.done { background:#059669; }

.cc-section-title { font-size:22px; font-weight:700; color:#1e293b; margin-bottom:6px; }
.cc-section-desc { font-size:14px; color:#64748b; margin-bottom:24px; }

/* 결과 */
.cc-result-section { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:24px; margin-bottom:20px; }
.cc-result-title { font-size:17px; font-weight:700; color:#1e293b; margin-bottom:14px; padding-bottom:10px; border-bottom:2px solid #e2e8f0; display:flex; align-items:center; gap:8px; }

.cc-summary-box { padding:20px; border-radius:12px; display:flex; align-items:center; gap:14px; margin-bottom:20px; }
.cc-summary-ok { background:#f0fdf4; border:1px solid #bbf7d0; }
.cc-summary-warning { background:#fffbeb; border:1px solid #fde68a; }
.cc-summary-error { background:#fef2f2; border:1px solid #fecaca; }
.cc-summary-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.cc-summary-ok .cc-summary-icon { background:#059669; }
.cc-summary-warning .cc-summary-icon { background:#d97706; }
.cc-summary-error .cc-summary-icon { background:#dc2626; }
.cc-summary-text { font-weight:600; font-size:15px; color:#1e293b; }

.cc-review-item { display:flex; align-items:flex-start; gap:14px; padding:14px 0; border-bottom:1px solid #f1f5f9; }
.cc-review-item:last-child { border-bottom:none; }
.cc-review-badge { padding:4px 10px; border-radius:8px; font-size:12px; font-weight:700; white-space:nowrap; flex-shrink:0; margin-top:2px; }
.cc-review-badge.ok { background:#dcfce7; color:#166534; }
.cc-review-badge.warning { background:#fef9c3; color:#854d0e; }
.cc-review-badge.error { background:#fee2e2; color:#991b1b; }
.cc-review-name { font-weight:700; color:#1e293b; font-size:15px; }
.cc-review-detail { font-size:13px; color:#64748b; margin-top:4px; line-height:1.6; }
.cc-review-meta { font-size:13px; color:#94a3b8; margin-top:4px; }

.cc-ref-box { background:#f5f3ff; border:1px solid #ddd6fe; border-radius:12px; padding:16px 20px; font-size:14px; color:#5b21b6; }

@media print {
  body * { visibility:hidden; }
  #cc-result-area, #cc-result-area * { visibility:visible; }
  #cc-result-area { position:absolute; left:0; top:0; width:100%; padding:20px; }
  .no-print { display:none !important; }
}

/* AI 업로드 */
@keyframes ccSpin { to { transform:rotate(360deg); } }
.cc-ai-filled { background:#f0fdf4 !important; border-color:#86efac !important; }
.cc-upload-zone { border:2px dashed #c4b5fd; border-radius:14px; padding:32px 20px; text-align:center; cursor:pointer; transition:all .2s; background:#faf5ff; }
.cc-upload-zone:hover, .cc-upload-zone.dragover { border-color:#7c3aed; background:#f5f3ff; }
.cc-upload-info { display:flex; align-items:center; gap:12px; padding:12px 16px; background:#f5f3ff; border:1px solid #ddd6fe; border-radius:10px; margin-top:12px; }
.cc-upload-info .cc-file-name { flex:1; font-weight:600; font-size:14px; color:#5b21b6; }
.cc-upload-info .cc-file-remove { background:none; border:none; cursor:pointer; color:#a78bfa; font-size:18px; padding:4px; }
.cc-upload-info .cc-file-remove:hover { color:#dc2626; }
.cc-analyze-btn { display:inline-flex; align-items:center; gap:8px; padding:10px 22px; border-radius:10px; font-weight:600; font-size:14px; border:none; cursor:pointer; background:#7c3aed; color:#fff; margin-top:12px; transition:all .2s; }
.cc-analyze-btn:hover { background:#6d28d9; }
.cc-analyze-btn:disabled { opacity:.5; cursor:not-allowed; }
.cc-analyze-btn .cc-spinner { width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:ccSpin .6s linear infinite; display:none; }
.cc-status-msg { margin-top:10px; font-size:13px; padding:8px 14px; border-radius:8px; display:none; }
.cc-status-msg.loading { display:block; background:#f5f3ff; color:#7c3aed; }
.cc-status-msg.success { display:block; background:#f0fdf4; color:#059669; }
.cc-status-msg.error { display:block; background:#fef2f2; color:#dc2626; }

@media (max-width:640px) {
  .cc-type-grid { grid-template-columns:repeat(2, 1fr); gap:10px; }
  .cc-type-btn { padding:16px 10px; }
}
</style>

<!-- 헤더 -->
<section class="gradient-premium text-white py-12 lg:py-16">
  <div class="container-wide">
    <div class="flex items-start gap-5">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
        <span class="material-symbols-outlined text-4xl text-white">price_check</span>
      </div>
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">원가계산서 검토 가이드</h1>
        <p class="text-navy-200 text-lg">용역 원가계산서 항목별 적정성을 자동 검토</p>
      </div>
    </div>
  </div>
</section>

<section class="py-10">
  <div class="container-wide max-w-4xl">

    <div class="cc-step-indicator" id="cc-steps">
      <div class="cc-step-dot active"></div>
      <div class="cc-step-dot"></div>
      <div class="cc-step-dot"></div>
    </div>

    <!-- Step 1: 용역유형 선택 -->
    <div class="cc-step-card active" id="cc-step1">
      <h2 class="cc-section-title">용역 유형 선택</h2>
      <p class="cc-section-desc">검토할 원가계산서의 용역 유형을 선택하세요. 유형별로 적정 비율 기준이 달라집니다.</p>

      <div class="cc-type-grid" id="cc-type-grid">
        <% @service_types.each do |type| %>
          <div class="cc-type-btn" data-type="<%= type[:id] %>" onclick="ccSelectType(this)">
            <div class="cc-icon">
              <span class="material-symbols-outlined text-2xl text-violet-500"><%= type[:icon] %></span>
            </div>
            <div class="cc-type-name"><%= type[:name] %></div>
            <div class="cc-type-desc"><%= type[:desc] %></div>
          </div>
        <% end %>
      </div>

      <div style="margin-top:24px; text-align:right;">
        <button class="cc-btn cc-btn-primary" id="cc-btn-step1" disabled onclick="ccGoStep(2)">
          다음 <span class="material-symbols-outlined text-lg">arrow_forward</span>
        </button>
      </div>
    </div>

    <!-- Step 2: 원가 입력 -->
    <div class="cc-step-card" id="cc-step2">
      <h2 class="cc-section-title">원가계산서 금액 입력</h2>
      <p class="cc-section-desc">원가계산서의 각 항목 금액을 입력하세요.</p>

      <!-- AI 업로드 -->
      <div style="background:#faf5ff; border:1px solid #ddd6fe; border-radius:14px; padding:20px; margin-bottom:24px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          <span class="material-symbols-outlined" style="color:#7c3aed;">smart_toy</span>
          <strong style="color:#5b21b6; font-size:15px;">AI 문서 분석</strong>
          <span style="font-size:12px; color:#a78bfa;">(선택사항)</span>
        </div>
        <p style="font-size:13px; color:#64748b; margin-bottom:14px;">원가계산서, 견적서, 대가산출내역서를 업로드하면 AI가 분석하여 금액을 자동 입력합니다.</p>

        <div class="cc-upload-zone" id="cc-upload-zone"
             ondragover="event.preventDefault(); this.classList.add('dragover');"
             ondragleave="this.classList.remove('dragover');"
             ondrop="event.preventDefault(); this.classList.remove('dragover'); ccHandleFile(event.dataTransfer.files[0]);"
             onclick="document.getElementById('cc-file-input').click();">
          <input type="file" id="cc-file-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" onchange="ccHandleFile(this.files[0]);">
          <span class="material-symbols-outlined text-3xl" style="color:#a78bfa;">cloud_upload</span>
          <div style="font-weight:600; color:#5b21b6; margin-top:8px;">파일을 드래그하거나 클릭하여 선택</div>
          <div style="font-size:12px; color:#94a3b8; margin-top:4px;">PDF, JPG, PNG (최대 20MB)</div>
        </div>

        <div class="cc-upload-info" id="cc-file-info" style="display:none;">
          <span class="material-symbols-outlined" style="color:#7c3aed;">description</span>
          <span class="cc-file-name" id="cc-file-name"></span>
          <button class="cc-file-remove" onclick="ccClearFile()" title="삭제">&times;</button>
        </div>

        <button class="cc-analyze-btn" id="cc-analyze-btn" style="display:none;" onclick="ccAnalyzeDocument()">
          <span class="material-symbols-outlined text-lg">auto_awesome</span>
          AI 분석 시작
          <span class="cc-spinner" id="cc-spinner"></span>
        </button>

        <div class="cc-status-msg" id="cc-status-msg"></div>
      </div>

      <table class="cc-cost-table">
        <thead>
          <tr>
            <th style="width:200px;">항목</th>
            <th style="width:200px;">금액 (원)</th>
            <th>비고</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="label-cell">직접인건비</td>
            <td><input type="number" id="cc-direct-labor" placeholder="0" min="0"></td>
            <td class="note-cell">노임단가 × 투입인월(M/M)</td>
          </tr>
          <tr>
            <td class="label-cell" id="cc-overhead-label">제경비(간접노무비+기타경비)</td>
            <td><input type="number" id="cc-overhead" placeholder="0" min="0"></td>
            <td class="note-cell" id="cc-overhead-note">직접인건비 기준</td>
          </tr>
          <tr>
            <td class="label-cell">직접경비</td>
            <td><input type="number" id="cc-direct-expense" placeholder="0" min="0"></td>
            <td class="note-cell">여비, 인쇄비, 소모품 등 실비</td>
          </tr>
          <tr>
            <td class="label-cell">일반관리비</td>
            <td><input type="number" id="cc-general-admin" placeholder="0" min="0"></td>
            <td class="note-cell">5~6% (회계예규)</td>
          </tr>
          <tr>
            <td class="label-cell" id="cc-profit-label">이윤</td>
            <td><input type="number" id="cc-profit" placeholder="0" min="0"></td>
            <td class="note-cell" id="cc-profit-note">상한 확인</td>
          </tr>
          <tr>
            <td class="label-cell">부가가치세</td>
            <td><input type="number" id="cc-vat" placeholder="0" min="0"></td>
            <td class="note-cell">공급가액의 10%</td>
          </tr>
          <tr class="total-row">
            <td>합계</td>
            <td id="cc-total-amount" style="text-align:right; padding-right:14px;">0 원</td>
            <td></td>
          </tr>
        </tbody>
      </table>
      <div class="cc-quick-bar">
        <span class="cc-quick-focus-hint">입력칸을 선택 후 금액 버튼을 눌러주세요</span>
        <span class="cc-quick-btn" onclick="ccAddQuick(1000)">+1천원</span>
        <span class="cc-quick-btn" onclick="ccAddQuick(10000)">+1만원</span>
        <span class="cc-quick-btn" onclick="ccAddQuick(100000)">+10만</span>
        <span class="cc-quick-btn" onclick="ccAddQuick(1000000)">+100만</span>
        <span class="cc-quick-btn" onclick="ccAddQuick(10000000)">+1천만</span>
        <span class="cc-quick-btn" onclick="ccAddQuick(50000000)">+5천만</span>
        <span class="cc-quick-btn" onclick="ccAddQuick(100000000)">+1억</span>
        <span class="cc-quick-btn cc-reset" onclick="ccResetQuick()">초기화</span>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:24px;">
        <button class="cc-btn cc-btn-secondary" onclick="ccGoStep(1)">
          <span class="material-symbols-outlined text-lg">arrow_back</span> 이전
        </button>
        <button class="cc-btn cc-btn-primary" onclick="ccGoStep(3)">
          검토 시작 <span class="material-symbols-outlined text-lg">auto_awesome</span>
        </button>
      </div>
    </div>

    <!-- Step 3: 검토 결과 -->
    <div class="cc-step-card" id="cc-step3">
      <h2 class="cc-section-title">검토 결과</h2>
      <p class="cc-section-desc">항목별 적정성 검토 결과입니다.</p>

      <div id="cc-result-area"></div>

      <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-top:24px;" class="no-print">
        <button class="cc-btn cc-btn-secondary" onclick="ccGoStep(2)">
          <span class="material-symbols-outlined text-lg">arrow_back</span> 수정
        </button>
        <button class="cc-btn cc-btn-success" onclick="window.print()">
          <span class="material-symbols-outlined text-lg">print</span> 인쇄
        </button>
      </div>
    </div>

  </div>
</section>

<script>
document.addEventListener('turbo:load', function() {
  var ccStep1 = document.getElementById('cc-step1');
  if (!ccStep1) return;

  var ccSelectedType = null;
  var ccLastFocusedInput = null;

  document.getElementById('cc-step2').addEventListener('focusin', function(e) {
    if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
      ccLastFocusedInput = e.target;
    }
  });

  window.ccAddQuick = function(amount) {
    if (!ccLastFocusedInput) {
      ccLastFocusedInput = document.getElementById('cc-direct-labor');
    }
    if (!ccLastFocusedInput) return;
    var cur = parseInt(ccLastFocusedInput.value) || 0;
    ccLastFocusedInput.value = cur + amount;
    ccLastFocusedInput.focus();
  };

  window.ccResetQuick = function() {
    if (ccLastFocusedInput) {
      ccLastFocusedInput.value = '';
      ccLastFocusedInput.focus();
    }
  };
  var ccTypeData = <%= raw CostCalculationReviewService::SERVICE_TYPES.to_json %>;

  window.ccSelectType = function(el) {
    var btns = document.querySelectorAll('.cc-type-btn');
    for (var i = 0; i < btns.length; i++) { btns[i].classList.remove('selected'); }
    el.classList.add('selected');
    ccSelectedType = el.dataset.type;
    document.getElementById('cc-btn-step1').disabled = false;

    // 유형에 맞게 라벨 업데이트
    var info = ccTypeData[ccSelectedType];
    if (info) {
      if (info.tech_fee) {
        document.getElementById('cc-profit-label').textContent = '기술료';
        document.getElementById('cc-profit-note').textContent = info.note;
      } else {
        document.getElementById('cc-profit-label').textContent = '이윤';
        document.getElementById('cc-profit-note').textContent = info.note;
      }
    }
  };

  // 합계 자동 계산
  var ccInputIds = ['cc-direct-labor', 'cc-overhead', 'cc-direct-expense', 'cc-general-admin', 'cc-profit', 'cc-vat'];
  for (var i = 0; i < ccInputIds.length; i++) {
    var inp = document.getElementById(ccInputIds[i]);
    if (inp) inp.addEventListener('input', ccCalcTotal);
  }

  function ccCalcTotal() {
    var total = 0;
    for (var i = 0; i < ccInputIds.length; i++) {
      total += parseInt(document.getElementById(ccInputIds[i]).value) || 0;
    }
    document.getElementById('cc-total-amount').textContent = ccComma(total) + ' 원';
  }

  window.ccGoStep = function(step) {
    if (step === 3) {
      ccReview();
    }

    for (var i = 1; i <= 3; i++) {
      var card = document.getElementById('cc-step' + i);
      if (card) card.classList.remove('active');
    }
    document.getElementById('cc-step' + step).classList.add('active');

    var dots = document.querySelectorAll('.cc-step-dot');
    for (var d = 0; d < dots.length; d++) {
      dots[d].classList.remove('active', 'done');
      if (d < step - 1) dots[d].classList.add('done');
      if (d === step - 1) dots[d].classList.add('active');
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  function ccReview() {
    var body = {
      service_type: ccSelectedType,
      direct_labor: document.getElementById('cc-direct-labor').value || '0',
      overhead: document.getElementById('cc-overhead').value || '0',
      direct_expense: document.getElementById('cc-direct-expense').value || '0',
      general_admin: document.getElementById('cc-general-admin').value || '0',
      profit_or_tech: document.getElementById('cc-profit').value || '0',
      vat: document.getElementById('cc-vat').value || '0'
    };

    fetch('/cost-calculations/review', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
      },
      body: JSON.stringify(body)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        ccRenderResult(data.result);
      }
    });
  }

  function ccRenderResult(r) {
    var html = '';

    // 요약
    var sClass = r.summary.status === 'ok' ? 'cc-summary-ok' : (r.summary.status === 'warning' ? 'cc-summary-warning' : 'cc-summary-error');
    var sIcon = r.summary.status === 'ok' ? 'check_circle' : (r.summary.status === 'warning' ? 'warning' : 'error');
    html += '<div class="cc-summary-box ' + sClass + '"><div class="cc-summary-icon"><span class="material-symbols-outlined text-2xl text-white">' + sIcon + '</span></div><div><div class="cc-summary-text">' + ccEsc(r.summary.message) + '</div><div style="font-size:13px;color:#64748b;margin-top:4px;">' + ccEsc(r.type_name) + ' · 합계 ' + ccComma(r.total) + '원 · ' + ccEsc(r.type_note) + '</div></div></div>';

    // 항목별 검토
    html += '<div class="cc-result-section"><div class="cc-result-title"><span class="material-symbols-outlined" style="color:#7c3aed;">analytics</span> 항목별 검토 결과</div>';

    for (var i = 0; i < r.reviews.length; i++) {
      var rv = r.reviews[i];
      var badgeClass = rv.status;
      var badgeText = rv.status === 'ok' ? '적정' : (rv.status === 'warning' ? '주의' : '부적정');
      html += '<div class="cc-review-item"><div class="cc-review-badge ' + badgeClass + '">' + badgeText + '</div><div style="flex:1;"><div class="cc-review-name">' + ccEsc(rv.name) + '</div><div class="cc-review-detail">' + ccEsc(rv.detail) + '</div>';
      if (rv.amount !== undefined) {
        var metaText = ccComma(rv.amount) + '원';
        if (rv.rate) metaText += ' (' + rv.rate + ')';
        html += '<div class="cc-review-meta">' + metaText + '</div>';
      }
      html += '</div></div>';
    }
    html += '</div>';

    // 직접경비 참고
    if (r.expense_items && r.expense_items.length > 0) {
      html += '<div class="cc-result-section"><div class="cc-result-title"><span class="material-symbols-outlined" style="color:#7c3aed;">receipt</span> 직접경비 항목 참고</div>';
      html += '<div class="cc-ref-box">일반적으로 포함되는 직접경비 항목: <strong>' + r.expense_items.join(', ') + '</strong></div></div>';
    }

    // 안내
    html += '<div class="cc-result-section"><div class="cc-result-title"><span class="material-symbols-outlined" style="color:#f59e0b;">info</span> 유의사항</div>';
    html += '<div style="font-size:14px;color:#64748b;line-height:1.8;">';
    html += '• 본 검토 결과는 참고용이며, 실제 원가검토는 관련 법령과 기준을 종합적으로 검토해야 합니다.<br>';
    html += '• 직접인건비는 해당 연도 노임단가(한국엔지니어링협회, SW기술자 등)를 기준으로 확인하세요.<br>';
    html += '• 제경비율은 용역 유형과 규모에 따라 차이가 있을 수 있습니다.<br>';
    html += '• 관련 근거: 예정가격 작성기준(회계예규), 엔지니어링사업 대가기준, SW사업 대가기준';
    html += '</div></div>';

    document.getElementById('cc-result-area').innerHTML = html;
  }

  // AI 업로드 기능
  var ccSelectedFile = null;
  var ccAnalyzedData = null;

  window.ccHandleFile = function(file) {
    if (!file) return;
    var allowed = ['application/pdf', 'image/jpeg', 'image/png'];
    if (allowed.indexOf(file.type) === -1) {
      ccShowStatus('error', 'PDF, JPG, PNG 파일만 업로드 가능합니다.');
      return;
    }
    if (file.size > 20 * 1024 * 1024) {
      ccShowStatus('error', '파일 크기는 20MB 이하여야 합니다.');
      return;
    }
    ccSelectedFile = file;
    document.getElementById('cc-file-name').textContent = file.name;
    document.getElementById('cc-file-info').style.display = 'flex';
    document.getElementById('cc-upload-zone').style.display = 'none';
    document.getElementById('cc-analyze-btn').style.display = 'inline-flex';
    ccShowStatus('', '');
  };

  window.ccClearFile = function() {
    ccSelectedFile = null;
    ccAnalyzedData = null;
    document.getElementById('cc-file-input').value = '';
    document.getElementById('cc-file-info').style.display = 'none';
    document.getElementById('cc-upload-zone').style.display = '';
    document.getElementById('cc-analyze-btn').style.display = 'none';
    ccShowStatus('', '');
  };

  window.ccAnalyzeDocument = function() {
    if (!ccSelectedFile) return;
    var btn = document.getElementById('cc-analyze-btn');
    var spinner = document.getElementById('cc-spinner');
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    ccShowStatus('loading', 'AI가 문서를 분석하고 있습니다... (10~20초 소요)');

    var formData = new FormData();
    formData.append('file', ccSelectedFile);
    formData.append('document_type', 'cost_calculation');

    fetch('/document-analysis/analyze', {
      method: 'POST',
      headers: { 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content },
      body: formData
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        btn.disabled = false;
        spinner.style.display = 'none';
        if (data.success && data.fields) {
          ccAnalyzedData = data.fields;
          ccShowStatus('success', 'AI 분석 완료! 금액이 자동 입력되었습니다.');
          ccApplyAnalyzedData();
        } else {
          ccShowStatus('error', data.error || 'AI 분석에 실패했습니다.');
        }
      })
      .catch(function() {
        btn.disabled = false;
        spinner.style.display = 'none';
        ccShowStatus('error', '서버 연결에 실패했습니다.');
      });
  };

  function ccApplyAnalyzedData() {
    if (!ccAnalyzedData) return;
    var d = ccAnalyzedData;

    // 용역 유형 자동 선택 (Step 1)
    if (d.service_type) {
      var typeBtn = document.querySelector('.cc-type-btn[data-type="' + d.service_type + '"]');
      if (typeBtn) {
        ccSelectType(typeBtn);
      }
    }

    // 금액 입력 (Step 2)
    var fieldMap = {
      'cc-direct-labor': d.direct_labor,
      'cc-overhead': d.overhead,
      'cc-direct-expense': d.direct_expense,
      'cc-general-admin': d.general_admin,
      'cc-profit': d.profit_or_tech,
      'cc-vat': d.vat
    };

    for (var id in fieldMap) {
      if (fieldMap[id] != null) {
        var input = document.getElementById(id);
        if (input) {
          input.value = fieldMap[id];
          input.classList.add('cc-ai-filled');
        }
      }
    }

    // 합계 재계산
    ccCalcTotal();
  }

  function ccShowStatus(type, msg) {
    var el = document.getElementById('cc-status-msg');
    el.className = 'cc-status-msg';
    if (type && msg) {
      el.classList.add(type);
      el.textContent = msg;
    }
  }

  function ccComma(n) { return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
  function ccEsc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
});
</script>
