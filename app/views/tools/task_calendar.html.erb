<%# 업무 할일 달력 — 사이드바 + 뷰 전환 %>
<% content_for :hide_footer, true %>
<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-cache">
  <style>
    #calendar-root { height: calc(100vh - 4rem); height: calc(100dvh - 4rem); }
    @media (min-width: 1024px) { #calendar-root { height: calc(100vh - 4.5rem); height: calc(100dvh - 4.5rem); } }
  </style>
<% end %>

<%
  cat_colors = {
    "급여" => { bg: "bg-emerald-50", text: "text-emerald-700", dot: "bg-emerald-500", badge: "bg-emerald-100" },
    "세무" => { bg: "bg-amber-50", text: "text-amber-700", dot: "bg-amber-500", badge: "bg-amber-100" },
    "보험" => { bg: "bg-blue-50", text: "text-blue-700", dot: "bg-blue-500", badge: "bg-blue-100" },
    "회계" => { bg: "bg-violet-50", text: "text-violet-700", dot: "bg-violet-500", badge: "bg-violet-100" },
    "보고" => { bg: "bg-rose-50", text: "text-rose-700", dot: "bg-rose-500", badge: "bg-rose-100" },
    "서무" => { bg: "bg-slate-50", text: "text-slate-600", dot: "bg-slate-400", badge: "bg-slate-100" },
    "복지" => { bg: "bg-cyan-50", text: "text-cyan-700", dot: "bg-cyan-500", badge: "bg-cyan-100" },
  }

  holidays = {
    [1,1] => "신정",
    [2,16] => "설연휴", [2,17] => "설날", [2,18] => "설연휴",
    [3,1] => "삼일절", [3,2] => "대체공휴일",
    [5,5] => "어린이날", [5,24] => "부처님오신날", [5,25] => "대체공휴일",
    [6,6] => "현충일",
    [8,15] => "광복절", [8,17] => "대체공휴일",
    [9,24] => "추석연휴", [9,25] => "추석", [9,26] => "추석연휴",
    [10,3] => "개천절", [10,5] => "대체공휴일", [10,9] => "한글날",
    [12,25] => "성탄절",
  }

  # 직전 평일 계산 (주말·공휴일이면 앞으로 이동)
  prev_workday = ->(d) {
    d -= 1 while d.wday == 0 || d.wday == 6 || holidays[[d.month, d.day]]
    d
  }

  months_tasks_raw = {
    1 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 15, cat: "보고", title: "일용근로소득 지급명세서 제출" },
      { day: 17, cat: "급여", title: "급여 지급 준비 (공제내역 확인)" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 31, cat: "세무", title: "연말정산 간소화 자료 확인·제출" },
      { day: 31, cat: "회계", title: "전년도 세입·세출 결산 마감" },
    ],
    2 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 15, cat: "보험", title: "건강보험 정산(보수총액 신고)" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 28, cat: "세무", title: "연말정산 환급·추징 처리" },
      { day: 28, cat: "보고", title: "4대보험 사업장현황 신고" },
    ],
    3 => [
      { day: 2, cat: "서무", title: "세입 세출 예산 관련" },
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 10, cat: "보고", title: "근로소득 지급명세서 제출" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 25, cat: "보험", title: "고용·산재보험 보수총액 신고" },
      { day: 31, cat: "회계", title: "1분기 결산 준비" },
    ],
    4 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 15, cat: "보험", title: "건강보험 연말정산 보험료 반영" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 20, cat: "서무", title: "상반기 물품구매계획 점검" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 25, cat: "세무", title: "지방세 납부(면허세 등)" },
      { day: 30, cat: "보고", title: "1분기 업무 실적 보고" },
    ],
    5 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 31, cat: "복지", title: "맞춤형복지 상반기 사용 점검" },
      { day: 31, cat: "세무", title: "종합소득세 신고(해당 시)" },
    ],
    6 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 25, cat: "보고", title: "상반기 계약 집행 현황 보고" },
      { day: 30, cat: "회계", title: "상반기(2분기) 결산" },
      { day: 30, cat: "서무", title: "하반기 업무계획 수립" },
    ],
    7 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 10, cat: "세무", title: "재산세 납부(건축물)" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 25, cat: "보험", title: "건강보험 보수월액 변경신고" },
      { day: 31, cat: "보고", title: "상반기 업무 실적 보고" },
    ],
    8 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 31, cat: "회계", title: "추가경정예산 편성(해당 시)" },
      { day: 31, cat: "서무", title: "하반기 물품구매계획 점검" },
    ],
    9 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 15, cat: "세무", title: "재산세 납부(토지)" },
      { day: 17, cat: "급여", title: "급여 지급 준비 (추석 전 조기 지급)" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 30, cat: "회계", title: "3분기 결산" },
      { day: 30, cat: "보고", title: "3분기 업무 실적 보고" },
    ],
    10 => [
      { day: 5, cat: "서무", title: "하반기 주요업무계획 점검" },
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 31, cat: "회계", title: "차년도 예산(안) 요구서 제출" },
      { day: 31, cat: "서무", title: "연말 계약 집행 계획 수립" },
    ],
    11 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 15, cat: "복지", title: "맞춤형복지 잔액 사용 안내" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 30, cat: "보고", title: "연말 계약 집행 현황 점검" },
      { day: 30, cat: "세무", title: "연말정산 사전 안내" },
    ],
    12 => [
      { day: 10, cat: "세무", title: "원천세 신고·납부" },
      { day: 10, cat: "보험", title: "4대보험료 납부" },
      { day: 17, cat: "급여", title: "급여 지급 준비" },
      { day: 20, cat: "회계", title: "세출예산 이·전용 마감" },
      { day: 25, cat: "급여", title: "급여 지급" },
      { day: 31, cat: "회계", title: "회계연도 마감 (세입·세출 결산)" },
      { day: 31, cat: "복지", title: "맞춤형복지 연말 정산" },
      { day: 31, cat: "서무", title: "문서 정리 및 이관 준비" },
    ],
  }

  today = Date.today
  year = 2026

  # 주말·공휴일 마감일을 직전 평일로 조정
  months_tasks = {}
  months_tasks_raw.each do |m, tasks|
    months_tasks[m] = tasks.map do |t|
      d = Date.new(year, m, t[:day]) rescue nil
      if d && (d.wday == 0 || d.wday == 6 || holidays[[d.month, d.day]])
        wd = prev_workday.call(d)
        t.merge(day: wd.day, original_day: t[:day])
      else
        t
      end
    end
  end

  current_month = today.month
  current_day = today.day
  day_names_short = %w[월 화 수 목 금 토 일]

  # 오늘 업무 계산
  today_tasks = (months_tasks[current_month] || []).select { |t| t[:day] >= current_day }.sort_by { |t| t[:day] }
  today_exact = today_tasks.select { |t| t[:day] == current_day }

  # 이번 주 날짜 계산 (월~일)
  week_start = today - ((today.wday - 1) % 7)
  week_dates = (0..6).map { |i| week_start + i }
%>

<% content_for :hide_quick_menu, true %>

<div class="flex overflow-hidden bg-slate-50"
     data-user-signed-in="<%= user_signed_in? %>"
     id="calendar-root">
  <!-- 사이드바 -->
  <aside id="sidebar" class="bg-white border-r border-gray-200 flex-shrink-0 flex-col overflow-y-auto hidden lg:flex" style="width:19rem">
    <!-- 작업 추가 버튼 + 검색 -->
    <div class="p-3 pb-2 flex flex-col gap-3">
      <button id="btn-add-task" class="w-full flex items-center justify-center gap-1.5 h-10 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm shadow-md shadow-indigo-500/20 active:scale-[0.98] transition-all">
        <span class="material-symbols-outlined" style="font-size:18px">add_circle</span>
        업무 추가
      </button>
      <div class="relative group">
        <div class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none text-gray-400 group-focus-within:text-indigo-600 transition-colors">
          <span class="material-symbols-outlined" style="font-size:18px">search</span>
        </div>
        <input id="btn-search" type="text" readonly class="block w-full h-9 pl-9 pr-2 py-1.5 border-none bg-gray-50 rounded-lg text-xs text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all cursor-pointer" placeholder="검색...">
      </div>
    </div>

    <!-- 네비게이션 -->
    <nav class="flex-1 px-2 py-3 space-y-0.5 overflow-y-auto">
      <button class="nav-item relative w-full flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors" data-view="inbox">
        <div class="nav-indicator hidden absolute left-0 top-1/2 -translate-y-1/2 h-8 w-[3px] bg-indigo-600 rounded-r-full"></div>
        <span class="material-symbols-outlined" style="font-size:20px">inventory_2</span>
        <span class="flex-1 text-left">관리함</span>
        <span class="nav-count text-[10px] font-semibold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-full" data-count="inbox"></span>
      </button>
      <button class="nav-item relative w-full flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors" data-view="today">
        <div class="nav-indicator hidden absolute left-0 top-1/2 -translate-y-1/2 h-8 w-[3px] bg-indigo-600 rounded-r-full"></div>
        <span class="material-symbols-outlined" style="font-size:20px">calendar_today</span>
        <span class="flex-1 text-left">오늘</span>
        <span class="nav-count text-[10px] font-semibold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-full" data-count="today" id="today-count"></span>
      </button>
      <button class="nav-item relative w-full flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors" data-view="upcoming">
        <div class="nav-indicator hidden absolute left-0 top-1/2 -translate-y-1/2 h-8 w-[3px] bg-indigo-600 rounded-r-full"></div>
        <span class="material-symbols-outlined" style="font-size:20px">date_range</span>
        <span class="flex-1 text-left">주간</span>
        <span class="nav-count text-[10px] font-semibold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-full" id="week-count"></span>
      </button>
      <button class="nav-item relative w-full flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors" data-view="monthly">
        <div class="nav-indicator hidden absolute left-0 top-1/2 -translate-y-1/2 h-8 w-[3px] bg-indigo-600 rounded-r-full"></div>
        <span class="material-symbols-outlined" style="font-size:20px">calendar_month</span>
        <span class="flex-1 text-left">월간</span>
        <span class="nav-count text-[10px] font-semibold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-full" id="month-count"></span>
      </button>
    </nav>

    <!-- 상시 체크리스트 -->
    <div class="px-2 py-3 border-t border-gray-100">
      <div class="flex items-center justify-between mb-2 px-1">
        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">상시 체크리스트</p>
        <button id="btn-add-standing-item" class="text-gray-400 hover:text-indigo-600 transition-colors">
          <span class="material-symbols-outlined" style="font-size:18px">add</span>
        </button>
      </div>
      <div id="standing-checklist-container" class="space-y-1.5"></div>
    </div>

    <!-- 이번 달 진행률 -->
    <div class="px-3 py-3 border-t border-gray-100">
      <div class="flex items-end justify-between mb-2">
        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">진행률</p>
        <span id="progress-label" class="text-xs font-bold text-gray-800">0%</span>
      </div>
      <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
        <div id="progress-bar" class="h-1.5 bg-gradient-to-r from-indigo-600 to-emerald-400 rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>

    <!-- 범례 -->
    <div class="p-3 pt-3 border-t border-gray-100">
      <div class="flex items-center justify-between mb-2">
        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">분류</p>
        <button id="btn-edit-cats" class="text-gray-400 hover:text-indigo-600 transition-colors">
          <span class="material-symbols-outlined" style="font-size:18px">add</span>
        </button>
      </div>
      <div id="cat-list" class="flex flex-wrap gap-2"></div>
      <!-- 분류 추가 인라인 -->
      <div id="cat-add-row" class="hidden mt-3 flex items-center gap-1.5">
        <input type="text" id="cat-add-input" class="flex-1 min-w-0 px-2.5 py-1.5 text-xs rounded-lg border border-slate-200 outline-none focus:border-indigo-400 focus:ring-2 focus:ring-indigo-500/20" placeholder="새 분류명" maxlength="8">
        <input type="color" id="cat-add-color" value="#6366f1" class="w-7 h-7 rounded cursor-pointer border-0 p-0">
        <button id="cat-add-submit" class="w-7 h-7 rounded-lg bg-indigo-600 text-white flex items-center justify-center hover:bg-indigo-700 transition-colors flex-shrink-0">
          <span class="material-symbols-outlined" style="font-size:16px">check</span>
        </button>
      </div>
    </div>
  </aside>

  <!-- 메인 콘텐츠 -->
  <main class="flex-1 overflow-y-auto pb-16 lg:pb-0" id="main-content">

    <!-- 모바일 헤더 -->
    <div class="lg:hidden flex items-center gap-3 px-4 py-3 bg-white border-b border-slate-200 sticky top-0 z-20">
      <button id="btn-sidebar-toggle" class="w-9 h-9 rounded-lg hover:bg-slate-100 flex items-center justify-center">
        <span class="material-symbols-outlined">menu</span>
      </button>
      <h1 id="mobile-title" class="text-lg font-bold text-slate-900 flex-1"></h1>
      <button id="btn-add-task-mobile" class="w-9 h-9 rounded-lg bg-indigo-600 text-white flex items-center justify-center shadow-sm">
        <span class="material-symbols-outlined text-lg">add</span>
      </button>
    </div>

    <!-- ===== 관리함 뷰 ===== -->
    <div class="view-panel hidden" id="view-inbox">
      <div class="max-w-3xl mx-auto px-4 lg:px-8 py-8">
        <!-- 헤더 + 공유/가져오기 + 월 전환 -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <h1 class="text-2xl font-black text-slate-900">관리함</h1>
            <div class="flex items-center gap-1">
              <button id="btn-share" class="flex items-center gap-1 px-2.5 py-1.5 rounded-lg text-[11px] font-semibold text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all" title="내 업무를 내보냅니다">
                <span class="material-symbols-outlined" style="font-size:15px">upload</span>
                업무 내보내기
              </button>
              <button id="btn-import" class="flex items-center gap-1 px-2.5 py-1.5 rounded-lg text-[11px] font-semibold text-slate-500 hover:text-emerald-600 hover:bg-emerald-50 transition-all" title="공유받은 업무를 가져옵니다">
                <span class="material-symbols-outlined" style="font-size:15px">download</span>
                업무 가져오기
              </button>
            </div>
          </div>
          <div class="flex items-center gap-1 bg-white rounded-xl border border-slate-200 p-1 shadow-sm">
            <button id="inbox-prev" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center transition-colors">
              <span class="material-symbols-outlined text-slate-500" style="font-size:18px">chevron_left</span>
            </button>
            <span id="inbox-month-label" class="px-3 py-1 text-sm font-bold text-slate-700 min-w-[4rem] text-center"></span>
            <button id="inbox-next" class="w-8 h-8 rounded-lg hover:bg-slate-100 flex items-center justify-center transition-colors">
              <span class="material-symbols-outlined text-slate-500" style="font-size:18px">chevron_right</span>
            </button>
          </div>
        </div>

        <p class="text-[11px] text-slate-400 -mt-4 mb-5"><span class="text-indigo-400 font-medium">내보내기</span> 코드를 동료에게 전달하면 <span class="text-emerald-500 font-medium">가져오기</span>로 바로 반영됩니다.</p>

        <%# 관리함: 12개월 전체 업무 (월별 페이지) %>
        <% day_labels = %w[일 월 화 수 목 금 토] %>
        <% (1..12).each do |m| %>
          <div class="inbox-page divide-y divide-dashed divide-slate-200" data-inbox-month="<%= m %>" style="display:none">
            <% (months_tasks[m] || []).sort_by { |t| t[:day] }.each do |t| %>
              <% tc = cat_colors[t[:cat]] %>
              <%
                task_date = Date.new(year, m, t[:day]) rescue nil
                wday = task_date&.wday
                is_sun = wday == 0
                is_sat = wday == 6
                h_name = holidays[[m, t[:day]]]
                date_color = (is_sun || h_name) ? 'text-red-500' : is_sat ? 'text-blue-500' : 'text-slate-400'
              %>
              <div class="task-item group flex items-center gap-3 px-3 py-3 hover:bg-white hover:shadow-sm transition-all rounded-lg" data-task-key="<%= m %>_<%= t[:title] %>">
                <label class="flex-shrink-0 cursor-pointer">
                  <input type="checkbox" class="task-cb sr-only" data-key="<%= m %>_<%= t[:title] %>">
                  <span class="check-box w-[22px] h-[22px] rounded-full border-2 border-slate-300 flex items-center justify-center hover:border-indigo-400 transition-colors">
                    <svg class="w-3 h-3 text-white opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                  </span>
                </label>
                <div class="flex-1 min-w-0">
                  <p class="task-text text-sm text-slate-800"><%= t[:title] %></p>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-[11px] <%= date_color %> font-medium flex items-center gap-0.5">
                      <span class="material-symbols-outlined" style="font-size:13px">schedule</span>
                      <%= m %>/<%= t[:day] %>(<%= day_labels[wday] %>)
                    </span>
                    <% if h_name %>
                      <span class="text-[10px] text-red-400 font-medium"><%= h_name %></span>
                    <% end %>
                    <span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[10px] font-semibold <%= tc[:badge] %> <%= tc[:text] %>"><%= t[:cat] %></span>
                  </div>
                </div>
              </div>
            <% end %>
            <!-- 사용자 추가 업무 표시 영역 -->
            <div class="custom-tasks-area" data-month="<%= m %>"></div>
            <!-- 업무 추가 버튼 -->
            <div class="py-2">
              <button class="btn-inline-add flex items-center gap-2 px-3 py-2 text-sm text-slate-400 hover:text-indigo-600 transition-colors w-full rounded-lg hover:bg-indigo-50/50" data-date="" data-inbox-month="<%= m %>">
                <span class="material-symbols-outlined" style="font-size:18px">add</span>
                업무 추가
              </button>
            </div>
          </div>
        <% end %>

        <!-- 빈 상태 (모든 체크 시) -->
        <div id="inbox-empty" class="hidden py-16 text-center">
          <div class="w-20 h-20 mx-auto mb-4 bg-indigo-50 rounded-2xl flex items-center justify-center">
            <span class="material-symbols-outlined text-4xl text-indigo-300">check_circle</span>
          </div>
          <h3 class="text-lg font-bold text-slate-700 mb-2">모든 업무를 완료했습니다</h3>
          <p class="text-sm text-slate-400">이번 달 업무가 모두 처리되었습니다.</p>
        </div>
      </div>
    </div>

    <!-- ===== 오늘 뷰 ===== -->
    <div class="view-panel hidden" id="view-today">
      <div class="max-w-3xl mx-auto px-6 sm:px-10 pt-12 pb-8 flex flex-col">
        <%
          today_sun = today.wday == 0
          today_sat = today.wday == 6
          today_h = holidays[[today.month, today.day]]
          today_date_color = (today_sun || today_h) ? 'text-red-500' : today_sat ? 'text-blue-500' : 'text-slate-500'
        %>
        <h1 class="text-4xl font-black text-slate-900 tracking-tight mb-2">오늘</h1>
        <p class="text-lg font-medium tracking-tight <%= today_date_color %>">
          <%= today.strftime("%Y년 %-m월 %-d일") %> · <span class="<%= (today_sun || today_h) ? 'text-red-500 font-semibold' : today_sat ? 'text-blue-500 font-semibold' : '' %>"><%= %w[일요일 월요일 화요일 수요일 목요일 금요일 토요일][today.wday] %></span>
          <% if today_h %>
            <span class="font-semibold text-red-500 ml-1"><%= today_h %></span>
          <% end %>
        </p>

        <% if today_exact.any? %>
          <!-- 마감 인디케이터 -->
          <div class="mt-8 mb-4 flex items-center gap-2">
            <div class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
            </div>
            <h2 class="text-indigo-600 text-xs font-bold tracking-widest uppercase">오늘 마감</h2>
          </div>

          <!-- 업무 목록 -->
          <div>
              <% today_exact.each do |t| %>
                <% tc = cat_colors[t[:cat]] %>
                <div class="task-item group flex items-start gap-4 py-5 border-b-2 border-dotted border-slate-100 hover:bg-slate-50 transition-colors rounded-lg px-2 -mx-2">
                  <label class="flex-shrink-0 pt-0.5 cursor-pointer">
                    <input type="checkbox" class="task-cb sr-only" data-key="<%= current_month %>_<%= t[:title] %>">
                    <span class="check-box w-[22px] h-[22px] rounded-full border-2 border-slate-300 flex items-center justify-center hover:border-indigo-400 transition-colors">
                      <svg class="w-3 h-3 text-white opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                    </span>
                  </label>
                  <div class="flex flex-col flex-1 gap-1.5 min-w-0">
                    <p class="task-text text-sm font-semibold text-slate-800 leading-tight group-hover:text-slate-900 transition-colors"><%= t[:title] %></p>
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="material-symbols-outlined text-red-500" style="font-size:16px">schedule</span>
                      <span class="text-red-500 text-xs font-medium">오늘 마감</span>
                      <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium ring-1 ring-inset ring-slate-500/10 <%= tc[:badge] %> <%= tc[:text] %>"><%= t[:cat] %></span>
                    </div>
                  </div>
                </div>
              <% end %>
              <!-- 업무 추가 -->
              <div class="py-3">
                <button class="btn-inline-add flex items-center gap-2 px-2 py-2.5 text-sm text-slate-400 hover:text-indigo-600 transition-colors w-full rounded-lg hover:bg-indigo-50/50" data-date="<%= today.strftime('%Y-%m-%d') %>">
                  <span class="material-symbols-outlined" style="font-size:18px">add</span>
                  업무 추가
                </button>
              </div>
          </div>
        <% end %>

        <% if today_exact.empty? %>
          <!-- 빈 상태 -->
          <div class="mt-12">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest">완료</h3>
              <div class="h-px bg-slate-100 flex-grow ml-4"></div>
            </div>
            <div class="flex flex-col items-center justify-center py-12 px-4 text-center bg-slate-50 rounded-xl border border-dashed border-slate-200">
              <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4 text-3xl">🎉</div>
              <h3 class="text-slate-900 font-bold text-lg mb-1">오늘은 여유롭습니다</h3>
              <p class="text-slate-500 text-sm">마감 업무가 없습니다. 좋은 하루 보내세요!</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- ===== 주간 뷰 ===== -->
    <div class="view-panel hidden" id="view-upcoming">
      <div class="max-w-3xl mx-auto px-6 sm:px-10 pt-12 pb-8">
        <h1 class="text-4xl font-black text-slate-900 tracking-tight mb-6">주간</h1>

        <!-- 카드 컨테이너 -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
          <!-- 카드 헤더 -->
          <div class="p-5 border-b border-slate-200 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 bg-slate-50/50">
            <!-- 년월 클릭 → 달력 드롭다운 -->
            <div class="relative">
              <button id="upcoming-month-toggle" class="flex items-center gap-1.5 text-base font-bold text-slate-800 hover:text-indigo-600 transition-colors">
                <div class="bg-indigo-500/10 p-1.5 rounded-lg text-indigo-600">
                  <span class="material-symbols-outlined" style="font-size:20px">date_range</span>
                </div>
                <span id="upcoming-month-label"></span>
                <span class="material-symbols-outlined text-slate-400" style="font-size:16px">expand_more</span>
              </button>
              <!-- 미니 달력 드롭다운 -->
              <div id="upcoming-cal-dropdown" class="hidden absolute top-full left-0 mt-2 bg-white rounded-2xl shadow-xl border border-slate-200 p-4 z-30 w-[280px]">
                <div class="flex items-center justify-between mb-3">
                  <span id="cal-drop-title" class="text-sm font-bold text-slate-800"></span>
                  <div class="flex items-center gap-1">
                    <button id="cal-drop-prev" class="w-7 h-7 rounded-lg hover:bg-slate-100 flex items-center justify-center">
                      <span class="material-symbols-outlined text-slate-400" style="font-size:16px">chevron_left</span>
                    </button>
                    <button id="cal-drop-today" class="w-7 h-7 rounded-full hover:bg-slate-100 flex items-center justify-center" title="오늘">
                      <span class="material-symbols-outlined text-slate-400" style="font-size:16px">circle</span>
                    </button>
                    <button id="cal-drop-next" class="w-7 h-7 rounded-lg hover:bg-slate-100 flex items-center justify-center">
                      <span class="material-symbols-outlined text-slate-400" style="font-size:16px">chevron_right</span>
                    </button>
                  </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(7,1fr)" class="mb-1">
                  <% %w[월 화 수 목 금 토 일].each_with_index do |dn, i| %>
                    <div class="text-center text-[10px] font-semibold py-1 <%= i == 5 ? 'text-blue-500' : i == 6 ? 'text-red-500' : 'text-slate-400' %>"><%= dn %></div>
                  <% end %>
                </div>
                <div id="cal-drop-grid" style="display:grid;grid-template-columns:repeat(7,1fr)"></div>
              </div>
            </div>

            <!-- 주간 이동 -->
            <div class="flex items-center gap-1.5 bg-white rounded-xl border border-slate-200 p-1.5 shadow-sm">
              <button id="upcoming-prev" class="h-9 w-9 rounded-lg hover:bg-slate-100 flex items-center justify-center transition-colors">
                <span class="material-symbols-outlined text-slate-500" style="font-size:18px">chevron_left</span>
              </button>
              <button id="upcoming-today-btn" class="px-4 py-1.5 text-xs font-bold text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">오늘</button>
              <button id="upcoming-next" class="h-9 w-9 rounded-lg hover:bg-slate-100 flex items-center justify-center transition-colors">
                <span class="material-symbols-outlined text-slate-500" style="font-size:18px">chevron_right</span>
              </button>
            </div>
          </div>

          <!-- 주간 바 (가로 한 줄) -->
          <div id="week-bar" class="border-b border-slate-200 bg-white" style="display:grid;grid-template-columns:repeat(7,1fr)"></div>

          <!-- 주간 업무 타임라인 (JS 동적 렌더링) -->
          <div id="upcoming-timeline" class="divide-y divide-slate-100"></div>
        </div>
      </div>
    </div>

    <!-- ===== 월간 뷰 ===== -->
    <div class="view-panel hidden" id="view-monthly">
      <div class="max-w-[800px] mx-auto w-full py-8 px-4 sm:px-6">
        <!-- 헤더: 월/연도 + 네비게이션 -->
        <div class="flex items-center justify-between mb-8">
          <div class="relative">
            <button id="monthly-month-toggle" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
              <span id="monthly-month-label" class="text-xl font-bold text-slate-900"></span>
              <span class="material-symbols-outlined text-slate-400" style="font-size:20px">arrow_drop_down</span>
            </button>
            <!-- 월 선택 드롭다운 -->
            <div id="monthly-cal-dropdown" class="hidden absolute top-full left-0 mt-2 bg-white rounded-2xl shadow-xl border border-slate-200 p-4 z-30 w-[280px]">
              <div class="flex items-center justify-between mb-3">
                <button id="monthly-cal-prev-year" class="w-7 h-7 rounded-lg hover:bg-slate-100 flex items-center justify-center">
                  <span class="material-symbols-outlined text-slate-400" style="font-size:16px">chevron_left</span>
                </button>
                <span id="monthly-cal-year" class="text-sm font-bold text-slate-800"></span>
                <button id="monthly-cal-next-year" class="w-7 h-7 rounded-lg hover:bg-slate-100 flex items-center justify-center">
                  <span class="material-symbols-outlined text-slate-400" style="font-size:16px">chevron_right</span>
                </button>
              </div>
              <div id="monthly-cal-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px"></div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="monthly-prev" class="p-1.5 hover:bg-gray-100 rounded-full transition-colors text-slate-400">
              <span class="material-symbols-outlined" style="font-size:20px">chevron_left</span>
            </button>
            <button id="monthly-today-btn" class="px-4 py-1.5 bg-slate-100 text-sm font-medium rounded-lg hover:bg-slate-200 transition-colors">이번 달</button>
            <button id="monthly-next" class="p-1.5 hover:bg-gray-100 rounded-full transition-colors text-slate-400">
              <span class="material-symbols-outlined" style="font-size:20px">chevron_right</span>
            </button>
          </div>
        </div>

        <!-- 월간 타임라인 (JS 동적 렌더링) -->
        <div id="monthly-timeline"></div>
      </div>
    </div>
  </main>
</div>

<!-- 모바일 하단 탭 바 -->
<nav class="lg:hidden fixed bottom-0 left-0 right-0 z-30 bg-white border-t border-slate-200 px-6 pt-2" style="padding-bottom: max(1.5rem, env(safe-area-inset-bottom, 1.5rem))">
  <ul class="flex justify-between items-center">
    <li class="flex-1">
      <button class="mobile-tab-item w-full flex flex-col items-center justify-center gap-1 py-2 text-slate-400 hover:text-slate-600 transition-colors group" data-view="inbox">
        <span class="material-symbols-outlined group-hover:scale-110 transition-transform text-[26px]">inbox</span>
        <span class="tab-label text-[10px] font-medium tracking-tight">관리함</span>
        <span class="tab-dot hidden w-1 h-1 rounded-full bg-indigo-600"></span>
      </button>
    </li>
    <li class="flex-1">
      <button class="mobile-tab-item w-full flex flex-col items-center justify-center gap-1 py-2 text-slate-400 hover:text-slate-600 transition-colors group" data-view="today">
        <span class="material-symbols-outlined group-hover:scale-110 transition-transform text-[26px]">today</span>
        <span class="tab-label text-[10px] font-medium tracking-tight">오늘</span>
        <span class="tab-dot hidden w-1 h-1 rounded-full bg-indigo-600"></span>
      </button>
    </li>
    <li class="flex-1">
      <button class="mobile-tab-item w-full flex flex-col items-center justify-center gap-1 py-2 text-slate-400 hover:text-slate-600 transition-colors group" data-view="upcoming">
        <span class="material-symbols-outlined group-hover:scale-110 transition-transform text-[26px]">date_range</span>
        <span class="tab-label text-[10px] font-medium tracking-tight">주간</span>
        <span class="tab-dot hidden w-1 h-1 rounded-full bg-indigo-600"></span>
      </button>
    </li>
    <li class="flex-1">
      <button class="mobile-tab-item w-full flex flex-col items-center justify-center gap-1 py-2 text-slate-400 hover:text-slate-600 transition-colors group" data-view="monthly">
        <span class="material-symbols-outlined group-hover:scale-110 transition-transform text-[26px]">calendar_month</span>
        <span class="tab-label text-[10px] font-medium tracking-tight">월간</span>
        <span class="tab-dot hidden w-1 h-1 rounded-full bg-indigo-600"></span>
      </button>
    </li>
  </ul>
</nav>

<!-- 업무 추가 모달 -->
<div id="modal-add" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
  <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-[448px] mx-4 overflow-hidden flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
    <!-- 헤더 + 닫기 -->
    <div class="flex-none px-6 pt-5 pb-0">
      <button id="modal-close-x" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition-colors">
        <span class="material-symbols-outlined" style="font-size:24px">close</span>
      </button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">새 업무 추가</h2>
      <p class="text-sm text-gray-400 mb-4">새로운 업무를 등록하고 관리하세요.</p>
      <!-- 탭 바 -->
      <div class="flex border-b border-gray-200">
        <button type="button" class="modal-tab flex-1 pb-3 pt-2 text-sm font-bold text-center transition-colors border-b-[3px] border-indigo-600 text-gray-900" data-modal-tab="regular">정기업무</button>
        <button type="button" class="modal-tab flex-1 pb-3 pt-2 text-sm font-bold text-center transition-colors text-gray-400 border-b-[3px] border-transparent hover:text-gray-600" data-modal-tab="onetime">비정기업무</button>
        <button type="button" class="modal-tab flex-1 pb-3 pt-2 text-sm font-bold text-center transition-colors text-gray-400 border-b-[3px] border-transparent hover:text-gray-600" data-modal-tab="document">공문 업로드</button>
      </div>
    </div>

    <!-- 탭 1: 정기업무 -->
    <div id="tab-panel-regular" class="tab-panel flex-1 overflow-y-auto px-6 py-5 space-y-5">
      <div class="space-y-2">
        <label class="block text-sm font-bold text-gray-900">업무 내용</label>
        <textarea id="new-task-input" class="w-full resize-none rounded-xl border border-gray-200 bg-white text-sm text-gray-800 placeholder-gray-400 p-4 min-h-[100px] outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all" placeholder="할 일을 입력해주세요. (예: 월간 급여 대장 작성)"></textarea>
      </div>
      <div class="space-y-2">
        <label class="block text-sm font-bold text-gray-900">반복 설정</label>
        <select id="new-task-repeat" class="w-full h-11 rounded-xl border border-gray-200 bg-white text-sm font-medium text-gray-600 px-4 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all">
          <option value="monthly">매월 반복</option>
          <option value="weekly">매주 반복</option>
        </select>
      </div>
      <div id="repeat-monthly-opts" class="space-y-2">
        <label class="block text-sm font-bold text-gray-900">날짜 선택 <span class="text-xs font-normal text-gray-400 ml-1">(매월)</span></label>
        <select id="new-task-day" class="w-full h-11 rounded-xl border border-gray-200 bg-white text-sm font-medium text-gray-600 px-4 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all">
          <% (1..31).each do |d| %><option value="<%= d %>"><%= d %>일</option><% end %>
        </select>
      </div>
      <div id="repeat-weekly-opts" class="hidden space-y-2">
        <label class="block text-sm font-bold text-gray-900">요일 선택</label>
        <div class="flex gap-2">
          <% %w[월 화 수 목 금].each_with_index do |dn, i| %>
            <button type="button" class="weekday-btn flex-1 h-10 rounded-xl text-sm font-semibold border border-gray-200 text-gray-500 hover:border-indigo-400 hover:text-indigo-600 transition-colors" data-weekday="<%= i + 1 %>"><%= dn %></button>
          <% end %>
        </div>
      </div>
      <div class="space-y-2">
        <label class="block text-sm font-bold text-gray-900">카테고리</label>
        <div class="flex flex-wrap gap-2">
          <% cat_colors.each do |name, c| %>
            <button type="button" class="cat-select-btn px-3 py-1.5 rounded-full text-xs font-semibold border border-transparent transition-all <%= c[:badge] %> <%= c[:text] %>" data-cat="<%= name %>"><%= name %></button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- 탭 2: 비정기업무 -->
    <div id="tab-panel-onetime" class="tab-panel hidden flex-1 overflow-y-auto px-6 py-5 space-y-5">
      <div class="space-y-2">
        <label class="block text-sm font-bold text-gray-900">업무명</label>
        <input type="text" id="onetime-task-input" class="w-full h-12 rounded-xl border border-gray-200 bg-white text-sm text-gray-800 placeholder-gray-400 px-4 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all" placeholder="업무명을 입력해 주세요">
      </div>
      <div class="flex gap-4">
        <div class="flex-1 space-y-2">
          <label class="block text-sm font-bold text-gray-900">날짜</label>
          <div class="relative">
            <input type="date" id="onetime-date" class="w-full h-12 rounded-xl border border-gray-200 bg-white text-sm text-gray-800 px-4 pr-10 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all">
            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none" style="font-size:20px">calendar_today</span>
          </div>
        </div>
        <div class="flex-1 space-y-2">
          <label class="block text-sm font-bold text-gray-900">시간</label>
          <div class="relative">
            <input type="time" id="onetime-time" class="w-full h-12 rounded-xl border border-gray-200 bg-white text-sm text-gray-800 px-4 pr-10 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all">
            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none" style="font-size:20px">schedule</span>
          </div>
        </div>
      </div>
      <div class="space-y-2">
        <label class="block text-sm font-bold text-gray-900">카테고리</label>
        <div class="flex flex-wrap gap-2">
          <% cat_colors.each do |name, c| %>
            <button type="button" class="onetime-cat-btn flex h-8 items-center justify-center gap-1.5 rounded-full px-3 ring-1 ring-inset ring-gray-200 text-xs font-medium text-gray-500 transition-all hover:ring-indigo-300" data-cat="<%= name %>">
              <div class="w-1.5 h-1.5 rounded-full <%= c[:dot] %>"></div>
              <%= name %>
            </button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- 탭 3: 공문 업로드 -->
    <div id="tab-panel-document" class="tab-panel hidden flex-1 overflow-y-auto px-6 py-5 space-y-5">
      <div class="flex items-start gap-3 p-3 bg-indigo-50/50 rounded-lg border border-indigo-100">
        <span class="material-symbols-outlined text-indigo-500 text-xl shrink-0 mt-0.5">info</span>
        <p class="text-sm text-gray-500 leading-relaxed">공문 파일을 업로드하면 <span class="text-indigo-600 font-bold">AI가 자동으로 내용을 분석</span>하여 업무 정보를 입력해줍니다.</p>
      </div>
      <div id="doc-upload-zone" class="group relative flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-200 rounded-xl hover:border-indigo-400 hover:bg-indigo-50/30 transition-all cursor-pointer bg-gray-50/50">
        <div class="flex flex-col items-center text-center gap-2">
          <div class="size-10 rounded-full bg-white shadow-sm flex items-center justify-center text-indigo-400 mb-1">
            <span class="material-symbols-outlined text-2xl">cloud_upload</span>
          </div>
          <p class="text-sm font-semibold text-gray-700">클릭 또는 파일을 이곳에 드래그하세요</p>
          <p class="text-xs text-gray-400">PDF, HWP, HWPX 지원 (최대 10MB)</p>
        </div>
      </div>
      <input type="file" id="doc-file-input" accept=".pdf,.jpg,.jpeg,.png,.hwp,.hwpx" class="hidden">
      <div id="doc-file-info" class="hidden flex items-center gap-3 p-3 rounded-lg border border-gray-200 bg-white">
        <div class="size-10 flex items-center justify-center rounded-lg bg-red-50 text-red-500 shrink-0">
          <span class="material-symbols-outlined">picture_as_pdf</span>
        </div>
        <div class="flex flex-col flex-1 min-w-0">
          <span id="doc-file-name" class="text-sm font-medium text-gray-800 truncate"></span>
          <span id="doc-file-size" class="text-xs text-gray-400"></span>
        </div>
        <button id="doc-file-remove" class="size-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-red-500 transition-colors">
          <span class="material-symbols-outlined" style="font-size:18px">close</span>
        </button>
      </div>
      <div id="doc-analysis-status" class="hidden"></div>
      <button id="doc-btn-analyze" class="hidden w-full flex items-center justify-center gap-2 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm shadow-md shadow-indigo-500/20 transition-all">
        <span class="material-symbols-outlined" style="font-size:18px">auto_awesome</span>
        AI 분석 시작
      </button>
      <div id="doc-extracted-tasks" class="hidden max-h-48 overflow-y-auto"></div>
    </div>

    <!-- 하단 버튼 -->
    <div class="flex-none p-4 bg-gray-50/50 border-t border-gray-100 flex justify-end gap-3">
      <button id="modal-cancel" class="px-5 py-2.5 rounded-xl border border-gray-200 bg-white text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors">취소</button>
      <button id="modal-submit" class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 shadow-lg shadow-indigo-500/25 transition-colors flex items-center gap-2">
        <span class="material-symbols-outlined" style="font-size:18px">add</span>
        업무 추가
      </button>
    </div>
  </div>
</div>

<!-- 검색 모달 -->
<div id="modal-search" class="hidden fixed inset-0 z-50 flex items-start justify-center pt-[12vh] bg-black/20 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden border border-slate-200" onclick="event.stopPropagation()">
    <div class="flex items-center gap-3 px-4 py-3 border-b border-slate-100">
      <span class="material-symbols-outlined text-slate-400">search</span>
      <input type="text" id="search-input" class="flex-1 text-sm text-slate-800 placeholder-slate-400 outline-none" placeholder="업무를 검색하세요...">
      <kbd class="hidden sm:inline text-[10px] text-slate-400 border border-slate-200 rounded px-1.5 py-0.5 font-mono">ESC</kbd>
    </div>
    <div id="search-results" class="max-h-80 overflow-y-auto p-2">
      <p class="text-sm text-slate-400 text-center py-8">검색어를 입력하세요</p>
    </div>
  </div>
</div>

<!-- 가져오기 모달 -->
<div id="modal-import" class="hidden fixed inset-0 z-50 flex items-start justify-center pt-[12vh] bg-black/20 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-slate-200" onclick="event.stopPropagation()">
    <div class="flex items-center gap-3 px-4 py-3 border-b border-slate-100">
      <span class="material-symbols-outlined text-emerald-500">download</span>
      <h3 class="text-sm font-bold text-slate-800">공유받은 업무 가져오기</h3>
    </div>
    <div class="p-4">
      <p class="text-xs text-slate-500 mb-3">공유받은 코드를 아래에 붙여넣으세요.</p>
      <textarea id="import-textarea" class="w-full h-28 px-3 py-2.5 text-xs font-mono text-slate-700 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-200 resize-none" placeholder="SILMU_TASKS:..."></textarea>
      <div id="import-preview" class="hidden mt-3 max-h-40 overflow-y-auto"></div>
      <div id="import-error" class="hidden mt-2 text-xs text-red-500 font-medium"></div>
    </div>
    <div class="flex items-center justify-end gap-2 px-4 py-3 border-t border-slate-100 bg-slate-50/50">
      <button id="import-cancel" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">취소</button>
      <button id="import-submit" class="px-4 py-2 text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm transition-colors disabled:opacity-40 disabled:cursor-not-allowed" disabled>가져오기</button>
    </div>
  </div>
</div>

<!-- 로그인 유도 배너 (비로그인 사용자만) -->
<% unless user_signed_in? %>
<div id="sync-banner" class="fixed bottom-20 lg:bottom-6 left-1/2 -translate-x-1/2 z-40 hidden w-[calc(100%-2rem)] max-w-md">
  <div class="flex items-start gap-3 px-4 py-3 bg-white border border-indigo-200 rounded-xl shadow-lg">
    <span class="material-symbols-outlined text-indigo-500 flex-shrink-0 mt-0.5" style="font-size:20px">cloud_upload</span>
    <div class="flex-1 min-w-0">
      <p class="text-sm font-semibold text-slate-800">데이터를 안전하게 보관하세요</p>
      <p class="text-xs text-slate-500 mt-0.5">로그인하면 다른 기기에서도, 초기화해도 안전하게 보관됩니다.</p>
      <div class="flex items-center gap-2 mt-2">
        <%= link_to "로그인", new_user_session_path, class: "text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors" %>
        <span class="text-slate-300">|</span>
        <%= link_to "시작하기", new_user_registration_path, class: "text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition-colors" %>
      </div>
    </div>
    <button id="sync-banner-close" class="flex-shrink-0 w-6 h-6 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors">
      <span class="material-symbols-outlined text-slate-400" style="font-size:16px">close</span>
    </button>
  </div>
</div>
<% end %>

<!-- AI 프로세스 가이드 팝업 모달 -->
<style>
  @keyframes guide-shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(300%)} }
</style>
<div id="guide-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" style="transition:opacity 0.3s">
  <div id="guide-panel" class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[85vh] overflow-hidden" style="opacity:0;transform:scale(0.95);transition:opacity 0.2s ease-out,transform 0.2s ease-out" onclick="event.stopPropagation()">
    <!-- 헤더 -->
    <header class="flex-none px-6 py-5 border-b border-slate-100 bg-white z-10 rounded-t-2xl">
      <div class="flex items-start justify-between mb-3">
        <span id="guide-category" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold tracking-wide">
          <span class="material-symbols-outlined text-[16px]">work</span>
          <span id="guide-category-text"></span>
        </span>
        <button id="guide-close" class="text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full hover:bg-slate-100">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <h1 id="guide-title" class="text-xl font-bold text-slate-900 leading-tight"></h1>
      <p class="text-slate-500 text-sm mt-1">AI가 분석한 업무 처리 가이드입니다.</p>
    </header>
    <!-- 콘텐츠 영역 -->
    <div id="guide-body" class="flex-1 overflow-y-auto flex flex-col">
      <!-- 로딩 스켈레톤 -->
      <div id="guide-skeleton" class="p-6 space-y-8">
        <div class="space-y-2">
          <p class="text-indigo-600 text-sm font-medium animate-pulse">AI 가이드를 생성 중입니다...</p>
          <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
            <div class="h-full w-1/3 rounded-full" style="background-image:linear-gradient(90deg,transparent,rgba(99,102,241,0.4),transparent);animation:guide-shimmer 1.5s infinite linear"></div>
          </div>
        </div>
        <div class="space-y-6">
          <div class="flex gap-4">
            <div class="shrink-0 pt-1"><div class="size-8 rounded-full bg-gray-200 animate-pulse"></div></div>
            <div class="flex-1 space-y-2 pt-1.5">
              <div class="h-5 w-3/4 bg-gray-200 rounded animate-pulse"></div>
              <div class="h-3 w-1/2 bg-gray-100 rounded animate-pulse"></div>
            </div>
          </div>
          <div class="flex gap-4">
            <div class="shrink-0 pt-1"><div class="size-8 rounded-full bg-gray-200 animate-pulse"></div></div>
            <div class="flex-1 space-y-2 pt-1.5">
              <div class="h-5 w-2/3 bg-gray-200 rounded animate-pulse"></div>
              <div class="h-3 w-5/6 bg-gray-100 rounded animate-pulse"></div>
            </div>
          </div>
          <div class="flex gap-4">
            <div class="shrink-0 pt-1"><div class="size-8 rounded-full bg-gray-200 animate-pulse"></div></div>
            <div class="flex-1 space-y-2 pt-1.5">
              <div class="h-5 w-4/5 bg-gray-200 rounded animate-pulse"></div>
            </div>
          </div>
        </div>
        <div class="space-y-6 pt-4 border-t border-gray-100">
          <div class="h-6 w-32 bg-gray-200 rounded animate-pulse mb-4"></div>
          <div class="space-y-3">
            <div class="h-3 w-full bg-gray-100 rounded animate-pulse"></div>
            <div class="h-3 w-full bg-gray-100 rounded animate-pulse"></div>
            <div class="h-3 w-5/6 bg-gray-100 rounded animate-pulse"></div>
            <div class="h-3 w-4/5 bg-gray-100 rounded animate-pulse"></div>
          </div>
          <div class="p-4 rounded-lg bg-gray-50 border border-gray-100 mt-6">
            <div class="flex gap-3 mb-3">
              <div class="size-5 rounded bg-gray-200 animate-pulse"></div>
              <div class="h-5 w-40 bg-gray-200 rounded animate-pulse"></div>
            </div>
            <div class="space-y-2 pl-8">
              <div class="h-3 w-full bg-gray-200 rounded animate-pulse"></div>
              <div class="h-3 w-3/4 bg-gray-200 rounded animate-pulse"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- AI 가이드 콘텐츠 (성공) -->
      <div id="guide-content" class="hidden p-6 space-y-8"></div>
      <!-- 에러 상태 -->
      <div id="guide-error" class="hidden flex-1 flex flex-col items-center justify-center p-8 min-h-[300px]">
        <div class="flex flex-col items-center gap-6 w-full max-w-sm text-center">
          <div class="relative flex items-center justify-center">
            <div class="absolute w-24 h-24 bg-slate-100 rounded-full animate-pulse"></div>
            <span class="material-symbols-outlined text-slate-400 relative z-10" style="font-size:80px;font-variation-settings:'FILL' 0,'wght' 200,'GRAD' 0,'opsz' 48">error_outline</span>
          </div>
          <div class="flex flex-col gap-2">
            <h3 class="text-slate-900 text-lg font-bold leading-tight">가이드를 생성하는 중 오류가 발생했습니다</h3>
            <p id="guide-error-msg" class="text-slate-500 text-sm leading-relaxed">일시적인 시스템 문제일 수 있습니다.<br>잠시 후 다시 시도해 주세요.</p>
          </div>
          <button id="guide-retry" class="mt-4 flex items-center justify-center gap-2 h-10 px-6 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold tracking-wide transition-all shadow-md hover:shadow-lg min-w-[120px]">
            <span class="material-symbols-outlined text-[20px]">refresh</span>
            <span>다시 시도</span>
          </button>
        </div>
      </div>
    </div>
    <!-- 기본 푸터 (로딩/성공) -->
    <footer id="guide-footer-default" class="flex-none p-4 bg-slate-50 border-t border-slate-100 rounded-b-2xl">
      <div class="flex items-start gap-3">
        <div class="mt-0.5 p-1 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 text-white shadow-sm">
          <span class="material-symbols-outlined text-[14px] block">auto_awesome</span>
        </div>
        <div class="flex flex-col gap-1">
          <p class="text-xs font-semibold text-slate-700">AI 생성 콘텐츠</p>
          <p class="text-[10px] text-slate-400 leading-tight">AI가 분석한 결과입니다. 실제 업무 처리 시 관련 규정을 반드시 재확인하시기 바랍니다.</p>
        </div>
      </div>
    </footer>
    <!-- 에러 푸터 -->
    <footer id="guide-footer-error" class="hidden flex-none p-4 border-t border-slate-100 bg-gray-50 rounded-b-2xl">
      <button id="guide-footer-close" class="w-full flex items-center justify-center h-12 rounded-xl bg-white border border-slate-200 text-slate-700 text-sm font-bold hover:bg-slate-50 transition-colors shadow-sm">닫기</button>
    </footer>
  </div>
</div>

<!-- 토스트 알림 -->
<div id="toast" class="fixed bottom-24 lg:bottom-8 left-1/2 -translate-x-1/2 z-50 hidden">
  <div class="flex items-center gap-2 px-5 py-3 bg-slate-800 text-white text-sm font-medium rounded-xl shadow-2xl border border-white/10">
    <span id="toast-icon" class="material-symbols-outlined" style="font-size:18px">check_circle</span>
    <span id="toast-msg"></span>
  </div>
</div>

<script>
(function() {
  // --- 서버 동기화 ---
  const isSignedIn = document.getElementById("calendar-root").dataset.userSignedIn === "true";
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || "";

  let syncTimer = null;
  let syncPending = {};
  function syncToServer(fields) {
    if (!isSignedIn) return;
    Object.assign(syncPending, fields);
    clearTimeout(syncTimer);
    syncTimer = setTimeout(() => {
      const payload = syncPending;
      syncPending = {};
      fetch("/calendar_data", {
        method: "PATCH",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": csrfToken },
        body: JSON.stringify(payload)
      }).catch(() => {});
    }, 300);
  }

  async function loadFromServer() {
    if (!isSignedIn) return;
    try {
      const res = await fetch("/calendar_data", { headers: { "Accept": "application/json" } });
      if (!res.ok) return;
      const data = await res.json();
      const serverEmpty = Object.keys(data.task_states || {}).length === 0
                       && (data.custom_tasks || []).length === 0
                       && Object.keys(data.categories || {}).length === 0
                       && (data.standing_checklist || []).length === 0;
      if (serverEmpty) {
        // 서버 비어있으면 localStorage → 서버 업로드
        syncToServer({
          task_states: JSON.parse(localStorage.getItem("silmu_task_calendar_2026") || "{}"),
          custom_tasks: JSON.parse(localStorage.getItem("silmu_custom_tasks") || "[]"),
          categories: JSON.parse(localStorage.getItem("silmu_task_cats") || "{}"),
          standing_checklist: JSON.parse(localStorage.getItem("silmu_standing_checklist") || "[]")
        });
      } else {
        // 서버 데이터 우선 → localStorage 덮어쓰기
        if (Object.keys(data.task_states).length > 0) localStorage.setItem("silmu_task_calendar_2026", JSON.stringify(data.task_states));
        if (data.custom_tasks.length > 0) localStorage.setItem("silmu_custom_tasks", JSON.stringify(data.custom_tasks));
        if (Object.keys(data.categories).length > 0) localStorage.setItem("silmu_task_cats", JSON.stringify(data.categories));
        if ((data.standing_checklist || []).length > 0) localStorage.setItem("silmu_standing_checklist", JSON.stringify(data.standing_checklist));
      }
    } catch(e) {}
  }

  // --- 뷰 전환 ---
  const views = { inbox: "관리함", today: "오늘", upcoming: "주간", monthly: "월간" };
  let currentView = "today";

  function switchView(view) {
    currentView = view;
    document.querySelectorAll(".view-panel").forEach(p => p.classList.add("hidden"));
    document.getElementById("view-" + view).classList.remove("hidden");
    document.querySelectorAll(".nav-item").forEach(n => {
      const isActive = n.dataset.view === view;
      const indicator = n.querySelector(".nav-indicator");
      // 활성 상태: Stitch 디자인 — 인디고 배경 + 좌측 인디케이터
      n.classList.toggle("bg-indigo-50", isActive);
      n.classList.toggle("text-indigo-700", isActive);
      n.classList.toggle("font-bold", isActive);
      n.classList.toggle("text-gray-600", !isActive);
      n.classList.toggle("hover:bg-gray-50", !isActive);
      if (indicator) indicator.classList.toggle("hidden", !isActive);
      // 활성 카운트 배지 스타일
      const count = n.querySelector(".nav-count");
      if (count) {
        count.classList.toggle("text-indigo-600", isActive);
        count.classList.toggle("bg-white", isActive);
        count.classList.toggle("shadow-sm", isActive);
        count.classList.toggle("font-bold", isActive);
        count.classList.toggle("text-gray-400", !isActive);
        count.classList.toggle("bg-gray-100", !isActive);
        count.classList.toggle("font-semibold", !isActive);
      }
    });
    // 모바일 하단 탭 바 동기화
    document.querySelectorAll(".mobile-tab-item").forEach(t => {
      const isActive = t.dataset.view === view;
      t.classList.toggle("text-indigo-600", isActive);
      t.classList.toggle("text-slate-400", !isActive);
      t.classList.toggle("hover:text-slate-600", !isActive);
      const dot = t.querySelector(".tab-dot");
      if (dot) dot.classList.toggle("hidden", !isActive);
      const label = t.querySelector(".tab-label");
      if (label) {
        label.classList.toggle("font-bold", isActive);
        label.classList.toggle("font-medium", !isActive);
      }
    });
    document.getElementById("mobile-title").textContent = views[view];
    // 뷰 진입 시 타임라인 갱신
    if (view === "monthly" && typeof renderMonthlyTimeline === "function") renderMonthlyTimeline();
    if (view === "upcoming" && typeof renderWeekTimeline === "function") renderWeekTimeline();
    // 모바일 사이드바 닫기
    if (window.innerWidth < 1024) {
      sidebar.classList.add("hidden");
      sidebar.classList.remove("flex", "fixed", "inset-y-0", "left-0", "z-40", "shadow-2xl");
    }
  }

  // --- 사이드바 (switchView보다 먼저 선언 필요) ---
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("btn-sidebar-toggle");

  document.querySelectorAll(".nav-item").forEach(n => {
    n.addEventListener("click", () => switchView(n.dataset.view));
  });
  document.querySelectorAll(".mobile-tab-item").forEach(t => {
    t.addEventListener("click", () => switchView(t.dataset.view));
  });

  switchView("today");

  // --- 사이드바 토글 (모바일) ---
  toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("hidden");
    sidebar.classList.toggle("flex");
    sidebar.classList.toggle("fixed");
    sidebar.classList.toggle("inset-y-0");
    sidebar.classList.toggle("left-0");
    sidebar.classList.toggle("z-40");
    sidebar.classList.toggle("shadow-2xl");
  });

  // --- 체크박스 ---
  const STORAGE_KEY = "silmu_task_calendar_2026";
  function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch { return {}; } }
  function saveState(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); syncToServer({ task_states: s }); }
  const state = loadState();

  // 오늘 업무 키 목록 (미완료 카운트 계산용)
  const todayTaskKeys = [];
  <% today_exact.each do |t| %>
    todayTaskKeys.push("<%= j("#{current_month}_#{t[:title]}") %>");
  <% end %>

  function updateTodayCount() {
    const total = todayTaskKeys.length;
    const done = todayTaskKeys.filter(k => state[k]).length;
    const remaining = total - done;
    const el = document.getElementById("today-count");
    if (remaining === 0 && total > 0) {
      el.innerHTML = '<span class="text-emerald-500">' + total + '/' + total + '</span>';
    } else {
      el.innerHTML = '<span class="text-indigo-600 font-bold">' + remaining + '</span><span class="text-slate-300">/' + total + '</span>';
    }
  }

  function updateProgress() {
    if (typeof allTasks === "undefined" || !allTasks.length) return;
    const curMonth = <%= current_month %>;
    const monthTasks = allTasks.filter(t => t.month === curMonth);
    const total = monthTasks.length;
    if (total === 0) return;
    const done = monthTasks.filter(t => state[t.month + "_" + t.title]).length;
    const pct = Math.round((done / total) * 100);
    const bar = document.getElementById("progress-bar");
    const label = document.getElementById("progress-label");
    if (bar) bar.style.width = pct + "%";
    if (label) {
      label.textContent = done + "/" + total + " (" + pct + "%)";
      label.className = "text-[11px] font-bold " + (pct === 100 ? "text-emerald-500" : "text-indigo-600");
    }
  }

  document.querySelectorAll(".task-cb").forEach(cb => {
    const key = cb.dataset.key;
    if (state[key]) { cb.checked = true; applyCheck(cb, true); }
    cb.addEventListener("change", () => {
      state[key] = cb.checked;
      saveState(state);
      applyCheck(cb, cb.checked);
      updateTodayCount();
      updateProgress();
    });
  });
  updateTodayCount();

  function applyCheck(cb, checked) {
    const box = cb.nextElementSibling;
    const item = cb.closest(".task-item");
    const text = item.querySelector(".task-text");
    const svg = box.querySelector("svg");
    if (checked) {
      box.classList.add("bg-emerald-500", "border-emerald-500");
      box.classList.remove("border-slate-300");
      svg.style.opacity = "1";
      text.style.textDecoration = "line-through";
      text.style.textDecorationColor = "#94a3b8";
      text.style.textDecorationThickness = "1px";
      text.classList.add("text-slate-400");
      text.classList.remove("text-slate-800");
      setTimeout(() => { item.style.opacity = "0.6"; }, 200);
    } else {
      box.classList.remove("bg-emerald-500", "border-emerald-500");
      box.classList.add("border-slate-300");
      svg.style.opacity = "0";
      text.style.textDecoration = "";
      text.style.textDecorationColor = "";
      text.style.textDecorationThickness = "";
      text.classList.remove("text-slate-400");
      text.classList.add("text-slate-800");
      item.style.opacity = "";
    }
  }

  // --- 사용자 추가 업무 관리 ---
  const CUSTOM_KEY = "silmu_custom_tasks";
  function loadCustom() { try { return JSON.parse(localStorage.getItem(CUSTOM_KEY) || "[]"); } catch { return []; } }
  function saveCustom(arr) { localStorage.setItem(CUSTOM_KEY, JSON.stringify(arr)); syncToServer({ custom_tasks: arr }); checkSyncBanner(); }

  const catColorMap = {
    "급여":{bg:"#d1fae5",text:"#047857"},"세무":{bg:"#fef3c7",text:"#b45309"},
    "보험":{bg:"#dbeafe",text:"#1d4ed8"},"회계":{bg:"#ede9fe",text:"#6d28d9"},
    "보고":{bg:"#ffe4e6",text:"#be123c"},"서무":{bg:"#f1f5f9",text:"#475569"},
    "복지":{bg:"#cffafe",text:"#0e7490"},
  };
  const dayLabels = ["일","월","화","수","목","금","토"];

  function renderCustomTasks() {
    const customs = loadCustom();
    document.querySelectorAll(".custom-tasks-area").forEach(area => {
      area.innerHTML = "";
      const m = parseInt(area.dataset.month);
      customs.forEach((t, idx) => {
        let show = false;
        let label = "";
        let sublabel = "";
        if (t.repeat === "monthly" && t.day) {
          show = true;
          label = m + "/" + t.day;
          sublabel = "매월";
        } else if (t.repeat === "weekly" && t.weekday !== undefined) {
          show = true;
          label = "매주 " + dayLabels[t.weekday];
          sublabel = "매주";
        } else if (t.repeat === "once" && t.date) {
          const parts = t.date.split("-");
          const taskMonth = parseInt(parts[1]);
          const taskDay = parseInt(parts[2]);
          if (taskMonth === m) {
            show = true;
            label = m + "/" + taskDay;
            if (t.time) label += " " + t.time;
            sublabel = "일회성";
          }
        }
        if (!show) return;

        const cc = catColorMap[t.cat] || {bg:"#f1f5f9",text:"#475569"};
        const iconName = t.repeat === "once" ? "event" : "person";
        const iconColor = t.repeat === "once" ? "text-amber-400" : "text-indigo-400";
        const borderColor = t.repeat === "once" ? "border-amber-300" : "border-indigo-300";
        const row = document.createElement("div");
        row.className = "group flex items-center gap-3 px-3 py-3.5 hover:bg-white hover:shadow-sm transition-all border-t border-dashed border-slate-200";
        row.innerHTML =
          '<div class="flex-shrink-0 w-[22px] h-[22px] rounded-full border-2 ' + borderColor + ' flex items-center justify-center">' +
            '<span class="material-symbols-outlined ' + iconColor + '" style="font-size:12px">' + iconName + '</span></div>' +
          '<div class="flex-1 min-w-0">' +
            '<p class="text-sm text-slate-800">' + t.title + '</p>' +
            '<div class="flex items-center gap-2 mt-1">' +
              '<span class="text-[11px] text-slate-400 font-medium">' + label + '</span>' +
              '<span class="text-[11px] text-slate-300">' + sublabel + '</span>' +
              '<span class="px-1.5 py-0.5 rounded text-[10px] font-semibold" style="background:' + cc.bg + ';color:' + cc.text + '">' + (t.cat||"서무") + '</span>' +
            '</div>' +
          '</div>' +
          '<button class="del-custom-btn hidden group-hover:flex w-6 h-6 rounded-full hover:bg-red-50 items-center justify-center flex-shrink-0" data-idx="' + idx + '">' +
            '<span class="material-symbols-outlined text-red-400" style="font-size:16px">close</span></button>';
        area.appendChild(row);
      });
    });
    document.querySelectorAll(".del-custom-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const customs = loadCustom();
        customs.splice(parseInt(btn.dataset.idx), 1);
        saveCustom(customs);
        renderCustomTasks();
      });
    });
  }
  renderCustomTasks();

  // --- 모달: 업무 추가 (3탭) ---
  const modalAdd = document.getElementById("modal-add");
  const taskInput = document.getElementById("new-task-input");
  const repeatSelect = document.getElementById("new-task-repeat");
  const monthlyOpts = document.getElementById("repeat-monthly-opts");
  const weeklyOpts = document.getElementById("repeat-weekly-opts");
  let selectedCat = "서무";
  let selectedOnetimeCat = "서무";
  let selectedWeekday = null;
  let addFromInboxMonth = null;
  let activeModalTab = "regular";

  // 탭 전환
  document.querySelectorAll(".modal-tab").forEach(tab => {
    tab.addEventListener("click", () => {
      activeModalTab = tab.dataset.modalTab;
      document.querySelectorAll(".modal-tab").forEach(t => {
        const isActive = t.dataset.modalTab === activeModalTab;
        t.classList.toggle("border-indigo-600", isActive);
        t.classList.toggle("text-gray-900", isActive);
        t.classList.toggle("text-gray-400", !isActive);
        t.classList.toggle("border-transparent", !isActive);
      });
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.add("hidden"));
      document.getElementById("tab-panel-" + activeModalTab).classList.remove("hidden");
      const submitBtn = document.getElementById("modal-submit");
      submitBtn.innerHTML = activeModalTab === "document"
        ? "선택한 업무 추가"
        : '<span class="material-symbols-outlined" style="font-size:18px">add</span> 업무 추가';
      submitBtn.classList.toggle("hidden", false);
    });
  });

  // 반복 유형 전환
  repeatSelect.addEventListener("change", () => {
    const isWeekly = repeatSelect.value === "weekly";
    monthlyOpts.classList.toggle("hidden", isWeekly);
    weeklyOpts.classList.toggle("hidden", !isWeekly);
  });

  // 요일 선택
  document.querySelectorAll(".weekday-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".weekday-btn").forEach(b => {
        b.classList.remove("bg-indigo-600", "text-white", "border-indigo-600");
        b.classList.add("border-slate-200", "text-slate-500");
      });
      btn.classList.add("bg-indigo-600", "text-white", "border-indigo-600");
      btn.classList.remove("border-slate-200", "text-slate-500");
      selectedWeekday = parseInt(btn.dataset.weekday);
    });
  });

  // 분류 선택 (정기업무)
  document.querySelectorAll(".cat-select-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".cat-select-btn").forEach(b => b.classList.remove("ring-2", "ring-indigo-400"));
      btn.classList.add("ring-2", "ring-indigo-400");
      selectedCat = btn.dataset.cat;
    });
  });

  // 분류 선택 (비정기업무)
  document.querySelectorAll(".onetime-cat-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".onetime-cat-btn").forEach(b => b.classList.remove("ring-2", "ring-indigo-400"));
      btn.classList.add("ring-2", "ring-indigo-400");
      selectedOnetimeCat = btn.dataset.cat;
    });
  });

  // 비정기 날짜 기본값 = 오늘
  document.getElementById("onetime-date").valueAsDate = new Date();

  function openAddModal(dateStr, inboxMonth) {
    addFromInboxMonth = inboxMonth || null;
    modalAdd.classList.remove("hidden");
    // 날짜가 지정된 경우 비정기 탭으로
    if (dateStr) {
      document.querySelector('.modal-tab[data-modal-tab="onetime"]').click();
      document.getElementById("onetime-date").value = dateStr;
      document.getElementById("onetime-task-input").value = "";
      setTimeout(() => document.getElementById("onetime-task-input").focus(), 100);
    } else {
      document.querySelector('.modal-tab[data-modal-tab="regular"]').click();
      taskInput.value = "";
      setTimeout(() => taskInput.focus(), 100);
    }
  }

  ["btn-add-task", "btn-add-task-mobile"].forEach(id => {
    document.getElementById(id).addEventListener("click", () => openAddModal(null, null));
  });

  document.querySelectorAll(".btn-inline-add").forEach(btn => {
    btn.addEventListener("click", () => openAddModal(btn.dataset.date, btn.dataset.inboxMonth));
  });

  document.getElementById("modal-cancel").addEventListener("click", () => modalAdd.classList.add("hidden"));
  document.getElementById("modal-close-x").addEventListener("click", () => modalAdd.classList.add("hidden"));
  modalAdd.addEventListener("click", () => modalAdd.classList.add("hidden"));

  // 제출 (3탭 분기)
  document.getElementById("modal-submit").addEventListener("click", () => {
    if (activeModalTab === "regular") {
      const val = taskInput.value.trim();
      if (!val) return;
      const customs = loadCustom();
      const rep = repeatSelect.value;
      if (rep === "monthly") {
        customs.push({ title: val, repeat: "monthly", day: parseInt(document.getElementById("new-task-day").value), cat: selectedCat });
      } else {
        if (selectedWeekday === null) { alert("요일을 선택하세요"); return; }
        customs.push({ title: val, repeat: "weekly", weekday: selectedWeekday, cat: selectedCat });
      }
      saveCustom(customs);
      taskInput.value = "";
      modalAdd.classList.add("hidden");
      renderCustomTasks();

    } else if (activeModalTab === "onetime") {
      const val = document.getElementById("onetime-task-input").value.trim();
      const dateVal = document.getElementById("onetime-date").value;
      const timeVal = document.getElementById("onetime-time").value || null;
      if (!val) { alert("업무 내용을 입력하세요"); return; }
      if (!dateVal) { alert("날짜를 선택하세요"); return; }
      const customs = loadCustom();
      customs.push({ title: val, repeat: "once", date: dateVal, time: timeVal, cat: selectedOnetimeCat });
      saveCustom(customs);
      modalAdd.classList.add("hidden");
      renderCustomTasks();
      showToast("비정기 업무가 추가되었습니다", "check_circle");

    } else if (activeModalTab === "document") {
      const cbs = document.querySelectorAll("#doc-extracted-tasks input[type=checkbox].doc-task-cb:checked");
      if (!cbs.length) { alert("추가할 업무를 선택하세요"); return; }
      const customs = loadCustom();
      cbs.forEach(cb => { customs.push(JSON.parse(cb.dataset.task)); });
      saveCustom(customs);
      modalAdd.classList.add("hidden");
      renderCustomTasks();
      showToast(cbs.length + "개 업무가 추가되었습니다", "check_circle");
    }
  });

  // --- 공문 업로드 ---
  let docUploadedFile = null;
  const docUploadZone = document.getElementById("doc-upload-zone");
  const docFileInput = document.getElementById("doc-file-input");

  docUploadZone.addEventListener("click", () => docFileInput.click());
  docUploadZone.addEventListener("dragover", (e) => { e.preventDefault(); docUploadZone.classList.add("border-indigo-400", "bg-indigo-50"); });
  docUploadZone.addEventListener("dragleave", (e) => { e.preventDefault(); docUploadZone.classList.remove("border-indigo-400", "bg-indigo-50"); });
  docUploadZone.addEventListener("drop", (e) => {
    e.preventDefault(); docUploadZone.classList.remove("border-indigo-400", "bg-indigo-50");
    if (e.dataTransfer.files.length > 0) docProcessFile(e.dataTransfer.files[0]);
  });
  docFileInput.addEventListener("change", (e) => { if (e.target.files.length > 0) docProcessFile(e.target.files[0]); });

  function docProcessFile(file) {
    const allowed = ["application/pdf", "image/jpeg", "image/png"];
    if (!allowed.includes(file.type)) { alert("PDF, JPG, PNG 파일만 업로드 가능합니다."); return; }
    if (file.size > 20 * 1024 * 1024) { alert("파일 크기는 20MB 이하여야 합니다."); return; }
    docUploadedFile = file;
    document.getElementById("doc-file-name").textContent = file.name;
    document.getElementById("doc-file-size").textContent = (file.size / (1024 * 1024)).toFixed(1) + "MB";
    document.getElementById("doc-file-info").classList.remove("hidden");
    docUploadZone.classList.add("hidden");
    document.getElementById("doc-btn-analyze").classList.remove("hidden");
    document.getElementById("doc-analysis-status").classList.add("hidden");
    document.getElementById("doc-extracted-tasks").classList.add("hidden");
  }

  document.getElementById("doc-file-remove").addEventListener("click", () => {
    docUploadedFile = null; docFileInput.value = "";
    document.getElementById("doc-file-info").classList.add("hidden");
    docUploadZone.classList.remove("hidden");
    document.getElementById("doc-btn-analyze").classList.add("hidden");
    document.getElementById("doc-analysis-status").classList.add("hidden");
    document.getElementById("doc-extracted-tasks").classList.add("hidden");
  });

  document.getElementById("doc-btn-analyze").addEventListener("click", () => {
    if (!docUploadedFile) return;
    const btn = document.getElementById("doc-btn-analyze");
    btn.disabled = true;
    btn.innerHTML = '<span class="material-symbols-outlined animate-spin" style="font-size:18px">progress_activity</span> AI 분석 중...';
    const statusEl = document.getElementById("doc-analysis-status");
    statusEl.classList.remove("hidden");
    statusEl.innerHTML = '<div class="flex items-center gap-2 px-3 py-2 bg-indigo-50 rounded-lg">' +
      '<span class="material-symbols-outlined text-indigo-500 animate-spin" style="font-size:16px">progress_activity</span>' +
      '<span class="text-xs text-indigo-600 font-medium">AI가 공문을 분석하고 있습니다... (10~30초 소요)</span></div>';

    const formData = new FormData();
    formData.append("file", docUploadedFile);
    formData.append("document_type", "task_extraction");

    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    const headers = {};
    if (csrfToken) headers["X-CSRF-Token"] = csrfToken.content;

    fetch("/document-analysis/analyze", { method: "POST", headers: headers, body: formData })
    .then(r => r.json())
    .then(result => {
      btn.disabled = false;
      btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:18px">auto_awesome</span> AI 분석 시작';
      if (result.success && result.fields && result.fields.tasks && result.fields.tasks.length) {
        const tasks = result.fields.tasks;
        const docTitle = result.fields.document_title || "공문";
        statusEl.innerHTML = '<div class="flex items-center gap-2 px-3 py-2 bg-emerald-50 rounded-lg">' +
          '<span class="material-symbols-outlined text-emerald-500" style="font-size:16px">check_circle</span>' +
          '<span class="text-xs text-emerald-600 font-medium">"' + docTitle + '"에서 ' + tasks.length + '건 추출</span></div>';

        const container = document.getElementById("doc-extracted-tasks");
        container.classList.remove("hidden");
        let html = '<label class="flex items-center gap-2 px-2 py-1.5 text-[11px] text-indigo-600 font-medium cursor-pointer hover:bg-indigo-50 rounded mb-1">' +
          '<input type="checkbox" id="doc-select-all" checked> 전체 선택</label>';
        tasks.forEach(task => {
          const cc = catColorMap[task.cat] || {bg:"#f1f5f9",text:"#475569"};
          const taskObj = { title: task.title, repeat: "once", date: task.date, time: task.time || null, cat: task.cat || "서무" };
          const escaped = JSON.stringify(taskObj).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
          html += '<label class="flex items-center gap-2.5 px-2 py-2 hover:bg-slate-50 rounded cursor-pointer">' +
            '<input type="checkbox" class="doc-task-cb" checked data-task="' + escaped + '">' +
            '<div class="flex-1 min-w-0">' +
              '<p class="text-xs text-slate-700">' + task.title + '</p>' +
              '<div class="flex items-center gap-2 mt-0.5">' +
                '<span class="text-[10px] text-slate-400">' + task.date + (task.time ? " " + task.time : "") + '</span>' +
                '<span class="px-1 py-0.5 rounded text-[9px] font-semibold" style="background:' + cc.bg + ';color:' + cc.text + '">' + (task.cat || "서무") + '</span>' +
              '</div></div></label>';
        });
        container.innerHTML = html;
        document.getElementById("doc-select-all").addEventListener("change", (e) => {
          document.querySelectorAll(".doc-task-cb").forEach(cb => cb.checked = e.target.checked);
        });
      } else {
        statusEl.innerHTML = '<div class="flex items-center gap-2 px-3 py-2 bg-red-50 rounded-lg">' +
          '<span class="material-symbols-outlined text-red-500" style="font-size:16px">error</span>' +
          '<span class="text-xs text-red-600 font-medium">' + (result.error || "업무를 추출할 수 없습니다.") + '</span></div>';
      }
    })
    .catch(() => {
      btn.disabled = false;
      btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:18px">auto_awesome</span> AI 분석 시작';
      statusEl.innerHTML = '<div class="flex items-center gap-2 px-3 py-2 bg-red-50 rounded-lg">' +
        '<span class="material-symbols-outlined text-red-500" style="font-size:16px">error</span>' +
        '<span class="text-xs text-red-600 font-medium">서버 연결에 실패했습니다. 다시 시도해주세요.</span></div>';
    });
  });

  // --- 모달: 검색 ---
  const modalSearch = document.getElementById("modal-search");
  const searchInput = document.getElementById("search-input");
  const searchResults = document.getElementById("search-results");
  document.getElementById("btn-search").addEventListener("click", () => {
    modalSearch.classList.remove("hidden");
    setTimeout(() => searchInput.focus(), 100);
  });
  modalSearch.addEventListener("click", () => modalSearch.classList.add("hidden"));

  // 검색 데이터
  const allTasks = [];
  <% months_tasks.each do |m, tasks| %>
    <% tasks.each do |t| %>
      allTasks.push({ month: <%= m %>, day: <%= t[:day] %>, cat: "<%= t[:cat] %>", title: "<%= j(t[:title]) %>" });
    <% end %>
  <% end %>
  updateProgress();

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim().toLowerCase();
    if (!q) {
      searchResults.innerHTML = '<p class="text-sm text-slate-400 text-center py-8">검색어를 입력하세요</p>';
      return;
    }
    const matched = allTasks.filter(t => t.title.toLowerCase().includes(q) || t.cat.includes(q));
    if (!matched.length) {
      searchResults.innerHTML = '<p class="text-sm text-slate-400 text-center py-8">결과 없음</p>';
      return;
    }
    searchResults.innerHTML = matched.map(t =>
      '<div class="flex items-center gap-3 px-3 py-2.5 rounded-xl hover:bg-slate-50 cursor-default">' +
        '<span class="material-symbols-outlined text-slate-300" style="font-size:18px">task_alt</span>' +
        '<div class="flex-1"><p class="text-sm text-slate-700">' + t.title + '</p>' +
        '<span class="text-[11px] text-slate-400">' + t.month + '/' + t.day + ' · ' + t.cat + '</span></div></div>'
    ).join("");
  });

  // ESC 닫기
  document.addEventListener("keydown", e => {
    if (e.key === "Escape") {
      modalAdd.classList.add("hidden");
      modalSearch.classList.add("hidden");
      document.getElementById("modal-import").classList.add("hidden");
    }
  });

  // --- 관리함: 월별 페이지네이션 ---
  let inboxMonth = <%= current_month %>;
  const inboxLabel = document.getElementById("inbox-month-label");

  function showInboxMonth(m) {
    inboxMonth = m;
    document.querySelectorAll(".inbox-page").forEach(p => p.style.display = "none");
    const page = document.querySelector('[data-inbox-month="' + m + '"]');
    if (page) page.style.display = "";
    inboxLabel.textContent = m + "월";
    // 새 페이지의 체크박스 상태 복원
    if (page) {
      page.querySelectorAll(".task-cb").forEach(cb => {
        const key = cb.dataset.key;
        if (state[key]) { cb.checked = true; applyCheck(cb, true); }
      });
    }
  }
  document.getElementById("inbox-prev").addEventListener("click", () => {
    showInboxMonth(inboxMonth <= 1 ? 12 : inboxMonth - 1);
  });
  document.getElementById("inbox-next").addEventListener("click", () => {
    showInboxMonth(inboxMonth >= 12 ? 1 : inboxMonth + 1);
  });
  showInboxMonth(inboxMonth);

  // --- 주간 뷰: 주간 바 + 달력 드롭다운 ---
  const dayNamesShort = ["월","화","수","목","금","토","일"];
  const todayDate = new Date(<%= today.year %>, <%= today.month - 1 %>, <%= today.day %>);
  let weekStart = new Date(todayDate);
  weekStart.setDate(weekStart.getDate() - ((weekStart.getDay() + 6) % 7)); // 월요일 기준

  // 공휴일 데이터 (월은 0-indexed)
  const holidayMap = {
    "0-1":"신정",
    "1-16":"설연휴","1-17":"설날","1-18":"설연휴",
    "2-1":"삼일절","2-2":"대체공휴일",
    "4-5":"어린이날","4-24":"부처님오신날","4-25":"대체공휴일",
    "5-6":"현충일",
    "7-15":"광복절","7-17":"대체공휴일",
    "8-24":"추석연휴","8-25":"추석","8-26":"추석연휴",
    "9-3":"개천절","9-5":"대체공휴일","9-9":"한글날",
    "11-25":"성탄절",
  };

  let selectedWeekDate = null; // 선택된 날짜 (null이면 전체 주간)

  function renderWeekBar() {
    const bar = document.getElementById("week-bar");
    bar.innerHTML = "";
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart);
      d.setDate(d.getDate() + i);
      const isToday = d.toDateString() === todayDate.toDateString();
      const dow = d.getDay();
      const hKey = d.getMonth() + "-" + d.getDate();
      const hName = holidayMap[hKey] || null;
      const isSun = dow === 0;
      const isSat = dow === 6;

      let dayColor, numColor;
      if (isSun || hName) {
        dayColor = "text-red-400"; numColor = "text-red-500";
      } else if (isSat) {
        dayColor = "text-blue-400"; numColor = "text-blue-500";
      } else if (isToday) {
        dayColor = "text-indigo-600"; numColor = "text-indigo-600";
      } else {
        dayColor = "text-slate-400"; numColor = "text-slate-700";
      }

      const cell = document.createElement("div");
      const dateStr = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
      const isSelected = selectedWeekDate === dateStr;
      cell.className = "text-center py-2.5 cursor-pointer rounded-lg transition-colors hover:bg-slate-100 " + (isSelected ? "border-b-2 border-indigo-600" : "");
      cell.dataset.date = dateStr;
      let numHtml;
      if (isToday) {
        numHtml = '<span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-bold">' + d.getDate() + '</span>';
      } else {
        numHtml = '<span class="text-sm font-bold ' + numColor + '">' + d.getDate() + '</span>';
      }
      let html = '<span class="text-xs font-medium ' + dayColor + '">' + dayNamesShort[i] + '</span> ' + numHtml;
      if (hName) {
        html += '<div class="text-[8px] text-red-400 font-medium leading-none mt-0.5">' + hName + '</div>';
      }
      cell.innerHTML = html;
      cell.addEventListener("click", () => {
        if (selectedWeekDate === dateStr) {
          selectedWeekDate = null; // 같은 날짜 다시 클릭하면 전체 주간
        } else {
          selectedWeekDate = dateStr;
        }
        renderWeekBar();
        renderWeekTimeline();
      });
      bar.appendChild(cell);
    }
    const mid = new Date(weekStart);
    mid.setDate(mid.getDate() + 3);
    document.getElementById("upcoming-month-label").textContent = (mid.getMonth() + 1) + "월 " + mid.getFullYear();
  }

  const dayNamesKo = ["일","월","화","수","목","금","토"];

  function renderWeekTimeline() {
    const timeline = document.getElementById("upcoming-timeline");
    let html = "";
    for (let i = 0; i < 7; i++) {
      const d = new Date(weekStart);
      d.setDate(d.getDate() + i);
      const m = d.getMonth() + 1;
      const dd = d.getDate();
      const dow = d.getDay();
      const dateStr = d.getFullYear() + "-" + String(m).padStart(2,"0") + "-" + String(dd).padStart(2,"0");

      // 선택된 날짜가 있으면 해당 날짜만 표시
      if (selectedWeekDate && selectedWeekDate !== dateStr) continue;
      const hKey = d.getMonth() + "-" + dd;
      const hName = holidayMap[hKey] || null;
      const isToday = d.toDateString() === todayDate.toDateString();
      const isSun = dow === 0;
      const isSat = dow === 6;

      // 날짜/요일 색상
      let dateColor, dayColor;
      if (isSun || hName) { dateColor = "text-red-600 font-bold"; dayColor = "text-red-600 font-medium"; }
      else if (isSat) { dateColor = "text-blue-600 font-bold"; dayColor = "text-blue-600 font-medium"; }
      else if (isToday) { dateColor = "text-indigo-600 font-bold"; dayColor = "text-indigo-600 font-medium"; }
      else { dateColor = "text-slate-900 font-medium"; dayColor = "text-slate-500"; }

      // 행 배경 (주말 틴트)
      let rowBg = "hover:bg-slate-50";
      if (isSun || hName) rowBg = "bg-red-50/30 hover:bg-red-50/50";
      else if (isSat) rowBg = "bg-blue-50/30 hover:bg-blue-50/50";

      // 해당 날짜 업무 필터
      const tasks = allTasks.filter(t => t.month === m && t.day === dd);

      // 날짜 라벨
      let dayLabel = dayNamesKo[dow];
      let extraLabel = "";
      if (isToday) extraLabel = " · 오늘";
      else {
        const tmr = new Date(todayDate);
        tmr.setDate(tmr.getDate() + 1);
        if (d.toDateString() === tmr.toDateString()) extraLabel = " · 내일";
      }

      // 날짜 그룹 컨테이너
      html += '<div class="upcoming-date-group ' + rowBg + ' transition-colors" data-upcoming-date="' + dateStr + '">';

      if (tasks.length === 0) {
        // 빈 날짜 — 한 줄 그리드
        html += '<div class="grid grid-cols-12 gap-4 px-6 py-4 items-center group">' +
          '<div class="col-span-2 sm:col-span-1 font-mono ' + dateColor + '">' + String(dd).padStart(2,"0") + '</div>' +
          '<div class="col-span-2 sm:col-span-1 text-sm ' + dayColor + '">' + dayLabel + '</div>' +
          '<div class="col-span-6 sm:col-span-8"><span class="text-slate-400 italic text-sm">업무 없음' +
            (hName ? ' · <span class="text-red-400 not-italic font-medium">' + hName + '</span>' : '') + '</span></div>' +
          '<div class="col-span-2 flex justify-end opacity-0 group-hover:opacity-100 transition-opacity">' +
            '<button class="btn-inline-add text-slate-400 hover:text-indigo-600" data-date="' + dateStr + '">' +
              '<span class="material-symbols-outlined" style="font-size:20px">add</span></button></div>' +
          '</div>';
      } else {
        tasks.forEach((t, idx) => {
          const cc = catColorMap[t.cat] || {bg:"#f1f5f9",text:"#475569"};
          const key = m + "_" + t.title;
          const isFirst = idx === 0;
          const border = idx > 0 ? ' border-t border-dashed border-slate-200' : '';

          html += '<div class="task-item grid grid-cols-12 gap-4 px-6 py-4 items-center group' + border + '">' +
            // 날짜 (첫 번째 행만 표시)
            '<div class="col-span-2 sm:col-span-1 font-mono ' + dateColor + '">' + (isFirst ? String(dd).padStart(2,"0") : '') + '</div>' +
            // 요일 (첫 번째 행만)
            '<div class="col-span-2 sm:col-span-1 text-sm ' + dayColor + '">' + (isFirst ? dayLabel + (hName ? '<div class="text-[10px] text-red-400">' + hName + '</div>' : '') + extraLabel : '') + '</div>' +
            // 업무 내용
            '<div class="col-span-6 sm:col-span-8">' +
              '<div class="flex items-start gap-4">' +
                '<label class="flex-shrink-0 pt-0.5 cursor-pointer">' +
                  '<input type="checkbox" class="task-cb sr-only" data-key="' + key + '">' +
                  '<span class="check-box w-[22px] h-[22px] rounded-full border-2 border-slate-300 flex items-center justify-center hover:border-indigo-400 transition-colors">' +
                    '<svg class="w-3 h-3 text-white opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' +
                  '</span>' +
                '</label>' +
                '<div class="flex flex-col flex-1 gap-1">' +
                  '<p class="task-text text-sm font-semibold text-slate-800 leading-tight">' + t.title + '</p>' +
                  '<span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium ring-1 ring-inset ring-slate-500/10 w-fit" style="background:' + cc.bg + ';color:' + cc.text + '">' + t.cat + '</span>' +
                '</div>' +
              '</div>' +
            '</div>' +
            // 액션
            '<div class="col-span-2 flex justify-end opacity-0 group-hover:opacity-100 transition-opacity"></div>' +
            '</div>';
        });
        // 인라인 추가 버튼
        html += '<div class="px-6 py-2">' +
          '<button class="btn-inline-add flex items-center justify-center gap-2 w-full py-2.5 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-slate-50 transition-all text-sm font-medium" data-date="' + dateStr + '">' +
            '<span class="material-symbols-outlined" style="font-size:18px">add_circle</span> 업무 추가</button></div>';
      }
      html += '</div>';
    }
    timeline.innerHTML = html;

    // 체크박스 상태 복원 + 이벤트 바인딩
    timeline.querySelectorAll(".task-cb").forEach(cb => {
      const key = cb.dataset.key;
      if (state[key]) { cb.checked = true; applyCheck(cb, true); }
      cb.addEventListener("change", () => {
        state[key] = cb.checked;
        saveState(state);
        applyCheck(cb, cb.checked);
        updateTodayCount();
        updateProgress();
        updateWeekCount();
      });
    });

    // 인라인 추가 버튼 이벤트
    timeline.querySelectorAll(".btn-inline-add").forEach(btn => {
      btn.addEventListener("click", () => openAddModal(btn.dataset.date, null));
    });

    updateWeekCount();
  }

  function updateWeekCount() {
    const cbs = document.querySelectorAll("#upcoming-timeline .task-cb");
    const total = cbs.length;
    const done = Array.from(cbs).filter(cb => cb.checked).length;
    const remaining = total - done;
    const el = document.getElementById("week-count");
    if (total === 0) {
      el.innerHTML = '';
    } else if (remaining === 0) {
      el.innerHTML = '<span class="text-emerald-500">' + total + '/' + total + '</span>';
    } else {
      el.innerHTML = '<span class="text-indigo-600 font-bold">' + remaining + '</span><span class="text-slate-300">/' + total + '</span>';
    }
  }

  document.getElementById("upcoming-prev").addEventListener("click", () => {
    selectedWeekDate = null;
    weekStart.setDate(weekStart.getDate() - 7);
    renderWeekBar();
    renderWeekTimeline();
  });
  document.getElementById("upcoming-next").addEventListener("click", () => {
    selectedWeekDate = null;
    weekStart.setDate(weekStart.getDate() + 7);
    renderWeekBar();
    renderWeekTimeline();
  });
  document.getElementById("upcoming-today-btn").addEventListener("click", () => {
    selectedWeekDate = null;
    weekStart = new Date(todayDate);
    weekStart.setDate(weekStart.getDate() - ((weekStart.getDay() + 6) % 7));
    renderWeekBar();
    renderWeekTimeline();
  });
  renderWeekBar();
  renderWeekTimeline();

  // --- 월간 뷰 ---
  let monthlyYear = todayDate.getFullYear(), monthlyMonth = todayDate.getMonth(); // 0-indexed

  function renderMonthlyTimeline() {
    const timeline = document.getElementById("monthly-timeline");
    const m = monthlyMonth + 1; // 1-indexed
    const daysInMonth = new Date(monthlyYear, monthlyMonth + 1, 0).getDate();
    document.getElementById("monthly-month-label").textContent = monthlyYear + "년 " + m + "월";

    // 주 단위로 그룹핑 (월요일 시작)
    const weeks = [];
    let currentWeek = [];
    for (let d = 1; d <= daysInMonth; d++) {
      const date = new Date(monthlyYear, monthlyMonth, d);
      const dow = (date.getDay() + 6) % 7; // 월=0, 일=6
      if (dow === 0 && currentWeek.length > 0) {
        weeks.push(currentWeek);
        currentWeek = [];
      }
      currentWeek.push(date);
    }
    if (currentWeek.length > 0) weeks.push(currentWeek);

    let html = '<div class="flex flex-col gap-8">';

    weeks.forEach((week, wIdx) => {
      const wStart = week[0];
      const wEnd = week[week.length - 1];
      const wLabel = m + "/" + wStart.getDate() + " ~ " + (wEnd.getMonth() + 1) + "/" + wEnd.getDate();

      // 해당 주의 업무 수집
      let weekTasks = [];
      week.forEach(date => {
        const dd = date.getDate();
        const tasks = allTasks.filter(t => t.month === m && t.day === dd);
        tasks.forEach(t => weekTasks.push({ ...t, date: date }));
      });

      html += '<section class="flex flex-col gap-3">';

      // 주차 헤더 + 그라데이션 라인
      html += '<div class="flex items-center gap-4">';
      html += '<h3 class="text-lg font-bold text-slate-900 whitespace-nowrap">' + (wIdx + 1) + '주차 · ' + wLabel + '</h3>';
      html += '<div class="h-px flex-1 bg-gradient-to-r from-indigo-400/40 to-transparent"></div>';
      html += '</div>';

      if (weekTasks.length === 0) {
        // 빈 주차 — dashed 카드 + 빈 상태
        html += '<div class="bg-white rounded-xl border-2 border-dashed border-gray-200 p-8 flex flex-col items-center justify-center text-center gap-2">';
        html += '<div class="size-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 mb-1">';
        html += '<span class="material-symbols-outlined">event_busy</span></div>';
        html += '<p class="text-sm font-medium text-gray-400">이 주에 등록된 업무가 없습니다</p>';
        html += '<button class="text-xs font-bold text-indigo-500 hover:underline" onclick="openAddModal(null, null)">업무 추가</button>';
        html += '</div>';
      } else {
        // 태스크 카드 컨테이너
        html += '<div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">';
        weekTasks.forEach((t, idx) => {
          const cc = catColorMap[t.cat] || {bg:"#f1f5f9",text:"#475569"};
          const key = m + "_" + t.title;
          const dateLabel = (t.date.getMonth()+1) + "/" + t.date.getDate();
          const dow = t.date.getDay();
          const hKey2 = t.date.getMonth() + "-" + t.date.getDate();
          const hName2 = holidayMap[hKey2] || null;
          const isDeadlineSoon = (new Date(monthlyYear, monthlyMonth, t.date.getDate()) <= new Date(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate() + 3));
          const isCurrentMonth = (monthlyYear === todayDate.getFullYear() && monthlyMonth === todayDate.getMonth());
          const dateColor = (isCurrentMonth && isDeadlineSoon && t.date.getDate() >= todayDate.getDate()) ? 'text-red-500 font-bold' : 'text-gray-400';

          html += '<div class="task-item group flex items-center gap-4 p-4 hover:bg-gray-50 transition-colors' + (idx < weekTasks.length - 1 ? ' border-b border-gray-100' : '') + ' cursor-pointer">';

          // 체크박스
          html += '<label class="flex-shrink-0 cursor-pointer">' +
            '<input type="checkbox" class="task-cb monthly-task-cb sr-only" data-key="' + key + '">' +
            '<span class="check-box w-[22px] h-[22px] rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-indigo-400 transition-colors">' +
              '<svg class="w-3 h-3 text-white opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' +
            '</span>' +
          '</label>';

          // 제목
          html += '<div class="flex-1 min-w-0">';
          html += '<p class="task-text text-sm font-medium text-slate-800 truncate group-hover:text-indigo-600 transition-colors">' + t.title + '</p>';
          html += '</div>';

          // 카테고리 배지 + 날짜
          html += '<div class="flex items-center gap-3 shrink-0">';
          html += '<span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium ring-1 ring-inset" style="background:' + cc.bg + ';color:' + cc.text + ';--tw-ring-color:' + cc.text + '20">' + t.cat + '</span>';
          html += '<span class="text-xs font-medium ' + dateColor + ' w-12 text-right">' + m + '/' + t.date.getDate() + '</span>';
          html += '</div>';

          html += '</div>';
        });
        html += '</div>';
      }

      html += '</section>';
    });

    html += '</div>';
    timeline.innerHTML = html;

    // 체크박스 복원 + 이벤트
    timeline.querySelectorAll(".task-cb").forEach(cb => {
      const key = cb.dataset.key;
      if (state[key]) { cb.checked = true; applyCheck(cb, true); }
      cb.addEventListener("change", () => {
        state[key] = cb.checked;
        saveState(state);
        applyCheck(cb, cb.checked);
        updateTodayCount();
        updateProgress();
        updateWeekCount();
        updateMonthCount();
      });
    });

    updateMonthCount();
  }

  function updateMonthCount() {
    const cbs = document.querySelectorAll("#monthly-timeline .task-cb");
    const total = cbs.length;
    const done = Array.from(cbs).filter(cb => cb.checked).length;
    const remaining = total - done;
    const el = document.getElementById("month-count");
    if (total === 0) {
      el.innerHTML = '';
    } else if (remaining === 0) {
      el.innerHTML = '<span class="text-emerald-500">' + total + '/' + total + '</span>';
    } else {
      el.innerHTML = '<span class="text-indigo-600 font-bold">' + remaining + '</span><span class="text-slate-300">/' + total + '</span>';
    }
  }

  document.getElementById("monthly-prev").addEventListener("click", () => {
    monthlyMonth--;
    if (monthlyMonth < 0) { monthlyMonth = 11; monthlyYear--; }
    renderMonthlyTimeline();
  });
  document.getElementById("monthly-next").addEventListener("click", () => {
    monthlyMonth++;
    if (monthlyMonth > 11) { monthlyMonth = 0; monthlyYear++; }
    renderMonthlyTimeline();
  });
  document.getElementById("monthly-today-btn").addEventListener("click", () => {
    monthlyYear = todayDate.getFullYear();
    monthlyMonth = todayDate.getMonth();
    renderMonthlyTimeline();
  });
  renderMonthlyTimeline();

  // --- 월간 월 선택 드롭다운 ---
  const monthlyCalDrop = document.getElementById("monthly-cal-dropdown");
  const monthlyCalGrid = document.getElementById("monthly-cal-grid");
  const monthlyCalYearEl = document.getElementById("monthly-cal-year");
  let monthlyPickYear = monthlyYear;
  const monthNames = ["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"];

  function renderMonthlyCalDrop() {
    monthlyCalYearEl.textContent = monthlyPickYear + "년";
    monthlyCalGrid.innerHTML = "";
    for (let i = 0; i < 12; i++) {
      const btn = document.createElement("button");
      const isCurrent = (monthlyPickYear === monthlyYear && i === monthlyMonth);
      const isThisMonth = (monthlyPickYear === todayDate.getFullYear() && i === todayDate.getMonth());
      let cls = "py-2 rounded-lg text-sm font-medium transition-colors ";
      if (isCurrent) {
        cls += "bg-indigo-600 text-white font-bold";
      } else if (isThisMonth) {
        cls += "bg-indigo-50 text-indigo-600 font-bold hover:bg-indigo-100";
      } else {
        cls += "text-slate-700 hover:bg-slate-100";
      }
      btn.className = cls;
      btn.textContent = monthNames[i];
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        monthlyYear = monthlyPickYear;
        monthlyMonth = i;
        renderMonthlyTimeline();
        monthlyCalDrop.classList.add("hidden");
      });
      monthlyCalGrid.appendChild(btn);
    }
  }

  document.getElementById("monthly-month-toggle").addEventListener("click", (e) => {
    e.stopPropagation();
    monthlyCalDrop.classList.toggle("hidden");
    if (!monthlyCalDrop.classList.contains("hidden")) {
      monthlyPickYear = monthlyYear;
      renderMonthlyCalDrop();
    }
  });
  document.getElementById("monthly-cal-prev-year").addEventListener("click", (e) => {
    e.stopPropagation();
    monthlyPickYear--;
    renderMonthlyCalDrop();
  });
  document.getElementById("monthly-cal-next-year").addEventListener("click", (e) => {
    e.stopPropagation();
    monthlyPickYear++;
    renderMonthlyCalDrop();
  });
  document.addEventListener("click", (e) => {
    if (!monthlyCalDrop.contains(e.target) && e.target.id !== "monthly-month-toggle") {
      monthlyCalDrop.classList.add("hidden");
    }
  });

  // --- 미니 달력 드롭다운 ---
  const calDropdown = document.getElementById("upcoming-cal-dropdown");
  const calGrid = document.getElementById("cal-drop-grid");
  const calTitle = document.getElementById("cal-drop-title");
  let calYear = todayDate.getFullYear(), calMonth = todayDate.getMonth();

  document.getElementById("upcoming-month-toggle").addEventListener("click", (e) => {
    e.stopPropagation();
    calDropdown.classList.toggle("hidden");
    if (!calDropdown.classList.contains("hidden")) {
      const label = document.getElementById("upcoming-month-label").textContent;
      const parts = label.match(/(\d+)월\s+(\d+)/);
      if (parts) { calMonth = parseInt(parts[1]) - 1; calYear = parseInt(parts[2]); }
      renderCalDropdown();
    }
  });

  document.addEventListener("click", (e) => {
    if (!calDropdown.contains(e.target)) calDropdown.classList.add("hidden");
  });

  document.getElementById("cal-drop-prev").addEventListener("click", (e) => {
    e.stopPropagation();
    calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; }
    renderCalDropdown();
  });
  document.getElementById("cal-drop-next").addEventListener("click", (e) => {
    e.stopPropagation();
    calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; }
    renderCalDropdown();
  });
  document.getElementById("cal-drop-today").addEventListener("click", (e) => {
    e.stopPropagation();
    calYear = todayDate.getFullYear(); calMonth = todayDate.getMonth();
    renderCalDropdown();
  });

  function renderCalDropdown() {
    calTitle.textContent = (calMonth + 1) + "월 " + calYear;
    calGrid.innerHTML = "";
    const first = new Date(calYear, calMonth, 1);
    const startDay = (first.getDay() + 6) % 7; // 월=0
    const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

    // 빈 셀
    for (let i = 0; i < startDay; i++) {
      const empty = document.createElement("div");
      empty.style.height = "36px";
      calGrid.appendChild(empty);
    }
    for (let d = 1; d <= daysInMonth; d++) {
      const thisDate = new Date(calYear, calMonth, d);
      const isToday = thisDate.toDateString() === todayDate.toDateString();
      const dow = thisDate.getDay(); // 0=일, 6=토
      const hKey = calMonth + "-" + d;
      const holiday = holidayMap[hKey] || null;
      const isHoliday = !!holiday;
      const isSun = dow === 0;
      const isSat = dow === 6;

      const wrapper = document.createElement("div");
      wrapper.className = "flex flex-col items-center justify-start";
      wrapper.style.height = "36px";

      const cell = document.createElement("button");
      let cls = "w-8 h-8 rounded-full text-sm font-medium flex items-center justify-center transition-colors ";
      if (isToday) {
        cls += "bg-indigo-600 text-white font-bold";
      } else if (isHoliday || isSun) {
        cls += "text-red-500 font-semibold hover:bg-red-50";
      } else if (isSat) {
        cls += "text-blue-500 font-semibold hover:bg-blue-50";
      } else {
        cls += "text-slate-700 hover:bg-indigo-50 hover:text-indigo-600";
      }
      cell.className = cls;
      cell.textContent = d;
      cell.addEventListener("click", (e) => {
        e.stopPropagation();
        const target = new Date(calYear, calMonth, d);
        selectedWeekDate = null;
        weekStart = new Date(target);
        weekStart.setDate(weekStart.getDate() - ((weekStart.getDay() + 6) % 7));
        renderWeekBar();
        renderWeekTimeline();
        calDropdown.classList.add("hidden");
      });
      wrapper.appendChild(cell);

      if (holiday) {
        cell.title = holiday;
        const label = document.createElement("span");
        label.className = "w-1 h-1 rounded-full bg-red-400 mt-0.5 flex-shrink-0";
        wrapper.appendChild(label);
      }

      calGrid.appendChild(wrapper);
    }
  }

  // --- 분류 관리 ---
  const CAT_STORAGE = "silmu_task_cats";
  const defaultCats = {
    "급여": { bg: "#d1fae5", text: "#047857", dot: "#10b981" },
    "세무": { bg: "#fef3c7", text: "#b45309", dot: "#f59e0b" },
    "보험": { bg: "#dbeafe", text: "#1d4ed8", dot: "#3b82f6" },
    "회계": { bg: "#ede9fe", text: "#6d28d9", dot: "#8b5cf6" },
    "보고": { bg: "#ffe4e6", text: "#be123c", dot: "#f43f5e" },
    "서무": { bg: "#f1f5f9", text: "#475569", dot: "#94a3b8" },
    "복지": { bg: "#cffafe", text: "#0e7490", dot: "#06b6d4" },
  };

  function loadCats() {
    try { const s = localStorage.getItem(CAT_STORAGE); return s ? JSON.parse(s) : { ...defaultCats }; }
    catch { return { ...defaultCats }; }
  }
  function saveCats(c) { localStorage.setItem(CAT_STORAGE, JSON.stringify(c)); syncToServer({ categories: c }); }

  let cats = loadCats();
  let editMode = false;
  const catList = document.getElementById("cat-list");
  const catAddRow = document.getElementById("cat-add-row");
  const editBtn = document.getElementById("btn-edit-cats");

  function renderCats() {
    catList.innerHTML = "";
    Object.entries(cats).forEach(([name, c]) => {
      const span = document.createElement("span");
      span.className = "group inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium cursor-pointer hover:opacity-80 transition-all";
      span.style.background = c.bg;
      span.style.color = c.text;
      span.innerHTML = '<span class="w-1.5 h-1.5 rounded-full mr-2" style="background:' + c.dot + '"></span>' + name;

      if (editMode) {
        const del = document.createElement("button");
        del.className = "ml-1.5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity";
        del.style.color = c.text;
        del.innerHTML = '<span class="material-symbols-outlined" style="font-size:12px">close</span>';
        del.addEventListener("click", (e) => {
          e.stopPropagation();
          delete cats[name];
          saveCats(cats);
          renderCats();
        });
        span.appendChild(del);
      }
      catList.appendChild(span);
    });

    if (editMode) {
      const addBtn = document.createElement("button");
      addBtn.className = "inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-medium border border-dashed border-gray-300 text-gray-400 hover:border-indigo-400 hover:text-indigo-500 transition-colors";
      addBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:14px">add</span>추가';
      addBtn.addEventListener("click", () => {
        catAddRow.classList.toggle("hidden");
        if (!catAddRow.classList.contains("hidden")) document.getElementById("cat-add-input").focus();
      });
      catList.appendChild(addBtn);
    }
  }

  editBtn.addEventListener("click", () => {
    editMode = !editMode;
    editBtn.innerHTML = editMode
      ? '<span class="material-symbols-outlined" style="font-size:18px">check</span>'
      : '<span class="material-symbols-outlined" style="font-size:18px">add</span>';
    editBtn.classList.toggle("text-indigo-600", editMode);
    if (!editMode) catAddRow.classList.add("hidden");
    renderCats();
  });

  // 분류 추가
  function addCat() {
    const input = document.getElementById("cat-add-input");
    const color = document.getElementById("cat-add-color").value;
    const name = input.value.trim();
    if (!name || cats[name]) return;

    // 색상에서 bg, text, dot 자동 생성
    const r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16);
    cats[name] = {
      bg: "rgba(" + r + "," + g + "," + b + ",0.12)",
      text: color,
      dot: color,
    };
    saveCats(cats);
    input.value = "";
    catAddRow.classList.add("hidden");
    renderCats();
  }

  document.getElementById("cat-add-submit").addEventListener("click", addCat);
  document.getElementById("cat-add-input").addEventListener("keydown", (e) => {
    if (e.key === "Enter") addCat();
  });

  // --- 토스트 알림 ---
  function showToast(msg, icon) {
    const toast = document.getElementById("toast");
    document.getElementById("toast-msg").textContent = msg;
    document.getElementById("toast-icon").textContent = icon || "check_circle";
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 2500);
  }

  // --- 공유 (내보내기): 기본 업무 + 커스텀 업무 모두 ---
  document.getElementById("btn-share").addEventListener("click", () => {
    // 기본 업무를 공유 포맷으로 변환
    const shareData = allTasks.map(t => ({
      title: t.title, repeat: "monthly", day: t.day, cat: t.cat, _src: "default"
    }));
    // 커스텀 업무도 포함
    const customs = loadCustom();
    customs.forEach(t => {
      shareData.push({ title: t.title, repeat: t.repeat, day: t.day, weekday: t.weekday, date: t.date, time: t.time, cat: t.cat, _src: "custom" });
    });

    if (!shareData.length) {
      showToast("공유할 업무가 없습니다.", "info");
      return;
    }

    const json = JSON.stringify(shareData);
    const encoded = "SILMU_TASKS:" + btoa(unescape(encodeURIComponent(json)));

    function copyDone() {
      showToast("전체 " + shareData.length + "개 업무가 복사되었습니다!", "content_copy");
    }
    navigator.clipboard.writeText(encoded).then(copyDone).catch(() => {
      const ta = document.createElement("textarea");
      ta.value = encoded;
      ta.style.cssText = "position:fixed;left:-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      copyDone();
    });
  });

  // --- 가져오기 (임포트) ---
  const modalImport = document.getElementById("modal-import");
  const importArea = document.getElementById("import-textarea");
  const importPreview = document.getElementById("import-preview");
  const importError = document.getElementById("import-error");
  const importSubmit = document.getElementById("import-submit");
  let importData = null;

  document.getElementById("btn-import").addEventListener("click", () => {
    modalImport.classList.remove("hidden");
    importArea.value = "";
    importPreview.classList.add("hidden");
    importError.classList.add("hidden");
    importSubmit.disabled = true;
    importData = null;
    setTimeout(() => importArea.focus(), 100);
  });

  document.getElementById("import-cancel").addEventListener("click", () => modalImport.classList.add("hidden"));
  modalImport.addEventListener("click", () => modalImport.classList.add("hidden"));

  // 기본 업무인지 판별 (서버 렌더링 목록과 동일하면 기본)
  function isDefaultTask(t) {
    return allTasks.some(d => d.title === t.title && d.day === t.day && d.cat === t.cat);
  }

  // 붙여넣기 시 실시간 미리보기
  importArea.addEventListener("input", () => {
    const raw = importArea.value.trim();
    importPreview.classList.add("hidden");
    importError.classList.add("hidden");
    importSubmit.disabled = true;
    importData = null;

    if (!raw) return;

    if (!raw.startsWith("SILMU_TASKS:")) {
      importError.textContent = "올바른 공유 코드가 아닙니다. 'SILMU_TASKS:'로 시작하는 코드를 붙여넣으세요.";
      importError.classList.remove("hidden");
      return;
    }

    try {
      const b64 = raw.slice("SILMU_TASKS:".length);
      const json = decodeURIComponent(escape(atob(b64)));
      const tasks = JSON.parse(json);
      if (!Array.isArray(tasks) || !tasks.length) {
        importError.textContent = "업무 데이터가 비어있습니다.";
        importError.classList.remove("hidden");
        return;
      }

      // 유효성 검증
      const valid = tasks.filter(t => t.title && t.repeat && (
        t.repeat === "monthly" ? t.day :
        t.repeat === "weekly" ? t.weekday !== undefined :
        t.repeat === "once" ? t.date : false
      ));
      if (!valid.length) {
        importError.textContent = "유효한 업무 데이터가 없습니다.";
        importError.classList.remove("hidden");
        return;
      }

      // 기본 업무와 커스텀 업무 분리
      const existingCustom = loadCustom();
      const newCustomOnly = [];
      let defaultCount = 0;
      let dupCount = 0;

      valid.forEach(t => {
        // 이미 서버에 있는 기본 업무면 건너뜀
        if (isDefaultTask(t)) { defaultCount++; return; }
        // 이미 내 커스텀에 있는 업무면 중복
        const dup = existingCustom.some(e => e.title === t.title && e.repeat === t.repeat && (
          t.repeat === "monthly" ? e.day === t.day :
          t.repeat === "weekly" ? e.weekday === t.weekday :
          t.repeat === "once" ? e.date === t.date : false
        ));
        if (dup) { dupCount++; return; }
        newCustomOnly.push(t);
      });

      importData = newCustomOnly;

      // 미리보기 렌더링
      let html = '<p class="text-xs font-semibold text-slate-500 mb-2">전체 ' + valid.length + '개 업무 분석 결과</p>';

      if (defaultCount > 0) {
        html += '<div class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-blue-50 mb-1.5">' +
          '<span class="material-symbols-outlined text-blue-400" style="font-size:14px">check_circle</span>' +
          '<span class="text-[11px] text-blue-600 font-medium">기본 업무 ' + defaultCount + '건 (이미 포함됨)</span></div>';
      }
      if (dupCount > 0) {
        html += '<div class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-amber-50 mb-1.5">' +
          '<span class="material-symbols-outlined text-amber-400" style="font-size:14px">info</span>' +
          '<span class="text-[11px] text-amber-600 font-medium">중복 ' + dupCount + '건 (건너뜀)</span></div>';
      }

      if (newCustomOnly.length > 0) {
        html += '<p class="text-[11px] font-semibold text-emerald-600 mt-2 mb-1.5">추가될 업무 ' + newCustomOnly.length + '건</p>';
        newCustomOnly.forEach(t => {
          const cc = catColorMap[t.cat] || {bg:"#f1f5f9",text:"#475569"};
          const schedule = t.repeat === "monthly" ? "매월 " + t.day + "일" :
            t.repeat === "weekly" ? "매주 " + dayLabels[t.weekday] + "요일" :
            t.date + (t.time ? " " + t.time : "");
          html += '<div class="flex items-center gap-2 px-2.5 py-2 rounded-lg bg-emerald-50 mb-1">' +
            '<span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background:' + cc.text + '"></span>' +
            '<div class="flex-1 min-w-0">' +
              '<p class="text-xs text-slate-700 truncate">' + t.title + '</p>' +
              '<span class="text-[10px] text-slate-400">' + schedule + ' · ' + (t.cat||"서무") + '</span>' +
            '</div></div>';
        });
        importSubmit.disabled = false;
      } else {
        html += '<div class="flex items-center gap-1.5 px-2.5 py-2 rounded-lg bg-slate-50 mt-2">' +
          '<span class="material-symbols-outlined text-slate-400" style="font-size:14px">done_all</span>' +
          '<span class="text-[11px] text-slate-500 font-medium">새로 추가할 업무가 없습니다. 모두 이미 포함되어 있습니다.</span></div>';
        importSubmit.disabled = true;
      }

      importPreview.innerHTML = html;
      importPreview.classList.remove("hidden");
    } catch (e) {
      importError.textContent = "코드를 해석할 수 없습니다. 전체 코드가 정확히 복사되었는지 확인하세요.";
      importError.classList.remove("hidden");
    }
  });

  importSubmit.addEventListener("click", () => {
    if (!importData || !importData.length) return;
    const existing = loadCustom();
    importData.forEach(t => {
      existing.push({ title: t.title, repeat: t.repeat, day: t.day, weekday: t.weekday, date: t.date, time: t.time, cat: t.cat || "서무" });
    });
    saveCustom(existing);
    renderCustomTasks();
    modalImport.classList.add("hidden");
    showToast(importData.length + "개 업무를 가져왔습니다!", "check_circle");
  });

  renderCats();

  // --- AI 프로세스 가이드 슬라이드 패널 ---
  const guideOverlay = document.getElementById("guide-overlay");
  const guidePanel = document.getElementById("guide-panel");
  const guideTitleEl = document.getElementById("guide-title");
  const guideCatEl = document.getElementById("guide-category");
  const guideCatTextEl = document.getElementById("guide-category-text");
  const guideSkeleton = document.getElementById("guide-skeleton");
  const guideContent = document.getElementById("guide-content");
  const guideError = document.getElementById("guide-error");
  const guideErrorMsg = document.getElementById("guide-error-msg");
  const guideFooterDefault = document.getElementById("guide-footer-default");
  const guideFooterError = document.getElementById("guide-footer-error");
  let lastGuideTitle = "";
  let lastGuideCat = "";

  function guideShowFooter(isError) {
    guideFooterDefault.classList.toggle("hidden", isError);
    guideFooterError.classList.toggle("hidden", !isError);
  }

  function openGuide(title, category) {
    lastGuideTitle = title;
    lastGuideCat = category;

    guideTitleEl.textContent = title;
    const cc = catColorMap[category] || {bg:"#f1f5f9",text:"#475569"};
    guideCatTextEl.textContent = category || "";
    guideCatEl.style.background = cc.bg;
    guideCatEl.style.color = cc.text;
    guideCatEl.classList.toggle("hidden", !category);

    guideSkeleton.classList.remove("hidden");
    guideContent.classList.add("hidden");
    guideContent.innerHTML = "";
    guideError.classList.add("hidden");
    guideShowFooter(false);

    guideOverlay.classList.remove("hidden");
    requestAnimationFrame(() => {
      guidePanel.style.opacity = "1";
      guidePanel.style.transform = "scale(1)";
    });

    const params = new URLSearchParams({ title: title });
    if (category) params.append("category", category);

    fetch("/task_guides?" + params.toString(), {
      headers: { "Accept": "application/json" }
    })
    .then(r => r.json())
    .then(data => {
      guideSkeleton.classList.add("hidden");
      if (window.checkAiLoginRequired && window.checkAiLoginRequired(data)) { closeGuide(); return; }
      if (data.success && data.content) {
        guideContent.innerHTML = data.content;
        guideContent.classList.remove("hidden");
      } else {
        guideErrorMsg.textContent = data.error || "가이드를 불러올 수 없습니다.";
        guideError.classList.remove("hidden");
        guideShowFooter(true);
      }
    })
    .catch(() => {
      guideSkeleton.classList.add("hidden");
      guideErrorMsg.textContent = "서버 연결에 실패했습니다.";
      guideError.classList.remove("hidden");
      guideShowFooter(true);
    });
  }

  function closeGuide() {
    guidePanel.style.opacity = "0";
    guidePanel.style.transform = "scale(0.95)";
    setTimeout(() => guideOverlay.classList.add("hidden"), 200);
  }

  document.getElementById("guide-close").addEventListener("click", closeGuide);
  document.getElementById("guide-retry").addEventListener("click", () => {
    if (lastGuideTitle) openGuide(lastGuideTitle, lastGuideCat);
  });
  document.getElementById("guide-footer-close").addEventListener("click", closeGuide);
  guideOverlay.addEventListener("click", (e) => {
    if (e.target === guideOverlay) closeGuide();
  });
  // ESC도 가이드 패널 닫기
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !guideOverlay.classList.contains("hidden")) {
      closeGuide();
    }
  });

  // 기본 업무 .task-item 클릭 → 가이드 열기 (체크박스 영역 제외)
  function attachGuideClick(container) {
    container.querySelectorAll(".task-item").forEach(item => {
      item.style.cursor = "pointer";
      item.addEventListener("click", (e) => {
        // 체크박스 라벨 클릭은 무시
        if (e.target.closest("label")) return;
        if (e.target.closest(".del-custom-btn")) return;
        const textEl = item.querySelector(".task-text");
        const catEl = item.querySelector("[style*='background']");
        const title = textEl ? textEl.textContent.trim() : "";
        let category = "";
        if (catEl) category = catEl.textContent.trim();
        if (title) openGuide(title, category);
      });
    });
  }

  // 초기 바인딩: 관리함, 오늘 뷰의 서버 렌더 업무
  attachGuideClick(document.getElementById("view-inbox"));
  attachGuideClick(document.getElementById("view-today"));

  // 동적 렌더링 뷰 (주간/월간)는 렌더 후 바인딩
  const origRenderWeekTimeline = renderWeekTimeline;
  renderWeekTimeline = function() {
    origRenderWeekTimeline();
    attachGuideClick(document.getElementById("upcoming-timeline"));
  };
  const origRenderMonthlyTimeline = renderMonthlyTimeline;
  renderMonthlyTimeline = function() {
    origRenderMonthlyTimeline();
    attachGuideClick(document.getElementById("monthly-timeline"));
  };

  // 커스텀 업무도 바인딩
  const origRenderCustomTasks = renderCustomTasks;
  renderCustomTasks = function() {
    origRenderCustomTasks();
    document.querySelectorAll(".custom-tasks-area").forEach(area => {
      area.querySelectorAll("[class*='group flex']").forEach(row => {
        row.style.cursor = "pointer";
        row.addEventListener("click", (e) => {
          if (e.target.closest(".del-custom-btn")) return;
          const textEl = row.querySelector("p");
          const catEl = row.querySelector("[style*='background'][style*='color']");
          const title = textEl ? textEl.textContent.trim() : "";
          let category = "";
          if (catEl) category = catEl.textContent.trim();
          if (title) openGuide(title, category);
        });
      });
    });
  };

  // saveCustom 후 백그라운드에서 가이드 사전 생성
  const origSaveCustom = saveCustom;
  saveCustom = function(arr) {
    origSaveCustom(arr);
    // 마지막으로 추가된 업무의 가이드 사전 생성
    if (arr.length > 0) {
      const last = arr[arr.length - 1];
      const params = new URLSearchParams({ title: last.title });
      if (last.cat) params.append("category", last.cat);
      fetch("/task_guides?" + params.toString(), {
        headers: { "Accept": "application/json" }
      }).catch(() => {});
    }
  };

  // 주간/월간 다시 렌더 (가이드 클릭 바인딩 적용)
  renderWeekTimeline();
  renderMonthlyTimeline();
  renderCustomTasks();

  // --- 상시 체크리스트 관리 ---
  const STANDING_CHECKLIST_KEY = "silmu_standing_checklist";
  const CHECKLIST_COLORS = [
    { bg: "bg-red-50", text: "text-red-700", border: "border-red-200" },
    { bg: "bg-orange-50", text: "text-orange-700", border: "border-orange-200" },
    { bg: "bg-amber-50", text: "text-amber-700", border: "border-amber-200" },
    { bg: "bg-yellow-50", text: "text-yellow-700", border: "border-yellow-200" },
    { bg: "bg-lime-50", text: "text-lime-700", border: "border-lime-200" },
    { bg: "bg-green-50", text: "text-green-700", border: "border-green-200" },
    { bg: "bg-emerald-50", text: "text-emerald-700", border: "border-emerald-200" },
    { bg: "bg-teal-50", text: "text-teal-700", border: "border-teal-200" },
    { bg: "bg-cyan-50", text: "text-cyan-700", border: "border-cyan-200" },
    { bg: "bg-sky-50", text: "text-sky-700", border: "border-sky-200" },
    { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-200" },
    { bg: "bg-indigo-50", text: "text-indigo-700", border: "border-indigo-200" },
    { bg: "bg-violet-50", text: "text-violet-700", border: "border-violet-200" },
    { bg: "bg-purple-50", text: "text-purple-700", border: "border-purple-200" },
    { bg: "bg-fuchsia-50", text: "text-fuchsia-700", border: "border-fuchsia-200" },
    { bg: "bg-pink-50", text: "text-pink-700", border: "border-pink-200" },
    { bg: "bg-rose-50", text: "text-rose-700", border: "border-rose-200" }
  ];

  function loadStandingChecklist() {
    return JSON.parse(localStorage.getItem(STANDING_CHECKLIST_KEY) || "[]");
  }

  function saveStandingChecklist(items) {
    localStorage.setItem(STANDING_CHECKLIST_KEY, JSON.stringify(items));
    if (isSignedIn) syncToServer({ standing_checklist: items });
  }

  function renderStandingChecklist() {
    const items = loadStandingChecklist();
    const container = document.getElementById("standing-checklist-container");
    if (!container) return;

    if (items.length === 0) {
      container.innerHTML = '<p class="text-xs text-gray-400 text-center py-3">상시 체크리스트가 없습니다</p>';
      return;
    }

    container.innerHTML = items.map((item, idx) => {
      const color = CHECKLIST_COLORS[idx % CHECKLIST_COLORS.length];
      return `
        <div class="p-2.5 rounded-lg border ${color.border} ${color.bg} group hover:shadow-sm transition-all">
          <div class="flex items-start gap-2">
            <input type="checkbox" ${item.checked ? 'checked' : ''}
                   class="standing-item-cb mt-0.5 w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                   data-idx="${idx}">
            <div class="flex-1 min-w-0">
              <p class="text-xs font-medium ${color.text} ${item.checked ? 'line-through opacity-60' : ''}">${escapeHtml(item.title)}</p>
            </div>
            <button class="del-standing-btn opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-red-600" data-idx="${idx}">
              <span class="material-symbols-outlined" style="font-size:16px">close</span>
            </button>
          </div>
        </div>
      `;
    }).join("");

    // 체크박스 이벤트
    container.querySelectorAll(".standing-item-cb").forEach(cb => {
      cb.addEventListener("change", (e) => {
        const idx = parseInt(e.target.dataset.idx);
        const items = loadStandingChecklist();
        items[idx].checked = e.target.checked;
        saveStandingChecklist(items);
        renderStandingChecklist();
      });
    });

    // 삭제 버튼 이벤트
    container.querySelectorAll(".del-standing-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const idx = parseInt(e.target.closest(".del-standing-btn").dataset.idx);
        const items = loadStandingChecklist();
        items.splice(idx, 1);
        saveStandingChecklist(items);
        renderStandingChecklist();
      });
    });
  }

  function escapeHtml(str) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  // 상시 체크리스트 추가 버튼
  document.getElementById("btn-add-standing-item")?.addEventListener("click", () => {
    const title = prompt("상시 체크리스트 항목 추가\\n\\n예: 안전점검, 화재예방 확인, 보안 점검 등");
    if (!title || !title.trim()) return;
    const items = loadStandingChecklist();
    items.push({ title: title.trim(), checked: false });
    saveStandingChecklist(items);
    renderStandingChecklist();
  });

  // --- 로그인 유도 배너 (비로그인 전용) ---
  const BANNER_DISMISSED_KEY = "silmu_sync_banner_dismissed";
  function checkSyncBanner() {
    if (isSignedIn) return;
    const banner = document.getElementById("sync-banner");
    if (!banner) return;
    const dismissed = localStorage.getItem(BANNER_DISMISSED_KEY);
    const customs = loadCustom();
    if (!dismissed && customs.length >= 1) {
      banner.classList.remove("hidden");
    }
  }
  const bannerCloseBtn = document.getElementById("sync-banner-close");
  if (bannerCloseBtn) {
    bannerCloseBtn.addEventListener("click", () => {
      document.getElementById("sync-banner").classList.add("hidden");
      localStorage.setItem(BANNER_DISMISSED_KEY, "1");
    });
  }
  checkSyncBanner();

  // --- 서버에서 데이터 로드 (로그인 시) ---
  loadFromServer().then(() => {
    if (!isSignedIn) return;
    // 서버 데이터 반영 후 UI 재렌더링
    Object.assign(state, loadState());
    document.querySelectorAll(".task-cb").forEach(cb => {
      const key = cb.dataset.key;
      cb.checked = !!state[key];
      applyCheck(cb, cb.checked);
    });
    cats = loadCats();
    renderCats();
    renderCustomTasks();
    renderStandingChecklist();
    updateTodayCount();
    updateProgress();
  });
})();
</script>
