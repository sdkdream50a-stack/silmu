<%# 계약서류 원클릭 생성기 %>

<style>
  .doc-generator {
    max-width: 1100px;
    margin: 0 auto;
  }

  /* 스텝 인디케이터 */
  .step-indicator {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }
  .step {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 30px;
    background: var(--surface-100, #f1f5f9);
    color: #64748b;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .step:hover:not(.disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .step.active {
    background: var(--navy-800, #1e3a5f);
    color: white;
  }
  .step.done {
    background: var(--forest-600, #2e7d32);
    color: white;
  }
  .step.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .step-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
  }

  /* 카드 */
  .doc-card {
    background: white;
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
  }
  .doc-card h3 {
    color: var(--navy-900, #1e3a5f);
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .doc-card .desc {
    color: #64748b;
    margin-bottom: 24px;
    font-size: 14px;
  }

  /* 계약 유형 선택 */
  .type-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 24px;
  }
  .type-btn {
    padding: 32px 20px;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    background: white;
    cursor: pointer;
    text-align: center;
    transition: all 0.25s ease;
  }
  .type-btn:hover {
    border-color: var(--navy-400, #829ab1);
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.08);
  }
  .type-btn.selected {
    border-color: var(--navy-700, #334e68);
    background: linear-gradient(135deg, var(--navy-50, #f0f4f8), white);
    box-shadow: 0 8px 20px rgba(30, 58, 95, 0.15);
  }
  .type-btn .material-symbols-outlined {
    font-size: 56px;
    color: var(--navy-400, #829ab1);
    margin-bottom: 16px;
    transition: color 0.2s;
  }
  .type-btn.selected .material-symbols-outlined {
    color: var(--navy-700, #334e68);
  }
  .type-btn span {
    display: block;
    font-size: 18px;
    font-weight: 700;
    color: var(--navy-900, #1e3a5f);
    margin-bottom: 8px;
  }
  .type-btn small {
    font-size: 13px;
    color: #64748b;
    line-height: 1.5;
  }

  /* 계약 정보 입력 */
  .form-section {
    margin-bottom: 24px;
    padding: 24px;
    background: var(--surface-50, #fafbfc);
    border-radius: 12px;
    border: 1px solid #e2e8f0;
  }
  .form-section h4 {
    font-size: 16px;
    font-weight: 600;
    color: var(--navy-900, #1e3a5f);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }
  .form-group {
    margin-bottom: 0;
  }
  .form-group.full {
    grid-column: 1 / -1;
  }
  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--navy-800, #243b53);
    font-size: 14px;
  }
  .form-group input, .form-group select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
    background: white;
  }
  .form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--navy-500, #627d98);
    box-shadow: 0 0 0 3px rgba(98, 125, 152, 0.15);
  }
  .form-group .hint {
    font-size: 12px;
    color: #64748b;
    margin-top: 6px;
  }
  .cd-quick-bar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px; }
  .cd-quick-btn { display:inline-flex; align-items:center; padding:6px 14px; border-radius:20px; border:1px solid #d1d5db; background:#fff; font-size:13px; font-weight:600; color:#475569; cursor:pointer; transition:all .15s; white-space:nowrap; }
  .cd-quick-btn:hover { background:#f1f5f9; border-color:#94a3b8; color:#334155; }
  .cd-quick-btn.cd-reset { background:#fef3c7; border-color:#fcd34d; color:#b45309; margin-left:auto; }
  .cd-quick-btn.cd-reset:hover { background:#fde68a; border-color:#f59e0b; }

  /* 서류 단계별 섹션 */
  .stage-section {
    margin-bottom: 24px;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
  }
  .stage-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--surface-100, #f1f5f9);
    cursor: pointer;
    transition: background 0.2s;
  }
  .stage-header:hover {
    background: var(--surface-200, #ebeef2);
  }
  .stage-header .left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .stage-header .icon-box {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--navy-100, #d9e2ec);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .stage-header .icon-box .material-symbols-outlined {
    color: var(--navy-700, #334e68);
    font-size: 22px;
  }
  .stage-header .stage-name {
    font-weight: 600;
    color: var(--navy-900, #1e3a5f);
    font-size: 15px;
  }
  .stage-header .stage-count {
    font-size: 13px;
    color: #64748b;
    margin-top: 2px;
  }
  .stage-header .toggle-icon {
    transition: transform 0.2s;
  }
  .stage-header.open .toggle-icon {
    transform: rotate(180deg);
  }
  .stage-body {
    padding: 0;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }
  .stage-body.open {
    padding: 20px;
    max-height: 1000px;
  }

  /* 서류 체크 항목 */
  .doc-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-radius: 10px;
    margin-bottom: 8px;
    background: white;
    border: 1px solid #e2e8f0;
    transition: all 0.2s;
    cursor: pointer;
  }
  .doc-item:hover {
    border-color: var(--navy-300, #9fb3c8);
    background: var(--surface-50, #fafbfc);
  }
  .doc-item.checked {
    border-color: var(--forest-400, #57ae5b);
    background: var(--forest-50, #e3f9e5);
  }
  .doc-item:last-child {
    margin-bottom: 0;
  }
  .doc-checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid #cbd5e1;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .doc-item.checked .doc-checkbox {
    background: var(--forest-500, #3f9142);
    border-color: var(--forest-500, #3f9142);
  }
  .doc-checkbox .material-symbols-outlined {
    font-size: 16px;
    color: white;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .doc-item.checked .doc-checkbox .material-symbols-outlined {
    opacity: 1;
  }
  .doc-info {
    flex: 1;
  }
  .doc-name {
    font-weight: 600;
    color: var(--navy-900, #1e3a5f);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .doc-name .required-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: var(--warm-100, #fef3c7);
    color: var(--warm-700, #b45309);
    border-radius: 4px;
    font-weight: 600;
  }
  .doc-desc {
    font-size: 12px;
    color: #64748b;
    margin-top: 4px;
  }

  /* 결과 화면 */
  .result-container {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
  }
  .result-header {
    background: linear-gradient(135deg, var(--navy-900, #1e3a5f), var(--navy-700, #2d4a6f));
    color: white;
    padding: 32px;
    text-align: center;
  }
  .result-header h2 {
    font-size: 24px;
    margin-bottom: 8px;
  }
  .result-header p {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.9);
  }
  .result-body {
    padding: 28px;
  }

  /* 요약 카드 */
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }
  .summary-card {
    text-align: center;
    padding: 20px;
    background: var(--surface-50, #fafbfc);
    border-radius: 12px;
    border: 1px solid #e2e8f0;
  }
  .summary-card .value {
    font-size: 32px;
    font-weight: 700;
    color: var(--navy-900, #1e3a5f);
    margin-bottom: 4px;
  }
  .summary-card .label {
    font-size: 13px;
    color: #64748b;
  }

  /* 체크리스트 인쇄용 */
  .checklist-stage {
    margin-bottom: 24px;
    page-break-inside: avoid;
  }
  .checklist-stage h4 {
    font-size: 15px;
    font-weight: 600;
    color: var(--navy-900, #1e3a5f);
    padding: 12px 16px;
    background: var(--surface-100, #f1f5f9);
    border-radius: 8px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .checklist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #f1f5f9;
  }
  .checklist-item:last-child {
    border-bottom: none;
  }
  .check-box {
    width: 20px;
    height: 20px;
    border: 2px solid #cbd5e1;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .checklist-item .name {
    flex: 1;
    font-size: 14px;
    color: var(--navy-900, #1e3a5f);
  }
  .checklist-item .name .required {
    color: var(--warm-600, #d97706);
    font-size: 12px;
    margin-left: 4px;
  }
  .checklist-item .desc {
    font-size: 12px;
    color: #64748b;
    width: 150px;
    text-align: right;
  }

  /* 버튼 */
  .btn-row {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  .btn-primary {
    flex: 2;
    padding: 16px;
    background: linear-gradient(135deg, var(--navy-800, #243b53), var(--navy-700, #334e68));
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(30, 58, 95, 0.3);
  }
  .btn-primary:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .btn-secondary {
    flex: 1;
    padding: 16px;
    background: var(--surface-100, #f1f5f9);
    color: var(--navy-900, #1e3a5f);
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }
  .btn-secondary:hover {
    background: #e2e8f0;
  }

  /* 액션 버튼 */
  .action-section {
    margin-top: 28px;
    padding: 24px;
    background: linear-gradient(135deg, var(--navy-100, #d9e2ec), var(--surface-100, #f1f5f9));
    border-radius: 12px;
    text-align: center;
  }
  .action-section h4 {
    font-size: 15px;
    color: var(--navy-900, #1e3a5f);
    margin-bottom: 16px;
  }
  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .btn-action {
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    border: none;
  }
  .btn-action.print {
    background: white;
    color: var(--navy-900, #1e3a5f);
    border: 2px solid #e2e8f0;
  }
  .btn-action.print:hover { background: var(--surface-100, #f1f5f9); }
  .btn-action.download {
    background: var(--forest-600, #2f8132);
    color: white;
  }
  .btn-action.download:hover { background: var(--forest-700, #207227); }

  /* 반응형 */
  @media (max-width: 768px) {
    .type-selector {
      grid-template-columns: 1fr;
    }
    .form-grid {
      grid-template-columns: 1fr;
    }
    .summary-cards {
      grid-template-columns: 1fr;
    }
    .action-buttons {
      flex-direction: column;
    }
    .btn-action {
      width: 100%;
      justify-content: center;
    }
  }

  /* 애니메이션 */
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  @keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(20px); opacity: 0; }
  }

  /* 인쇄 스타일 */
  @media print {
    .step-indicator, .btn-row, .action-section {
      display: none !important;
    }
    .doc-card, .result-container {
      box-shadow: none;
      border: 1px solid #333;
    }
    .checklist-stage {
      page-break-inside: avoid;
    }
  }
</style>

<!-- 페이지 헤더 -->
<section class="gradient-navy text-white py-12 lg:py-16">
  <div class="container-wide">
    <div class="flex items-start gap-5">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
        <span class="material-symbols-outlined text-4xl text-white">fact_check</span>
      </div>
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">계약서류 원클릭 생성기</h1>
        <p class="text-navy-200 text-lg">물품/용역/공사별 필수 서류를 한 번에 확인하고 체크리스트를 생성하세요</p>
      </div>
    </div>
  </div>
</section>

<section class="section py-8">
  <div class="container-wide doc-generator">
    <!-- 스텝 인디케이터 -->
    <div class="step-indicator">
      <div class="step active" id="step1" onclick="goToStep(1)">
        <span class="step-number">1</span>
        <span>계약 유형</span>
      </div>
      <div class="step disabled" id="step2" onclick="goToStep(2)">
        <span class="step-number">2</span>
        <span>계약 정보</span>
      </div>
      <div class="step disabled" id="step3" onclick="goToStep(3)">
        <span class="step-number">3</span>
        <span>서류 선택</span>
      </div>
      <div class="step disabled" id="step4" onclick="goToStep(4)">
        <span class="step-number">4</span>
        <span>체크리스트</span>
      </div>
    </div>

    <!-- Step 1: 계약 유형 선택 -->
    <div class="doc-card" id="step1-card">
      <h3>
        <span class="material-symbols-outlined">category</span>
        계약 유형 선택
      </h3>
      <p class="desc">계약 종류를 선택하면 해당 유형에 필요한 모든 서류 목록을 확인할 수 있습니다</p>

      <div class="type-selector">
        <div class="type-btn" data-type="goods" onclick="selectType('goods')">
          <span class="material-symbols-outlined">inventory_2</span>
          <span>물품</span>
          <small>물품 구매, 납품, 검수 등<br>물품 계약 관련 서류</small>
        </div>
        <div class="type-btn" data-type="service" onclick="selectType('service')">
          <span class="material-symbols-outlined">support_agent</span>
          <span>용역</span>
          <small>유지보수, 청소, 연구 등<br>용역 계약 관련 서류</small>
        </div>
        <div class="type-btn" data-type="construction" onclick="selectType('construction')">
          <span class="material-symbols-outlined">construction</span>
          <span>공사</span>
          <small>시설공사, 수선공사 등<br>공사 계약 관련 서류</small>
        </div>
      </div>

      <button class="btn-primary" onclick="nextStep(2)" id="btn-step1" disabled style="width: 100%;">
        <span class="material-symbols-outlined">arrow_forward</span>
        다음 단계로
      </button>
    </div>

    <!-- Step 2: 계약 정보 입력 -->
    <div class="doc-card" id="step2-card" style="display: none;">
      <h3>
        <span class="material-symbols-outlined">edit_note</span>
        계약 정보 입력
      </h3>
      <p class="desc">체크리스트에 표시될 계약 기본 정보를 입력해주세요 (선택사항)</p>

      <div class="form-section">
        <h4>
          <span class="material-symbols-outlined">description</span>
          계약 기본 정보
        </h4>
        <div class="form-grid">
          <div class="form-group full">
            <label>계약명</label>
            <input type="text" id="contract_name" placeholder="예: 2025년 사무용품 구매">
          </div>
          <div class="form-group">
            <label>계약 상대방</label>
            <input type="text" id="contractor" placeholder="예: (주)실무솔루션">
          </div>
          <div class="form-group">
            <label>계약금액 (원)</label>
            <input type="text" id="contract_amount" placeholder="예: 50,000,000" oninput="formatCurrency(this)">
            <div class="cd-quick-bar">
              <span class="cd-quick-btn" onclick="cdAddQuick(100000)">+10만</span>
              <span class="cd-quick-btn" onclick="cdAddQuick(1000000)">+100만</span>
              <span class="cd-quick-btn" onclick="cdAddQuick(10000000)">+1천만</span>
              <span class="cd-quick-btn" onclick="cdAddQuick(50000000)">+5천만</span>
              <span class="cd-quick-btn" onclick="cdAddQuick(100000000)">+1억</span>
              <span class="cd-quick-btn cd-reset" onclick="cdResetQuick()">초기화</span>
            </div>
          </div>
          <div class="form-group">
            <label>계약일</label>
            <input type="date" id="contract_date">
          </div>
          <div class="form-group">
            <label>납품/준공 예정일</label>
            <input type="date" id="delivery_date">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>
          <span class="material-symbols-outlined">badge</span>
          담당자 정보
        </h4>
        <div class="form-grid">
          <div class="form-group">
            <label>담당부서</label>
            <input type="text" id="department" placeholder="예: 총무과">
          </div>
          <div class="form-group">
            <label>담당자</label>
            <input type="text" id="manager" placeholder="예: 홍길동">
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-secondary" onclick="goToStep(1)">
          <span class="material-symbols-outlined">arrow_back</span>
          이전
        </button>
        <button class="btn-primary" onclick="nextStep(3)">
          <span class="material-symbols-outlined">arrow_forward</span>
          서류 목록 보기
        </button>
      </div>
    </div>

    <!-- Step 3: 서류 선택 -->
    <div class="doc-card" id="step3-card" style="display: none;">
      <h3>
        <span class="material-symbols-outlined">checklist</span>
        <span id="step3-title">필요 서류 선택</span>
      </h3>
      <p class="desc">체크리스트에 포함할 서류를 선택하세요. 필수 서류는 자동으로 포함됩니다.</p>

      <div id="documents-container">
        <!-- 동적으로 서류 목록이 로드됨 -->
      </div>

      <div class="btn-row">
        <button class="btn-secondary" onclick="goToStep(2)">
          <span class="material-symbols-outlined">arrow_back</span>
          이전
        </button>
        <button class="btn-primary" onclick="generateChecklist()">
          <span class="material-symbols-outlined">assignment</span>
          체크리스트 생성
        </button>
      </div>
    </div>

    <!-- Step 4: 체크리스트 결과 -->
    <div class="doc-card" id="step4-card" style="display: none;">
      <div class="result-container" id="checklist-result">
        <div class="result-header">
          <h2 id="result-title">계약서류 체크리스트</h2>
          <p id="result-meta"></p>
        </div>
        <div class="result-body" id="result-body">
          <!-- 결과가 동적으로 생성됨 -->
        </div>
      </div>

      <div class="action-section">
        <h4>체크리스트 저장 및 활용</h4>
        <div class="action-buttons">
          <button class="btn-action print" onclick="window.print()">
            <span class="material-symbols-outlined">print</span>
            인쇄하기
          </button>
          <button class="btn-action download" onclick="downloadChecklist()">
            <span class="material-symbols-outlined">download</span>
            체크리스트 저장
          </button>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-secondary" onclick="goToStep(3)">
          <span class="material-symbols-outlined">arrow_back</span>
          서류 수정
        </button>
        <button class="btn-primary" onclick="resetForm()">
          <span class="material-symbols-outlined">refresh</span>
          새로 만들기
        </button>
      </div>
    </div>
  </div>
</section>

<script>
  // HTML 이스케이프 헬퍼
  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // 상태 (var: Turbo 재평가 시 재선언 허용)
  var currentStep = 1;
  var selectedType = null;
  var documentsData = null;
  var selectedDocuments = new Set();
  var checklistResult = null;

  // 계약 유형 선택
  function selectType(type) {
    selectedType = type;
    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.classList.toggle('selected', btn.dataset.type === type);
    });
    document.getElementById('btn-step1').disabled = false;
  }

  // 스텝 인디케이터 업데이트
  function updateStepIndicator() {
    for (let i = 1; i <= 4; i++) {
      const step = document.getElementById(`step${i}`);
      step.classList.remove('active', 'done', 'disabled');
      if (i < currentStep) step.classList.add('done');
      else if (i === currentStep) step.classList.add('active');
      else step.classList.add('disabled');
    }
  }

  function goToStep(step) {
    if (step > currentStep) return;
    currentStep = step;
    updateStepIndicator();
    showCurrentStep();
  }

  async function nextStep(step) {
    if (step === 2 && !selectedType) {
      showToast('계약 유형을 선택해주세요.');
      return;
    }

    currentStep = step;
    updateStepIndicator();

    // 스텝 활성화
    for (let i = 2; i <= step; i++) {
      document.getElementById(`step${i}`).classList.remove('disabled');
    }

    showCurrentStep();

    // 스텝 3에서 서류 목록 로드
    if (step === 3) {
      await loadDocuments();
    }
  }

  function showCurrentStep() {
    document.getElementById('step1-card').style.display = currentStep === 1 ? 'block' : 'none';
    document.getElementById('step2-card').style.display = currentStep === 2 ? 'block' : 'none';
    document.getElementById('step3-card').style.display = currentStep === 3 ? 'block' : 'none';
    document.getElementById('step4-card').style.display = currentStep === 4 ? 'block' : 'none';
  }

  // 서류 목록 로드
  async function loadDocuments() {
    const container = document.getElementById('documents-container');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">서류 목록을 불러오는 중...</div>';

    try {
      const response = await fetch(`/contract-documents/documents/${selectedType}`, {
        headers: { 'Accept': 'application/json' }
      });
      const data = await response.json();
      documentsData = data.documents;

      // 제목 업데이트
      const typeNames = { goods: '물품', service: '용역', construction: '공사' };
      document.getElementById('step3-title').textContent = `${typeNames[selectedType]} 계약 필요 서류`;

      // 필수 서류 자동 선택
      selectedDocuments.clear();
      Object.values(documentsData.stages).forEach(stage => {
        stage.documents.forEach(doc => {
          if (doc.required) {
            selectedDocuments.add(doc.id);
          }
        });
      });

      renderDocuments();
    } catch (error) {
      console.error('Error loading documents:', error);
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">서류 목록을 불러오는데 실패했습니다.</div>';
    }
  }

  // 서류 목록 렌더링
  function renderDocuments() {
    const container = document.getElementById('documents-container');
    let html = '';

    Object.entries(documentsData.stages).forEach(([stageKey, stage]) => {
      const requiredCount = stage.documents.filter(d => d.required).length;
      const totalCount = stage.documents.length;

      html += `
        <div class="stage-section">
          <div class="stage-header open" onclick="toggleStage(this)">
            <div class="left">
              <div class="icon-box">
                <span class="material-symbols-outlined">${stage.icon}</span>
              </div>
              <div>
                <div class="stage-name">${stage.name}</div>
                <div class="stage-count">필수 ${requiredCount}개 / 총 ${totalCount}개</div>
              </div>
            </div>
            <span class="material-symbols-outlined toggle-icon">expand_more</span>
          </div>
          <div class="stage-body open">
      `;

      stage.documents.forEach(doc => {
        const isChecked = selectedDocuments.has(doc.id);
        html += `
          <div class="doc-item ${isChecked ? 'checked' : ''}" onclick="toggleDocument('${doc.id}', ${doc.required})">
            <div class="doc-checkbox">
              <span class="material-symbols-outlined">check</span>
            </div>
            <div class="doc-info">
              <div class="doc-name">
                ${doc.name}
                ${doc.required ? '<span class="required-badge">필수</span>' : ''}
              </div>
              <div class="doc-desc">${doc.description}</div>
            </div>
          </div>
        `;
      });

      html += `
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // 단계 토글
  function toggleStage(header) {
    header.classList.toggle('open');
    const body = header.nextElementSibling;
    body.classList.toggle('open');
  }

  // 서류 선택 토글
  function toggleDocument(docId, isRequired) {
    if (isRequired) {
      showToast('필수 서류는 해제할 수 없습니다.');
      return;
    }

    if (selectedDocuments.has(docId)) {
      selectedDocuments.delete(docId);
    } else {
      selectedDocuments.add(docId);
    }

    renderDocuments();
  }

  // 체크리스트 생성
  async function generateChecklist() {
    const generateBtn = document.querySelector('#step3-card .btn-primary');
    const originalText = generateBtn.innerHTML;
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="material-symbols-outlined" style="animation:spin 1s linear infinite">hourglass_empty</span> 생성 중...';

    const contractInfo = {
      contract_name: document.getElementById('contract_name').value,
      contractor: document.getElementById('contractor').value,
      contract_amount: document.getElementById('contract_amount').value,
      contract_date: document.getElementById('contract_date').value,
      delivery_date: document.getElementById('delivery_date').value,
      department: document.getElementById('department').value,
      manager: document.getElementById('manager').value
    };

    try {
      const response = await fetch('/contract-documents/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify({
          contract_type: selectedType,
          ...contractInfo,
          selected_documents: Array.from(selectedDocuments)
        })
      });

      const result = await response.json();

      if (result.success) {
        checklistResult = result.checklist;
        renderChecklist(result.checklist);
        document.getElementById('step4').classList.remove('disabled');
        currentStep = 4;
        updateStepIndicator();
        showCurrentStep();
        showToast('체크리스트가 생성되었습니다!');
      } else {
        showToast(result.error || '체크리스트 생성에 실패했습니다.');
      }
    } catch (error) {
      console.error('Error generating checklist:', error);
      showToast('서버와 통신할 수 없습니다. 잠시 후 다시 시도해주세요.');
    } finally {
      generateBtn.disabled = false;
      generateBtn.innerHTML = originalText;
    }
  }

  // 체크리스트 렌더링
  function renderChecklist(checklist) {
    const typeNames = { goods: '물품', service: '용역', construction: '공사' };

    // 메타 정보
    let metaText = `${checklist.contract_type} 계약`;
    if (checklist.contract_info.contract_name) {
      metaText = checklist.contract_info.contract_name;
    }
    document.getElementById('result-meta').textContent = `${metaText} | 생성일: ${checklist.generated_at}`;

    // 본문
    let html = '';

    // 계약 정보 요약 (사용자 입력 이스케이프 처리)
    const ci = checklist.contract_info;
    if (ci.contractor || ci.contract_amount) {
      html += `<div style="padding: 20px; background: var(--surface-50); border-radius: 12px; margin-bottom: 24px;">`;
      html += `<h4 style="font-size: 14px; font-weight: 600; color: var(--navy-800); margin-bottom: 12px;">계약 정보</h4>`;
      html += `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">`;

      if (ci.contractor) {
        html += `<div><span style="color: #64748b;">계약 상대방:</span> <strong>${escapeHtml(ci.contractor)}</strong></div>`;
      }
      if (ci.contract_amount) {
        html += `<div><span style="color: #64748b;">계약금액:</span> <strong>${escapeHtml(ci.contract_amount)}원</strong></div>`;
      }
      if (ci.contract_date) {
        html += `<div><span style="color: #64748b;">계약일:</span> <strong>${escapeHtml(ci.contract_date)}</strong></div>`;
      }
      if (ci.delivery_date) {
        html += `<div><span style="color: #64748b;">납품/준공일:</span> <strong>${escapeHtml(ci.delivery_date)}</strong></div>`;
      }
      if (ci.department) {
        html += `<div><span style="color: #64748b;">담당부서:</span> <strong>${escapeHtml(ci.department)}</strong></div>`;
      }
      if (ci.manager) {
        html += `<div><span style="color: #64748b;">담당자:</span> <strong>${escapeHtml(ci.manager)}</strong></div>`;
      }

      html += `</div></div>`;
    }

    // 통계 요약
    let totalDocs = 0;
    let requiredDocs = 0;
    checklist.stages.forEach(stage => {
      totalDocs += stage.documents.length;
      requiredDocs += stage.documents.filter(d => d.required).length;
    });

    html += `
      <div class="summary-cards">
        <div class="summary-card">
          <div class="value">${totalDocs}</div>
          <div class="label">총 서류</div>
        </div>
        <div class="summary-card">
          <div class="value" style="color: var(--warm-600);">${requiredDocs}</div>
          <div class="label">필수 서류</div>
        </div>
        <div class="summary-card">
          <div class="value" style="color: var(--forest-600);">${checklist.stages.length}</div>
          <div class="label">진행 단계</div>
        </div>
      </div>
    `;

    // 단계별 체크리스트
    checklist.stages.forEach(stage => {
      html += `
        <div class="checklist-stage">
          <h4>
            <span class="material-symbols-outlined">${stage.icon}</span>
            ${stage.stage}
          </h4>
      `;

      stage.documents.forEach(doc => {
        html += `
          <div class="checklist-item">
            <div class="check-box"></div>
            <div class="name">
              ${doc.name}
              ${doc.required ? '<span class="required">(필수)</span>' : ''}
            </div>
            <div class="desc">${doc.description}</div>
          </div>
        `;
      });

      html += `</div>`;
    });

    document.getElementById('result-body').innerHTML = html;
  }

  // 체크리스트 다운로드
  function downloadChecklist() {
    if (!checklistResult) return;

    let text = `===========================================\n`;
    text += `계약서류 체크리스트\n`;
    text += `===========================================\n\n`;

    text += `계약유형: ${checklistResult.contract_type}\n`;
    if (checklistResult.contract_info.contract_name) {
      text += `계약명: ${checklistResult.contract_info.contract_name}\n`;
    }
    if (checklistResult.contract_info.contractor) {
      text += `계약상대방: ${checklistResult.contract_info.contractor}\n`;
    }
    if (checklistResult.contract_info.contract_amount) {
      text += `계약금액: ${checklistResult.contract_info.contract_amount}원\n`;
    }
    text += `생성일: ${checklistResult.generated_at}\n\n`;

    checklistResult.stages.forEach(stage => {
      text += `-------------------------------------------\n`;
      text += `[${stage.stage}]\n`;
      text += `-------------------------------------------\n`;

      stage.documents.forEach(doc => {
        const required = doc.required ? ' (필수)' : '';
        text += `[ ] ${doc.name}${required}\n`;
        text += `    - ${doc.description}\n`;
      });
      text += `\n`;
    });

    text += `\n실무(silmu.kr)에서 생성됨`;

    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `계약서류체크리스트_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('체크리스트가 다운로드되었습니다!');
  }

  // 폼 초기화
  function resetForm() {
    selectedType = null;
    documentsData = null;
    selectedDocuments.clear();
    checklistResult = null;

    document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('btn-step1').disabled = true;

    // 입력 필드 초기화
    ['contract_name', 'contractor', 'contract_amount', 'contract_date', 'delivery_date', 'department', 'manager'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    currentStep = 1;
    updateStepIndicator();
    showCurrentStep();
  }

  // 통화 형식
  function formatCurrency(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value) {
      input.value = parseInt(value).toLocaleString('ko-KR');
    }
  }

  window.cdAddQuick = function(amount) {
    var el = document.getElementById('contract_amount');
    if (!el) return;
    var cur = parseInt(el.value.replace(/[^0-9]/g, '')) || 0;
    el.value = (cur + amount).toLocaleString('ko-KR');
  };

  window.cdResetQuick = function() {
    var el = document.getElementById('contract_amount');
    if (!el) return;
    el.value = '';
    el.focus();
  };

  // 토스트
  function showToast(message) {
    const existingToast = document.querySelector('.doc-toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'doc-toast';
    toast.style.cssText = `
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      background: #1e3a5f;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

</script>
