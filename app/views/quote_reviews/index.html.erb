<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê²¬ì ì„œ ê²€í†  ì‹œìŠ¤í…œ | ì‹¤ë¬´</title>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <style>
    @page { size: A4; margin: 15mm; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Pretendard', 'ë§‘ì€ ê³ ë”•', sans-serif;
      font-size: 14px;
      line-height: 1.6;
      background: #f8fafc;
      color: #1e3a5f;
    }

    /* ë¸Œëœë“œ ìƒ‰ìƒ */
    :root {
      --navy-900: #1e3a5f;
      --navy-700: #2d4a6f;
      --navy-600: #3d5a7f;
      --navy-100: #e8eef5;
      --forest-600: #2e7d32;
      --forest-500: #4caf50;
      --forest-100: #e8f5e9;
      --warm-500: #f59e0b;
      --warm-100: #fef3c7;
      --red-500: #ef4444;
      --red-100: #fee2e2;
      --surface-100: #f1f5f9;
    }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, var(--navy-900) 0%, var(--navy-700) 100%);
      color: white;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(30, 58, 95, 0.15);
    }
    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: white;
    }
    .header-title {
      font-size: 16px;
      font-weight: 600;
      padding-left: 16px;
      border-left: 1px solid rgba(255,255,255,0.3);
    }
    .header-nav {
      display: flex;
      gap: 8px;
    }
    .header-nav a {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .header-nav a:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      min-height: calc(100vh - 64px);
    }

    /* ì™¼ìª½: ì—…ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸° */
    .viewer-panel {
      width: 50%;
      background: var(--navy-900);
      padding: 24px;
      overflow-y: auto;
    }
    .upload-zone {
      border: 3px dashed rgba(255,255,255,0.3);
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--forest-500);
      background: rgba(46, 125, 50, 0.1);
    }
    .upload-zone .material-symbols-outlined {
      font-size: 64px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 16px;
    }
    .upload-zone h3 {
      color: white;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .upload-zone p {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }
    .upload-zone input { display: none; }
    .file-types {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .file-type {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .file-type.image { background: #dbeafe; color: #1e40af; }
    .file-type.pdf { background: #fce7f3; color: #9d174d; }
    .file-type.excel { background: #dcfce7; color: #166534; }

    .preview-container { display: none; }
    .preview-container.show { display: block; }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .preview-header h3 {
      color: white;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn-remove {
      background: var(--red-500);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .preview-image { width: 100%; border-radius: 12px; background: white; }
    .preview-pdf { width: 100%; height: calc(100vh - 180px); border: none; border-radius: 12px; }
    .preview-excel {
      background: white;
      border-radius: 12px;
      padding: 16px;
      max-height: calc(100vh - 180px);
      overflow: auto;
    }
    .excel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .excel-table th, .excel-table td {
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      text-align: left;
    }
    .excel-table th {
      background: var(--forest-100);
      color: var(--forest-600);
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    .excel-table tr:hover { background: #f8fafc; }
    .sheet-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    .sheet-tab {
      padding: 8px 16px;
      background: #e5e7eb;
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-size: 13px;
    }
    .sheet-tab.active {
      background: var(--forest-500);
      color: white;
    }

    /* ì˜¤ë¥¸ìª½: ì…ë ¥/ê²°ê³¼ íŒ¨ë„ */
    .input-panel {
      width: 50%;
      padding: 24px;
      overflow-y: auto;
      max-height: calc(100vh - 64px);
    }

    /* ìŠ¤í… ì¸ë””ì¼€ì´í„° */
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 30px;
      background: var(--surface-100);
      color: #64748b;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .step:hover:not(.disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .step.active {
      background: var(--forest-600);
      color: white;
    }
    .step.done {
      background: var(--navy-900);
      color: white;
    }
    .step.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    /* ì¹´ë“œ */
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }
    .card h3 {
      color: var(--navy-900);
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card.highlight {
      border: 2px solid var(--forest-500);
      background: linear-gradient(to bottom right, #f0fdf4, #ffffff);
    }

    /* ì¢…ë¥˜ ì„ íƒ ë²„íŠ¼ */
    .type-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .type-btn {
      padding: 24px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .type-btn:hover {
      border-color: var(--forest-500);
      transform: translateY(-2px);
    }
    .type-btn.selected {
      border-color: var(--forest-600);
      background: var(--forest-100);
    }
    .type-btn .material-symbols-outlined {
      font-size: 40px;
      color: var(--navy-600);
      margin-bottom: 8px;
    }
    .type-btn.selected .material-symbols-outlined {
      color: var(--forest-600);
    }
    .type-btn span {
      display: block;
      font-size: 15px;
      font-weight: 600;
      color: var(--navy-900);
    }
    .type-btn small {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
      display: block;
    }

    /* í¼ ê·¸ë¦¬ë“œ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group.full {
      grid-column: 1 / -1;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--navy-900);
      font-size: 14px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--forest-500);
    }
    .form-group .hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }

    /* ê³„ì•½ë°©ë²• ë¼ë””ì˜¤ */
    .radio-group {
      display: flex;
      gap: 12px;
    }
    .radio-btn {
      flex: 1;
      padding: 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .radio-btn:hover {
      border-color: var(--forest-500);
    }
    .radio-btn.selected {
      border-color: var(--forest-600);
      background: var(--forest-100);
    }
    .radio-btn input { display: none; }

    /* ë¹ ë¥¸ ì…ë ¥ ë²„íŠ¼ */
    .quick-input {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    .quick-input button {
      padding: 10px;
      background: var(--navy-100);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--navy-700);
      transition: all 0.2s;
    }
    .quick-input button:hover {
      background: var(--forest-100);
      color: var(--forest-600);
    }

    /* ì²´í¬ë¦¬ìŠ¤íŠ¸ */
    .checklist-section h4 {
      font-size: 15px;
      font-weight: 600;
      color: var(--navy-900);
      margin: 20px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--surface-100);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .checklist-item:hover {
      background: #e2e8f0;
    }
    .checklist-item.checked {
      background: var(--forest-100);
    }
    .checklist-item.unchecked {
      background: var(--red-100);
    }
    .checklist-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--forest-600);
    }
    .checklist-item label {
      flex: 1;
      cursor: pointer;
      font-size: 14px;
    }

    /* ë¶„ì„ ë²„íŠ¼ */
    .btn-analyze {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--forest-600), var(--forest-500));
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      margin-top: 20px;
    }
    .btn-analyze:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(46, 125, 50, 0.3);
    }

    /* ë¦¬í¬íŠ¸ */
    .report { display: none; }
    .report.show { display: block; }
    .report-header {
      text-align: center;
      padding: 32px;
      background: linear-gradient(135deg, var(--navy-900), var(--navy-700));
      color: white;
      border-radius: 16px 16px 0 0;
      margin: -24px -24px 24px -24px;
    }
    .report-header h2 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .report-header p {
      opacity: 0.8;
      font-size: 14px;
    }

    /* ì ìˆ˜ ë°•ìŠ¤ */
    .score-box {
      text-align: center;
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    .score-box.excellent {
      background: linear-gradient(135deg, var(--forest-600), #4ade80);
      color: white;
    }
    .score-box.good {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
    }
    .score-box.warning {
      background: linear-gradient(135deg, var(--warm-500), #fbbf24);
      color: white;
    }
    .score-box.poor {
      background: linear-gradient(135deg, var(--red-500), #f87171);
      color: white;
    }
    .score-number {
      font-size: 72px;
      font-weight: 700;
      line-height: 1;
    }
    .score-number span {
      font-size: 32px;
      opacity: 0.8;
    }
    .score-label {
      font-size: 18px;
      margin-top: 8px;
      opacity: 0.9;
    }
    .score-grade {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
    }

    /* ìš”ì•½ ë°•ìŠ¤ */
    .summary-box {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .summary-item {
      text-align: center;
      padding: 20px 16px;
      border-radius: 12px;
    }
    .summary-item.pass { background: var(--forest-100); color: var(--forest-600); }
    .summary-item.warn { background: var(--warm-100); color: #92400e; }
    .summary-item.fail { background: var(--red-100); color: #991b1b; }
    .summary-item .number {
      font-size: 32px;
      font-weight: 700;
    }
    .summary-item .label {
      font-size: 13px;
      margin-top: 4px;
    }

    /* ë¦¬í¬íŠ¸ ì„¹ì…˜ */
    .report-section {
      margin-bottom: 24px;
      padding: 20px;
      background: var(--surface-100);
      border-radius: 12px;
      border-left: 4px solid var(--navy-900);
    }
    .report-section h4 {
      font-size: 16px;
      font-weight: 700;
      color: var(--navy-900);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ì²´í¬ ì•„ì´í…œ */
    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: white;
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .check-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .check-icon.pass { background: var(--forest-100); color: var(--forest-600); }
    .check-icon.warn { background: var(--warm-100); color: #92400e; }
    .check-icon.fail { background: var(--red-100); color: var(--red-500); }
    .check-icon.info { background: var(--navy-100); color: var(--navy-700); }
    .check-content { flex: 1; }
    .check-content strong {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--navy-900);
      margin-bottom: 4px;
    }
    .check-content p {
      font-size: 13px;
      color: #64748b;
      margin: 0;
    }

    /* í•„ìš” ì„œë¥˜ ì„¹ì…˜ */
    .docs-list {
      display: grid;
      gap: 8px;
    }
    .doc-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: white;
      border-radius: 10px;
    }
    .doc-item .material-symbols-outlined {
      color: var(--navy-600);
    }
    .doc-item.required .material-symbols-outlined {
      color: var(--red-500);
    }
    .doc-item span {
      flex: 1;
      font-size: 14px;
    }
    .doc-item .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .doc-item .badge.required {
      background: var(--red-100);
      color: var(--red-500);
    }
    .doc-item .badge.optional {
      background: var(--navy-100);
      color: var(--navy-700);
    }

    /* ê´€ë ¨ ê·œì • */
    .regulation-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: white;
      border-radius: 10px;
      margin-bottom: 8px;
      text-decoration: none;
      color: var(--navy-900);
      transition: all 0.2s;
    }
    .regulation-item:hover {
      background: var(--navy-100);
    }
    .regulation-item .material-symbols-outlined {
      color: var(--forest-600);
    }

    /* ê¶Œê³ ì‚¬í•­ */
    .recommendation {
      background: linear-gradient(to right, var(--navy-100), white);
      border: 2px solid var(--navy-900);
      border-radius: 12px;
      padding: 20px;
    }
    .recommendation h4 {
      color: var(--navy-900);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .recommendation ul {
      margin: 0;
      padding-left: 20px;
    }
    .recommendation li {
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--navy-700);
    }

    /* ë©´ì±… ì¡°í•­ */
    .disclaimer {
      margin-top: 24px;
      padding: 16px;
      background: #fef3c7;
      border-radius: 10px;
      border-left: 4px solid var(--warm-500);
    }
    .disclaimer h5 {
      font-size: 13px;
      color: #92400e;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .disclaimer ul {
      margin: 0;
      padding-left: 16px;
      font-size: 12px;
      color: #92400e;
    }
    .disclaimer li {
      margin-bottom: 4px;
    }

    /* ë°”ì´ëŸ´ ìš”ì†Œ */
    .viral-section {
      margin-top: 24px;
      padding: 20px;
      background: linear-gradient(135deg, var(--forest-100), white);
      border-radius: 12px;
      text-align: center;
    }
    .viral-counter {
      font-size: 14px;
      color: var(--forest-600);
      margin-bottom: 12px;
    }
    .viral-counter strong {
      font-size: 18px;
    }
    .viral-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .btn-viral {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-share {
      background: var(--forest-600);
      color: white;
      border: none;
    }
    .btn-share:hover {
      background: var(--forest-500);
    }
    .btn-pdf {
      background: #dc2626;
      color: white;
      border: none;
    }
    .btn-pdf:hover {
      background: #b91c1c;
    }
    .btn-print {
      background: white;
      color: var(--navy-900);
      border: 2px solid #e2e8f0;
    }
    .btn-print:hover {
      background: var(--surface-100);
    }

    /* ë‹¤ìŒ ë‹¨ê³„ ì„¹ì…˜ */
    .next-step-section {
      margin-top: 24px;
      padding: 24px;
      background: linear-gradient(135deg, var(--navy-100), white);
      border-radius: 12px;
      border: 2px solid var(--navy-900);
    }
    .next-step-section h4 {
      font-size: 16px;
      font-weight: 700;
      color: var(--navy-900);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .next-step-section p {
      font-size: 14px;
      color: var(--navy-700);
      margin-bottom: 16px;
    }
    .btn-next-step {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 24px;
      background: var(--navy-900);
      color: white;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
    }
    .btn-next-step:hover {
      background: var(--navy-700);
      transform: translateY(-2px);
    }
    .badge-coming {
      padding: 4px 8px;
      background: var(--warm-500);
      color: white;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      background: var(--navy-900);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 1024px) {
      .main-container {
        flex-direction: column;
      }
      .viewer-panel, .input-panel {
        width: 100%;
        max-height: none;
      }
      .viewer-panel {
        min-height: 300px;
      }
    }

    @media print {
      .header, .viewer-panel, .step-indicator, .toast, .viral-section { display: none !important; }
      body { background: white; }
      .main-container { display: block; }
      .input-panel { width: 100%; max-height: none; padding: 0; }
      .report { display: block !important; }
      .card { box-shadow: none; break-inside: avoid; }
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(30, 58, 95, 0.9);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay.show {
      display: flex;
    }
    .loading-spinner {
      width: 60px; height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #4caf50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header">
    <div class="header-inner">
      <div class="header-left">
        <a href="/" class="logo">
          <span class="material-symbols-outlined">verified</span>
          ì‹¤ë¬´
        </a>
        <span class="header-title">ê²¬ì ì„œ ê²€í†  ì‹œìŠ¤í…œ</span>
      </div>
      <nav class="header-nav">
        <a href="/">
          <span class="material-symbols-outlined">home</span>
          í™ˆ
        </a>
        <a href="/topics/private-contract">
          <span class="material-symbols-outlined">description</span>
          ìˆ˜ì˜ê³„ì•½ ê°€ì´ë“œ
        </a>
        <a href="/tools">
          <span class="material-symbols-outlined">handyman</span>
          ì‹¤ë¬´ ë„êµ¬
        </a>
      </nav>
    </div>
  </header>

  <div class="main-container">
    <!-- ì™¼ìª½: ê²¬ì ì„œ ì—…ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸° -->
    <div class="viewer-panel">
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
        <span class="material-symbols-outlined">cloud_upload</span>
        <h3>ê²¬ì ì„œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
        <p>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
        <div class="file-types">
          <span class="file-type image">ğŸ“· ì´ë¯¸ì§€</span>
          <span class="file-type pdf">ğŸ“‘ PDF</span>
          <span class="file-type excel">ğŸ“Š Excel</span>
        </div>
        <input type="file" id="file-input" accept="image/*,.pdf,.xlsx,.xls" onchange="handleFileSelect(event)">
      </div>

      <div class="preview-container" id="preview-container">
        <div class="preview-header">
          <h3>
            <span class="material-symbols-outlined">description</span>
            ì—…ë¡œë“œëœ ê²¬ì ì„œ
          </h3>
          <button class="btn-remove" onclick="removeFile()">ì‚­ì œ</button>
        </div>
        <div id="preview-content"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì…ë ¥ ë° ë¶„ì„ -->
    <div class="input-panel">
      <div class="step-indicator">
        <div class="step active" id="step1" onclick="goToStep(1)">
          <span class="step-number">1</span>
          <span>ì¢…ë¥˜ ì„ íƒ</span>
        </div>
        <div class="step disabled" id="step2" onclick="goToStep(2)">
          <span class="step-number">2</span>
          <span>ì •ë³´ ì…ë ¥</span>
        </div>
        <div class="step disabled" id="step3" onclick="goToStep(3)">
          <span class="step-number">3</span>
          <span>ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
        </div>
        <div class="step disabled" id="step4" onclick="goToStep(4)">
          <span class="step-number">4</span>
          <span>ê²°ê³¼</span>
        </div>
      </div>

      <!-- Step 1: ì¢…ë¥˜ ì„ íƒ -->
      <div class="card" id="step1-card">
        <h3>
          <span class="material-symbols-outlined">category</span>
          ê²¬ì ì„œ ì¢…ë¥˜ ì„ íƒ
        </h3>
        <p style="color: #64748b; margin-bottom: 20px;">ê²€í† í•  ê²¬ì ì„œì˜ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>

        <div class="type-selector">
          <div class="type-btn" data-type="construction" onclick="selectType('construction')">
            <span class="material-symbols-outlined">construction</span>
            <span>ê³µì‚¬</span>
            <small>ì‹œì„¤ê³µì‚¬, ìˆ˜ì„ ê³µì‚¬ ë“±</small>
          </div>
          <div class="type-btn" data-type="goods" onclick="selectType('goods')">
            <span class="material-symbols-outlined">inventory_2</span>
            <span>ë¬¼í’ˆ</span>
            <small>ë¹„í’ˆ, ì†Œëª¨í’ˆ, ì¥ë¹„ ë“±</small>
          </div>
          <div class="type-btn" data-type="service" onclick="selectType('service')">
            <span class="material-symbols-outlined">support_agent</span>
            <span>ìš©ì—­</span>
            <small>ì—°êµ¬ìš©ì—­, ì‹œìŠ¤í…œê°œë°œ ë“±</small>
          </div>
        </div>

        <button class="btn-analyze" onclick="nextStep(2)" id="btn-step1" disabled>
          <span class="material-symbols-outlined">arrow_forward</span>
          ë‹¤ìŒ ë‹¨ê³„ë¡œ
        </button>
      </div>

      <!-- Step 2: ê¸°ë³¸ ì •ë³´ ì…ë ¥ -->
      <div class="card highlight" id="step2-card" style="display: none;">
        <h3>
          <span class="material-symbols-outlined">edit_note</span>
          ê¸°ë³¸ ì •ë³´ ì…ë ¥
        </h3>

        <div class="form-grid">
          <div class="form-group">
            <label>ì¶”ì •ê°€ê²© (ì›) *</label>
            <input type="number" id="estimated_price" placeholder="10000000" onchange="formatPriceDisplay('estimated')">
            <div class="hint" id="estimated_display"></div>
          </div>
          <div class="form-group">
            <label>ê²¬ì  ì´ì•¡ (VAT í¬í•¨)</label>
            <input type="number" id="total_price" placeholder="11000000" onchange="formatPriceDisplay('total')">
            <div class="hint" id="total_display"></div>
          </div>
        </div>

        <div class="quick-input">
          <button onclick="setPrice(5000000)">500ë§Œì›</button>
          <button onclick="setPrice(10000000)">1,000ë§Œì›</button>
          <button onclick="setPrice(20000000)">2,000ë§Œì›</button>
          <button onclick="setPrice(50000000)">5,000ë§Œì›</button>
          <button onclick="setPrice(200000000)">2ì–µì›</button>
          <button onclick="setPrice(100000000)">1ì–µì›</button>
        </div>

        <div class="form-group full" style="margin-top: 20px;">
          <label>ê³„ì•½ ë°©ë²• *</label>
          <div class="radio-group">
            <div class="radio-btn" onclick="selectContractMethod('private')">
              <input type="radio" name="contract_method" value="private">
              ìˆ˜ì˜ê³„ì•½
            </div>
            <div class="radio-btn" onclick="selectContractMethod('bidding')">
              <input type="radio" name="contract_method" value="bidding">
              ì…ì°°
            </div>
          </div>
        </div>

        <div class="form-grid" style="margin-top: 16px;">
          <div class="form-group">
            <label>ì—…ì²´ëª…</label>
            <input type="text" id="company_name" placeholder="(ì£¼)OOìƒì‚¬">
          </div>
          <div class="form-group">
            <label>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label>
            <input type="text" id="biz_number" placeholder="123-45-67890">
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn-analyze" style="flex: 1; background: var(--surface-100); color: var(--navy-900);" onclick="goToStep(1)">
            <span class="material-symbols-outlined">arrow_back</span>
            ì´ì „
          </button>
          <button class="btn-analyze" style="flex: 2;" onclick="nextStep(3)" id="btn-step2">
            <span class="material-symbols-outlined">arrow_forward</span>
            ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ
          </button>
        </div>
      </div>

      <!-- Step 3: ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
      <div class="card" id="step3-card" style="display: none;">
        <h3>
          <span class="material-symbols-outlined">checklist</span>
          ê²¬ì ì„œ ì²´í¬ë¦¬ìŠ¤íŠ¸
        </h3>
        <p style="color: #64748b; margin-bottom: 20px;">ì—…ë¡œë“œí•œ ê²¬ì ì„œë¥¼ ë³´ë©´ì„œ í•´ë‹¹ í•­ëª©ì„ ì²´í¬í•´ì£¼ì„¸ìš”</p>

        <div class="checklist-section" id="checklist-basic">
          <h4>
            <span class="material-symbols-outlined">business</span>
            ì—…ì²´ ì •ë³´
          </h4>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_company_name" onchange="updateChecklistUI(this)">
            <label for="chk_company_name">ì—…ì²´ëª… (ìƒí˜¸) ê¸°ì¬</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_biz_number" onchange="updateChecklistUI(this)">
            <label for="chk_biz_number">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ê¸°ì¬</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_representative" onchange="updateChecklistUI(this)">
            <label for="chk_representative">ëŒ€í‘œìëª… ê¸°ì¬</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_contact" onchange="updateChecklistUI(this)">
            <label for="chk_contact">ì—°ë½ì²˜ ê¸°ì¬</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_seal" onchange="updateChecklistUI(this)">
            <label for="chk_seal">ë‚ ì¸ ë˜ëŠ” ì„œëª…</label>
          </div>
        </div>

        <div class="checklist-section" id="checklist-price">
          <h4>
            <span class="material-symbols-outlined">payments</span>
            ê¸ˆì•¡ ì •ë³´
          </h4>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_item_name" onchange="updateChecklistUI(this)">
            <label for="chk_item_name">í’ˆëª… ëª…ì‹œ</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_spec" onchange="updateChecklistUI(this)">
            <label for="chk_spec">ê·œê²© ëª…ì‹œ</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_quantity" onchange="updateChecklistUI(this)">
            <label for="chk_quantity">ìˆ˜ëŸ‰ ëª…ì‹œ</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_unit_price" onchange="updateChecklistUI(this)">
            <label for="chk_unit_price">ë‹¨ê°€ ëª…ì‹œ</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_total" onchange="updateChecklistUI(this)">
            <label for="chk_total">í•©ê³„ê¸ˆì•¡ ê¸°ì¬</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_vat" onchange="updateChecklistUI(this)">
            <label for="chk_vat">ë¶€ê°€ì„¸ ë³„ë„ í‘œê¸°</label>
          </div>
        </div>

        <div class="checklist-section" id="checklist-etc">
          <h4>
            <span class="material-symbols-outlined">info</span>
            ê¸°íƒ€ ì •ë³´
          </h4>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_valid_period" onchange="updateChecklistUI(this)">
            <label for="chk_valid_period">ê²¬ì  ìœ íš¨ê¸°ê°„ ê¸°ì¬</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_delivery" onchange="updateChecklistUI(this)">
            <label for="chk_delivery">ë‚©í’ˆê¸°í•œ ê¸°ì¬</label>
          </div>
        </div>

        <!-- ê³µì‚¬ íŠ¹í™” ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        <div class="checklist-section" id="checklist-construction" style="display: none;">
          <h4>
            <span class="material-symbols-outlined">construction</span>
            ê³µì‚¬ íŠ¹í™” í•­ëª©
          </h4>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_indirect_labor" onchange="updateChecklistUI(this)">
            <label for="chk_indirect_labor">ê°„ì ‘ë…¸ë¬´ë¹„ í¬í•¨</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_insurance" onchange="updateChecklistUI(this)">
            <label for="chk_insurance">ì‚°ì¬ë³´í—˜ë£Œ í¬í•¨</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_safety" onchange="updateChecklistUI(this)">
            <label for="chk_safety">ì•ˆì „ê´€ë¦¬ë¹„ í¬í•¨</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_warranty" onchange="updateChecklistUI(this)">
            <label for="chk_warranty">í•˜ìë³´ì¦ ê¸°ê°„ ëª…ì‹œ</label>
          </div>
        </div>

        <!-- ìš©ì—­ íŠ¹í™” ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        <div class="checklist-section" id="checklist-service" style="display: none;">
          <h4>
            <span class="material-symbols-outlined">support_agent</span>
            ìš©ì—­ íŠ¹í™” í•­ëª©
          </h4>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_labor_cost" onchange="updateChecklistUI(this)">
            <label for="chk_labor_cost">ì¸ê±´ë¹„ ì‚°ì¶œë‚´ì—­</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_direct_cost" onchange="updateChecklistUI(this)">
            <label for="chk_direct_cost">ì§ì ‘ê²½ë¹„ ë‚´ì—­</label>
          </div>
          <div class="checklist-item" onclick="toggleCheck(this)">
            <input type="checkbox" id="chk_tech_fee" onchange="updateChecklistUI(this)">
            <label for="chk_tech_fee">ê¸°ìˆ ë£Œ ì ì •ì„±</label>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn-analyze" style="flex: 1; background: var(--surface-100); color: var(--navy-900);" onclick="goToStep(2)">
            <span class="material-symbols-outlined">arrow_back</span>
            ì´ì „
          </button>
          <button class="btn-analyze" style="flex: 2;" onclick="analyzeQuotation()">
            <span class="material-symbols-outlined">analytics</span>
            ê²€í†  ê²°ê³¼ ë³´ê¸°
          </button>
        </div>
      </div>

      <!-- Step 4: ê²°ê³¼ ë¦¬í¬íŠ¸ -->
      <div class="card report report-card" id="report-section">
        <div class="report-header">
          <h2>ê²¬ì ì„œ ê²€í†  ë¦¬í¬íŠ¸</h2>
          <p id="report-date"></p>
        </div>

        <!-- ì ìˆ˜ ë°•ìŠ¤ -->
        <div id="score-container"></div>

        <!-- ìš”ì•½ -->
        <div class="summary-box" id="summary-box"></div>

        <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²°ê³¼ -->
        <div class="report-section" id="checklist-result">
          <h4>
            <span class="material-symbols-outlined">checklist</span>
            ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²°ê³¼
          </h4>
          <div id="checklist-result-items"></div>
        </div>

        <!-- í•„ìš” ì¦ë¹™ì„œë¥˜ -->
        <div class="report-section" id="docs-section">
          <h4>
            <span class="material-symbols-outlined">folder_open</span>
            í•„ìš” ì¦ë¹™ì„œë¥˜
          </h4>
          <div class="docs-list" id="docs-list"></div>
        </div>

        <!-- ê´€ë ¨ ê·œì • -->
        <div class="report-section" id="regulation-section">
          <h4>
            <span class="material-symbols-outlined">gavel</span>
            ê´€ë ¨ ê·œì •
          </h4>
          <div id="regulation-list"></div>
        </div>

        <!-- ê¶Œê³ ì‚¬í•­ -->
        <div class="recommendation" id="recommendation">
          <h4>
            <span class="material-symbols-outlined">lightbulb</span>
            ê²€í†  ì˜ê²¬ ë° ê¶Œê³ ì‚¬í•­
          </h4>
          <ul id="recommendation-list"></ul>
        </div>

        <!-- ë©´ì±… ì¡°í•­ -->
        <div class="disclaimer">
          <h5>
            <span class="material-symbols-outlined">warning</span>
            ë©´ì±… ì¡°í•­
          </h5>
          <ul>
            <li>ë³¸ ê²€í†  ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©° ë²•ì  íš¨ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>
            <li>ìµœì¢… íŒë‹¨ì€ ë‹´ë‹¹ ê³µë¬´ì›ì˜ ì±…ì„ì…ë‹ˆë‹¤.</li>
            <li>ì •í™•í•œ ê²€í† ëŠ” ê³„ì•½ë‹´ë‹¹ë¶€ì„œ ë˜ëŠ” ì „ë¬¸ê¸°ê´€ì— ì˜ë¢°í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
          </ul>
        </div>

        <!-- ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´ -->
        <div class="next-step-section" id="next-step-section">
          <h4>
            <span class="material-symbols-outlined">arrow_forward</span>
            ë‹¤ìŒ ë‹¨ê³„
          </h4>
          <p>ê²¬ì ì„œ ê²€í† ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì•½ ì§„í–‰ì„ ìœ„í•´ ê³¼ì—…ì§€ì‹œì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.</p>
          <a href="/forms/ê³¼ì—…ì§€ì‹œì„œ.html" class="btn-next-step">
            <span class="material-symbols-outlined">description</span>
            ê³¼ì—…ì§€ì‹œì„œ ì‘ì„±í•˜ê¸°
            <span class="material-symbols-outlined" style="margin-left: auto;">arrow_forward</span>
          </a>
        </div>

        <!-- ë°”ì´ëŸ´ ì„¹ì…˜ -->
        <div class="viral-section">
          <div class="viral-counter">
            ì˜¤ëŠ˜ <strong id="review-count">127</strong>ëª…ì´ ê²¬ì ì„œë¥¼ ê²€í† í–ˆì–´ìš”
          </div>
          <div class="viral-buttons">
            <button class="btn-viral btn-share" onclick="shareResult()">
              <span class="material-symbols-outlined">share</span>
              ê³µìœ í•˜ê¸°
            </button>
            <button class="btn-viral btn-pdf" onclick="downloadPDF()">
              <span class="material-symbols-outlined">picture_as_pdf</span>
              PDF ì €ì¥
            </button>
            <button class="btn-viral btn-print" onclick="window.print()">
              <span class="material-symbols-outlined">print</span>
              ì¸ì‡„
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loading-overlay" class="loading-overlay">
    <div style="text-align:center; color:white;">
      <div class="loading-spinner"></div>
      <h3 style="font-size:20px; margin-bottom:8px;">AIê°€ ê²¬ì ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</h3>
      <p style="opacity:0.8; font-size:14px;">ì—…ì²´ì •ë³´, í’ˆëª©, ê¸ˆì•¡ì„ ìë™ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤...</p>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ìƒíƒœ ê´€ë¦¬
    let currentStep = 1;
    let selectedType = null;
    let selectedContractMethod = null;
    let fileUploaded = false;

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    const uploadZone = document.getElementById('upload-zone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => uploadZone.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('dragover'), false);
    });
    uploadZone.addEventListener('drop', e => {
      const files = e.dataTransfer.files;
      if (files.length > 0) handleFile(files[0]);
    }, false);

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) handleFile(file);
    }

    function handleFile(file) {
      const previewContainer = document.getElementById('preview-container');
      const previewContent = document.getElementById('preview-content');
      const uploadZone = document.getElementById('upload-zone');

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewContent.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="ê²¬ì ì„œ">`;
          showPreview();
        };
        reader.readAsDataURL(file);
      } else if (file.type === 'application/pdf') {
        const url = URL.createObjectURL(file);
        previewContent.innerHTML = `<iframe src="${url}" class="preview-pdf"></iframe>`;
        showPreview();
      } else if (file.name.match(/\.xlsx?$/i)) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            renderExcelPreview(workbook, file.name);
            showPreview();
            tryExtractFromExcel(workbook);
          } catch (err) {
            showToast('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        showToast('ì´ë¯¸ì§€(JPG, PNG), PDF ë˜ëŠ” Excel íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      function showPreview() {
        uploadZone.style.display = 'none';
        previewContainer.classList.add('show');
        fileUploaded = true;
        // ì´ë¯¸ì§€/PDFëŠ” AI ìë™ ë¶„ì„ ì‹œì‘
        if (file.type.startsWith('image/') || file.type === 'application/pdf') {
          analyzeWithAI(file);
        } else {
          showToast('ê²¬ì ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }
    }

    function renderExcelPreview(workbook, fileName) {
      const previewContent = document.getElementById('preview-content');
      const sheetNames = workbook.SheetNames;
      let html = `<div class="preview-excel"><h4 style="margin-bottom: 12px; color: var(--forest-600);">${fileName}</h4>`;

      if (sheetNames.length > 1) {
        html += `<div class="sheet-tabs">`;
        sheetNames.forEach((name, idx) => {
          html += `<button class="sheet-tab ${idx === 0 ? 'active' : ''}" onclick="showSheet(${idx})">${name}</button>`;
        });
        html += `</div>`;
      }

      sheetNames.forEach((name, idx) => {
        const sheet = workbook.Sheets[name];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
        html += `<div class="sheet-content" id="sheet-${idx}" style="${idx > 0 ? 'display:none;' : ''}">`;

        if (jsonData.length > 0) {
          html += `<table class="excel-table"><thead><tr>`;
          const maxCols = Math.min(Math.max(...jsonData.map(r => r.length)), 10);
          for (let c = 0; c < maxCols; c++) {
            html += `<th>${jsonData[0][c] || ''}</th>`;
          }
          html += `</tr></thead><tbody>`;
          for (let r = 1; r < Math.min(jsonData.length, 50); r++) {
            html += `<tr>`;
            for (let c = 0; c < maxCols; c++) {
              let val = jsonData[r][c] || '';
              if (typeof val === 'number' && val > 1000) val = formatNumber(Math.round(val));
              html += `<td>${val}</td>`;
            }
            html += `</tr>`;
          }
          html += `</tbody></table>`;
        }
        html += `</div>`;
      });
      html += `</div>`;
      previewContent.innerHTML = html;
    }

    function showSheet(idx) {
      document.querySelectorAll('.sheet-content').forEach((el, i) => el.style.display = i === idx ? 'block' : 'none');
      document.querySelectorAll('.sheet-tab').forEach((el, i) => el.classList.toggle('active', i === idx));
    }

    function tryExtractFromExcel(workbook) {
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
      const priceKeywords = ['í•©ê³„', 'ì´ì•¡', 'ì´ê³„', 'ê²¬ì ê¸ˆì•¡', 'ê³µê¸‰ê°€ì•¡'];
      const supplyKeywords = ['ê³µê¸‰ê°€ì•¡', 'ê³µê¸‰ê°€', 'ì†Œê³„'];
      const vatKeywords = ['ë¶€ê°€ì„¸', 'ë¶€ê°€ê°€ì¹˜ì„¸', 'vat'];
      const companyKeywords = ['ìƒí˜¸', 'ì—…ì²´ëª…', 'íšŒì‚¬ëª…', 'ê³µê¸‰ì'];
      const bizNoKeywords = ['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸', 'ì‚¬ì—…ìë²ˆí˜¸', 'ë“±ë¡ë²ˆí˜¸'];
      const repKeywords = ['ëŒ€í‘œì', 'ëŒ€í‘œ'];

      let totalFound = 0, supplyFound = 0, vatFound = 0;
      let companyFound = '', bizNoFound = '', repFound = '';
      let hasItems = false, hasSpec = false, hasQty = false, hasUnitPrice = false;

      jsonData.forEach(row => {
        row.forEach((cell, idx) => {
          const cellStr = String(cell);
          const cellLower = cellStr.toLowerCase();

          // ê°€ê²© í‚¤ì›Œë“œ íƒìƒ‰
          priceKeywords.forEach(kw => {
            if (cellLower.includes(kw) && row[idx + 1] && typeof row[idx + 1] === 'number' && row[idx + 1] > 10000) {
              if (row[idx + 1] > totalFound) totalFound = row[idx + 1];
            }
          });
          supplyKeywords.forEach(kw => {
            if (cellLower.includes(kw) && row[idx + 1] && typeof row[idx + 1] === 'number' && row[idx + 1] > 10000) {
              if (row[idx + 1] > supplyFound) supplyFound = row[idx + 1];
            }
          });
          vatKeywords.forEach(kw => {
            if (cellLower.includes(kw) && row[idx + 1] && typeof row[idx + 1] === 'number') {
              vatFound = row[idx + 1];
            }
          });
          companyKeywords.forEach(kw => {
            if (cellLower.includes(kw) && row[idx + 1] && !companyFound) {
              companyFound = String(row[idx + 1]).trim();
            }
          });
          bizNoKeywords.forEach(kw => {
            if (cellLower.includes(kw) && row[idx + 1] && !bizNoFound) {
              bizNoFound = String(row[idx + 1]).trim();
            }
          });
          repKeywords.forEach(kw => {
            if (cellLower.includes(kw) && row[idx + 1] && !repFound) {
              repFound = String(row[idx + 1]).trim();
            }
          });

          // í—¤ë” í–‰ì—ì„œ í•­ëª© êµ¬ì¡° í™•ì¸
          if (cellLower.includes('í’ˆëª…') || cellLower.includes('í’ˆëª©')) hasItems = true;
          if (cellLower.includes('ê·œê²©') || cellLower.includes('ì‚¬ì–‘')) hasSpec = true;
          if (cellLower.includes('ìˆ˜ëŸ‰')) hasQty = true;
          if (cellLower.includes('ë‹¨ê°€')) hasUnitPrice = true;
        });
      });

      // ì¶”ì¶œëœ ë°ì´í„°ë¥¼ AI ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ìë™ ë¶„ì„
      const fields = {};
      if (companyFound) fields.company_name = companyFound;
      if (bizNoFound) fields.business_no = bizNoFound;
      if (repFound) fields.representative = repFound;

      if (totalFound > 0) fields.total_amount = Math.round(totalFound);
      if (supplyFound > 0) {
        fields.supply_amount = Math.round(supplyFound);
      } else if (totalFound > 0) {
        fields.supply_amount = Math.round(totalFound / 1.1);
      }
      if (vatFound > 0) fields.vat_amount = Math.round(vatFound);

      // í•­ëª© êµ¬ì¡°ê°€ ìˆìœ¼ë©´ ì²´í¬ìš© ë”ë¯¸ ì•„ì´í…œ
      if (hasItems) {
        fields.items = [{
          name: hasItems ? 'found' : '',
          spec: hasSpec ? 'found' : '',
          qty: hasQty ? 1 : 0,
          unit_price: hasUnitPrice ? 1 : 0
        }];
      }

      // ì¶”ì •ê°€ê²©ì´ ìˆìœ¼ë©´ ìë™ ë¶„ì„ ì‹¤í–‰
      if (fields.supply_amount || fields.total_amount) {
        fields.contract_type = 'ë¬¼í’ˆ'; // ì—‘ì…€ ê¸°ë³¸ê°’
        autoFillFromAI(fields);
      } else {
        // ê°€ê²© ë¯¸ì¶”ì¶œ ì‹œ ìˆ˜ë™ ëª¨ë“œ (ê¸°ì¡´ ë™ì‘)
        if (totalFound > 0) {
          document.getElementById('total_price').value = Math.round(totalFound);
          formatPriceDisplay('total');
        }
        if (companyFound) document.getElementById('company_name').value = companyFound;
        showToast('ê²¬ì ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì •ë³´ë¥¼ í™•ì¸ í›„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
      }
    }

    function removeFile() {
      document.getElementById('preview-container').classList.remove('show');
      document.getElementById('upload-zone').style.display = 'block';
      document.getElementById('preview-content').innerHTML = '';
      document.getElementById('file-input').value = '';
      fileUploaded = false;
    }

    // ì¢…ë¥˜ ì„ íƒ
    function selectType(type) {
      selectedType = type;
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.type === type);
      });
      document.getElementById('btn-step1').disabled = false;

      // ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
      document.getElementById('checklist-construction').style.display = type === 'construction' ? 'block' : 'none';
      document.getElementById('checklist-service').style.display = type === 'service' ? 'block' : 'none';
    }

    // ê³„ì•½ ë°©ë²• ì„ íƒ
    function selectContractMethod(method) {
      selectedContractMethod = method;
      document.querySelectorAll('.radio-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.querySelector('input').value === method);
      });
    }

    // ìŠ¤í… ì´ë™
    function updateStepIndicator() {
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'done', 'disabled');
        if (i < currentStep) step.classList.add('done');
        else if (i === currentStep) step.classList.add('active');
        else step.classList.add('disabled');
      }
    }

    function goToStep(step) {
      if (step > currentStep && step !== currentStep + 1) return;
      if (step === 4 && currentStep < 3) return;

      currentStep = step;
      updateStepIndicator();

      document.getElementById('step1-card').style.display = step === 1 ? 'block' : 'none';
      document.getElementById('step2-card').style.display = step === 2 ? 'block' : 'none';
      document.getElementById('step3-card').style.display = step === 3 ? 'block' : 'none';
      document.getElementById('report-section').classList.toggle('show', step === 4);
    }

    function nextStep(step) {
      if (step === 2 && !selectedType) {
        showToast('ê²¬ì ì„œ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      currentStep = step;
      updateStepIndicator();

      // Step 2ë¡œ ì´ë™ ì‹œ disabled í•´ì œ
      if (step >= 2) document.getElementById('step2').classList.remove('disabled');
      if (step >= 3) document.getElementById('step3').classList.remove('disabled');

      goToStep(step);
    }

    // ê¸ˆì•¡ ì…ë ¥
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function setPrice(amount) {
      document.getElementById('estimated_price').value = amount;
      formatPriceDisplay('estimated');
    }

    function formatPriceDisplay(type) {
      const input = document.getElementById(type + '_price');
      const display = document.getElementById(type + '_display');
      const price = parseInt(input.value) || 0;
      display.textContent = price > 0 ? `= ${formatNumber(price)}ì›` : '';
    }

    // ì²´í¬ë¦¬ìŠ¤íŠ¸
    function toggleCheck(item) {
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      updateChecklistUI(checkbox);
    }

    function updateChecklistUI(checkbox) {
      const item = checkbox.closest('.checklist-item');
      item.classList.remove('checked', 'unchecked');
      item.classList.add(checkbox.checked ? 'checked' : 'unchecked');
    }

    // ë¶„ì„
    function analyzeQuotation() {
      const estimatedPrice = parseInt(document.getElementById('estimated_price').value) || 0;
      const totalPrice = parseInt(document.getElementById('total_price').value) || estimatedPrice;
      const companyName = document.getElementById('company_name').value || 'ë¯¸ì…ë ¥';

      if (!estimatedPrice) {
        showToast('ì¶”ì •ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì§‘
      const checkItems = {
        pass: [],
        warn: [],
        fail: []
      };

      // í•„ìˆ˜ í•­ëª© ì²´í¬
      const requiredChecks = [
        { id: 'chk_company_name', name: 'ì—…ì²´ëª…', required: true },
        { id: 'chk_biz_number', name: 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸', required: true },
        { id: 'chk_seal', name: 'ë‚ ì¸/ì„œëª…', required: true },
        { id: 'chk_item_name', name: 'í’ˆëª…', required: true },
        { id: 'chk_spec', name: 'ê·œê²©', required: true },
        { id: 'chk_quantity', name: 'ìˆ˜ëŸ‰', required: true },
        { id: 'chk_unit_price', name: 'ë‹¨ê°€', required: true },
        { id: 'chk_total', name: 'í•©ê³„ê¸ˆì•¡', required: true },
        { id: 'chk_vat', name: 'ë¶€ê°€ì„¸ í‘œê¸°', required: true },
        { id: 'chk_valid_period', name: 'ìœ íš¨ê¸°ê°„', required: false },
        { id: 'chk_representative', name: 'ëŒ€í‘œìëª…', required: false },
        { id: 'chk_contact', name: 'ì—°ë½ì²˜', required: false },
        { id: 'chk_delivery', name: 'ë‚©í’ˆê¸°í•œ', required: false }
      ];

      requiredChecks.forEach(item => {
        const el = document.getElementById(item.id);
        if (el) {
          if (el.checked) {
            checkItems.pass.push(item.name);
          } else if (item.required) {
            checkItems.fail.push(item.name);
          } else {
            checkItems.warn.push(item.name);
          }
        }
      });

      // ì¢…ë¥˜ë³„ íŠ¹í™” ì²´í¬
      if (selectedType === 'construction') {
        ['chk_indirect_labor', 'chk_insurance', 'chk_safety', 'chk_warranty'].forEach(id => {
          const el = document.getElementById(id);
          const name = el?.closest('.checklist-item')?.querySelector('label')?.textContent;
          if (el && name) {
            if (el.checked) checkItems.pass.push(name);
            else checkItems.warn.push(name);
          }
        });
      }
      if (selectedType === 'service') {
        ['chk_labor_cost', 'chk_direct_cost', 'chk_tech_fee'].forEach(id => {
          const el = document.getElementById(id);
          const name = el?.closest('.checklist-item')?.querySelector('label')?.textContent;
          if (el && name) {
            if (el.checked) checkItems.pass.push(name);
            else checkItems.warn.push(name);
          }
        });
      }

      // ì ìˆ˜ ê³„ì‚° (100ì  ë§Œì )
      const totalItems = checkItems.pass.length + checkItems.warn.length + checkItems.fail.length;
      const score = Math.round((checkItems.pass.length * 10 + checkItems.warn.length * 5) / totalItems * 10);

      // ê°€ê²© ì ì •ì„± ë³´ë„ˆìŠ¤/í˜ë„í‹°
      let priceScore = 0;
      if (totalPrice && estimatedPrice) {
        const ratio = totalPrice / estimatedPrice;
        if (ratio >= 0.95 && ratio <= 1.05) priceScore = 10;
        else if (ratio >= 0.80 && ratio <= 1.20) priceScore = 5;
        else priceScore = -10;
      }

      const finalScore = Math.max(0, Math.min(100, score + priceScore));

      // ë“±ê¸‰ ê²°ì •
      let grade, gradeText, gradeClass;
      if (finalScore >= 90) {
        grade = 'A'; gradeText = 'ìš°ìˆ˜'; gradeClass = 'excellent';
      } else if (finalScore >= 75) {
        grade = 'B'; gradeText = 'ì–‘í˜¸'; gradeClass = 'good';
      } else if (finalScore >= 60) {
        grade = 'C'; gradeText = 'ë³´í†µ'; gradeClass = 'warning';
      } else {
        grade = 'D'; gradeText = 'ë¯¸í¡'; gradeClass = 'poor';
      }

      // í•„ìš” ì„œë¥˜ ê²°ì •
      const docs = [];
      const typeThresholds = {
        construction: 200000000,
        goods: 50000000,
        service: 50000000
      };
      const threshold = typeThresholds[selectedType] || 50000000;

      docs.push({ name: 'ê²¬ì ì„œ ì›ë³¸', required: true });
      docs.push({ name: 'ì‚¬ì—…ìë“±ë¡ì¦ ì‚¬ë³¸', required: true });

      if (selectedContractMethod === 'private') {
        docs.push({ name: 'ìˆ˜ì˜ê³„ì•½ì‚¬ìœ ì„œ', required: true });
        if (estimatedPrice > 20000000) {
          docs.push({ name: '2ê°œ ì—…ì²´ ì´ìƒ ê²¬ì ì„œ', required: true });
        }
      }

      docs.push({ name: 'ì˜ˆì •ê°€ê²©ì¡°ì„œ', required: true });

      if (estimatedPrice > 50000000) {
        docs.push({ name: 'ì›ê°€ê³„ì‚°ì„œ', required: true });
      }

      if (selectedType === 'construction') {
        docs.push({ name: 'ì„¤ê³„ì„œ/ì‹œë°©ì„œ', required: estimatedPrice > threshold });
      }

      // ê´€ë ¨ ê·œì •
      const regulations = [
        { name: 'ì§€ë°©ê³„ì•½ë²• ì‹œí–‰ë ¹ ì œ25ì¡° (ìˆ˜ì˜ê³„ì•½)', url: 'https://www.law.go.kr' },
        { name: 'ì§€ë°©ê³„ì•½ë²• ì‹œí–‰ë ¹ ì œ7ì¡° (ì˜ˆì •ê°€ê²©ì˜ ê²°ì •)', url: 'https://www.law.go.kr' },
        { name: 'ì§€ë°©ê³„ì•½ë²• ì‹œí–‰ë ¹ ì œ30ì¡° (ìˆ˜ì˜ê³„ì•½ëŒ€ìƒì ì„ ì •)', url: 'https://www.law.go.kr' }
      ];

      if (selectedType === 'construction') {
        regulations.push({ name: 'ê±´ì„¤ê¸°ìˆ ì§„í¥ë²• ì œ62ì¡° (ì•ˆì „ê´€ë¦¬ë¹„)', url: 'https://www.law.go.kr' });
      }

      // ê¶Œê³ ì‚¬í•­
      const recommendations = [];

      if (checkItems.fail.length > 0) {
        recommendations.push(`ë‹¤ìŒ í•„ìˆ˜ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${checkItems.fail.join(', ')}`);
      }

      if (estimatedPrice > threshold && selectedContractMethod === 'private') {
        recommendations.push(`ì¶”ì •ê°€ê²© ${formatNumber(threshold)}ì› ì´ˆê³¼ë¡œ ìˆ˜ì˜ê³„ì•½ì´ ì–´ë µìŠµë‹ˆë‹¤. ê²½ìŸì…ì°°ì„ ê²€í† í•˜ì„¸ìš”.`);
      }

      if (totalPrice && estimatedPrice && totalPrice / estimatedPrice > 1.1) {
        recommendations.push('ê²¬ì ê°€ê²©ì´ ì¶”ì •ê°€ê²©ë³´ë‹¤ 10% ì´ìƒ ë†’ìŠµë‹ˆë‹¤. ê°€ê²© í˜‘ìƒ ë˜ëŠ” ì¬ê²¬ì ì„ ê²€í† í•˜ì„¸ìš”.');
      }

      if (checkItems.warn.length > 0) {
        recommendations.push(`ë‹¤ìŒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”: ${checkItems.warn.join(', ')}`);
      }

      if (recommendations.length === 0) {
        recommendations.push('ê²¬ì ì„œê°€ ì ì •í•˜ê²Œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì•½ ì§„í–‰ì„ ì¶”ì§„í•˜ì„¸ìš”.');
      }

      // ë¦¬í¬íŠ¸ ë Œë”ë§
      renderReport({
        score: finalScore,
        grade,
        gradeText,
        gradeClass,
        companyName,
        estimatedPrice,
        totalPrice,
        checkItems,
        docs,
        regulations,
        recommendations
      });

      document.getElementById('step4').classList.remove('disabled');
      goToStep(4);
      showToast('ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function renderReport(data) {
      const date = new Date().toLocaleDateString('ko-KR');
      const typeNames = { construction: 'ê³µì‚¬', goods: 'ë¬¼í’ˆ', service: 'ìš©ì—­' };

      document.getElementById('report-date').textContent =
        `${typeNames[selectedType]} | ${data.companyName} | ì¶”ì •ê°€ê²©: ${formatNumber(data.estimatedPrice)}ì› | ${date}`;

      // ì ìˆ˜
      document.getElementById('score-container').innerHTML = `
        <div class="score-box ${data.gradeClass}">
          <div class="score-grade">${data.grade}</div>
          <div class="score-number">${data.score}<span>ì </span></div>
          <div class="score-label">${data.gradeText} - ê²€í†  ê²°ê³¼</div>
        </div>
      `;

      // ìš”ì•½
      document.getElementById('summary-box').innerHTML = `
        <div class="summary-item pass">
          <div class="number">${data.checkItems.pass.length}</div>
          <div class="label">ì í•©</div>
        </div>
        <div class="summary-item warn">
          <div class="number">${data.checkItems.warn.length}</div>
          <div class="label">í™•ì¸ í•„ìš”</div>
        </div>
        <div class="summary-item fail">
          <div class="number">${data.checkItems.fail.length}</div>
          <div class="label">ë¯¸ì¶©ì¡±</div>
        </div>
      `;

      // ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²°ê³¼
      let checklistHtml = '';
      data.checkItems.pass.forEach(item => {
        checklistHtml += `<div class="check-item"><div class="check-icon pass">âœ“</div><div class="check-content"><strong>${item}</strong><p>í™•ì¸ë¨</p></div></div>`;
      });
      data.checkItems.warn.forEach(item => {
        checklistHtml += `<div class="check-item"><div class="check-icon warn">âš </div><div class="check-content"><strong>${item}</strong><p>í™•ì¸ í•„ìš”</p></div></div>`;
      });
      data.checkItems.fail.forEach(item => {
        checklistHtml += `<div class="check-item"><div class="check-icon fail">âœ—</div><div class="check-content"><strong>${item}</strong><p>ë¯¸ê¸°ì¬ - í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤</p></div></div>`;
      });
      document.getElementById('checklist-result-items').innerHTML = checklistHtml;

      // í•„ìš” ì„œë¥˜
      let docsHtml = '';
      data.docs.forEach(doc => {
        docsHtml += `
          <div class="doc-item ${doc.required ? 'required' : ''}">
            <span class="material-symbols-outlined">description</span>
            <span>${doc.name}</span>
            <span class="badge ${doc.required ? 'required' : 'optional'}">${doc.required ? 'í•„ìˆ˜' : 'ê¶Œì¥'}</span>
          </div>
        `;
      });
      document.getElementById('docs-list').innerHTML = docsHtml;

      // ê´€ë ¨ ê·œì •
      let regHtml = '';
      data.regulations.forEach(reg => {
        regHtml += `
          <a href="${reg.url}" target="_blank" class="regulation-item">
            <span class="material-symbols-outlined">gavel</span>
            <span>${reg.name}</span>
            <span class="material-symbols-outlined" style="margin-left: auto; font-size: 18px;">open_in_new</span>
          </a>
        `;
      });
      document.getElementById('regulation-list').innerHTML = regHtml;

      // ê¶Œê³ ì‚¬í•­
      document.getElementById('recommendation-list').innerHTML =
        data.recommendations.map(r => `<li>${r}</li>`).join('');

      // ê²€í†  ì¹´ìš´í„° ëœë¤ ì—…ë°ì´íŠ¸
      document.getElementById('review-count').textContent = 100 + Math.floor(Math.random() * 50);
    }

    function shareResult() {
      const score = document.querySelector('.score-number')?.textContent || '';
      const text = `ì´ ê²¬ì ì„œ ${score}! ì‹¤ë¬´ì—ì„œ ê²€í† í–ˆì–´ìš” ğŸ”\n\nê²¬ì ì„œ ê²€í†  ì‹œìŠ¤í…œ: silmu.kr`;

      if (navigator.share) {
        navigator.share({ title: 'ê²¬ì ì„œ ê²€í†  ê²°ê³¼', text });
      } else {
        navigator.clipboard.writeText(text).then(() => showToast('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));
      }
    }

    async function downloadPDF() {
      showToast('PDF ìƒì„± ì¤‘...');

      const reportSection = document.getElementById('report-section');
      const viralSection = document.querySelector('.viral-section');
      const nextStepSection = document.getElementById('next-step-section');

      // ì„ì‹œë¡œ ë°”ì´ëŸ´/ë‹¤ìŒë‹¨ê³„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      viralSection.style.display = 'none';
      nextStepSection.style.display = 'none';

      try {
        const canvas = await html2canvas(reportSection, {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff'
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // í˜ì´ì§€ ë‚˜ëˆ„ê¸°
        let heightLeft = imgHeight;
        let position = 0;
        const pageHeight = 297;

        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // ì›Œí„°ë§ˆí¬ ì¶”ê°€
        const pageCount = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          pdf.setPage(i);
          pdf.setFontSize(10);
          pdf.setTextColor(150);
          pdf.text('silmu.krì—ì„œ ê²€í† ë¨', 105, 290, { align: 'center' });
        }

        const companyName = document.getElementById('company_name').value || 'ê²¬ì ì„œ';
        const date = new Date().toISOString().split('T')[0];
        pdf.save(`ê²¬ì ì„œê²€í† _${companyName}_${date}.pdf`);

        showToast('PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (error) {
        console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
        showToast('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸ì‡„ ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      }

      // ì„¹ì…˜ ë‹¤ì‹œ í‘œì‹œ
      viralSection.style.display = '';
      nextStepSection.style.display = '';
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // === AI ìë™ ë¶„ì„ ===

    function showLoading(show) {
      document.getElementById('loading-overlay').classList.toggle('show', show);
    }

    function analyzeWithAI(file) {
      showLoading(true);

      const formData = new FormData();
      formData.append('file', file);

      fetch('/quote-reviews/analyze', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      })
      .then(res => {
        if (res.status === 401) throw new Error('login_required');
        return res.json();
      })
      .then(data => {
        showLoading(false);
        if (data.success && data.fields) {
          autoFillFromAI(data.fields);
        } else {
          showToast(data.error || 'AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
      })
      .catch(err => {
        showLoading(false);
        if (err.message === 'login_required') {
          showToast('ë¡œê·¸ì¸ í›„ ìë™ ë¶„ì„ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        } else {
          console.error('AI analysis error:', err);
          showToast('AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
      });
    }

    function autoFillFromAI(fields) {
      // 1. ì¢…ë¥˜ ìë™ ì„ íƒ
      const typeMap = { 'ê³µì‚¬': 'construction', 'ë¬¼í’ˆ': 'goods', 'ìš©ì—­': 'service' };
      const autoType = typeMap[fields.contract_type] || 'goods';
      selectType(autoType);

      // 2. ì¶”ì •ê°€ê²© ê²°ì •
      let estimatedAmount = fields.supply_amount;
      if (!estimatedAmount && fields.total_amount) {
        estimatedAmount = Math.round(fields.total_amount / 1.1);
      }
      if (!estimatedAmount && fields.items?.length > 0) {
        estimatedAmount = fields.items.reduce((sum, i) => sum + ((i.qty || 0) * (i.unit_price || 0)), 0);
      }

      if (!estimatedAmount) {
        showToast('ê°€ê²© ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // 3. ê°€ê²© ìë™ ì…ë ¥
      document.getElementById('estimated_price').value = estimatedAmount;
      formatPriceDisplay('estimated');

      if (fields.total_amount) {
        document.getElementById('total_price').value = fields.total_amount;
        formatPriceDisplay('total');
      }

      // 4. ì—…ì²´ ì •ë³´ ìë™ ì…ë ¥
      if (fields.company_name) document.getElementById('company_name').value = fields.company_name;
      if (fields.business_no) document.getElementById('biz_number').value = fields.business_no;

      // 5. ê³„ì•½ ë°©ë²• ìë™ ì„ íƒ (ìˆ˜ì˜ê³„ì•½ ê¸°ë³¸)
      selectContractMethod('private');

      // 6. ì²´í¬ë¦¬ìŠ¤íŠ¸ ìë™ ì²´í¬
      const items = fields.items || [];
      const autoChecks = {
        chk_company_name: !!fields.company_name,
        chk_biz_number: !!fields.business_no,
        chk_representative: !!fields.representative,
        chk_contact: !!(fields.contact_phone || fields.contact_person),
        chk_seal: !!fields.representative,
        chk_item_name: items.length > 0 && items.some(i => i.name),
        chk_spec: items.length > 0 && items.some(i => i.spec),
        chk_quantity: items.length > 0 && items.some(i => i.qty > 0),
        chk_unit_price: items.length > 0 && items.some(i => i.unit_price > 0),
        chk_total: !!(fields.total_amount || fields.supply_amount),
        chk_vat: !!fields.vat_amount,
        chk_valid_period: !!fields.validity_period,
        chk_delivery: !!fields.delivery_period
      };

      Object.entries(autoChecks).forEach(([id, checked]) => {
        const el = document.getElementById(id);
        if (el) {
          el.checked = !!checked;
          updateChecklistUI(el);
        }
      });

      // 7. ìŠ¤í…ì„ 3ìœ¼ë¡œ ì„¤ì •í•˜ê³  ìë™ ë¶„ì„ ì‹¤í–‰ (â†’ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™)
      currentStep = 3;
      analyzeQuotation();
    }
  </script>
</body>
</html>
