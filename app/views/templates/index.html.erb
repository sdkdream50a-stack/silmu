<%# 문서 양식 목록 페이지 - 프리미엄 디자인 시스템 %>

<!-- 페이지 헤더 -->
<section class="gradient-premium text-white py-12 lg:py-16">
  <div class="container-wide">
    <div class="flex items-start gap-5">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
        <span class="material-symbols-outlined text-4xl text-white">folder_open</span>
      </div>
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">문서 양식 보관함</h1>
        <p class="text-navy-200 text-lg">공무원 업무에 필요한 모든 양식을 한 곳에서</p>
      </div>
    </div>
  </div>
</section>

<!-- 검색 및 필터 -->
<section class="bg-white/80 backdrop-blur-xl border-b border-gray-100 sticky top-16 z-40 shadow-soft">
  <div class="container-wide py-4">
    <!-- 검색바 -->
    <div class="flex items-center bg-surface-100 rounded-xl overflow-hidden mb-4">
      <div class="flex items-center justify-center pl-4 text-navy-400">
        <span class="material-symbols-outlined">search</span>
      </div>
      <input type="text" id="search-input" placeholder="양식명 또는 키워드 검색" class="w-full border-none focus:ring-0 bg-transparent py-3 px-3 text-navy-800 placeholder:text-navy-400">
    </div>

    <!-- 카테고리 필터 -->
    <div class="flex flex-wrap gap-2" id="category-tabs">
      <button data-category="전체" class="tab-btn active px-5 py-2.5 bg-navy-800 text-white rounded-xl text-sm font-semibold shadow-md transition-all">전체</button>
      <button data-category="계약서" class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">계약서</button>
      <button data-category="기안문" class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">기안문</button>
      <button data-category="품의서" class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">품의서</button>
      <button data-category="검수조서" class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">검수조서</button>
      <button data-category="기타" class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">기타</button>
    </div>
  </div>
</section>

<!-- 양식 그리드 -->
<section class="section py-10">
  <div class="container-wide">
    <div class="flex items-center justify-between mb-6">
      <p class="text-navy-600">총 <span class="font-bold text-navy-900" id="item-count">23</span>개의 양식</p>
      <select class="border-gray-200 rounded-xl text-sm focus:ring-point-500 focus:border-point-500 px-4 py-2">
        <option>최신순</option>
        <option>인기순</option>
        <option>이름순</option>
      </select>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="items-grid">
      <% @templates.each do |template| %>
        <div class="card card-interactive overflow-hidden group item-card" data-category="<%= template[:category] %>" data-title="<%= template[:title] %>">
          <!-- 미리보기 영역 (클릭 가능) -->
          <%= link_to template_path(template[:id]), class: "block aspect-[4/3] bg-gradient-to-br from-surface-50 to-surface-100 flex items-center justify-center relative" do %>
            <span class="material-symbols-outlined text-6xl text-navy-200 group-hover:text-<%= template[:color] %>-400 transition-colors">description</span>
            <div class="absolute top-3 left-3">
              <span class="badge badge-<%= template[:color] %>"><%= template[:category] %></span>
            </div>
            <% if template[:badge] %>
              <div class="absolute top-3 right-3">
                <span class="badge <%= template[:badge] == 'NEW' ? 'badge-warm' : 'badge-point' %>"><%= template[:badge] %></span>
              </div>
            <% end %>
          <% end %>

          <!-- 정보 영역 -->
          <div class="p-5">
            <%= link_to template_path(template[:id]), class: "block" do %>
              <h3 class="font-bold text-navy-900 mb-1 group-hover:text-<%= template[:color] %>-600 transition-colors"><%= template[:title] %></h3>
              <p class="text-navy-500 text-sm mb-3"><%= template[:desc] %></p>
            <% end %>

            <div class="flex items-center justify-between">
              <div class="flex gap-1.5">
                <% template[:formats].each do |format| %>
                  <span class="text-xs px-2 py-0.5 bg-surface-100 text-navy-600 rounded-md font-medium"><%= format %></span>
                <% end %>
              </div>
              <span class="text-xs text-navy-400 flex items-center gap-1">
                <span class="material-symbols-outlined text-sm">download</span>
                <%= number_with_delimiter(template[:downloads]) %>
              </span>
            </div>

            <div class="flex gap-2 mt-4">
              <%= link_to template_path(template[:id]), class: "flex-1 text-center py-2.5 border-2 border-gray-200 rounded-xl text-sm font-medium text-navy-700 hover:bg-surface-50 hover:border-navy-300 transition-all" do %>
                미리보기
              <% end %>
              <%= link_to template_path(template[:id]), class: "flex-1 py-2.5 btn btn-primary btn-sm text-center" do %>
                다운로드
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 페이지네이션 -->
    <div class="flex justify-center mt-12" id="pagination-container">
      <nav class="flex items-center gap-2" id="pagination-nav">
        <!-- JavaScript로 동적 생성 -->
      </nav>
    </div>
  </div>
</section>

<script>
document.addEventListener('turbo:load', function() {
  const itemCount = document.getElementById('item-count');
  if (!itemCount) return;
  const tabs = document.querySelectorAll('#category-tabs .tab-btn');
  const items = document.querySelectorAll('.item-card');
  const searchInput = document.getElementById('search-input');
  const paginationNav = document.getElementById('pagination-nav');

  // 페이지네이션 설정
  const ITEMS_PER_PAGE = 8;
  let currentPage = 1;
  let filteredItems = [];

  function getFilteredItems() {
    const activeTab = document.querySelector('#category-tabs .tab-btn.active');
    const category = activeTab ? activeTab.dataset.category : '전체';
    const searchTerm = searchInput.value.toLowerCase();

    return Array.from(items).filter(item => {
      const itemCategory = item.dataset.category;
      const itemTitle = item.dataset.title.toLowerCase();
      const matchesCategory = category === '전체' || itemCategory === category;
      const matchesSearch = itemTitle.includes(searchTerm);
      return matchesCategory && matchesSearch;
    });
  }

  function displayPage(page) {
    currentPage = page;
    const startIndex = (page - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;

    // 모든 아이템 숨기기
    items.forEach(item => item.style.display = 'none');

    // 현재 페이지 아이템만 표시
    filteredItems.slice(startIndex, endIndex).forEach(item => {
      item.style.display = '';
    });

    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);

    if (totalPages <= 1) {
      paginationNav.innerHTML = '';
      return;
    }

    let html = '';

    // 이전 버튼
    html += `
      <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
        class="w-10 h-10 flex items-center justify-center rounded-xl ${currentPage === 1 ? 'text-navy-300 cursor-not-allowed' : 'text-navy-500 hover:bg-surface-100'} transition-colors">
        <span class="material-symbols-outlined">chevron_left</span>
      </button>
    `;

    // 페이지 번호들
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      html += `<button onclick="goToPage(1)" class="w-10 h-10 flex items-center justify-center rounded-xl text-navy-600 hover:bg-surface-100 font-medium transition-colors">1</button>`;
      if (startPage > 2) {
        html += `<span class="w-10 h-10 flex items-center justify-center text-navy-400">...</span>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      if (i === currentPage) {
        html += `<button class="w-10 h-10 flex items-center justify-center rounded-xl bg-navy-800 text-white font-semibold shadow-md cursor-default">${i}</button>`;
      } else {
        html += `<button onclick="goToPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-xl text-navy-600 hover:bg-surface-100 font-medium transition-colors">${i}</button>`;
      }
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="w-10 h-10 flex items-center justify-center text-navy-400">...</span>`;
      }
      html += `<button onclick="goToPage(${totalPages})" class="w-10 h-10 flex items-center justify-center rounded-xl text-navy-600 hover:bg-surface-100 font-medium transition-colors">${totalPages}</button>`;
    }

    // 다음 버튼
    html += `
      <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
        class="w-10 h-10 flex items-center justify-center rounded-xl ${currentPage === totalPages ? 'text-navy-300 cursor-not-allowed' : 'text-navy-500 hover:bg-surface-100'} transition-colors">
        <span class="material-symbols-outlined">chevron_right</span>
      </button>
    `;

    paginationNav.innerHTML = html;
  }

  // 전역 함수로 노출
  window.goToPage = function(page) {
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
    if (page < 1 || page > totalPages) return;
    displayPage(page);
    document.getElementById('items-grid').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  function filterAndPaginate() {
    filteredItems = getFilteredItems();
    itemCount.textContent = filteredItems.length;
    currentPage = 1;
    displayPage(1);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // 모든 탭 비활성화
      tabs.forEach(t => {
        t.classList.remove('active', 'bg-navy-800', 'text-white', 'shadow-md');
        t.classList.add('bg-surface-100', 'text-navy-600');
      });

      // 클릭된 탭 활성화
      this.classList.add('active', 'bg-navy-800', 'text-white', 'shadow-md');
      this.classList.remove('bg-surface-100', 'text-navy-600');

      filterAndPaginate();
    });
  });

  searchInput.addEventListener('input', filterAndPaginate);

  // 초기 필터링 및 페이지네이션 실행
  filterAndPaginate();
});
</script>
