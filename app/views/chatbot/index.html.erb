<%# 챗봇 페이지 - 프리미엄 디자인 시스템 %>

<div class="min-h-screen bg-surface-50">
  <!-- 헤더 -->
  <div class="gradient-premium py-12 lg:py-16">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg mx-auto mb-4">
        <span class="material-symbols-outlined text-4xl text-white">support_agent</span>
      </div>
      <h1 class="text-3xl font-bold mb-2 text-white">공무원 업무 도우미</h1>
      <p class="text-slate-200">법령 · 예규 · 유권해석 · 실무 가이드</p>
    </div>
  </div>

  <!-- 검색 영역 -->
  <div class="max-w-4xl mx-auto px-4 -mt-8">
    <div class="card p-6 shadow-strong">
      <%= form_with url: chatbot_search_path, method: :get, data: { turbo_frame: "search-results" } do |f| %>
        <div class="flex gap-3">
          <div class="flex-1">
            <%= f.text_field :q,
                placeholder: "궁금한 업무를 입력하세요 (예: 수의계약 가능 금액, 출장비 지급 방법)",
                class: "input input-lg",
                autofocus: true %>
          </div>
          <button type="submit" class="btn btn-primary btn-lg">
            <span class="material-symbols-outlined">search</span>
            검색
          </button>
        </div>
      <% end %>

      <!-- 인기 키워드 -->
      <div class="mt-4 flex flex-wrap gap-2 items-center">
        <span class="text-sm text-slate-500 font-medium">인기 검색어:</span>
        <% %w[수의계약 연말정산 출장비 이월 기간제 보조금정산 겸직 일상경비].each do |keyword| %>
          <%= link_to keyword, chatbot_search_path(q: keyword),
              class: "px-3 py-1.5 bg-surface-100 text-slate-700 rounded-full text-sm font-medium hover:bg-indigo-100 hover:text-indigo-700 transition-all",
              data: { turbo: false } %>
        <% end %>
      </div>
    </div>

    <!-- 금액 기반 검색 -->
    <div class="card p-6 mt-4 shadow-soft">
      <h3 class="text-lg font-bold mb-4 text-slate-900 flex items-center gap-2">
        <span class="material-symbols-outlined text-amber-500">payments</span>
        금액으로 계약방법 찾기
      </h3>
      <div class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-semibold text-slate-700 mb-2">계약 분야</label>
          <select id="price-category" class="input">
            <option value="goods">물품</option>
            <option value="service">용역</option>
            <option value="construction">공사</option>
          </select>
        </div>
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-semibold text-slate-700 mb-2">추정가격 (원)</label>
          <input type="text" id="price-input"
                 placeholder="예: 30,000,000"
                 class="input"
                 oninput="formatPrice(this)">
        </div>
        <button onclick="searchByPrice()" class="btn btn-accent btn-md">
          <span class="material-symbols-outlined">check</span>
          확인
        </button>
      </div>

      <!-- 빠른 금액 버튼 -->
      <div class="mt-4 flex flex-wrap gap-2 items-center">
        <span class="text-sm text-slate-500 font-medium">빠른 선택:</span>
        <button onclick="setPrice(10000000)" class="px-3 py-1.5 bg-surface-100 text-slate-700 rounded-full text-sm font-medium hover:bg-emerald-100 hover:text-emerald-700 transition-all">1천만원</button>
        <button onclick="setPrice(20000000)" class="px-3 py-1.5 bg-surface-100 text-slate-700 rounded-full text-sm font-medium hover:bg-emerald-100 hover:text-emerald-700 transition-all">2천만원</button>
        <button onclick="setPrice(50000000)" class="px-3 py-1.5 bg-surface-100 text-slate-700 rounded-full text-sm font-medium hover:bg-emerald-100 hover:text-emerald-700 transition-all">5천만원</button>
        <button onclick="setPrice(100000000)" class="px-3 py-1.5 bg-surface-100 text-slate-700 rounded-full text-sm font-medium hover:bg-emerald-100 hover:text-emerald-700 transition-all">1억원</button>
        <button onclick="setPrice(200000000)" class="px-3 py-1.5 bg-surface-100 text-slate-700 rounded-full text-sm font-medium hover:bg-emerald-100 hover:text-emerald-700 transition-all">2억원</button>
      </div>

      <!-- 금액 검색 결과 -->
      <div id="price-result" class="mt-4 hidden"></div>
    </div>

    <!-- 주제별 가이드 -->
    <div class="card p-6 mt-4 shadow-soft">
      <h3 class="text-lg font-bold mb-4 text-slate-900 flex items-center gap-2">
        <span class="material-symbols-outlined text-indigo-600">menu_book</span>
        주제별 상세 가이드
      </h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <a href="/topics/private-contract" class="group block p-4 bg-gradient-to-br from-indigo-50 to-slate-50 rounded-xl border-2 border-transparent hover:border-indigo-300 hover:shadow-medium transition-all">
          <div class="icon-container icon-container-md bg-indigo-100 group-hover:bg-indigo-600 transition-colors mb-3">
            <span class="material-symbols-outlined text-xl text-indigo-600 group-hover:text-white transition-colors">edit_note</span>
          </div>
          <div class="font-semibold text-slate-800 group-hover:text-indigo-700">수의계약</div>
          <div class="text-xs text-slate-500 mt-1">법령·서식·흐름도</div>
        </a>
        <a href="/topics/travel-expense" class="group block p-4 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl border-2 border-transparent hover:border-emerald-300 hover:shadow-medium transition-all">
          <div class="icon-container icon-container-md bg-emerald-100 group-hover:bg-emerald-600 transition-colors mb-3">
            <span class="material-symbols-outlined text-xl text-emerald-600 group-hover:text-white transition-colors">work</span>
          </div>
          <div class="font-semibold text-slate-800 group-hover:text-emerald-700">출장비</div>
          <div class="text-xs text-slate-500 mt-1">여비규정·청구절차</div>
        </a>
        <a href="/topics/budget-carryover" class="group block p-4 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl border-2 border-transparent hover:border-amber-300 hover:shadow-medium transition-all">
          <div class="icon-container icon-container-md bg-amber-100 group-hover:bg-amber-600 transition-colors mb-3">
            <span class="material-symbols-outlined text-xl text-amber-600 group-hover:text-white transition-colors">event</span>
          </div>
          <div class="font-semibold text-slate-800 group-hover:text-amber-700">예산이월</div>
          <div class="text-xs text-slate-500 mt-1">명시·사고·계속비</div>
        </a>
        <a href="/topics/year-end-settlement" class="group block p-4 bg-gradient-to-br from-rose-50 to-pink-50 rounded-xl border-2 border-transparent hover:border-rose-300 hover:shadow-medium transition-all">
          <div class="icon-container icon-container-md bg-rose-100 group-hover:bg-rose-600 transition-colors mb-3">
            <span class="material-symbols-outlined text-xl text-rose-600 group-hover:text-white transition-colors">receipt</span>
          </div>
          <div class="font-semibold text-slate-800 group-hover:text-rose-700">연말정산</div>
          <div class="text-xs text-slate-500 mt-1">2025 변경사항</div>
        </a>
      </div>
    </div>
  </div>

  <!-- 검색 결과 영역 -->
  <%= turbo_frame_tag "search-results" do %>
    <div class="max-w-4xl mx-auto px-4 mt-8 pb-12">
      <!-- 기본 상태: 통계 및 인기 질문 표시 -->
      <div class="grid md:grid-cols-2 gap-6">
        <!-- 카테고리별 가이드 -->
        <div class="card p-6">
          <h2 class="text-lg font-bold mb-4 text-slate-900 flex items-center gap-2">
            <span class="material-symbols-outlined text-indigo-600">folder</span>
            실무 가이드
          </h2>
          <div class="space-y-2">
            <% Topic::CATEGORIES.each do |key, name| %>
              <%= link_to guides_path(category: name), class: "flex items-center justify-between py-3 border-b border-gray-100 last:border-0 hover:bg-surface-50 px-2 -mx-2 rounded-lg transition-colors cursor-pointer group", data: { turbo_frame: "_top" } do %>
                <span class="text-slate-700 font-medium group-hover:text-indigo-600"><%= name %></span>
                <span class="material-symbols-outlined text-gray-400 group-hover:text-indigo-600 text-lg">chevron_right</span>
              <% end %>
            <% end %>
          </div>
        </div>

        <!-- 자주 묻는 질문 -->
        <div class="card p-6">
          <h2 class="text-lg font-bold mb-4 text-slate-900 flex items-center gap-2">
            <span class="material-symbols-outlined text-amber-500">help</span>
            자주 묻는 질문
          </h2>
          <div class="space-y-3">
            <% @recent_popular.each_with_index do |article, i| %>
              <div class="block p-3 bg-surface-50 rounded-xl">
                <div class="flex items-start gap-3">
                  <span class="w-6 h-6 flex items-center justify-center bg-indigo-100 text-indigo-600 rounded-full text-xs font-bold shrink-0"><%= i + 1 %></span>
                  <p class="text-sm text-slate-800 font-medium"><%= article.title.gsub(/\(.*?\)/, '').strip %></p>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="text-center mt-10 text-sm text-slate-500">
        공무원 업무에 필요한 법령과 실무 가이드를 제공합니다
      </div>
    </div>
  <% end %>
</div>

<script>
// 금액 포맷팅 (천 단위 콤마)
function formatPrice(input) {
  let value = input.value.replace(/[^\d]/g, '');
  if (value) {
    value = parseInt(value).toLocaleString('ko-KR');
  }
  input.value = value;
}

// 빠른 금액 선택
function setPrice(amount) {
  document.getElementById('price-input').value = amount.toLocaleString('ko-KR');
  searchByPrice();
}

// 금액 기반 검색
function searchByPrice() {
  const category = document.getElementById('price-category').value;
  const priceStr = document.getElementById('price-input').value;
  const price = parseInt(priceStr.replace(/[^\d]/g, '')) || 0;

  if (price <= 0) {
    alert('금액을 입력해주세요.');
    return;
  }

  const resultDiv = document.getElementById('price-result');
  resultDiv.classList.remove('hidden');

  // 계약 방법 계산
  let result;
  const categoryName = { goods: '물품', service: '용역', construction: '공사' }[category];

  if (category === 'goods' || category === 'service') {
    if (price <= 20000000) {
      result = {
        method: '1인 견적 수의계약',
        color: 'forest',
        description: '1개 업체에서 견적서를 받아 계약 가능합니다. (특례기업은 5천만원 이하 1인 견적, 수의한도 1억원)',
        checklist: ['추정가격 산정', '견적서 1부 징구', '수의계약 사유서 작성', '계약서 작성'],
        tips: ['나라장터 등록 없이 가능', '견적서는 반드시 계약 전에 징구', '청년창업·여성·장애인기업 등은 5천만원까지 1인 견적 가능 (수의한도 1억원)']
      };
    } else if (price <= 100000000) {
      result = {
        method: '2인 이상 견적 수의계약',
        color: 'point',
        description: '2개 이상 업체에서 견적서를 받아 최저가로 계약합니다. (소기업·소상공인 특례 적용 시 1억원 이하)',
        checklist: ['예정가격 작성', '2인 이상 견적서 징구 (동일 조건)', '최저가 업체 선정', '수의계약 사유서 작성', '계약서 작성'],
        tips: ['동일한 규격/조건으로 견적 요청', '견적 마감일시 명시하여 통보', '소기업·소상공인 특례 적용 가능 여부 확인']
      };
    } else {
      result = {
        method: '경쟁입찰',
        color: 'navy',
        description: '나라장터를 통한 공개경쟁입찰을 진행해야 합니다.',
        checklist: ['입찰공고 (나라장터)', '현장설명회 (필요시)', '입찰서 접수', '개찰 및 낙찰자 결정', '계약 체결'],
        tips: ['공고기간 준수 (7일 이상)', '2회 유찰 시 수의계약 전환 가능']
      };
    }
  } else { // construction
    if (price <= 20000000) {
      result = {
        method: '1인 견적 수의계약',
        color: 'forest',
        description: '1개 업체에서 견적서를 받아 계약 가능합니다. (특례기업은 5천만원 이하 1인 견적)',
        checklist: ['설계서/도면 준비', '추정가격 산정', '견적서 1부 징구', '수의계약 사유서 작성', '계약서 작성'],
        tips: ['건설업 등록 업체 확인', '설계변경 가능성 고려', '청년창업·여성·장애인기업 등은 5천만원까지 1인 견적 가능']
      };
    } else if (price <= 400000000) {
      result = {
        method: '2인 이상 견적 수의계약',
        color: 'point',
        description: '2개 이상 업체에서 견적서를 받아 최저가로 계약합니다. (종합공사 4억원, 전문공사 2억원, 기타공사 1.6억원 이하)',
        checklist: ['설계서/도면 준비', '예정가격 작성', '2인 이상 견적서 징구', '최저가 업체 선정', '계약서 작성'],
        tips: ['건설업 등록증 확인', '시공능력평가액 확인', '공사 종류별 수의계약 한도 확인']
      };
    } else {
      result = {
        method: '경쟁입찰',
        color: 'navy',
        description: '나라장터를 통한 공개경쟁입찰을 진행해야 합니다.',
        checklist: ['설계서/도면 확정', '입찰공고 (나라장터)', '현장설명회', '입찰/개찰', '적격심사 (추정가 300억 미만)', '계약 체결'],
        tips: ['공고기간 준수 (7일~40일)', '현장설명 필수 여부 확인']
      };
    }
  }

  const colorMap = {
    forest: { bg: 'bg-emerald-50', border: 'border-emerald-500', text: 'text-emerald-700', badge: 'bg-emerald-100 text-emerald-800' },
    point: { bg: 'bg-indigo-50', border: 'border-indigo-500', text: 'text-indigo-700', badge: 'bg-indigo-100 text-indigo-800' },
    navy: { bg: 'bg-slate-50', border: 'border-slate-500', text: 'text-slate-700', badge: 'bg-slate-100 text-slate-800' }
  };
  const colors = colorMap[result.color];

  resultDiv.innerHTML = `
    <div class="${colors.bg} ${colors.border} border-2 rounded-2xl p-6 shadow-soft">
      <div class="flex items-center justify-between mb-4">
        <div>
          <span class="text-sm text-slate-500">${categoryName} · ${price.toLocaleString('ko-KR')}원</span>
          <h4 class="text-xl font-bold ${colors.text}">${result.method}</h4>
        </div>
        <span class="px-4 py-1.5 ${colors.badge} rounded-full text-sm font-semibold">${result.method}</span>
      </div>

      <p class="text-slate-700 mb-4">${result.description}</p>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h5 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">checklist</span>
            체크리스트
          </h5>
          <ul class="space-y-2">
            ${result.checklist.map(item => `<li class="flex items-center gap-2 text-sm text-slate-600"><span class="w-4 h-4 border-2 border-gray-300 rounded"></span>${item}</li>`).join('')}
          </ul>
        </div>
        <div>
          <h5 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">lightbulb</span>
            실무 팁
          </h5>
          <ul class="space-y-2">
            ${result.tips.map(tip => `<li class="text-sm text-slate-600 flex items-start gap-2"><span class="text-amber-500 font-bold">•</span>${tip}</li>`).join('')}
          </ul>
        </div>
      </div>

      <div class="mt-5 pt-5 border-t border-gray-200">
        <a href="/topics/private-contract" class="text-indigo-600 hover:text-indigo-700 font-semibold text-sm flex items-center gap-1 transition-colors">
          <span class="material-symbols-outlined">menu_book</span>
          수의계약 상세 가이드 보기
          <span class="material-symbols-outlined text-lg">arrow_forward</span>
        </a>
      </div>
    </div>
  `;
}
</script>
