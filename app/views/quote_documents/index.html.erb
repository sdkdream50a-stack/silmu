<%# 견적서 일괄 문서생성 %>

<style>
.qd-card { background:#fff; border-radius:16px; border:1px solid #e5e7eb; padding:28px; margin-bottom:24px; }
.qd-label { display:block; font-size:13px; font-weight:700; color:#334155; margin-bottom:6px; }
.qd-label .qd-required { color:#ef4444; margin-left:2px; }
.qd-input { width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:10px 14px; font-size:14px; color:#1e293b; transition:border-color .2s, box-shadow .2s; box-sizing:border-box; }
.qd-input:focus { outline:none; border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79,70,229,.1); }
.qd-textarea { min-height:80px; resize:vertical; font-family:inherit; }
.qd-select { appearance:auto; }
.qd-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.qd-grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
.qd-btn { display:inline-flex; align-items:center; gap:6px; padding:12px 28px; border-radius:12px; font-weight:600; font-size:15px; border:none; cursor:pointer; transition:all .2s; }
.qd-btn-primary { background:#4f46e5; color:#fff; }
.qd-btn-primary:hover { background:#4338ca; }
.qd-btn-secondary { background:#f1f5f9; color:#475569; border:1px solid #e2e8f0; }
.qd-btn-secondary:hover { background:#e2e8f0; }
.qd-btn-success { background:#059669; color:#fff; }
.qd-btn-success:hover { background:#047857; }
.qd-btn:disabled { opacity:.5; cursor:not-allowed; }
.qd-btn-sm { padding:8px 16px; font-size:13px; border-radius:8px; }

/* Steps indicator */
.qd-steps { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:32px; }
.qd-step { display:flex; align-items:center; gap:8px; padding:8px 16px; border-radius:10px; font-size:13px; font-weight:600; color:#94a3b8; background:#f8fafc; transition:all .3s; }
.qd-step.active { color:#4f46e5; background:#eef2ff; }
.qd-step.done { color:#059669; background:#ecfdf5; }
.qd-step-num { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; background:#e2e8f0; color:#64748b; }
.qd-step.active .qd-step-num { background:#4f46e5; color:#fff; }
.qd-step.done .qd-step-num { background:#059669; color:#fff; }
.qd-step-arrow { color:#cbd5e1; font-size:18px; }

/* Upload zone */
.qd-upload-zone { border:2px dashed #cbd5e1; border-radius:16px; padding:48px 24px; text-align:center; cursor:pointer; transition:all .3s; background:#fafbfc; }
.qd-upload-zone:hover, .qd-upload-zone.dragover { border-color:#4f46e5; background:#eef2ff; }
.qd-upload-zone.has-file { border-color:#059669; background:#ecfdf5; }

/* Items table */
.qd-items-table { width:100%; border-collapse:collapse; margin:12px 0; font-size:13px; }
.qd-items-table th { background:#f8fafc; padding:8px 10px; text-align:center; border:1px solid #e2e8f0; font-weight:600; color:#475569; font-size:12px; }
.qd-items-table td { padding:4px 6px; border:1px solid #e2e8f0; }
.qd-items-table input { width:100%; border:1px solid transparent; background:transparent; padding:6px 8px; font-size:13px; border-radius:6px; }
.qd-items-table input:focus { outline:none; border-color:#4f46e5; background:#fff; }
.qd-items-table .qd-num { text-align:right; }
.qd-item-amount { text-align:right; padding:6px 10px !important; font-weight:600; color:#1e293b; }
.qd-item-remove { cursor:pointer; color:#ef4444; font-size:18px; text-align:center; }
.qd-item-remove:hover { color:#dc2626; }

/* Tabs */
.qd-tabs { display:flex; border-bottom:2px solid #e5e7eb; margin-bottom:0; }
.qd-tab { padding:12px 20px; font-size:14px; font-weight:600; color:#64748b; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all .2s; }
.qd-tab:hover { color:#4f46e5; }
.qd-tab.active { color:#4f46e5; border-bottom-color:#4f46e5; }
.qd-tab-content { display:none; }
.qd-tab-content.active { display:block; }

/* Document styles */
.qd-doc { background:#fff; border:2px solid #c7d2fe; border-radius:0 0 16px 16px; padding:32px; }
.qd-doc-header { text-align:center; margin-bottom:28px; padding-bottom:20px; border-bottom:2px solid #1e293b; }
.qd-doc-title { font-size:22px; font-weight:800; color:#1e293b; letter-spacing:2px; }
.qd-doc-section { margin-bottom:20px; }
.qd-doc-section-title { font-size:14px; font-weight:700; color:#4f46e5; margin-bottom:8px; padding:6px 12px; background:#eef2ff; border-radius:8px; display:inline-block; }
.qd-doc-content { font-size:14px; color:#334155; line-height:1.8; padding:8px 0 8px 12px; border-left:3px solid #e0e7ff; white-space:pre-wrap; }
.qd-doc-table { width:100%; border-collapse:collapse; margin:8px 0; }
.qd-doc-table th { background:#f8fafc; padding:8px 12px; text-align:left; border:1px solid #e2e8f0; font-size:13px; font-weight:600; color:#475569; }
.qd-doc-table td { padding:8px 12px; border:1px solid #e2e8f0; font-size:14px; color:#1e293b; }
.qd-doc-table .qd-right { text-align:right; }
.qd-doc-footer { text-align:center; margin-top:32px; padding-top:20px; border-top:1px solid #e2e8f0; color:#64748b; font-size:13px; }

.qd-actions { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }

/* Summary cards */
.qd-summary { display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin:16px 0; }
.qd-summary-item { background:#f8fafc; border-radius:12px; padding:14px 16px; text-align:center; border:1px solid #e5e7eb; }
.qd-summary-item .label { font-size:12px; color:#64748b; margin-bottom:4px; }
.qd-summary-item .value { font-size:18px; font-weight:700; color:#1e293b; }

/* Toast */
.qd-toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(100px); background:#1e293b; color:#fff; padding:12px 24px; border-radius:12px; font-size:14px; font-weight:600; z-index:9999; transition:transform .3s ease; display:flex; align-items:center; gap:8px; }
.qd-toast.show { transform:translateX(-50%) translateY(0); }

/* Loading spinner */
.qd-spinner { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:qd-spin 1s ease-in-out infinite; }
@keyframes qd-spin { to { transform:rotate(360deg); } }

/* Hidden */
.qd-hidden { display:none !important; }

@media print {
  body * { visibility:hidden; }
  .qd-doc-print-target, .qd-doc-print-target * { visibility:visible; }
  .qd-doc-print-target { position:absolute; left:0; top:0; width:100%; padding:20px; border:none; }
  .no-print { display:none !important; }
}
@media (max-width:640px) {
  .qd-grid { grid-template-columns:1fr; }
  .qd-grid-3 { grid-template-columns:1fr; }
  .qd-summary { grid-template-columns:1fr; }
  .qd-steps { flex-wrap:wrap; }
  .qd-doc-title { font-size:18px; }
  .qd-tabs { overflow-x:auto; }
}
</style>

<!-- 헤더 -->
<section class="gradient-indigo text-white py-12 lg:py-16">
  <div class="container-wide">
    <div class="flex items-start gap-5">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
        <span class="material-symbols-outlined text-4xl text-white">receipt_long</span>
      </div>
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">견적서 일괄 문서생성</h1>
        <p class="text-indigo-100 text-lg">견적서 1장으로 수의계약 서류를 한 번에 자동 생성</p>
      </div>
    </div>
  </div>
</section>

<section class="py-10">
  <div class="container-wide max-w-5xl">

    <% unless user_signed_in? %>
      <div class="qd-card" style="background:linear-gradient(135deg,#eef2ff,#e0e7ff); border-color:#c7d2fe; text-align:center; padding:40px 28px;">
        <span class="material-symbols-outlined" style="font-size:48px; color:#4f46e5; margin-bottom:12px;">lock</span>
        <h2 style="font-size:20px; font-weight:700; color:#312e81; margin-bottom:8px;">로그인이 필요한 기능입니다</h2>
        <p style="color:#4338ca; margin-bottom:20px; font-size:15px;">AI 문서 분석 기능은 회원만 이용할 수 있습니다.<br>무료 회원가입 후 바로 사용하세요.</p>
        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
          <a href="<%= new_user_session_path %>" class="qd-btn qd-btn-primary">
            <span class="material-symbols-outlined">login</span> 로그인
          </a>
          <a href="<%= new_user_registration_path %>" class="qd-btn qd-btn-secondary">
            <span class="material-symbols-outlined">person_add</span> 회원가입
          </a>
        </div>
      </div>
    <% end %>

    <!-- Steps Indicator -->
    <div class="qd-steps" id="qd-steps">
      <div class="qd-step active" data-step="1">
        <span class="qd-step-num">1</span> 견적서 업로드
      </div>
      <span class="material-symbols-outlined qd-step-arrow">chevron_right</span>
      <div class="qd-step" data-step="2">
        <span class="qd-step-num">2</span> 데이터 확인
      </div>
      <span class="material-symbols-outlined qd-step-arrow">chevron_right</span>
      <div class="qd-step" data-step="3">
        <span class="qd-step-num">3</span> 문서 생성
      </div>
    </div>

    <!-- ===== STEP 1: 업로드 ===== -->
    <div id="qd-step1">
      <!-- 견적서 검토 안내 -->
      <a href="/forms/견적서검토.html" class="qd-card" style="display:flex; align-items:center; gap:16px; background:#fffbeb; border-color:#fde68a; text-decoration:none; cursor:pointer; transition:all .2s;" onmouseenter="this.style.borderColor='#f59e0b'" onmouseleave="this.style.borderColor='#fde68a'">
        <div style="width:44px; height:44px; background:#fef3c7; border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
          <span class="material-symbols-outlined" style="color:#d97706; font-size:24px;">fact_check</span>
        </div>
        <div style="flex:1;">
          <div style="font-size:14px; font-weight:700; color:#92400e;">견적서 검토를 먼저 해보세요</div>
          <div style="font-size:13px; color:#a16207; margin-top:2px;">견적 금액이 적정한지 확인한 후 서류를 생성하면 더 안전합니다</div>
        </div>
        <span class="material-symbols-outlined" style="color:#d97706;">arrow_forward</span>
      </a>

      <div class="qd-card">
        <h2 style="font-size:20px; font-weight:700; color:#1e293b; margin-bottom:6px; display:flex; align-items:center; gap:8px;">
          <span class="material-symbols-outlined text-indigo-500">upload_file</span>
          견적서 업로드
        </h2>
        <p style="font-size:14px; color:#64748b; margin-bottom:24px;">업체로부터 받은 견적서를 업로드하면 AI가 자동으로 데이터를 추출합니다.</p>

        <div class="qd-upload-zone" id="qd-upload-zone"
             onclick="document.getElementById('qd-file-input').click()">
          <input type="file" id="qd-file-input" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none;" onchange="qdFilesSelected(this)">
          <div id="qd-upload-placeholder">
            <span class="material-symbols-outlined" style="font-size:48px; color:#94a3b8; display:block; margin-bottom:12px;">cloud_upload</span>
            <div style="font-size:16px; font-weight:600; color:#475569; margin-bottom:4px;">견적서를 드래그하거나 클릭하여 업로드</div>
            <div style="font-size:13px; color:#94a3b8;">PDF, JPG, PNG (파일당 최대 20MB, 여러 장 가능)</div>
          </div>
          <div id="qd-upload-info" class="qd-hidden">
            <span class="material-symbols-outlined" style="font-size:48px; color:#059669; display:block; margin-bottom:12px;">description</span>
            <div id="qd-file-list"></div>
            <div style="font-size:12px; color:#94a3b8; margin-top:8px;">클릭하거나 드래그하여 파일을 더 추가할 수 있습니다</div>
          </div>
        </div>

        <div style="text-align:center; margin-top:24px;">
          <button class="qd-btn qd-btn-primary" id="qd-analyze-btn" onclick="qdAnalyze()" disabled>
            <span class="material-symbols-outlined">auto_awesome</span>
            <span id="qd-analyze-text">AI 분석 시작</span>
          </button>
        </div>

        <div id="qd-error" class="qd-hidden" style="margin-top:16px; padding:12px 16px; background:#fef2f2; border:1px solid #fecaca; border-radius:10px; color:#dc2626; font-size:14px; display:flex; align-items:center; gap:8px;">
          <span class="material-symbols-outlined" style="font-size:18px;">error</span>
          <span id="qd-error-msg"></span>
        </div>
      </div>

      <!-- 안내 -->
      <div class="qd-card" style="background:#f0fdf4; border-color:#bbf7d0;">
        <h3 style="font-size:15px; font-weight:700; color:#166534; margin-bottom:12px; display:flex; align-items:center; gap:6px;">
          <span class="material-symbols-outlined" style="font-size:20px;">lightbulb</span>
          이런 분에게 추천합니다
        </h3>
        <ul style="font-size:14px; color:#15803d; line-height:2;">
          <li>- 1인 소액수의 계약 서류를 한 번에 만들고 싶은 분</li>
          <li>- 견적서를 받았는데 사업계획서·소요예산·예정가격·과업내용서 등을 따로 작성하기 번거로운 분</li>
          <li>- 견적서 데이터를 직접 옮겨적다가 오타가 나는 게 걱정인 분</li>
        </ul>
      </div>
    </div>

    <!-- ===== STEP 2: 데이터 확인/수정 ===== -->
    <div id="qd-step2" class="qd-hidden">
      <div class="qd-card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
          <h2 style="font-size:20px; font-weight:700; color:#1e293b; display:flex; align-items:center; gap:8px;">
            <span class="material-symbols-outlined text-indigo-500">edit_note</span>
            추출 데이터 확인
          </h2>
          <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdGoStep(1)">
            <span class="material-symbols-outlined" style="font-size:16px;">arrow_back</span> 다시 업로드
          </button>
        </div>
        <p style="font-size:14px; color:#64748b; margin-bottom:24px;">AI가 추출한 데이터를 확인하고 필요시 수정하세요. 추가 입력 항목도 작성해주세요.</p>

        <!-- 업체 정보 -->
        <div style="font-size:14px; font-weight:700; color:#475569; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid #e5e7eb;">업체 정보 (견적서에서 추출)</div>
        <div class="qd-grid" style="margin-bottom:16px;">
          <div>
            <label class="qd-label">업체명</label>
            <input type="text" class="qd-input" id="qd-company-name">
          </div>
          <div>
            <label class="qd-label">사업자등록번호</label>
            <input type="text" class="qd-input" id="qd-business-no">
          </div>
        </div>
        <div class="qd-grid" style="margin-bottom:16px;">
          <div>
            <label class="qd-label">대표자</label>
            <input type="text" class="qd-input" id="qd-representative">
          </div>
          <div>
            <label class="qd-label">견적일자</label>
            <input type="date" class="qd-input" id="qd-quote-date">
          </div>
        </div>

        <!-- 건명 -->
        <div style="font-size:14px; font-weight:700; color:#475569; margin-bottom:12px; margin-top:24px; padding-bottom:6px; border-bottom:1px solid #e5e7eb;">건명/품목</div>
        <div style="margin-bottom:16px;">
          <label class="qd-label">건명 (사업명) <span class="qd-required">*</span></label>
          <input type="text" class="qd-input" id="qd-project-name" placeholder="예: 사무실 에어컨 구매">
        </div>

        <!-- 내역 항목 -->
        <div style="font-size:14px; font-weight:700; color:#475569; margin-bottom:12px; margin-top:24px; padding-bottom:6px; border-bottom:1px solid #e5e7eb;">내역 항목</div>
        <div style="overflow-x:auto;">
          <table class="qd-items-table" id="qd-items-table">
            <thead>
              <tr>
                <th style="width:30px;">No</th>
                <th style="min-width:160px;">품명</th>
                <th style="min-width:120px;">규격</th>
                <th style="width:60px;">단위</th>
                <th style="width:70px;">수량</th>
                <th style="width:100px;">단가</th>
                <th style="width:100px;">금액</th>
                <th style="width:36px;"></th>
              </tr>
            </thead>
            <tbody id="qd-items-body">
            </tbody>
          </table>
        </div>
        <div style="margin-top:8px;">
          <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdAddItem()">
            <span class="material-symbols-outlined" style="font-size:16px;">add</span> 항목 추가
          </button>
        </div>

        <!-- 간접비 (원가계산서 기반 공사 견적일 때 표시) -->
        <div id="qd-overhead-section" class="qd-hidden" style="margin-top:16px; padding:14px 16px; background:#fffbeb; border:1px solid #fde68a; border-radius:10px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div style="font-size:13px; font-weight:600; color:#92400e; display:flex; align-items:center; gap:4px;">
                <span class="material-symbols-outlined" style="font-size:16px;">info</span>
                간접비·관리비·이윤 (원가계산서 기반)
              </div>
              <div style="font-size:12px; color:#a16207; margin-top:2px;">간접노무비, 보험료, 기타경비, 일반관리비, 이윤 등이 포함된 금액입니다</div>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
              <input type="number" class="qd-input" id="qd-overhead-input" value="0" min="0"
                     style="width:150px; text-align:right; padding:6px 10px; font-size:14px; font-weight:600;"
                     onchange="qdRecalc()" oninput="qdRecalc()">
              <span style="font-size:13px; color:#64748b;">원</span>
            </div>
          </div>
        </div>

        <!-- 금액 요약 -->
        <div class="qd-summary" id="qd-amount-summary">
          <div class="qd-summary-item">
            <div class="label">공급가액</div>
            <div class="value" id="qd-supply-display">0</div>
          </div>
          <div class="qd-summary-item">
            <div class="label">부가세 (10%)</div>
            <div class="value" id="qd-vat-display">0</div>
          </div>
          <div class="qd-summary-item" style="background:#eef2ff; border-color:#c7d2fe;">
            <div class="label" style="color:#4f46e5;">합계금액</div>
            <div class="value" style="color:#4f46e5;" id="qd-total-display">0</div>
          </div>
        </div>

        <!-- 추가 입력 -->
        <div style="font-size:14px; font-weight:700; color:#475569; margin-bottom:12px; margin-top:24px; padding-bottom:6px; border-bottom:1px solid #e5e7eb;">추가 입력 (사업계획서용)</div>
        <div class="qd-grid" style="margin-bottom:16px;">
          <div>
            <label class="qd-label">사업부서 <span class="qd-required">*</span></label>
            <input type="text" class="qd-input" id="qd-department" placeholder="예: 총무과">
          </div>
          <div>
            <label class="qd-label">담당자</label>
            <input type="text" class="qd-input" id="qd-manager" placeholder="예: 홍길동 주무관">
          </div>
        </div>
        <div class="qd-grid" style="margin-bottom:16px;">
          <div>
            <label class="qd-label">담당자 연락처</label>
            <input type="text" class="qd-input" id="qd-dept-phone" placeholder="예: 02-1234-5678">
          </div>
          <div>
            <label class="qd-label">계약 구분</label>
            <select class="qd-input qd-select" id="qd-contract-type" onchange="qdUpdateTypeFields()">
              <option value="물품">물품 구매</option>
              <option value="용역">용역</option>
              <option value="공사">공사</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom:16px;">
          <label class="qd-label">사업 필요성 <span class="qd-required">*</span></label>
          <textarea class="qd-input qd-textarea" id="qd-necessity" placeholder="사업을 추진해야 하는 이유를 간단히 작성하세요.&#10;예: 기존 에어컨이 노후화되어 냉방효율이 떨어지고 전력 소비가 과다하여 교체가 필요함"></textarea>
        </div>

        <!-- 용역 추가 입력 -->
        <div id="qd-fields-service" class="qd-hidden">
          <div style="font-size:14px; font-weight:700; color:#475569; margin-bottom:12px; margin-top:24px; padding-bottom:6px; border-bottom:1px solid #e5e7eb;">
            과업내용서 추가 정보 <span style="font-size:12px; font-weight:400; color:#94a3b8;">용역</span>
          </div>
          <div class="qd-grid" style="margin-bottom:16px;">
            <div>
              <label class="qd-label">과업 기간</label>
              <input type="text" class="qd-input" id="qd-task-period" placeholder="예: 계약일로부터 30일">
            </div>
            <div>
              <label class="qd-label">용역 장소</label>
              <input type="text" class="qd-input" id="qd-task-location" placeholder="예: 발주기관 지정 장소">
            </div>
          </div>
          <div style="margin-bottom:16px;">
            <label class="qd-label">납품물</label>
            <textarea class="qd-input qd-textarea" id="qd-deliverables" placeholder="납품물 목록을 작성하세요.&#10;예: 최종보고서 2부, 결과물 CD 1매" style="min-height:60px;"></textarea>
          </div>
        </div>

        <!-- 공사 추가 입력 -->
        <div id="qd-fields-construction" class="qd-hidden">
          <div style="font-size:14px; font-weight:700; color:#475569; margin-bottom:12px; margin-top:24px; padding-bottom:6px; border-bottom:1px solid #e5e7eb;">
            시방서 추가 정보 <span style="font-size:12px; font-weight:400; color:#94a3b8;">공사</span>
          </div>
          <div class="qd-grid" style="margin-bottom:16px;">
            <div>
              <label class="qd-label">공사 장소</label>
              <input type="text" class="qd-input" id="qd-construction-location" placeholder="예: 본관 2층 사무실">
            </div>
            <div>
              <label class="qd-label">공사 기간</label>
              <input type="text" class="qd-input" id="qd-construction-period" placeholder="예: 착공일로부터 30일">
            </div>
          </div>
          <div style="margin-bottom:16px;">
            <label class="qd-label">시공 시 유의사항</label>
            <textarea class="qd-input qd-textarea" id="qd-construction-notes" placeholder="시공 유의사항을 작성하세요.&#10;예: 근무시간 외 작업, 분진 및 소음 최소화" style="min-height:60px;"></textarea>
          </div>
        </div>

        <div style="text-align:center; margin-top:28px;">
          <button class="qd-btn qd-btn-success" id="qd-generate-btn" onclick="qdGenerateDocuments()">
            <span class="material-symbols-outlined">description</span>
            <span id="qd-generate-text">3개 문서 일괄 생성</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ===== STEP 3: 문서 생성 결과 ===== -->
    <div id="qd-step3" class="qd-hidden">
      <div class="qd-card" style="padding:0; overflow:hidden;">
        <div style="padding:20px 28px 0; display:flex; align-items:center; justify-content:space-between;">
          <h2 style="font-size:20px; font-weight:700; color:#1e293b; display:flex; align-items:center; gap:8px;">
            <span class="material-symbols-outlined text-green-600">check_circle</span>
            문서 생성 완료
          </h2>
          <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdGoStep(2)">
            <span class="material-symbols-outlined" style="font-size:16px;">arrow_back</span> 데이터 수정
          </button>
        </div>

        <!-- Tabs -->
        <div style="padding:16px 28px 0;">
          <div class="qd-tabs">
            <div class="qd-tab active" onclick="qdSwitchTab('plan')">
              <span class="material-symbols-outlined" style="font-size:16px; vertical-align:middle;">assignment</span>
              사업계획서
            </div>
            <div class="qd-tab" onclick="qdSwitchTab('budget')">
              <span class="material-symbols-outlined" style="font-size:16px; vertical-align:middle;">calculate</span>
              소요예산
            </div>
            <div class="qd-tab" onclick="qdSwitchTab('price')">
              <span class="material-symbols-outlined" style="font-size:16px; vertical-align:middle;">price_check</span>
              예정가격
            </div>
            <div class="qd-tab qd-hidden" id="qd-tab-btn-taskorder" onclick="qdSwitchTab('taskorder')">
              <span class="material-symbols-outlined" style="font-size:16px; vertical-align:middle;">description</span>
              과업내용서
            </div>
            <div class="qd-tab qd-hidden" id="qd-tab-btn-estimate" onclick="qdSwitchTab('estimate')">
              <span class="material-symbols-outlined" style="font-size:16px; vertical-align:middle;">receipt_long</span>
              물량내역서+시방서
            </div>
          </div>
        </div>

        <!-- Tab: 사업계획서 -->
        <div class="qd-tab-content active" id="qd-tab-plan">
          <div style="padding:20px 28px;">
            <div class="qd-actions no-print">
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdCopyDoc('plan')">
                <span class="material-symbols-outlined" style="font-size:16px;">content_copy</span> 복사
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdDownloadDoc('plan', '사업계획서')">
                <span class="material-symbols-outlined" style="font-size:16px;">download</span> 다운로드
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdPrintDoc('plan')">
                <span class="material-symbols-outlined" style="font-size:16px;">print</span> 인쇄
              </button>
            </div>
            <div class="qd-doc" id="qd-doc-plan"></div>
          </div>
        </div>

        <!-- Tab: 소요예산 -->
        <div class="qd-tab-content" id="qd-tab-budget">
          <div style="padding:20px 28px;">
            <div class="qd-actions no-print">
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdCopyDoc('budget')">
                <span class="material-symbols-outlined" style="font-size:16px;">content_copy</span> 복사
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdDownloadDoc('budget', '소요예산추정')">
                <span class="material-symbols-outlined" style="font-size:16px;">download</span> 다운로드
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdPrintDoc('budget')">
                <span class="material-symbols-outlined" style="font-size:16px;">print</span> 인쇄
              </button>
            </div>
            <div class="qd-doc" id="qd-doc-budget"></div>
          </div>
        </div>

        <!-- Tab: 예정가격 -->
        <div class="qd-tab-content" id="qd-tab-price">
          <div style="padding:20px 28px;">
            <div class="qd-actions no-print">
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdCopyDoc('price')">
                <span class="material-symbols-outlined" style="font-size:16px;">content_copy</span> 복사
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdDownloadDoc('price', '예정가격조서')">
                <span class="material-symbols-outlined" style="font-size:16px;">download</span> 다운로드
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdPrintDoc('price')">
                <span class="material-symbols-outlined" style="font-size:16px;">print</span> 인쇄
              </button>
            </div>
            <div class="qd-doc" id="qd-doc-price"></div>
          </div>
        </div>

        <!-- Tab: 과업내용서 (용역) -->
        <div class="qd-tab-content" id="qd-tab-taskorder">
          <div style="padding:20px 28px;">
            <div class="qd-actions no-print">
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdCopyDoc('taskorder')">
                <span class="material-symbols-outlined" style="font-size:16px;">content_copy</span> 복사
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdDownloadDoc('taskorder', '과업내용서')">
                <span class="material-symbols-outlined" style="font-size:16px;">download</span> 다운로드
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdPrintDoc('taskorder')">
                <span class="material-symbols-outlined" style="font-size:16px;">print</span> 인쇄
              </button>
            </div>
            <div class="qd-doc" id="qd-doc-taskorder"></div>
          </div>
        </div>

        <!-- Tab: 물량내역서+시방서 (공사) -->
        <div class="qd-tab-content" id="qd-tab-estimate">
          <div style="padding:20px 28px;">
            <div class="qd-actions no-print">
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdCopyDoc('estimate')">
                <span class="material-symbols-outlined" style="font-size:16px;">content_copy</span> 복사
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdDownloadDoc('estimate', '물량내역서_시방서')">
                <span class="material-symbols-outlined" style="font-size:16px;">download</span> 다운로드
              </button>
              <button class="qd-btn qd-btn-secondary qd-btn-sm" onclick="qdPrintDoc('estimate')">
                <span class="material-symbols-outlined" style="font-size:16px;">print</span> 인쇄
              </button>
            </div>
            <div class="qd-doc" id="qd-doc-estimate"></div>
          </div>
        </div>
      </div>

      <!-- 전체 다시하기 -->
      <div style="text-align:center; margin-top:16px;">
        <button class="qd-btn qd-btn-secondary" onclick="qdReset()">
          <span class="material-symbols-outlined" style="font-size:18px;">refresh</span> 새 견적서로 다시 시작
        </button>
      </div>
    </div>

  </div>
</section>

<!-- 토스트 -->
<div class="qd-toast" id="qd-toast">
  <span class="material-symbols-outlined" style="font-size:18px;">check_circle</span>
  <span id="qd-toast-msg"></span>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<script>
// ========== 유틸 ==========
function qdEscape(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function qdFmt(n) {
  return Number(n || 0).toLocaleString();
}

function qdNumberToKorean(n) {
  if (!n || n === 0) return '영';
  const units = ['', '만', '억', '조'];
  const digits = ['', '일', '이', '삼', '사', '오', '육', '칠', '팔', '구'];
  const subUnits = ['', '십', '백', '천'];
  let result = '';
  let unitIndex = 0;
  while (n > 0) {
    let part = n % 10000;
    if (part > 0) {
      let partStr = '';
      let subIndex = 0;
      while (part > 0) {
        let d = part % 10;
        if (d > 0) {
          partStr = (d === 1 && subIndex > 0 ? '' : digits[d]) + subUnits[subIndex] + partStr;
        }
        part = Math.floor(part / 10);
        subIndex++;
      }
      result = partStr + units[unitIndex] + ' ' + result;
    }
    n = Math.floor(n / 10000);
    unitIndex++;
  }
  return result.trim();
}

function qdShowToast(msg) {
  const t = document.getElementById('qd-toast');
  document.getElementById('qd-toast-msg').textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function qdDateStr() {
  const d = new Date();
  return d.getFullYear() + '.' + String(d.getMonth()+1).padStart(2,'0') + '.' + String(d.getDate()).padStart(2,'0');
}

// ========== Step 전환 ==========
function qdGoStep(n) {
  document.getElementById('qd-step1').classList.toggle('qd-hidden', n !== 1);
  document.getElementById('qd-step2').classList.toggle('qd-hidden', n !== 2);
  document.getElementById('qd-step3').classList.toggle('qd-hidden', n !== 3);

  document.querySelectorAll('.qd-step').forEach(el => {
    const s = parseInt(el.dataset.step);
    el.classList.remove('active', 'done');
    if (s < n) el.classList.add('done');
    if (s === n) el.classList.add('active');
  });

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ========== STEP 1: 파일 업로드 ==========
let qdSelectedFiles = [];

// 드래그 앤 드롭
const uploadZone = document.getElementById('qd-upload-zone');
uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  if (e.dataTransfer.files.length > 0) {
    qdAddFiles(e.dataTransfer.files);
  }
});

function qdFilesSelected(input) {
  if (input.files.length > 0) {
    qdAddFiles(input.files);
  }
  input.value = '';
}

function qdAddFiles(fileList) {
  const allowed = ['application/pdf', 'image/jpeg', 'image/png'];
  for (const file of fileList) {
    if (!allowed.includes(file.type)) {
      qdShowError('지원하지 않는 파일 형식입니다. (PDF, JPG, PNG만 가능)');
      return;
    }
    if (file.size > 20 * 1024 * 1024) {
      qdShowError('개별 파일 크기는 20MB 이하여야 합니다.');
      return;
    }
  }
  qdHideError();
  for (const file of fileList) {
    if (!qdSelectedFiles.some(f => f.name === file.name && f.size === file.size)) {
      qdSelectedFiles.push(file);
    }
  }
  qdUpdateFileList();
}

function qdRemoveFile(index) {
  event.stopPropagation();
  qdSelectedFiles.splice(index, 1);
  qdUpdateFileList();
}

function qdUpdateFileList() {
  const hasFiles = qdSelectedFiles.length > 0;
  document.getElementById('qd-upload-placeholder').classList.toggle('qd-hidden', hasFiles);
  document.getElementById('qd-upload-info').classList.toggle('qd-hidden', !hasFiles);
  uploadZone.classList.toggle('has-file', hasFiles);
  document.getElementById('qd-analyze-btn').disabled = !hasFiles;
  if (hasFiles) {
    let html = '';
    qdSelectedFiles.forEach((f, i) => {
      html += '<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">' +
        '<span class="material-symbols-outlined" style="font-size:16px;color:#059669;">description</span>' +
        '<span style="font-size:14px;color:#1e293b;">' + qdEscape(f.name) + '</span>' +
        '<span style="font-size:12px;color:#94a3b8;">(' + (f.size/1024/1024).toFixed(2) + ' MB)</span>' +
        '<span class="material-symbols-outlined" onclick="qdRemoveFile(' + i + ')" style="cursor:pointer;color:#ef4444;font-size:16px;">close</span>' +
        '</div>';
    });
    const totalSize = qdSelectedFiles.reduce((s, f) => s + f.size, 0);
    html += '<div style="font-size:12px;color:#64748b;margin-top:6px;">' + qdSelectedFiles.length + '개 파일 · 총 ' + (totalSize/1024/1024).toFixed(2) + ' MB</div>';
    document.getElementById('qd-file-list').innerHTML = html;
  }
}

function qdShowError(msg) {
  document.getElementById('qd-error').classList.remove('qd-hidden');
  document.getElementById('qd-error-msg').textContent = msg;
}

function qdHideError() {
  document.getElementById('qd-error').classList.add('qd-hidden');
}

// ========== AI 분석 ==========
function qdAnalyze() {
  if (qdSelectedFiles.length === 0) return;
  qdHideError();

  const btn = document.getElementById('qd-analyze-btn');
  const textEl = document.getElementById('qd-analyze-text');
  btn.disabled = true;
  textEl.innerHTML = '<span class="qd-spinner"></span> AI 분석 중...';

  const formData = new FormData();
  qdSelectedFiles.forEach(f => formData.append('files[]', f));

  fetch('/quote-documents/extract', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
    }
  })
  .then(r => r.json())
  .then(data => {
    btn.disabled = false;
    textEl.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> AI 분석 시작';
    if (window.checkAiLoginRequired && window.checkAiLoginRequired(data)) return;

    if (data.success) {
      qdPopulateFields(data.fields);
      qdGoStep(2);
      qdShowToast('견적서 분석이 완료되었습니다');
    } else {
      qdShowError(data.error || '분석에 실패했습니다.');
    }
  })
  .catch(err => {
    btn.disabled = false;
    textEl.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> AI 분석 시작';
    qdShowError('네트워크 오류가 발생했습니다. 다시 시도해주세요.');
  });
}

// ========== STEP 2: 필드 채우기 ==========
function qdPopulateFields(f) {
  document.getElementById('qd-company-name').value = f.company_name || '';
  document.getElementById('qd-business-no').value = f.business_no || '';
  document.getElementById('qd-representative').value = f.representative || '';
  document.getElementById('qd-project-name').value = f.project_name || '';

  if (f.quote_date) {
    document.getElementById('qd-quote-date').value = f.quote_date;
  }

  // 계약 구분 자동 설정
  if (f.contract_type) {
    const typeMap = { '물품': '물품', '용역': '용역', '공사': '공사' };
    const typeVal = typeMap[f.contract_type];
    if (typeVal) {
      document.getElementById('qd-contract-type').value = typeVal;
      qdUpdateTypeFields();
    }
  }

  // 사업 필요성 자동 채움
  if (f.necessity) {
    document.getElementById('qd-necessity').value = f.necessity;
  }

  // 납품기한 → 용역 과업기간 / 공사기간에도 반영
  if (f.delivery_period) {
    const ctype = document.getElementById('qd-contract-type').value;
    if (ctype === '용역') {
      document.getElementById('qd-task-period').value = f.delivery_period;
    } else if (ctype === '공사') {
      document.getElementById('qd-construction-period').value = f.delivery_period;
    }
  }

  // 항목 렌더
  const tbody = document.getElementById('qd-items-body');
  tbody.innerHTML = '';
  if (f.items && f.items.length > 0) {
    f.items.forEach(item => qdAddItemRow(item));
  } else {
    qdAddItemRow({});
  }

  // 간접비 자동 감지: AI가 추출한 공급가액과 항목 합계의 차이
  const itemSum = qdGetItemSum();
  const aiSupply = qdNum(f.supply_amount);
  const overheadEl = document.getElementById('qd-overhead-input');
  const overheadSection = document.getElementById('qd-overhead-section');

  if (aiSupply > 0 && aiSupply > itemSum && (aiSupply - itemSum) > 100) {
    const overhead = aiSupply - itemSum;
    overheadEl.value = overhead;
    overheadSection.classList.remove('qd-hidden');
  } else {
    overheadEl.value = 0;
    overheadSection.classList.add('qd-hidden');
  }

  qdRecalc();
}

// 항목 합계(직접비) 계산 헬퍼
function qdGetItemSum() {
  let sum = 0;
  document.querySelectorAll('#qd-items-body tr').forEach(tr => {
    const qty = qdNum(tr.querySelector('.qd-item-qty')?.value);
    const price = qdNum(tr.querySelector('.qd-item-price')?.value);
    sum += qty * price;
  });
  return sum;
}

let qdItemIndex = 0;

function qdAddItemRow(item) {
  const tbody = document.getElementById('qd-items-body');
  const idx = ++qdItemIndex;
  const tr = document.createElement('tr');
  tr.id = 'qd-item-' + idx;
  tr.innerHTML =
    '<td style="text-align:center; color:#94a3b8; font-size:12px;">' + (tbody.children.length + 1) + '</td>' +
    '<td><input type="text" class="qd-item-name" value="' + qdAttr(item.name) + '" placeholder="품명"></td>' +
    '<td><input type="text" class="qd-item-spec" value="' + qdAttr(item.spec) + '" placeholder="규격"></td>' +
    '<td><input type="text" class="qd-item-unit" value="' + qdAttr(item.unit || 'EA') + '" style="text-align:center;"></td>' +
    '<td><input type="number" class="qd-item-qty qd-num" value="' + qdNum(item.qty) + '" min="0" onchange="qdRecalc()" oninput="qdRecalc()"></td>' +
    '<td><input type="number" class="qd-item-price qd-num" value="' + qdNum(item.unit_price) + '" min="0" onchange="qdRecalc()" oninput="qdRecalc()"></td>' +
    '<td class="qd-item-amount">0</td>' +
    '<td class="qd-item-remove" onclick="qdRemoveItem(' + idx + ')"><span class="material-symbols-outlined" style="font-size:18px;">close</span></td>';
  tbody.appendChild(tr);
  qdRecalc();
}

function qdAddItem() {
  qdAddItemRow({});
}

function qdRemoveItem(idx) {
  const tr = document.getElementById('qd-item-' + idx);
  if (tr) tr.remove();
  qdRenumber();
  qdRecalc();
}

function qdRenumber() {
  document.querySelectorAll('#qd-items-body tr').forEach((tr, i) => {
    tr.querySelector('td').textContent = i + 1;
  });
}

function qdNum(val) {
  if (val == null) return 0;
  return parseInt(String(val).replace(/[^\d]/g, ''), 10) || 0;
}

function qdAttr(val) {
  if (!val) return '';
  return String(val).replace(/"/g, '&quot;');
}

function qdRecalc() {
  let directCost = 0;
  document.querySelectorAll('#qd-items-body tr').forEach(tr => {
    const qty = qdNum(tr.querySelector('.qd-item-qty')?.value);
    const price = qdNum(tr.querySelector('.qd-item-price')?.value);
    const amount = qty * price;
    directCost += amount;
    const amountCell = tr.querySelector('.qd-item-amount');
    if (amountCell) amountCell.textContent = qdFmt(amount);
  });

  const overhead = qdNum(document.getElementById('qd-overhead-input')?.value);
  const supply = directCost + overhead;
  const vat = Math.round(supply * 0.1);
  const total = supply + vat;

  document.getElementById('qd-supply-display').textContent = qdFmt(supply) + '원';
  document.getElementById('qd-vat-display').textContent = qdFmt(vat) + '원';
  document.getElementById('qd-total-display').textContent = qdFmt(total) + '원';
}

// ========== 계약유형별 필드 표시 ==========
function qdUpdateTypeFields() {
  const type = document.getElementById('qd-contract-type').value;
  document.getElementById('qd-fields-service').classList.toggle('qd-hidden', type !== '용역');
  document.getElementById('qd-fields-construction').classList.toggle('qd-hidden', type !== '공사');
  const count = type === '물품' ? 3 : 4;
  document.getElementById('qd-generate-text').textContent = count + '개 문서 일괄 생성';
}

// ========== 데이터 수집 ==========
function qdCollectData() {
  const items = [];
  let directCost = 0;
  document.querySelectorAll('#qd-items-body tr').forEach(tr => {
    const name = tr.querySelector('.qd-item-name')?.value?.trim() || '';
    const spec = tr.querySelector('.qd-item-spec')?.value?.trim() || '';
    const unit = tr.querySelector('.qd-item-unit')?.value?.trim() || 'EA';
    const qty = qdNum(tr.querySelector('.qd-item-qty')?.value);
    const unitPrice = qdNum(tr.querySelector('.qd-item-price')?.value);
    const amount = qty * unitPrice;
    directCost += amount;
    if (name) {
      items.push({ name, spec, unit, qty, unitPrice, amount });
    }
  });

  const overhead = qdNum(document.getElementById('qd-overhead-input')?.value);
  const supply = directCost + overhead;
  const vat = Math.round(supply * 0.1);
  const total = supply + vat;

  return {
    companyName: document.getElementById('qd-company-name').value.trim(),
    businessNo: document.getElementById('qd-business-no').value.trim(),
    representative: document.getElementById('qd-representative').value.trim(),
    quoteDate: document.getElementById('qd-quote-date').value,
    projectName: document.getElementById('qd-project-name').value.trim(),
    department: document.getElementById('qd-department').value.trim() || '○○과',
    manager: document.getElementById('qd-manager').value.trim(),
    deptPhone: document.getElementById('qd-dept-phone').value.trim(),
    contractType: document.getElementById('qd-contract-type').value,
    necessity: document.getElementById('qd-necessity').value.trim(),
    // 용역 추가
    taskPeriod: document.getElementById('qd-task-period').value.trim(),
    taskLocation: document.getElementById('qd-task-location').value.trim(),
    deliverables: document.getElementById('qd-deliverables').value.trim(),
    // 공사 추가
    constructionLocation: document.getElementById('qd-construction-location').value.trim(),
    constructionPeriod: document.getElementById('qd-construction-period').value.trim(),
    constructionNotes: document.getElementById('qd-construction-notes').value.trim(),
    items,
    directCost,
    overhead,
    supply,
    vat,
    total
  };
}

// ========== STEP 3: 문서 생성 ==========
function qdGenerateDocuments() {
  const d = qdCollectData();

  if (!d.projectName) { qdShowToast('건명(사업명)을 입력하세요'); return; }
  if (!d.necessity) { qdShowToast('사업 필요성을 입력하세요'); return; }
  if (d.items.length === 0) { qdShowToast('품목을 1개 이상 입력하세요'); return; }

  // 기본 3개 문서
  qdBuildPlanDoc(d);
  qdBuildBudgetDoc(d);
  qdBuildPriceDoc(d);

  // 계약유형별 추가 문서 + 탭 표시
  const isService = d.contractType === '용역';
  const isConstruction = d.contractType === '공사';
  document.getElementById('qd-tab-btn-taskorder').classList.toggle('qd-hidden', !isService);
  document.getElementById('qd-tab-btn-estimate').classList.toggle('qd-hidden', !isConstruction);

  if (isService) qdBuildTaskOrderDoc(d);
  if (isConstruction) qdBuildCostEstimateDoc(d);

  const count = (isService || isConstruction) ? 4 : 3;
  qdGoStep(3);
  qdShowToast(count + '개 문서가 생성되었습니다');
}

// ----- 기대효과 생성 (plain text, HTML 용도 시 qdEscape 필요) -----
function qdBuildExpectedEffects(d) {
  var effects = [];
  var t = d.contractType;
  var pn = d.projectName;
  if (t === '물품') {
    effects.push('- ' + pn + ' 도입을 통한 업무 효율성 향상');
    effects.push('- 노후 장비(시설) 교체로 유지보수 비용 절감');
    effects.push('- 안전하고 쾌적한 업무환경 조성');
  } else if (t === '용역') {
    effects.push('- 전문 용역 수행을 통한 ' + pn + ' 성과물 확보');
    effects.push('- 체계적 분석 및 전문 결과물 기반 업무 품질 향상');
    effects.push('- 내부 인력 부담 경감 및 전문성 확보');
  } else {
    effects.push('- ' + pn + ' 시행으로 시설물 안전성 확보');
    effects.push('- 시설물 기능 개선 및 수명 연장');
    effects.push('- 이용자 편의 증진 및 쾌적한 환경 조성');
  }
  return effects.join('\n');
}

// ----- 관련 법규 생성 -----
function qdBuildLegalRefs(d) {
  var refs = [];
  refs.push('- 지방자치단체를 당사자로 하는 계약에 관한 법률 (지방계약법)');
  refs.push('- 동법 시행령 제25조 (수의계약에 의할 수 있는 경우)');
  refs.push('- 동법 시행령 제9조 (예정가격의 결정기준)');
  if (d.contractType === '물품') {
    refs.push('- 물품관리법 및 동법 시행령');
    refs.push('- 지방자치단체 세출예산 집행기준 (행정안전부)');
  } else if (d.contractType === '용역') {
    refs.push('- 지방자치단체 입찰 및 계약 집행기준 (행정안전부)');
    refs.push('- 용역계약 일반조건 (지방계약법 시행규칙 별지)');
  } else {
    refs.push('- 건설산업기본법 및 동법 시행령');
    refs.push('- 지방자치단체 공사계약 일반조건');
    refs.push('- 시설물의 안전 및 유지관리에 관한 특별법');
  }
  return refs.join('\n');
}

// ----- 사업계획서 -----
function qdBuildPlanDoc(d) {
  let h = '';
  h += '<div class="qd-doc-header"><div class="qd-doc-title">사 업 계 획 서</div></div>';

  // 기본정보
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:120px;">사업명</th><td>' + qdEscape(d.projectName) + '</td></tr>';
  h += '<tr><th>사업부서</th><td>' + qdEscape(d.department) + '</td></tr>';
  if (d.manager) {
    h += '<tr><th>담당자</th><td>' + qdEscape(d.manager) + (d.deptPhone ? ' (' + qdEscape(d.deptPhone) + ')' : '') + '</td></tr>';
  }
  h += '<tr><th>계약구분</th><td>' + qdEscape(d.contractType) + ' 수의계약 (1인 견적)</td></tr>';
  h += '<tr><th>작성일</th><td>' + qdDateStr() + '</td></tr>';
  h += '</table>';

  // 필요성
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">1. 사업 필요성</div>';

  // 가. 추진 배경 및 필요성
  h += '<div style="font-size:13px; font-weight:600; color:#334155; margin:12px 0 6px 4px;">가. 추진 배경 및 필요성</div>';
  h += '<div class="qd-doc-content">' + qdEscape(d.necessity) + '</div>';

  // 나. 기대효과
  h += '<div style="font-size:13px; font-weight:600; color:#334155; margin:12px 0 6px 4px;">나. 기대효과</div>';
  h += '<div class="qd-doc-content">' + qdEscape(qdBuildExpectedEffects(d)) + '</div>';

  // 다. 관련 법규 및 지침
  h += '<div style="font-size:13px; font-weight:600; color:#334155; margin:12px 0 6px 4px;">다. 관련 법규 및 지침</div>';
  h += '<div class="qd-doc-content">' + qdEscape(qdBuildLegalRefs(d)) + '</div>';

  h += '</div>';

  // 사업내용
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">2. 사업 내용</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th>품명</th><th>규격</th><th style="text-align:center;">수량</th><th style="text-align:right;">금액</th></tr>';
  d.items.forEach(item => {
    h += '<tr><td>' + qdEscape(item.name) + '</td><td>' + qdEscape(item.spec) + '</td><td style="text-align:center;">' + item.qty + ' ' + qdEscape(item.unit) + '</td><td class="qd-right">' + qdFmt(item.amount) + '원</td></tr>';
  });
  h += '</table>';
  h += '</div>';

  // 소요예산
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">3. 소요 예산</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:120px;">금액</th><td style="font-weight:700; font-size:16px; color:#4f46e5;">금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)</td></tr>';
  if (d.overhead > 0) {
    h += '<tr><th>내역</th><td>직접비 ' + qdFmt(d.directCost) + '원 + 간접비 등 ' + qdFmt(d.overhead) + '원 + 부가세 ' + qdFmt(d.vat) + '원</td></tr>';
  } else {
    h += '<tr><th>내역</th><td>공급가액 ' + qdFmt(d.supply) + '원 + 부가세 ' + qdFmt(d.vat) + '원</td></tr>';
  }
  h += '</table>';
  h += '</div>';

  // 추진방법
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">4. 추진 방법</div>';
  h += '<div class="qd-doc-content">- 계약방법: ' + qdEscape(d.contractType) + ' 수의계약 (1인 견적)\n- 계약근거: 지방계약법 시행령 제25조 제1항 제5호</div>';
  h += '</div>';

  // 붙임
  h += '<div class="qd-doc-section" style="margin-top:32px;">';
  h += '<div style="font-size:13px; color:#64748b;">붙임  1. 견적서 1부</div>';
  h += '<div style="font-size:13px; color:#64748b;">      2. 소요예산 추정서 1부</div>';
  h += '<div style="font-size:13px; color:#64748b;">      3. 예정가격 조서 1부</div>';
  h += '<div style="font-size:13px; color:#64748b;">      4. 수의계약 사유서 1부. 끝.</div>';
  h += '</div>';

  h += '<div class="qd-doc-footer">' + qdEscape(d.department) + '<br><span style="font-size:12px; color:#94a3b8;">이 문서는 실무(silmu.kr) 견적서 일괄 문서생성기로 작성되었습니다.</span></div>';

  document.getElementById('qd-doc-plan').innerHTML = h;
}

// ----- 소요예산 추정 -----
function qdBuildBudgetDoc(d) {
  let h = '';
  h += '<div class="qd-doc-header"><div class="qd-doc-title">소 요 예 산 추 정 서</div></div>';

  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:120px;">건명</th><td>' + qdEscape(d.projectName) + '</td></tr>';
  h += '<tr><th>추정근거</th><td>거래실례가격 (견적서 기반)</td></tr>';
  h += '<tr><th>작성일</th><td>' + qdDateStr() + '</td></tr>';
  h += '</table>';

  // 내역표
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">내역</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="text-align:center;">No</th><th>품명</th><th>규격</th><th style="text-align:center;">단위</th><th style="text-align:center;">수량</th><th style="text-align:right;">단가(원)</th><th style="text-align:right;">금액(원)</th></tr>';
  d.items.forEach((item, i) => {
    h += '<tr><td style="text-align:center;">' + (i+1) + '</td><td>' + qdEscape(item.name) + '</td><td>' + qdEscape(item.spec) + '</td><td style="text-align:center;">' + qdEscape(item.unit) + '</td><td style="text-align:center;">' + qdFmt(item.qty) + '</td><td class="qd-right">' + qdFmt(item.unitPrice) + '</td><td class="qd-right">' + qdFmt(item.amount) + '</td></tr>';
  });
  if (d.overhead > 0) {
    h += '<tr style="background:#f8fafc; font-weight:600;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">직접비 소계</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.directCost) + '</td></tr>';
    h += '<tr style="background:#fffbeb;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">간접비·관리비·이윤</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.overhead) + '</td></tr>';
  }
  h += '<tr style="background:#f8fafc; font-weight:700;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">공급가액</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.supply) + '</td></tr>';
  h += '<tr style="background:#f8fafc;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">부가가치세 (10%)</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.vat) + '</td></tr>';
  h += '<tr style="background:#eef2ff; font-weight:700; font-size:15px;"><td colspan="6" style="text-align:right; border:1px solid #c7d2fe; padding:10px 12px; color:#4f46e5;">합계</td><td class="qd-right" style="border:1px solid #c7d2fe; padding:10px 12px; color:#4f46e5;">' + qdFmt(d.total) + '</td></tr>';
  h += '</table>';
  h += '</div>';

  // 금액 한글 표기
  h += '<div style="padding:12px 16px; background:#f8fafc; border-radius:10px; margin:16px 0; font-size:14px;">';
  h += '<strong>금액:</strong> 금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)';
  h += '</div>';

  // 견적 업체 정보
  if (d.companyName) {
    h += '<div class="qd-doc-section">';
    h += '<div class="qd-doc-section-title">견적 업체</div>';
    h += '<table class="qd-doc-table">';
    h += '<tr><th style="width:120px;">업체명</th><td>' + qdEscape(d.companyName) + '</td></tr>';
    if (d.businessNo) h += '<tr><th>사업자등록번호</th><td>' + qdEscape(d.businessNo) + '</td></tr>';
    if (d.representative) h += '<tr><th>대표자</th><td>' + qdEscape(d.representative) + '</td></tr>';
    if (d.quoteDate) h += '<tr><th>견적일</th><td>' + qdEscape(d.quoteDate) + '</td></tr>';
    h += '</table>';
    h += '</div>';
  }

  h += '<div class="qd-doc-footer">' + qdEscape(d.department) + '<br><span style="font-size:12px; color:#94a3b8;">이 문서는 실무(silmu.kr) 견적서 일괄 문서생성기로 작성되었습니다.</span></div>';

  document.getElementById('qd-doc-budget').innerHTML = h;
}

// ----- 예정가격 조서 -----
function qdBuildPriceDoc(d) {
  // 수의계약 기준금액 판단 — 추정가격(부가세 제외 = 공급가액) 기준
  const thresholdLabel = d.contractType === '공사' ? '5천만원' : '2천만원';
  const thresholdAmount = d.contractType === '공사' ? 50000000 : 20000000;
  const isUnder = d.supply <= thresholdAmount;

  let h = '';
  h += '<div class="qd-doc-header"><div class="qd-doc-title">예 정 가 격 조 서</div></div>';

  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:140px;">건명</th><td>' + qdEscape(d.projectName) + '</td></tr>';
  h += '<tr><th>계약 구분</th><td>' + qdEscape(d.contractType) + '</td></tr>';
  h += '<tr><th>가격결정 방법</th><td>거래실례가격 (견적서 기준)</td></tr>';
  h += '<tr><th>작성일</th><td>' + qdDateStr() + '</td></tr>';
  h += '</table>';

  // 1. 추정가격 산정
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">1. 추정가격 산정 (부가세 제외)</div>';
  h += '<table class="qd-doc-table">';
  if (d.overhead > 0) {
    h += '<tr><th style="width:180px;">직접비</th><td class="qd-right">' + qdFmt(d.directCost) + '원</td></tr>';
    h += '<tr><th>간접비·관리비·이윤</th><td class="qd-right">' + qdFmt(d.overhead) + '원</td></tr>';
  }
  h += '<tr style="background:#f0fdf4;"><th style="width:180px; font-weight:700; color:#166534;">추정가격 (공급가액)</th><td class="qd-right" style="font-weight:700; font-size:16px; color:#166534;">' + qdFmt(d.supply) + '원</td></tr>';
  h += '</table>';
  h += '<div style="font-size:12px; color:#64748b; margin-top:6px;">※ 추정가격 = 부가세 제외 금액. 계약방법(수의/입찰) 결정 기준 (지방계약법 시행령 제7조)</div>';
  h += '</div>';

  // 2. 예정가격 결정
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">2. 예정가격 결정 (부가세 포함)</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:180px;">추정가격</th><td class="qd-right">' + qdFmt(d.supply) + '원</td></tr>';
  h += '<tr><th>부가가치세 (10%)</th><td class="qd-right">' + qdFmt(d.vat) + '원</td></tr>';
  h += '<tr style="background:#eef2ff;"><th style="font-weight:700; color:#4f46e5;">예정가격</th><td class="qd-right" style="font-weight:700; font-size:16px; color:#4f46e5;">' + qdFmt(d.total) + '원</td></tr>';
  h += '</table>';
  h += '<div style="font-size:12px; color:#64748b; margin-top:6px;">※ 예정가격 = 추정가격 + 부가세. 계약 체결 기준가 (지방계약법 시행령 제9조)</div>';
  h += '</div>';

  // 한글 금액
  h += '<div style="padding:12px 16px; background:#f8fafc; border-radius:10px; margin:16px 0; font-size:14px;">';
  h += '<div><strong>추정가격 (부가세 제외):</strong> 금 ' + qdFmt(d.supply) + '원 (' + qdNumberToKorean(d.supply) + '원)</div>';
  h += '<div style="margin-top:4px;"><strong>예정가격 (부가세 포함):</strong> 금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)</div>';
  h += '</div>';

  // 수의계약 가능 여부
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">수의계약 해당 여부</div>';
  if (isUnder) {
    h += '<div style="padding:16px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:10px; display:flex; align-items:center; gap:10px;">';
    h += '<span class="material-symbols-outlined" style="color:#16a34a; font-size:24px;">check_circle</span>';
    h += '<div><div style="font-weight:700; color:#166534;">1인 수의계약 가능</div>';
    h += '<div style="font-size:13px; color:#15803d;">추정가격 ' + qdFmt(d.supply) + '원 ≤ ' + qdEscape(d.contractType) + ' 기준금액 ' + thresholdLabel + ' (부가세 제외 기준)</div></div>';
    h += '</div>';
  } else {
    h += '<div style="padding:16px; background:#fef2f2; border:1px solid #fecaca; border-radius:10px; display:flex; align-items:center; gap:10px;">';
    h += '<span class="material-symbols-outlined" style="color:#dc2626; font-size:24px;">warning</span>';
    h += '<div><div style="font-weight:700; color:#991b1b;">1인 수의계약 기준금액 초과</div>';
    h += '<div style="font-size:13px; color:#b91c1c;">추정가격 ' + qdFmt(d.supply) + '원 > ' + qdEscape(d.contractType) + ' 기준금액 ' + thresholdLabel + ' (부가세 제외 기준) → 2인 이상 견적 또는 입찰 필요</div></div>';
    h += '</div>';
  }
  h += '</div>';

  // 법적 근거
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">관련 법령</div>';
  h += '<div class="qd-doc-content">- 지방계약법 시행령 제9조 (예정가격의 결정기준)\n- 지방계약법 시행령 제10조 (예정가격의 결정방법)\n- 지방계약법 시행령 제25조 (수의계약에 의할 수 있는 경우)</div>';
  h += '</div>';

  // 견적 업체 정보
  if (d.companyName) {
    h += '<div class="qd-doc-section">';
    h += '<div class="qd-doc-section-title">견적 제출 업체</div>';
    h += '<table class="qd-doc-table">';
    h += '<tr><th style="width:120px;">업체명</th><td>' + qdEscape(d.companyName) + '</td></tr>';
    if (d.businessNo) h += '<tr><th>사업자등록번호</th><td>' + qdEscape(d.businessNo) + '</td></tr>';
    if (d.representative) h += '<tr><th>대표자</th><td>' + qdEscape(d.representative) + '</td></tr>';
    h += '</table>';
    h += '</div>';
  }

  h += '<div class="qd-doc-footer">' + qdEscape(d.department) + '<br><span style="font-size:12px; color:#94a3b8;">이 문서는 실무(silmu.kr) 견적서 일괄 문서생성기로 작성되었습니다.</span></div>';

  document.getElementById('qd-doc-price').innerHTML = h;
}

// ----- 과업내용서 (용역) -----
function qdBuildTaskOrderDoc(d) {
  let h = '';
  h += '<div class="qd-doc-header"><div class="qd-doc-title">과 업 내 용 서</div></div>';

  // 기본정보
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:120px;">과업명</th><td>' + qdEscape(d.projectName) + '</td></tr>';
  h += '<tr><th>발주부서</th><td>' + qdEscape(d.department) + '</td></tr>';
  if (d.manager) {
    h += '<tr><th>담당자</th><td>' + qdEscape(d.manager) + (d.deptPhone ? ' (' + qdEscape(d.deptPhone) + ')' : '') + '</td></tr>';
  }
  if (d.taskPeriod) h += '<tr><th>과업 기간</th><td>' + qdEscape(d.taskPeriod) + '</td></tr>';
  if (d.taskLocation) h += '<tr><th>수행 장소</th><td>' + qdEscape(d.taskLocation) + '</td></tr>';
  h += '<tr><th>작성일</th><td>' + qdDateStr() + '</td></tr>';
  h += '</table>';

  // 과업 목적
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">1. 과업 목적</div>';
  h += '<div class="qd-doc-content">' + qdEscape(d.necessity) + '</div>';
  h += '</div>';

  // 과업 내용
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">2. 과업 범위 및 내용</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="text-align:center;">No</th><th>과업 항목</th><th>규격/내용</th><th style="text-align:center;">단위</th><th style="text-align:center;">수량</th></tr>';
  d.items.forEach((item, i) => {
    h += '<tr><td style="text-align:center;">' + (i+1) + '</td><td>' + qdEscape(item.name) + '</td><td>' + qdEscape(item.spec) + '</td><td style="text-align:center;">' + qdEscape(item.unit) + '</td><td style="text-align:center;">' + qdFmt(item.qty) + '</td></tr>';
  });
  h += '</table>';
  h += '</div>';

  // 과업 기간
  if (d.taskPeriod) {
    h += '<div class="qd-doc-section">';
    h += '<div class="qd-doc-section-title">3. 과업 기간</div>';
    h += '<div class="qd-doc-content">' + qdEscape(d.taskPeriod) + '</div>';
    h += '</div>';
  }

  // 납품물
  let sectionNum = d.taskPeriod ? 4 : 3;
  if (d.deliverables) {
    h += '<div class="qd-doc-section">';
    h += '<div class="qd-doc-section-title">' + sectionNum + '. 납품물</div>';
    h += '<div class="qd-doc-content">' + qdEscape(d.deliverables) + '</div>';
    h += '</div>';
    sectionNum++;
  }

  // 소요 예산
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">' + sectionNum + '. 소요 예산</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:120px;">금액</th><td style="font-weight:700; color:#4f46e5;">금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)</td></tr>';
  if (d.overhead > 0) {
    h += '<tr><th>내역</th><td>직접비 ' + qdFmt(d.directCost) + '원 + 간접비 등 ' + qdFmt(d.overhead) + '원 + 부가세 ' + qdFmt(d.vat) + '원</td></tr>';
  } else {
    h += '<tr><th>내역</th><td>공급가액 ' + qdFmt(d.supply) + '원 + 부가세 ' + qdFmt(d.vat) + '원</td></tr>';
  }
  h += '</table>';
  h += '</div>';
  sectionNum++;

  // 기타 조건
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">' + sectionNum + '. 기타 조건</div>';
  h += '<div class="qd-doc-content">- 계약방법: 용역 수의계약 (1인 견적)\n- 과업 수행 중 발주자와 긴밀히 협의하여야 한다.\n- 과업 내용의 변경이 필요한 경우 사전에 발주자의 승인을 받아야 한다.\n- 납품물의 지식재산권은 발주기관에 귀속한다.</div>';
  h += '</div>';

  h += '<div class="qd-doc-footer">' + qdEscape(d.department) + '<br><span style="font-size:12px; color:#94a3b8;">이 문서는 실무(silmu.kr) 견적서 일괄 문서생성기로 작성되었습니다.</span></div>';

  document.getElementById('qd-doc-taskorder').innerHTML = h;
}

// ----- 물량내역서 + 시방서 (공사) -----
function qdBuildCostEstimateDoc(d) {
  let h = '';

  // ===== 파트 1: 물량내역서 =====
  h += '<div class="qd-doc-header"><div class="qd-doc-title">물 량 내 역 서</div></div>';

  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:120px;">공사명</th><td>' + qdEscape(d.projectName) + '</td></tr>';
  if (d.constructionLocation) h += '<tr><th>공사 장소</th><td>' + qdEscape(d.constructionLocation) + '</td></tr>';
  if (d.constructionPeriod) h += '<tr><th>공사 기간</th><td>' + qdEscape(d.constructionPeriod) + '</td></tr>';
  h += '<tr><th>작성일</th><td>' + qdDateStr() + '</td></tr>';
  h += '</table>';

  // 내역 항목
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">공사 내역</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th style="text-align:center;">No</th><th>공종/품명</th><th>규격</th><th style="text-align:center;">단위</th><th style="text-align:center;">수량</th><th style="text-align:right;">단가(원)</th><th style="text-align:right;">금액(원)</th></tr>';
  d.items.forEach((item, i) => {
    h += '<tr><td style="text-align:center;">' + (i+1) + '</td><td>' + qdEscape(item.name) + '</td><td>' + qdEscape(item.spec) + '</td><td style="text-align:center;">' + qdEscape(item.unit) + '</td><td style="text-align:center;">' + qdFmt(item.qty) + '</td><td class="qd-right">' + qdFmt(item.unitPrice) + '</td><td class="qd-right">' + qdFmt(item.amount) + '</td></tr>';
  });
  h += '<tr style="background:#f8fafc; font-weight:700;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">직접공사비 소계</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.directCost) + '</td></tr>';
  if (d.overhead > 0) {
    h += '<tr style="background:#fffbeb;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">간접비·관리비·이윤</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.overhead) + '</td></tr>';
    h += '<tr style="background:#f8fafc; font-weight:600;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">공급가액</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.supply) + '</td></tr>';
  }
  h += '<tr style="background:#f8fafc;"><td colspan="6" style="text-align:right; border:1px solid #e2e8f0; padding:8px 12px;">부가가치세 (10%)</td><td class="qd-right" style="border:1px solid #e2e8f0; padding:8px 12px;">' + qdFmt(d.vat) + '</td></tr>';
  h += '<tr style="background:#eef2ff; font-weight:700; font-size:15px;"><td colspan="6" style="text-align:right; border:1px solid #c7d2fe; padding:10px 12px; color:#4f46e5;">합계</td><td class="qd-right" style="border:1px solid #c7d2fe; padding:10px 12px; color:#4f46e5;">' + qdFmt(d.total) + '</td></tr>';
  h += '</table>';
  h += '</div>';

  h += '<div style="padding:12px 16px; background:#f8fafc; border-radius:10px; margin:16px 0; font-size:14px;">';
  h += '<strong>금액:</strong> 금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)';
  h += '</div>';

  // 구분선
  h += '<div style="margin:40px 0 32px; border-top:3px double #cbd5e1; position:relative; text-align:center;">';
  h += '<span style="position:relative; top:-12px; background:#fff; padding:0 16px; font-size:13px; color:#94a3b8;">시방서</span>';
  h += '</div>';

  // ===== 파트 2: 시방서 =====
  h += '<div class="qd-doc-header"><div class="qd-doc-title">시   방   서</div></div>';

  h += '<table class="qd-doc-table">';
  h += '<tr><th style="width:120px;">공사명</th><td>' + qdEscape(d.projectName) + '</td></tr>';
  h += '<tr><th>시공부서</th><td>' + qdEscape(d.department) + '</td></tr>';
  if (d.manager) {
    h += '<tr><th>감독관</th><td>' + qdEscape(d.manager) + (d.deptPhone ? ' (' + qdEscape(d.deptPhone) + ')' : '') + '</td></tr>';
  }
  if (d.constructionLocation) h += '<tr><th>공사 장소</th><td>' + qdEscape(d.constructionLocation) + '</td></tr>';
  if (d.constructionPeriod) h += '<tr><th>공사 기간</th><td>' + qdEscape(d.constructionPeriod) + '</td></tr>';
  h += '<tr><th>공사 금액</th><td style="font-weight:700; color:#4f46e5;">금 ' + qdFmt(d.total) + '원</td></tr>';
  h += '<tr><th>지시일</th><td>' + qdDateStr() + '</td></tr>';
  h += '</table>';

  // 시공 내용
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">1. 시공 내용</div>';
  h += '<table class="qd-doc-table">';
  h += '<tr><th>공종/품명</th><th>규격</th><th style="text-align:center;">수량</th></tr>';
  d.items.forEach(item => {
    h += '<tr><td>' + qdEscape(item.name) + '</td><td>' + qdEscape(item.spec) + '</td><td style="text-align:center;">' + qdFmt(item.qty) + ' ' + qdEscape(item.unit) + '</td></tr>';
  });
  h += '</table>';
  h += '</div>';

  // 유의사항
  h += '<div class="qd-doc-section">';
  h += '<div class="qd-doc-section-title">2. 시공 시 유의사항</div>';
  const defaultNotes = '- 안전관리에 만전을 기하고, 안전사고 발생 시 시공자가 책임진다.\n- 기존 시설물 훼손 시 원상복구하여야 한다.\n- 작업 완료 후 현장을 깨끗이 정리·정돈한다.';
  const notes = d.constructionNotes ? qdEscape(d.constructionNotes) + '\n' + defaultNotes : defaultNotes;
  h += '<div class="qd-doc-content">' + notes + '</div>';
  h += '</div>';

  // 서명란
  h += '<div style="margin-top:40px; display:flex; justify-content:space-around; text-align:center;">';
  h += '<div><div style="font-size:13px; color:#64748b; margin-bottom:40px;">시공지시자 (감독관)</div><div style="border-top:1px solid #334155; padding-top:8px; width:120px; margin:0 auto; font-size:13px; color:#334155;">' + qdEscape(d.manager || '(서명)') + '</div></div>';
  h += '<div><div style="font-size:13px; color:#64748b; margin-bottom:40px;">수급인 (시공자)</div><div style="border-top:1px solid #334155; padding-top:8px; width:120px; margin:0 auto; font-size:13px; color:#334155;">(서명)</div></div>';
  h += '</div>';

  h += '<div class="qd-doc-footer">' + qdEscape(d.department) + '<br><span style="font-size:12px; color:#94a3b8;">이 문서는 실무(silmu.kr) 견적서 일괄 문서생성기로 작성되었습니다.</span></div>';

  document.getElementById('qd-doc-estimate').innerHTML = h;
}

// ========== 탭 전환 ==========
function qdSwitchTab(tab) {
  document.querySelectorAll('.qd-tab').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.qd-tab-content').forEach(el => el.classList.remove('active'));

  event.currentTarget.classList.add('active');
  document.getElementById('qd-tab-' + tab).classList.add('active');
}

// ========== 복사 / 다운로드 / 인쇄 ==========
function qdCopyDoc(type) {
  const el = document.getElementById('qd-doc-' + type);
  const text = el.innerText || el.textContent;
  navigator.clipboard.writeText(text).then(() => {
    qdShowToast('클립보드에 복사되었습니다');
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    qdShowToast('클립보드에 복사되었습니다');
  });
}

function qdDownloadDoc(type, docName) {
  var d = qdCollectData();
  var pName = d.projectName || '문서';

  var builders = {
    plan: qdExcelPlan,
    budget: qdExcelBudget,
    price: qdExcelPrice,
    taskorder: qdExcelTaskOrder,
    estimate: qdExcelEstimate
  };

  var builder = builders[type];
  if (!builder) return;

  var ws = builder(d);
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, docName);
  XLSX.writeFile(wb, docName + '_' + pName + '.xlsx');
  qdShowToast('엑셀 파일이 다운로드되었습니다');
}

// ========== 엑셀 스타일 유틸리티 ==========
var XS = {
  border: {top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}},
  titleFont: {bold:true, sz:14},
  sectionFont: {bold:true, sz:11},
  headerFont: {bold:true, sz:10},
  bodyFont: {sz:10},
  numFmt: '#,##0',
  center: {horizontal:'center', vertical:'center'},
  left: {horizontal:'left', vertical:'center'},
  right: {horizontal:'right', vertical:'center'},
  gray: {fgColor:{rgb:'F2F2F2'}}
};
function xsCell(ws, r, c, style) {
  var addr = XLSX.utils.encode_cell({r:r,c:c});
  if (!ws[addr]) ws[addr] = {v:'',t:'s'};
  ws[addr].s = Object.assign({}, ws[addr].s||{}, style);
  return ws[addr];
}
function xsTitle(ws, r, colEnd) {
  for (var c=0;c<=colEnd;c++) xsCell(ws,r,c,{font:XS.titleFont, alignment:XS.center});
}
function xsSection(ws, r) {
  xsCell(ws,r,0,{font:XS.sectionFont});
}
function xsLabel(ws, r, c) {
  xsCell(ws,r,c||0,{font:{bold:true,sz:10}});
}
function xsTableHeader(ws, r, sc, ec) {
  for (var c=sc;c<=ec;c++) xsCell(ws,r,c,{font:XS.headerFont, border:XS.border, fill:XS.gray, alignment:XS.center});
}
function xsTableRow(ws, r, sc, ec, numCols) {
  for (var c=sc;c<=ec;c++) {
    var s = {font:XS.bodyFont, border:XS.border};
    if (numCols && numCols.indexOf(c)>=0) {
      s.alignment = XS.right;
      var addr = XLSX.utils.encode_cell({r:r,c:c});
      if (ws[addr] && ws[addr].t==='n') ws[addr].z = XS.numFmt;
    }
    xsCell(ws,r,c,s);
  }
}
function xsSummaryRow(ws, r, labelCol, valCol) {
  xsCell(ws,r,labelCol,{font:{bold:true,sz:10}, border:XS.border, alignment:XS.right});
  var s = {font:{bold:true,sz:10}, border:XS.border, alignment:XS.right};
  var addr = XLSX.utils.encode_cell({r:r,c:valCol});
  if (ws[addr] && ws[addr].t==='n') ws[addr].z = XS.numFmt;
  xsCell(ws,r,valCol,s);
}
function xsNumCell(ws, r, c) {
  var addr = XLSX.utils.encode_cell({r:r,c:c});
  if (ws[addr] && ws[addr].t==='n') ws[addr].z = XS.numFmt;
}

// ----- 엑셀: 사업계획서 -----
function qdExcelPlan(d) {
  var rows = [];
  var C = 6; // last col index (A~G = 7 cols)
  rows.push(['사 업 계 획 서']);                     // r0
  rows.push([]);                                     // r1
  rows.push(['사업명', d.projectName]);
  rows.push(['사업부서', d.department]);
  var ri = 4;
  if (d.manager) { rows.push(['담당자', d.manager + (d.deptPhone ? ' (' + d.deptPhone + ')' : '')]); ri++; }
  rows.push(['계약구분', d.contractType + ' 수의계약 (1인 견적)']); ri++;
  rows.push(['작성일', qdDateStr()]); ri++;
  rows.push([]); ri++;

  var secR1 = ri;
  rows.push(['1. 사업 필요성']); ri++;
  rows.push(['가. 추진 배경 및 필요성']); ri++;
  rows.push([d.necessity]); ri++;
  rows.push([]); ri++;
  rows.push(['나. 기대효과']); ri++;
  qdBuildExpectedEffects(d).split('\n').forEach(function(line) { rows.push([line]); ri++; });
  rows.push([]); ri++;
  rows.push(['다. 관련 법규 및 지침']); ri++;
  qdBuildLegalRefs(d).split('\n').forEach(function(line) { rows.push([line]); ri++; });
  rows.push([]); ri++;

  rows.push(['2. 사업 내용']); var secR2 = ri; ri++;
  var thR = ri;
  rows.push(['No', '품명', '규격', '수량', '단위', '단가', '금액']); ri++;
  var dataStart = ri;
  d.items.forEach(function(item, i) {
    rows.push([i + 1, item.name, item.spec, item.qty, item.unit, item.unitPrice, item.amount]); ri++;
  });
  var dataEnd = ri - 1;
  rows.push([]); ri++;

  rows.push(['3. 소요 예산']); var secR3 = ri; ri++;
  var budgetR = ri;
  rows.push(['금액', d.total, '', '', '', '', '금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)']); ri++;
  if (d.overhead > 0) {
    rows.push(['내역', '직접비 ' + qdFmt(d.directCost) + '원 + 간접비 등 ' + qdFmt(d.overhead) + '원 + 부가세 ' + qdFmt(d.vat) + '원']); ri++;
  } else {
    rows.push(['내역', '공급가액 ' + qdFmt(d.supply) + '원 + 부가세 ' + qdFmt(d.vat) + '원']); ri++;
  }
  rows.push([]); ri++;

  rows.push(['4. 추진 방법']); ri++;
  rows.push(['계약방법', d.contractType + ' 수의계약 (1인 견적)']); ri++;
  rows.push(['계약근거', '지방계약법 시행령 제25조 제1항 제5호']); ri++;

  var ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:10},{wch:24},{wch:22},{wch:10},{wch:8},{wch:14},{wch:16}];
  ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:C}}];

  // 스타일 적용
  xsTitle(ws, 0, C);
  xsSection(ws, secR1);
  xsSection(ws, secR2);
  xsSection(ws, secR3);
  // 표 헤더 + 데이터
  xsTableHeader(ws, thR, 0, C);
  for (var r = dataStart; r <= dataEnd; r++) xsTableRow(ws, r, 0, C, [3,5,6]);
  // 레이블 볼드
  for (var r2 = 2; r2 <= 6; r2++) xsLabel(ws, r2);
  xsLabel(ws, budgetR);
  xsLabel(ws, budgetR+1);
  xsNumCell(ws, budgetR, 1);

  return ws;
}

// ----- 엑셀: 소요예산추정서 -----
function qdExcelBudget(d) {
  var rows = [];
  var C = 6;
  rows.push(['소 요 예 산 추 정 서']);
  rows.push([]);
  rows.push(['건명', d.projectName]);
  rows.push(['추정근거', '거래실례가격 (견적서 기반)']);
  rows.push(['작성일', qdDateStr()]);
  rows.push([]);

  var thR = 6;
  rows.push(['No', '품명', '규격', '단위', '수량', '단가(원)', '금액(원)']);
  var dataStart = 7;
  d.items.forEach(function(item, i) {
    rows.push([i + 1, item.name, item.spec, item.unit, item.qty, item.unitPrice, item.amount]);
  });
  var dataEnd = 6 + d.items.length;
  var sumStart = dataEnd + 1;
  if (d.overhead > 0) {
    rows.push(['', '', '', '', '', '직접비 소계', d.directCost]);
    rows.push(['', '', '', '', '', '간접비·관리비·이윤', d.overhead]);
  }
  rows.push(['', '', '', '', '', '공급가액', d.supply]);
  rows.push(['', '', '', '', '', '부가가치세 (10%)', d.vat]);
  rows.push(['', '', '', '', '', '합계', d.total]);
  var sumEnd = rows.length - 1;
  rows.push([]);
  var amtR = rows.length;
  rows.push(['금액', '금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)']);
  rows.push([]);

  if (d.companyName) {
    var coR = rows.length;
    rows.push(['견적 업체']);
    rows.push(['업체명', d.companyName]);
    if (d.businessNo) rows.push(['사업자등록번호', d.businessNo]);
    if (d.representative) rows.push(['대표자', d.representative]);
    if (d.quoteDate) rows.push(['견적일', d.quoteDate]);
  }

  var ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:6},{wch:24},{wch:20},{wch:8},{wch:8},{wch:18},{wch:16}];
  ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:C}}];

  xsTitle(ws, 0, C);
  for (var r2=2;r2<=4;r2++) xsLabel(ws,r2);
  xsTableHeader(ws, thR, 0, C);
  for (var r=dataStart;r<=dataEnd;r++) xsTableRow(ws,r,0,C,[4,5,6]);
  for (var r3=sumStart;r3<=sumEnd;r3++) xsSummaryRow(ws,r3,5,6);
  xsLabel(ws,amtR);
  if (typeof coR !== 'undefined') xsSection(ws,coR);

  return ws;
}

// ----- 엑셀: 예정가격조서 -----
function qdExcelPrice(d) {
  var thresholdLabel = d.contractType === '공사' ? '5천만원' : '2천만원';
  var thresholdAmount = d.contractType === '공사' ? 50000000 : 20000000;
  var isUnder = d.supply <= thresholdAmount;

  var rows = [];
  rows.push(['예 정 가 격 조 서']);
  rows.push([]);
  rows.push(['건명', d.projectName]);
  rows.push(['계약 구분', d.contractType]);
  rows.push(['가격결정 방법', '거래실례가격 (견적서 기준)']);
  rows.push(['작성일', qdDateStr()]);
  rows.push([]);

  var s1 = rows.length;
  rows.push(['1. 추정가격 산정 (부가세 제외)']);
  if (d.overhead > 0) {
    rows.push(['  직접비', d.directCost]);
    rows.push(['  간접비·관리비·이윤', d.overhead]);
  }
  rows.push(['  추정가격 (공급가액)', d.supply]);
  var noteR1 = rows.length;
  rows.push(['※ 추정가격 = 부가세 제외 금액. 계약방법(수의/입찰) 결정 기준 (지방계약법 시행령 제7조)']);
  rows.push([]);

  var s2 = rows.length;
  rows.push(['2. 예정가격 결정 (부가세 포함)']);
  rows.push(['  추정가격', d.supply]);
  rows.push(['  부가가치세 (10%)', d.vat]);
  rows.push(['  예정가격', d.total]);
  var noteR2 = rows.length;
  rows.push(['※ 예정가격 = 추정가격 + 부가세. 계약 체결 기준가 (지방계약법 시행령 제9조)']);
  rows.push([]);

  rows.push(['추정가격 (부가세 제외)', '금 ' + qdFmt(d.supply) + '원 (' + qdNumberToKorean(d.supply) + '원)']);
  rows.push(['예정가격 (부가세 포함)', '금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)']);
  rows.push([]);

  var s3 = rows.length;
  rows.push(['수의계약 해당 여부']);
  if (isUnder) {
    rows.push(['  판정', '1인 수의계약 가능']);
    rows.push(['  사유', '추정가격 ' + qdFmt(d.supply) + '원 ≤ ' + d.contractType + ' 기준금액 ' + thresholdLabel + ' (부가세 제외 기준)']);
  } else {
    rows.push(['  판정', '1인 수의계약 기준금액 초과']);
    rows.push(['  사유', '추정가격 ' + qdFmt(d.supply) + '원 > ' + d.contractType + ' 기준금액 ' + thresholdLabel + ' → 2인 이상 견적 또는 입찰 필요']);
  }
  rows.push([]);

  if (d.companyName) {
    var coR = rows.length;
    rows.push(['견적 제출 업체']);
    rows.push(['업체명', d.companyName]);
    if (d.businessNo) rows.push(['사업자등록번호', d.businessNo]);
    if (d.representative) rows.push(['대표자', d.representative]);
  }

  var ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:26},{wch:52}];
  ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:1}}];

  xsTitle(ws, 0, 1);
  for (var r=2;r<=5;r++) xsLabel(ws,r);
  xsSection(ws,s1); xsSection(ws,s2); xsSection(ws,s3);
  // 금액 셀에 천단위 쉼표
  for (var r2=s1+1;r2<noteR1;r2++) xsNumCell(ws,r2,1);
  for (var r3=s2+1;r3<noteR2;r3++) xsNumCell(ws,r3,1);
  if (typeof coR !== 'undefined') xsSection(ws,coR);

  return ws;
}

// ----- 엑셀: 과업내용서 -----
function qdExcelTaskOrder(d) {
  var rows = [];
  var C = 4;
  rows.push(['과 업 내 용 서']);
  rows.push([]);
  rows.push(['과업명', d.projectName]);
  rows.push(['발주부서', d.department]);
  var ri = 4;
  if (d.manager) { rows.push(['담당자', d.manager + (d.deptPhone ? ' (' + d.deptPhone + ')' : '')]); ri++; }
  if (d.taskPeriod) { rows.push(['과업 기간', d.taskPeriod]); ri++; }
  if (d.taskLocation) { rows.push(['수행 장소', d.taskLocation]); ri++; }
  rows.push(['작성일', qdDateStr()]); ri++;
  rows.push([]); ri++;

  rows.push(['1. 과업 목적']); xsSec1 = ri; ri++;
  rows.push([d.necessity]); ri++;
  rows.push([]); ri++;

  rows.push(['2. 과업 범위 및 내용']); var xsSec2 = ri; ri++;
  var thR = ri;
  rows.push(['No', '과업 항목', '규격/내용', '단위', '수량']); ri++;
  var dataStart = ri;
  d.items.forEach(function(item, i) {
    rows.push([i + 1, item.name, item.spec, item.unit, item.qty]); ri++;
  });
  var dataEnd = ri - 1;
  rows.push([]); ri++;

  var sn = 3;
  if (d.taskPeriod) {
    rows.push([sn + '. 과업 기간']); ri++;
    rows.push([d.taskPeriod]); ri++;
    rows.push([]); ri++;
    sn++;
  }
  if (d.deliverables) {
    rows.push([sn + '. 납품물']); ri++;
    rows.push([d.deliverables]); ri++;
    rows.push([]); ri++;
    sn++;
  }

  var secBudget = ri;
  rows.push([sn + '. 소요 예산']); ri++;
  var budgetR = ri;
  rows.push(['금액', d.total, '', '', '금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)']); ri++;
  if (d.overhead > 0) {
    rows.push(['내역', '직접비 ' + qdFmt(d.directCost) + '원 + 간접비 등 ' + qdFmt(d.overhead) + '원 + 부가세 ' + qdFmt(d.vat) + '원']);
  } else {
    rows.push(['내역', '공급가액 ' + qdFmt(d.supply) + '원 + 부가세 ' + qdFmt(d.vat) + '원']);
  }

  var ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:10},{wch:24},{wch:24},{wch:8},{wch:10}];
  ws['!merges'] = [{s:{r:0,c:0},e:{r:0,c:C}}];

  xsTitle(ws, 0, C);
  for (var r=2;r<=3;r++) xsLabel(ws,r);
  xsSection(ws, xsSec1);
  xsSection(ws, xsSec2);
  xsSection(ws, secBudget);
  xsTableHeader(ws, thR, 0, C);
  for (var r2=dataStart;r2<=dataEnd;r2++) xsTableRow(ws,r2,0,C,[4]);
  xsLabel(ws, budgetR);
  xsNumCell(ws, budgetR, 1);

  return ws;
}

// ----- 엑셀: 물량내역서+시방서 -----
function qdExcelEstimate(d) {
  var rows = [];
  var C = 6;

  // === 물량내역서 ===
  rows.push(['물 량 내 역 서']);
  rows.push([]);
  rows.push(['공사명', d.projectName]);
  var ri = 3;
  if (d.constructionLocation) { rows.push(['공사 장소', d.constructionLocation]); ri++; }
  if (d.constructionPeriod) { rows.push(['공사 기간', d.constructionPeriod]); ri++; }
  rows.push(['작성일', qdDateStr()]); ri++;
  rows.push([]); ri++;

  var thR = ri;
  rows.push(['No', '공종/품명', '규격', '단위', '수량', '단가(원)', '금액(원)']); ri++;
  var dataStart = ri;
  d.items.forEach(function(item, i) {
    rows.push([i + 1, item.name, item.spec, item.unit, item.qty, item.unitPrice, item.amount]); ri++;
  });
  var dataEnd = ri - 1;
  var sumStart = ri;
  rows.push(['', '', '', '', '', '직접공사비 소계', d.directCost]); ri++;
  if (d.overhead > 0) {
    rows.push(['', '', '', '', '', '간접비·관리비·이윤', d.overhead]); ri++;
    rows.push(['', '', '', '', '', '공급가액', d.supply]); ri++;
  }
  rows.push(['', '', '', '', '', '부가가치세 (10%)', d.vat]); ri++;
  rows.push(['', '', '', '', '', '합계', d.total]); ri++;
  var sumEnd = ri - 1;
  rows.push([]); ri++;
  var amtR = ri;
  rows.push(['금액', '금 ' + qdFmt(d.total) + '원 (' + qdNumberToKorean(d.total) + '원)']); ri++;
  rows.push([]); ri++;
  rows.push([]); ri++;

  // === 시방서 ===
  var specTitleR = ri;
  rows.push(['시   방   서']); ri++;
  rows.push([]); ri++;
  rows.push(['공사명', d.projectName]); ri++;
  rows.push(['시공부서', d.department]); ri++;
  if (d.manager) { rows.push(['감독관', d.manager + (d.deptPhone ? ' (' + d.deptPhone + ')' : '')]); ri++; }
  if (d.constructionLocation) { rows.push(['공사 장소', d.constructionLocation]); ri++; }
  if (d.constructionPeriod) { rows.push(['공사 기간', d.constructionPeriod]); ri++; }
  rows.push(['공사 금액', '금 ' + qdFmt(d.total) + '원']); ri++;
  rows.push(['지시일', qdDateStr()]); ri++;
  rows.push([]); ri++;

  var specSec1 = ri;
  rows.push(['1. 시공 내용']); ri++;
  var specThR = ri;
  rows.push(['공종/품명', '규격', '수량']); ri++;
  var specDataStart = ri;
  d.items.forEach(function(item) {
    rows.push([item.name, item.spec, item.qty + ' ' + item.unit]); ri++;
  });
  var specDataEnd = ri - 1;
  rows.push([]); ri++;

  var specSec2 = ri;
  rows.push(['2. 시공 시 유의사항']); ri++;
  var defaultNotes = '- 안전관리에 만전을 기하고, 안전사고 발생 시 시공자가 책임진다.\n- 기존 시설물 훼손 시 원상복구하여야 한다.\n- 작업 완료 후 현장을 깨끗이 정리·정돈한다.';
  var notes = d.constructionNotes ? d.constructionNotes + '\n' + defaultNotes : defaultNotes;
  notes.split('\n').forEach(function(line) { rows.push([line]); ri++; });

  var ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:10},{wch:24},{wch:22},{wch:8},{wch:8},{wch:18},{wch:16}];
  ws['!merges'] = [
    {s:{r:0,c:0},e:{r:0,c:C}},
    {s:{r:specTitleR,c:0},e:{r:specTitleR,c:C}}
  ];

  // 물량내역서 스타일
  xsTitle(ws, 0, C);
  xsTableHeader(ws, thR, 0, C);
  for (var r=dataStart;r<=dataEnd;r++) xsTableRow(ws,r,0,C,[4,5,6]);
  for (var r2=sumStart;r2<=sumEnd;r2++) xsSummaryRow(ws,r2,5,6);
  xsLabel(ws, amtR);

  // 시방서 스타일
  xsTitle(ws, specTitleR, C);
  xsSection(ws, specSec1);
  xsSection(ws, specSec2);
  xsTableHeader(ws, specThR, 0, 2);
  for (var r3=specDataStart;r3<=specDataEnd;r3++) xsTableRow(ws,r3,0,2,[]);

  return ws;
}

function qdPrintDoc(type) {
  const el = document.getElementById('qd-doc-' + type);
  el.classList.add('qd-doc-print-target');
  window.print();
  el.classList.remove('qd-doc-print-target');
}

// ========== 리셋 ==========
function qdReset() {
  qdSelectedFiles = [];
  document.getElementById('qd-file-input').value = '';
  document.getElementById('qd-overhead-input').value = 0;
  document.getElementById('qd-overhead-section').classList.add('qd-hidden');
  document.getElementById('qd-upload-placeholder').classList.remove('qd-hidden');
  document.getElementById('qd-upload-info').classList.add('qd-hidden');
  document.getElementById('qd-upload-zone').classList.remove('has-file');
  document.getElementById('qd-analyze-btn').disabled = true;
  qdHideError();
  qdGoStep(1);
}
</script>
