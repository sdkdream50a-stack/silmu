<%# 사업계획서 생성기 %>

<style>
.pp-card { background:#fff; border-radius:16px; border:1px solid #e5e7eb; padding:28px; margin-bottom:24px; }
.pp-label { display:block; font-size:13px; font-weight:700; color:#334155; margin-bottom:6px; }
.pp-label .pp-required { color:#ef4444; margin-left:2px; }
.pp-input { width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:10px 14px; font-size:14px; color:#1e293b; transition:border-color .2s, box-shadow .2s; }
.pp-input:focus { outline:none; border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79,70,229,.1); }
.pp-textarea { min-height:90px; resize:vertical; font-family:inherit; }
.pp-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.pp-btn { display:inline-flex; align-items:center; gap:6px; padding:12px 28px; border-radius:12px; font-weight:600; font-size:15px; border:none; cursor:pointer; transition:all .2s; }
.pp-btn-primary { background:#4f46e5; color:#fff; }
.pp-btn-primary:hover { background:#4338ca; }
.pp-btn-secondary { background:#f1f5f9; color:#475569; border:1px solid #e2e8f0; }
.pp-btn-secondary:hover { background:#e2e8f0; }
.pp-btn:disabled { opacity:.5; cursor:not-allowed; }

.pp-result { background:#fff; border:2px solid #c7d2fe; border-radius:16px; padding:32px; display:none; }
.pp-result.active { display:block; }
.pp-doc-header { text-align:center; margin-bottom:28px; padding-bottom:20px; border-bottom:2px solid #1e293b; }
.pp-doc-title { font-size:22px; font-weight:800; color:#1e293b; letter-spacing:2px; }
.pp-doc-section { margin-bottom:20px; }
.pp-doc-section-title { font-size:14px; font-weight:700; color:#4f46e5; margin-bottom:8px; padding:6px 12px; background:#eef2ff; border-radius:8px; display:inline-block; }
.pp-doc-content { font-size:14px; color:#334155; line-height:1.8; padding:8px 0 8px 12px; border-left:3px solid #e0e7ff; white-space:pre-wrap; }
.pp-doc-table { width:100%; border-collapse:collapse; margin:8px 0; }
.pp-doc-table th { background:#f8fafc; padding:8px 12px; text-align:left; border:1px solid #e2e8f0; font-size:13px; font-weight:600; color:#475569; }
.pp-doc-table td { padding:8px 12px; border:1px solid #e2e8f0; font-size:14px; color:#1e293b; }
.pp-doc-footer { text-align:center; margin-top:32px; padding-top:20px; border-top:1px solid #e2e8f0; color:#64748b; font-size:13px; }

.pp-actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }

.pp-toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(100px); background:#1e293b; color:#fff; padding:12px 24px; border-radius:12px; font-size:14px; font-weight:600; z-index:9999; transition:transform .3s ease; display:flex; align-items:center; gap:8px; }
.pp-toast.show { transform:translateX(-50%) translateY(0); }

@media print {
  body * { visibility:hidden; }
  #pp-result, #pp-result * { visibility:visible; }
  #pp-result { position:absolute; left:0; top:0; width:100%; padding:20px; border:none; }
  .no-print { display:none !important; }
}
@media (max-width:640px) {
  .pp-grid { grid-template-columns:1fr; }
  .pp-doc-title { font-size:18px; }
}
</style>

<!-- 헤더 -->
<section class="gradient-indigo text-white py-12 lg:py-16">
  <div class="container-wide">
    <div class="flex items-start gap-5">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
        <span class="material-symbols-outlined text-4xl text-white">assignment</span>
      </div>
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">사업계획서 생성기</h1>
        <p class="text-indigo-100 text-lg">사업정보를 입력하면 공문 서식의 사업계획서를 자동 생성합니다</p>
      </div>
    </div>
  </div>
</section>

<section class="py-10">
  <div class="container-wide max-w-4xl">

    <!-- 견적서 업로드 자동입력 -->
    <%= render 'shared/quote_upload_zone', tool_id: 'pp' %>
    <script>
    function quMapFields_pp(f) {
      quSetField('pp-project-name', f.project_name);
      if (f.total_amount) quSetField('pp-budget', Number(f.total_amount).toLocaleString());
      if (f.contact_phone) quSetField('pp-contact', f.contact_phone);
      // 사업 내용: 품목 요약
      if (f.items && f.items.length > 0) {
        const itemDesc = f.items.map(function(it) {
          let line = it.name;
          if (it.spec) line += ' (' + it.spec + ')';
          if (it.qty) line += ' ' + it.qty + (it.unit || '개');
          return line;
        }).join('\n');
        quSetField('pp-content', itemDesc);
      }
      if (f.delivery_period) quSetField('pp-schedule', f.delivery_period);
    }
    </script>

    <!-- 입력 폼 -->
    <div class="pp-card" id="pp-form-card">
      <h2 style="font-size:20px; font-weight:700; color:#1e293b; margin-bottom:6px; display:flex; align-items:center; gap:8px;">
        <span class="material-symbols-outlined text-indigo-500">edit_note</span>
        사업 정보 입력
      </h2>
      <p style="font-size:14px; color:#64748b; margin-bottom:24px;">필수 항목을 입력하면 사업계획서가 자동으로 생성됩니다.</p>

      <div class="pp-grid" style="margin-bottom:16px;">
        <div>
          <label class="pp-label">사업명 <span class="pp-required">*</span></label>
          <input type="text" class="pp-input" id="pp-project-name" placeholder="예: 사무실 LED 조명 교체">
        </div>
        <div>
          <label class="pp-label">사업부서</label>
          <input type="text" class="pp-input" id="pp-department" placeholder="예: 총무과">
        </div>
      </div>

      <div class="pp-grid" style="margin-bottom:16px;">
        <div>
          <label class="pp-label">담당자</label>
          <input type="text" class="pp-input" id="pp-manager" placeholder="예: 홍길동 주무관">
        </div>
        <div>
          <label class="pp-label">연락처</label>
          <input type="text" class="pp-input" id="pp-contact" placeholder="예: 02-1234-5678">
        </div>
      </div>

      <div style="margin-bottom:16px;">
        <label class="pp-label">사업 필요성 <span class="pp-required">*</span></label>
        <textarea class="pp-input pp-textarea" id="pp-necessity" placeholder="사업을 추진해야 하는 이유를 작성하세요.&#10;예: 기존 형광등이 노후화되어 에너지 효율이 떨어지고 조도가 부족하여 업무환경 개선이 필요함"></textarea>
      </div>

      <div style="margin-bottom:16px;">
        <label class="pp-label">현황 및 문제점</label>
        <textarea class="pp-input pp-textarea" id="pp-current-status" placeholder="현재 상황과 문제점을 구체적으로 작성하세요.&#10;예: 2010년 설치된 형광등 120개 중 30%가 고장, 전력 소비 월 50만원"></textarea>
      </div>

      <div style="margin-bottom:16px;">
        <label class="pp-label">사업 내용 <span class="pp-required">*</span></label>
        <textarea class="pp-input pp-textarea" id="pp-content" placeholder="추진할 사업의 구체적 내용을 작성하세요.&#10;예: 사무실 1~3층 형광등 120개를 LED 조명으로 교체"></textarea>
      </div>

      <div style="margin-bottom:16px;">
        <label class="pp-label">추진 방법 및 일정</label>
        <textarea class="pp-input pp-textarea" id="pp-schedule" placeholder="추진 일정과 방법을 작성하세요.&#10;예: 2026.3월 업체 선정 → 4월 시공 → 5월 완료"></textarea>
      </div>

      <div class="pp-grid" style="margin-bottom:16px;">
        <div>
          <label class="pp-label">소요 예산 <span class="pp-required">*</span></label>
          <input type="text" class="pp-input" id="pp-budget" placeholder="예: 15,000,000" oninput="ppFormatBudget(this)">
          <div style="font-size:12px; color:#94a3b8; margin-top:4px;" id="pp-budget-text"></div>
        </div>
        <div>
          <label class="pp-label">예산 과목</label>
          <input type="text" class="pp-input" id="pp-budget-item" placeholder="예: 시설비-자산취득비">
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <label class="pp-label">기대 효과</label>
        <textarea class="pp-input pp-textarea" id="pp-effect" placeholder="사업 추진 시 예상되는 효과를 작성하세요.&#10;예: 연간 전력비 40% 절감, 업무 환경 개선, 탄소 배출 감소"></textarea>
      </div>

      <div style="text-align:center;">
        <button class="pp-btn pp-btn-primary" onclick="ppGenerate()">
          <span class="material-symbols-outlined">description</span>
          사업계획서 생성
        </button>
      </div>
    </div>

    <!-- 결과 -->
    <div class="pp-result" id="pp-result">
      <div class="no-print pp-actions" style="margin-top:0; margin-bottom:20px;">
        <button class="pp-btn pp-btn-secondary" onclick="ppCopy()">
          <span class="material-symbols-outlined" style="font-size:18px;">content_copy</span> 복사
        </button>
        <button class="pp-btn pp-btn-secondary" onclick="ppDownload()">
          <span class="material-symbols-outlined" style="font-size:18px;">download</span> 다운로드
        </button>
        <button class="pp-btn pp-btn-secondary" onclick="window.print()">
          <span class="material-symbols-outlined" style="font-size:18px;">print</span> 인쇄
        </button>
        <button class="pp-btn pp-btn-secondary" onclick="ppReset()" style="margin-left:auto;">
          <span class="material-symbols-outlined" style="font-size:18px;">refresh</span> 다시 작성
        </button>
      </div>
      <div id="pp-doc-content"></div>
    </div>

  </div>
</section>

<!-- 토스트 -->
<div class="pp-toast" id="pp-toast">
  <span class="material-symbols-outlined" style="font-size:18px;">check_circle</span>
  <span id="pp-toast-msg"></span>
</div>

<script>
function ppFormatBudget(el) {
  let v = el.value.replace(/[^\d]/g, '');
  if (v) {
    el.value = Number(v).toLocaleString();
    document.getElementById('pp-budget-text').textContent = ppNumberToKorean(Number(v)) + '원';
  } else {
    document.getElementById('pp-budget-text').textContent = '';
  }
}

function ppNumberToKorean(n) {
  if (n === 0) return '영';
  const units = ['', '만', '억', '조'];
  const digits = ['', '일', '이', '삼', '사', '오', '육', '칠', '팔', '구'];
  const subUnits = ['', '십', '백', '천'];
  let result = '';
  let unitIndex = 0;
  while (n > 0) {
    let part = n % 10000;
    if (part > 0) {
      let partStr = '';
      let subIndex = 0;
      while (part > 0) {
        let d = part % 10;
        if (d > 0) {
          partStr = (d === 1 && subIndex > 0 ? '' : digits[d]) + subUnits[subIndex] + partStr;
        }
        part = Math.floor(part / 10);
        subIndex++;
      }
      result = partStr + units[unitIndex] + ' ' + result;
    }
    n = Math.floor(n / 10000);
    unitIndex++;
  }
  return result.trim();
}

function ppGenerate() {
  const name = document.getElementById('pp-project-name').value.trim();
  const necessity = document.getElementById('pp-necessity').value.trim();
  const content = document.getElementById('pp-content').value.trim();
  const budget = document.getElementById('pp-budget').value.trim();

  if (!name) { ppShowToast('사업명을 입력하세요'); return; }
  if (!necessity) { ppShowToast('사업 필요성을 입력하세요'); return; }
  if (!content) { ppShowToast('사업 내용을 입력하세요'); return; }
  if (!budget) { ppShowToast('소요 예산을 입력하세요'); return; }

  const dept = document.getElementById('pp-department').value.trim() || '○○과';
  const manager = document.getElementById('pp-manager').value.trim();
  const contact = document.getElementById('pp-contact').value.trim();
  const currentStatus = document.getElementById('pp-current-status').value.trim();
  const schedule = document.getElementById('pp-schedule').value.trim();
  const budgetItem = document.getElementById('pp-budget-item').value.trim();
  const effect = document.getElementById('pp-effect').value.trim();
  const budgetNum = Number(budget.replace(/[^\d]/g, ''));
  const budgetKorean = ppNumberToKorean(budgetNum);
  const today = new Date();
  const dateStr = today.getFullYear() + '.' + String(today.getMonth()+1).padStart(2,'0') + '.' + String(today.getDate()).padStart(2,'0');

  let html = '';
  html += '<div class="pp-doc-header">';
  html += '<div class="pp-doc-title">사 업 계 획 서</div>';
  html += '</div>';

  // 기본정보 테이블
  html += '<table class="pp-doc-table">';
  html += '<tr><th style="width:120px;">사업명</th><td>' + ppEscape(name) + '</td></tr>';
  html += '<tr><th>사업부서</th><td>' + ppEscape(dept) + '</td></tr>';
  if (manager || contact) {
    html += '<tr><th>담당자</th><td>' + ppEscape(manager) + (contact ? ' (' + ppEscape(contact) + ')' : '') + '</td></tr>';
  }
  html += '<tr><th>작성일</th><td>' + dateStr + '</td></tr>';
  html += '</table>';

  // 사업 필요성
  html += '<div class="pp-doc-section">';
  html += '<div class="pp-doc-section-title">1. 사업 필요성</div>';
  html += '<div class="pp-doc-content">' + ppEscape(necessity) + '</div>';
  html += '</div>';

  // 현황 및 문제점
  if (currentStatus) {
    html += '<div class="pp-doc-section">';
    html += '<div class="pp-doc-section-title">2. 현황 및 문제점</div>';
    html += '<div class="pp-doc-content">' + ppEscape(currentStatus) + '</div>';
    html += '</div>';
  }

  // 사업 내용
  const sectionNum = currentStatus ? 3 : 2;
  html += '<div class="pp-doc-section">';
  html += '<div class="pp-doc-section-title">' + sectionNum + '. 사업 내용</div>';
  html += '<div class="pp-doc-content">' + ppEscape(content) + '</div>';
  html += '</div>';

  // 추진 일정
  if (schedule) {
    html += '<div class="pp-doc-section">';
    html += '<div class="pp-doc-section-title">' + (sectionNum+1) + '. 추진 방법 및 일정</div>';
    html += '<div class="pp-doc-content">' + ppEscape(schedule) + '</div>';
    html += '</div>';
  }

  // 소요 예산
  const budgetSectionNum = sectionNum + (schedule ? 2 : 1);
  html += '<div class="pp-doc-section">';
  html += '<div class="pp-doc-section-title">' + budgetSectionNum + '. 소요 예산</div>';
  html += '<table class="pp-doc-table">';
  html += '<tr><th style="width:120px;">금액</th><td style="font-weight:700; font-size:16px; color:#4f46e5;">금 ' + budget + '원 (' + budgetKorean + '원)</td></tr>';
  if (budgetItem) {
    html += '<tr><th>예산 과목</th><td>' + ppEscape(budgetItem) + '</td></tr>';
  }
  html += '<tr><th>부가세</th><td>포함 / 별도 (해당시)</td></tr>';
  html += '</table>';
  html += '</div>';

  // 기대 효과
  if (effect) {
    html += '<div class="pp-doc-section">';
    html += '<div class="pp-doc-section-title">' + (budgetSectionNum+1) + '. 기대 효과</div>';
    html += '<div class="pp-doc-content">' + ppEscape(effect) + '</div>';
    html += '</div>';
  }

  // 붙임
  html += '<div class="pp-doc-section" style="margin-top:32px;">';
  html += '<div style="font-size:13px; color:#64748b;">붙임  1. 견적서 1부</div>';
  html += '<div style="font-size:13px; color:#64748b;">      2. 수의계약 사유서 1부. 끝.</div>';
  html += '</div>';

  html += '<div class="pp-doc-footer">';
  html += ppEscape(dept) + '<br>';
  html += '<span style="font-size:12px; color:#94a3b8;">이 문서는 실무(silmu.kr) 사업계획서 생성기로 작성되었습니다.</span>';
  html += '</div>';

  document.getElementById('pp-doc-content').innerHTML = html;
  document.getElementById('pp-result').classList.add('active');
  document.getElementById('pp-result').scrollIntoView({ behavior:'smooth', block:'start' });
  ppShowToast('사업계획서가 생성되었습니다');
}

function ppEscape(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function ppCopy() {
  const el = document.getElementById('pp-doc-content');
  const text = el.innerText || el.textContent;
  navigator.clipboard.writeText(text).then(function() {
    ppShowToast('클립보드에 복사되었습니다');
  }).catch(function() {
    // fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    ppShowToast('클립보드에 복사되었습니다');
  });
}

function ppDownload() {
  const el = document.getElementById('pp-doc-content');
  const text = el.innerText || el.textContent;
  const name = document.getElementById('pp-project-name').value.trim() || '사업계획서';
  const blob = new Blob([text], { type:'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = '사업계획서_' + name + '.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  ppShowToast('파일이 다운로드되었습니다');
}

function ppReset() {
  document.getElementById('pp-result').classList.remove('active');
  document.getElementById('pp-form-card').scrollIntoView({ behavior:'smooth', block:'start' });
}

function ppShowToast(msg) {
  const toast = document.getElementById('pp-toast');
  document.getElementById('pp-toast-msg').textContent = msg;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2500);
}
</script>
