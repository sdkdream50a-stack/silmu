<!-- 지체상금 실무흐름도 -->
<div class="card">
  <div class="card-header">
    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-3">
      <span class="material-symbols-outlined text-indigo-500">account_tree</span>
      지체상금 실무흐름도
    </h2>
    <p class="text-slate-600 mt-1">계약상대자의 이행 지체 시 지체상금 산정·징수 절차</p>
  </div>

  <div class="p-6">
    <!-- 사전 안내 -->
    <div class="mb-6 p-3 bg-red-50 border border-red-200 rounded-xl text-sm text-red-800 flex items-start gap-2">
      <span class="material-symbols-outlined text-red-500 mt-0.5" style="font-size:18px">gavel</span>
      <span>지체상금 징수는 <strong>재량이 아닌 법적 의무(기속행위)</strong>입니다. 미징수 시 감사에서 지적됩니다. (지방계약법 제30조)</span>
    </div>

    <!-- 처리 절차 -->
    <div class="space-y-4">
      <!-- Step 1: red -->
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
        <div class="flex-1 bg-red-50 rounded-xl p-4 border border-red-200">
          <h4 class="font-semibold text-red-800 mb-2">이행 지체 확인</h4>
          <ul class="text-sm text-slate-700 space-y-1">
            <li>• 계약상 <strong class="text-red-700">이행기한</strong> 확인</li>
            <li>• 이행기한 경과 여부 확인</li>
            <li>• <strong class="text-red-700">이행완료 통보일</strong> 확인 (검사 합격일 아님)</li>
            <li class="text-xs text-slate-500 ml-3">※ 기산일: 이행기한의 <strong>다음 날</strong>부터</li>
          </ul>
        </div>
      </div>

      <div class="flex justify-center">
        <span class="material-symbols-outlined text-slate-300 text-2xl">arrow_downward</span>
      </div>

      <!-- Step 2: orange -->
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
        <div class="flex-1 bg-orange-50 rounded-xl p-4 border border-orange-200">
          <div class="flex items-start justify-between mb-2">
            <h4 class="font-semibold text-orange-800">귀책사유 판단</h4>
            <span class="doc-tool-badge" onclick="showDocPopup('step2')"><span class="material-symbols-outlined" style="font-size:14px">edit_document</span>공문/양식 생성 도구</span>
          </div>
          <ul class="text-sm text-slate-700 space-y-1">
            <li>• 지체가 <strong class="text-orange-700">계약상대자 귀책</strong>인지 판단</li>
            <li>• 계약상대자 소명 기회 부여</li>
            <li>• <strong class="text-orange-700">발주기관 귀책</strong> 여부 검토 (설계변경, 용지 미확보 등)</li>
            <li class="text-xs text-slate-500 ml-3">※ 인력 부족, 자재난 등은 계약상대자 귀책 → 면제 불가</li>
          </ul>
        </div>
      </div>

      <div class="flex justify-center">
        <span class="material-symbols-outlined text-slate-300 text-2xl">arrow_downward</span>
      </div>

      <!-- Step 3: amber -->
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-amber-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
        <div class="flex-1 bg-amber-50 rounded-xl p-4 border border-amber-200">
          <div class="flex items-start justify-between mb-2">
            <h4 class="font-semibold text-amber-800">면제·감면 검토</h4>
            <span class="doc-tool-badge" onclick="showDocPopup('step3')"><span class="material-symbols-outlined" style="font-size:14px">edit_document</span>공문/양식 생성 도구</span>
          </div>
          <ul class="text-sm text-slate-700 space-y-1">
            <li>• <strong class="text-amber-700">면제 사유</strong> 해당 여부 검토 (시행령 제75조)</li>
            <li class="text-xs text-slate-500 ml-3">천재지변 / 발주기관 귀책 / 설계변경 / 관급자재 지연 등</li>
            <li>• 계약상대자 <strong class="text-amber-700">감면 신청서·소명자료</strong> 접수·검토</li>
            <li>• 면제일수 확정 → 지체일수에서 공제</li>
          </ul>
        </div>
      </div>

      <div class="flex justify-center">
        <span class="material-symbols-outlined text-slate-300 text-2xl">arrow_downward</span>
      </div>

      <!-- Step 4: blue -->
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">4</div>
        <div class="flex-1 bg-blue-50 rounded-xl p-4 border border-blue-200">
          <h4 class="font-semibold text-blue-800 mb-2">지체상금 산정</h4>
          <ul class="text-sm text-slate-700 space-y-1">
            <li>• <strong class="text-blue-700">지체상금 = 계약금액 x 상금률 x 지체일수</strong></li>
            <li>• 계약 유형별 상금률 적용</li>
            <li class="text-xs text-slate-500 ml-3">공사: 1/2,000 | 물품·용역: 3/4,000 | 임대차: 1/1,000</li>
            <li>• 부분 이행 시: 독립 사용 가능 부분 금액 공제 후 산정</li>
            <li>• <strong class="text-blue-700">한도 확인:</strong> 계약금액 초과 불가</li>
          </ul>
          <!-- 산정 예시 박스 -->
          <div class="mt-3 p-3 bg-blue-100/60 rounded-lg text-xs text-blue-800">
            <strong>예시)</strong> 5억원 공사, 20일 지체 → 5억 x 1/2,000 x 20 = <strong>500만원</strong>
          </div>
        </div>
      </div>

      <div class="flex justify-center">
        <span class="material-symbols-outlined text-slate-300 text-2xl">arrow_downward</span>
      </div>

      <!-- Step 5: green -->
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">5</div>
        <div class="flex-1 bg-green-50 rounded-xl p-4 border border-green-200">
          <div class="flex items-start justify-between mb-2">
            <h4 class="font-semibold text-green-800">지체상금 징수</h4>
            <span class="doc-tool-badge" onclick="showDocPopup('step5')"><span class="material-symbols-outlined" style="font-size:14px">edit_document</span>공문/양식 생성 도구</span>
          </div>
          <ul class="text-sm text-slate-700 space-y-1">
            <li>• 지체상금 징수 결정 통보</li>
            <li>• <strong class="text-green-700">대금 지급 시 공제</strong> 또는 별도 징수</li>
            <li>• 계약보증금에서 공제 가능</li>
          </ul>
        </div>
      </div>

      <div class="flex justify-center">
        <span class="material-symbols-outlined text-slate-300 text-2xl">arrow_downward</span>
      </div>

      <!-- Step 6: slate -->
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-10 h-10 bg-slate-500 text-white rounded-full flex items-center justify-center font-bold">6</div>
        <div class="flex-1 bg-slate-50 rounded-xl p-4 border border-slate-200">
          <h4 class="font-semibold text-slate-800 mb-2">후속 조치 검토</h4>
          <ul class="text-sm text-slate-700 space-y-1">
            <li>• 지체상금이 <strong class="text-slate-800">계약금액에 도달</strong> → 계약 해지·해제 검토</li>
            <li>• 반복 지체 → <strong class="text-slate-800">부정당업자 제재</strong> 검토 (법 제31조)</li>
            <li>• 이행 독촉 병행</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 참고 안내 (접히는 섹션) -->
    <details open class="mt-8 border border-slate-200 rounded-xl overflow-hidden">
      <summary class="flex items-center gap-3 p-4 bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer">
        <span class="material-symbols-outlined text-slate-500">info</span>
        <span class="font-semibold text-slate-700">참고 안내</span>
        <span class="text-xs text-slate-400 ml-auto">상금률 · 면제사유 · 감사대비</span>
      </summary>
      <div class="p-4 space-y-4">
        <!-- 지체상금률 비교표 -->
        <div class="bg-white border border-slate-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-blue-500">calculate</span>
            <div class="w-full">
              <h4 class="font-semibold text-slate-800 mb-3">공종별 지체상금률 <span class="text-xs font-normal bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">시행령 제74조</span></h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                  <span class="material-symbols-outlined text-blue-400">construction</span>
                  <div>
                    <span class="font-semibold text-slate-800">공사</span>
                    <p class="text-blue-700 font-bold">1일당 1/2,000</p>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-violet-50 rounded-lg">
                  <span class="material-symbols-outlined text-violet-400">inventory_2</span>
                  <div>
                    <span class="font-semibold text-slate-800">물품 제조·구매</span>
                    <p class="text-violet-700 font-bold">1일당 3/4,000</p>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-teal-50 rounded-lg">
                  <span class="material-symbols-outlined text-teal-400">engineering</span>
                  <div>
                    <span class="font-semibold text-slate-800">용역·물품 수리·가공</span>
                    <p class="text-teal-700 font-bold">1일당 3/4,000</p>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-lg">
                  <span class="material-symbols-outlined text-amber-400">apartment</span>
                  <div>
                    <span class="font-semibold text-slate-800">임대차</span>
                    <p class="text-amber-700 font-bold">1일당 1/1,000</p>
                  </div>
                </div>
              </div>
              <p class="text-xs text-slate-500 mt-2">※ 지체상금 합계액은 계약금액을 초과할 수 없음</p>
            </div>
          </div>
        </div>

        <!-- 면제 사유 -->
        <div class="bg-white border border-slate-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-green-500">check_circle</span>
            <div>
              <h4 class="font-semibold text-slate-800 mb-2">지체일수 제외 사유 <span class="text-xs font-normal bg-green-100 text-green-700 px-2 py-0.5 rounded-full">시행령 제75조</span></h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                <div class="flex items-center gap-2 text-slate-700">
                  <span class="material-symbols-outlined text-green-400 text-lg">check</span>
                  천재지변 (태풍·지진·홍수)
                </div>
                <div class="flex items-center gap-2 text-slate-700">
                  <span class="material-symbols-outlined text-green-400 text-lg">check</span>
                  발주기관 귀책 (설계변경 지연 등)
                </div>
                <div class="flex items-center gap-2 text-slate-700">
                  <span class="material-symbols-outlined text-green-400 text-lg">check</span>
                  관급자재 지급 지연
                </div>
                <div class="flex items-center gap-2 text-slate-700">
                  <span class="material-symbols-outlined text-green-400 text-lg">check</span>
                  사전 승인된 공기 연장 기간
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 면제 불가 사유 -->
        <div class="bg-white border border-slate-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-red-400">block</span>
            <div>
              <h4 class="font-semibold text-slate-800 mb-2">면제 불가 사유 (계약상대자 귀책)</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                <div class="flex items-center gap-2 text-red-700">
                  <span class="material-symbols-outlined text-red-400 text-lg">close</span>
                  인력 부족·확보 곤란
                </div>
                <div class="flex items-center gap-2 text-red-700">
                  <span class="material-symbols-outlined text-red-400 text-lg">close</span>
                  자재 수급 곤란
                </div>
                <div class="flex items-center gap-2 text-red-700">
                  <span class="material-symbols-outlined text-red-400 text-lg">close</span>
                  하도급 업체 문제
                </div>
                <div class="flex items-center gap-2 text-red-700">
                  <span class="material-symbols-outlined text-red-400 text-lg">close</span>
                  자금난·경영 사정
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 지체일수 산정 -->
        <div class="bg-white border border-slate-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-indigo-500">event</span>
            <div>
              <h4 class="font-semibold text-slate-800 mb-2">지체일수 산정 기준</h4>
              <div class="text-sm space-y-2">
                <div class="flex items-start gap-2 text-slate-700">
                  <span class="material-symbols-outlined text-indigo-400 text-lg mt-0.5">arrow_forward</span>
                  <span><strong>기산일:</strong> 이행기한의 <strong class="text-indigo-700">다음 날</strong> (이행기한 당일 미포함)</span>
                </div>
                <div class="flex items-start gap-2 text-slate-700">
                  <span class="material-symbols-outlined text-indigo-400 text-lg mt-0.5">arrow_forward</span>
                  <span><strong>종료일:</strong> <strong class="text-indigo-700">이행완료 통보일</strong> (검사 합격일이 아님)</span>
                </div>
                <div class="flex items-start gap-2 text-slate-700">
                  <span class="material-symbols-outlined text-indigo-400 text-lg mt-0.5">arrow_forward</span>
                  <span><strong>검사 불합격:</strong> 시정 후 재검사 합격일까지 지체일수에 <strong class="text-indigo-700">산입</strong></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 감사 대비 -->
        <div class="bg-red-50 border border-red-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-red-500">gavel</span>
            <div>
              <h4 class="font-semibold text-red-800 mb-2">감사 대비 체크리스트</h4>
              <ul class="text-sm text-slate-700 space-y-1.5">
                <li class="flex items-start gap-2">
                  <span class="material-symbols-outlined text-red-400 text-lg mt-0.5">warning</span>
                  <span><strong>지체상금 미징수</strong> — 징수는 재량이 아닌 법적 의무, 미징수 시 감사 지적</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="material-symbols-outlined text-red-400 text-lg mt-0.5">warning</span>
                  <span><strong>상금률 혼동</strong> — 공사(1/2,000)와 물품·용역(3/4,000)은 상금률이 다름</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="material-symbols-outlined text-red-400 text-lg mt-0.5">warning</span>
                  <span><strong>기산일 오류</strong> — 이행기한 <strong>다음 날</strong>부터 기산, 당일 미포함</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="material-symbols-outlined text-red-400 text-lg mt-0.5">warning</span>
                  <span><strong>부당 면제</strong> — 법정 사유 외 사유로 면제 시 감사 지적</span>
                </li>
                <li class="flex items-start gap-2">
                  <span class="material-symbols-outlined text-red-400 text-lg mt-0.5">warning</span>
                  <span><strong>부분 이행 공제 부적정</strong> — 독립 사용 불가 부분은 공제 불가</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </details>
  </div>
</div>

<!-- 공문생산 팝업 -->
<div id="doc-popup-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:9999; display:none; align-items:center; justify-content:center;" onclick="if(event.target===this) closeDocPopup()">
  <div style="background:#fff; border-radius:16px; max-width:480px; width:90%; max-height:80vh; overflow-y:auto; padding:28px; box-shadow:0 20px 60px rgba(0,0,0,.2); animation:docPopupIn .2s ease;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="material-symbols-outlined" style="color:#e11d48; font-size:22px;">edit_document</span>
        <h3 id="doc-popup-title" style="font-size:18px; font-weight:700; color:#1e293b; margin:0;"></h3>
      </div>
      <button onclick="closeDocPopup()" style="background:none; border:none; cursor:pointer; padding:4px;">
        <span class="material-symbols-outlined" style="color:#94a3b8; font-size:22px;">close</span>
      </button>
    </div>
    <div id="doc-popup-body"></div>
  </div>
</div>

<style>
@keyframes docPopupIn { from { opacity:0; transform:scale(.95) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }
.doc-tool-badge {
  display:inline-flex; align-items:center; gap:6px; margin-top:4px;
  padding:6px 14px; background:#fff1f2; color:#e11d48;
  font-size:13px; font-weight:600; border-radius:10px;
  cursor:pointer; border:1.5px solid #fecdd3;
  box-shadow:0 1px 3px rgba(225,29,72,.1);
  transition:all .2s ease;
}
.doc-tool-badge:hover {
  transform:translateY(-2px) scale(1.04);
  box-shadow:0 6px 20px rgba(225,29,72,.2);
  background:#ffe4e6; border-color:#fda4af;
}
.doc-tool-badge:active { transform:translateY(0) scale(.98); box-shadow:0 1px 2px rgba(225,29,72,.1); }
.doc-item { display:flex; align-items:flex-start; gap:10px; padding:12px; border-radius:10px; border:1px solid #e2e8f0; margin-bottom:8px; }
.doc-item .doc-icon { flex-shrink:0; width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; }
.doc-item .doc-name { font-size:14px; font-weight:600; color:#1e293b; }
.doc-item .doc-desc { font-size:12px; color:#64748b; margin-top:2px; }
.doc-item.has-tool { cursor:pointer; transition:all .15s; }
.doc-item.has-tool:hover { border-color:#818cf8; background:#f5f3ff; }
</style>

<script>
var docPopupData = {
  step2: {
    title: '귀책사유 판단 단계 공문/양식',
    groups: [
      { label: '필수', icon: 'verified', color: '#dc2626', items: [
        { name: '지체사유 소명 요청 통보서', desc: '계약상대자에게 지체사유 소명 기회 부여 통보', icon: 'outgoing_mail', color: '#059669', tool: '<%= official_document_path %>?type=notification', toolLabel: 'AI 공문서 (통보문)' }
      ]},
      { label: '계약상대자 제출', icon: 'person', color: '#6366f1', items: [
        { name: '지체사유 소명서', desc: '계약상대자가 제출하는 지체 사유 소명 문서', icon: 'description', color: '#6366f1' }
      ]}
    ]
  },
  step3: {
    title: '면제·감면 검토 단계 공문/양식',
    groups: [
      { label: '계약상대자 제출', icon: 'person', color: '#6366f1', items: [
        { name: '지체상금 감면 신청서', desc: '면제·감면 사유 및 증빙자료 첨부', icon: 'edit_document', color: '#6366f1' },
        { name: '증빙자료', desc: '천재지변 증명, 설계변경 통보서 등 객관적 근거', icon: 'attach_file', color: '#6366f1' }
      ]},
      { label: '내부 검토', icon: 'fact_check', color: '#64748b', items: [
        { name: '면제·감면 검토서', desc: '감면 타당성 검토 및 결정 (내부 기안)', icon: 'fact_check', color: '#64748b', tool: '<%= official_document_path %>?type=draft', toolLabel: 'AI 공문서 (기안문)' }
      ]}
    ]
  },
  step5: {
    title: '지체상금 징수 단계 공문/양식',
    groups: [
      { label: '필수', icon: 'verified', color: '#dc2626', items: [
        { name: '지체상금 징수 통보서', desc: '지체상금 금액·산정 근거·징수 방법 통보', icon: 'outgoing_mail', color: '#dc2626', tool: '<%= official_document_path %>?type=notification', toolLabel: 'AI 공문서 (통보문)' },
        { name: '지출결의서', desc: '대금에서 지체상금 공제 후 지급 결의', icon: 'request_quote', color: '#e11d48', tool: '<%= official_document_path %>?type=draft', toolLabel: 'AI 공문서 (기안문)' }
      ]},
      { label: '도구', icon: 'build', color: '#6366f1', items: [
        { name: '기간 계산', desc: '지체일수 자동 계산', icon: 'date_range', color: '#6366f1', tool: '<%= legal_period_path %>' }
      ]}
    ]
  }
};

function showDocPopup(step) {
  var data = docPopupData[step];
  if (!data) return;
  document.getElementById('doc-popup-title').textContent = data.title;
  var html = '';
  data.groups.forEach(function(group) {
    html += '<div style="display:flex; align-items:center; gap:6px; margin:16px 0 8px; padding-bottom:6px; border-bottom:1px solid #f1f5f9;">';
    html += '<span class="material-symbols-outlined" style="font-size:16px; color:' + group.color + ';">' + group.icon + '</span>';
    html += '<span style="font-size:13px; font-weight:700; color:' + group.color + ';">' + group.label + '</span>';
    html += '</div>';
    group.items.forEach(function(item) {
      var tag = item.tag ? ' <span style="font-size:11px; color:#94a3b8; background:#f1f5f9; padding:1px 6px; border-radius:4px; margin-left:4px;">' + item.tag + '</span>' : '';
      var toolAttr = item.tool ? ' has-tool" onclick="window.location.href=\'' + item.tool + '\'"' : '"';
      var featuredStyle = item.featured ? ' style="background:#eef2ff; border-color:#a5b4fc;"' : '';
      html += '<div class="doc-item' + toolAttr + featuredStyle + '>';
      html += '<div class="doc-icon" style="background:' + item.color + '15;"><span class="material-symbols-outlined" style="font-size:18px; color:' + item.color + ';">' + item.icon + '</span></div>';
      html += '<div><div class="doc-name">' + item.name + tag;
      if (item.tool && !item.toolLabel) html += ' <span class="material-symbols-outlined" style="font-size:12px; color:#818cf8; vertical-align:middle;">open_in_new</span>';
      html += '</div><div class="doc-desc">' + item.desc + '</div>';
      if (item.note) html += '<div style="font-size:11px; color:#d97706; margin-top:3px; display:flex; align-items:center; gap:3px;"><span class="material-symbols-outlined" style="font-size:12px;">info</span>' + item.note + '</div>';
      if (item.toolLabel) html += '<div style="margin-top:5px;"><a href="' + item.tool + '" style="font-size:11px; color:#4f46e5; font-weight:600; display:inline-flex; align-items:center; gap:3px; text-decoration:none;" onclick="event.stopPropagation();"><span class="material-symbols-outlined" style="font-size:13px;">calculate</span>' + item.toolLabel + ' <span class="material-symbols-outlined" style="font-size:11px;">open_in_new</span></a></div>';
      html += '</div>';
      html += '</div>';
    });
  });
  document.getElementById('doc-popup-body').innerHTML = html;
  document.getElementById('doc-popup-overlay').style.display = 'flex';
}

function closeDocPopup() {
  document.getElementById('doc-popup-overlay').style.display = 'none';
}

document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeDocPopup(); });
</script>
