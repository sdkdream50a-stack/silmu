<%# Created: 2026-02-22 20:40 %>
<%# 장기계속계약 실무흐름도 %>

<div class="space-y-8">
  <!-- 프로세스 개요 -->
  <div class="bg-gradient-to-r from-indigo-50 to-emerald-50 rounded-2xl p-6 border border-indigo-100">
    <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
      <span class="material-symbols-outlined text-indigo-600">account_tree</span>
      장기계속계약 프로세스
    </h3>
    <div class="flex items-center gap-3 overflow-x-auto pb-2">
      <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm whitespace-nowrap">
        <span class="w-6 h-6 rounded-full bg-indigo-600 text-white text-xs flex items-center justify-center font-bold">1</span>
        <span class="text-sm font-medium text-slate-700">최초 계약 체결</span>
      </div>
      <span class="material-symbols-outlined text-slate-300">arrow_forward</span>
      <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm whitespace-nowrap">
        <span class="w-6 h-6 rounded-full bg-emerald-600 text-white text-xs flex items-center justify-center font-bold">2</span>
        <span class="text-sm font-medium text-slate-700">연차별 예산 확보</span>
      </div>
      <span class="material-symbols-outlined text-slate-300">arrow_forward</span>
      <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm whitespace-nowrap">
        <span class="w-6 h-6 rounded-full bg-amber-500 text-white text-xs flex items-center justify-center font-bold">3</span>
        <span class="text-sm font-medium text-slate-700">계약금액 조정</span>
      </div>
      <span class="material-symbols-outlined text-slate-300">arrow_forward</span>
      <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm whitespace-nowrap">
        <span class="w-6 h-6 rounded-full bg-slate-600 text-white text-xs flex items-center justify-center font-bold">4</span>
        <span class="text-sm font-medium text-slate-700">계약 갱신</span>
      </div>
    </div>
  </div>

  <!-- STEP 1: 최초 계약 체결 -->
  <div class="card overflow-hidden" style="border-left: 4px solid #4f46e5;">
    <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center font-bold shadow-md">1</span>
          <div>
            <h4 class="font-bold text-slate-900">최초 계약 체결</h4>
            <p class="text-sm text-slate-600">사업 기간 확정, 총 계약금액 결정, 최초 연도 계약 체결</p>
          </div>
        </div>
        <span class="px-3 py-1 bg-indigo-600 text-white text-xs font-semibold rounded-full">입찰 준비</span>
      </div>
    </div>
    <div class="p-6">
      <div class="grid sm:grid-cols-2 gap-4 mb-5">
        <a href="<%= contract_method_path %>" class="group block p-4 bg-white border border-slate-200 rounded-xl hover:border-indigo-300 hover:shadow-md transition-all">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-indigo-600 text-2xl">gavel</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900 group-hover:text-indigo-600 transition-colors">계약방식 결정</div>
              <div class="text-sm text-slate-500 mt-1">장기계속계약 대상 여부 판단</div>
            </div>
          </div>
        </a>
        <a href="<%= estimated_price_path %>" class="group block p-4 bg-white border border-slate-200 rounded-xl hover:border-indigo-300 hover:shadow-md transition-all">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-indigo-600 text-2xl">calculate</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900 group-hover:text-indigo-600 transition-colors">총 계약금액 산정</div>
              <div class="text-sm text-slate-500 mt-1">5년 이내 총 사업비 추정</div>
            </div>
          </div>
        </a>
        <a href="<%= contract_documents_path %>" class="group block p-4 bg-white border border-slate-200 rounded-xl hover:border-indigo-300 hover:shadow-md transition-all">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-indigo-600 text-2xl">checklist</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900 group-hover:text-indigo-600 transition-colors">계약서류 준비</div>
              <div class="text-sm text-slate-500 mt-1">표준계약서+특수조건 명시</div>
            </div>
          </div>
        </a>
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">edit_document</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">1차 연도 계약 체결</div>
              <div class="text-sm text-slate-500 mt-1">최초 연도 예산 범위 내</div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
        <div class="flex items-start gap-3">
          <span class="material-symbols-outlined text-blue-600 shrink-0">info</span>
          <p class="text-sm text-blue-900"><strong>체크포인트</strong>: 장기계속계약은 <strong>5년 이내</strong> 범위에서 연차별 예산 확보가 전제됩니다. 최초 계약 시 <strong>총 계약금액</strong>과 <strong>연차별 계약금액</strong>을 모두 명시해야 하며, 사업 기간 변경 시 재계약이 필요합니다.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 2: 연차별 예산 확보 -->
  <div class="card overflow-hidden" style="border-left: 4px solid #059669;">
    <div class="bg-emerald-50 px-6 py-4 border-b border-emerald-100">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="w-10 h-10 rounded-xl bg-emerald-600 text-white flex items-center justify-center font-bold shadow-md">2</span>
          <div>
            <h4 class="font-bold text-slate-900 flex items-center gap-2">
              연차별 예산 확보
              <span class="doc-tool-badge" onclick="showDocPopup('step2')">
                <span class="material-symbols-outlined" style="font-size:16px">edit_document</span>
                공문/양식 생성 도구
              </span>
            </h4>
            <p class="text-sm text-slate-600">다음 연도 예산 요구, 예산 편성, 계속비 신청</p>
          </div>
        </div>
        <span class="px-3 py-1 bg-emerald-600 text-white text-xs font-semibold rounded-full">예산 편성</span>
      </div>
    </div>
    <div class="p-6">
      <div class="grid sm:grid-cols-2 gap-4 mb-5">
        <a href="<%= budget_estimator_path %>" class="group block p-4 bg-gradient-to-br from-emerald-50 to-white border-2 border-emerald-300 rounded-xl hover:border-emerald-500 hover:shadow-lg transition-all">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-emerald-600 text-2xl">savings</span>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-slate-900 group-hover:text-emerald-600 transition-colors flex items-center gap-2">
                예산 요구서 작성
                <span class="text-xs px-2 py-0.5 bg-emerald-600 text-white rounded-full">핵심</span>
              </div>
              <div class="text-sm text-slate-500 mt-1">차년도 소요예산 명시 ⭐</div>
            </div>
          </div>
        </a>
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">calendar_month</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">예산 편성 일정 확인</div>
              <div class="text-sm text-slate-500 mt-1">5~12월 예산 편성 절차</div>
            </div>
          </div>
        </div>
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">trending_up</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">물가변동 반영</div>
              <div class="text-sm text-slate-500 mt-1">물가지수 반영 계약금액 조정</div>
            </div>
          </div>
        </div>
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">check_circle</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">예산 확보 확인</div>
              <div class="text-sm text-slate-500 mt-1">의회 예산안 의결 후 확정</div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
        <div class="flex items-start gap-3">
          <span class="material-symbols-outlined text-amber-600 shrink-0">warning</span>
          <p class="text-sm text-amber-900"><strong>체크포인트</strong>: 차년도 예산이 확보되지 않으면 계약이 자동 해지됩니다. 예산 요구서는 <strong>7~8월</strong>에 제출해야 하며, 의회 예산안 의결(12월) 후 최종 확정됩니다.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3: 계약금액 조정 -->
  <div class="card overflow-hidden" style="border-left: 4px solid #f59e0b;">
    <div class="bg-amber-50 px-6 py-4 border-b border-amber-100">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="w-10 h-10 rounded-xl bg-amber-500 text-white flex items-center justify-center font-bold shadow-md">3</span>
          <div>
            <h4 class="font-bold text-slate-900">계약금액 조정</h4>
            <p class="text-sm text-slate-600">물가변동 반영, 설계변경, 계약금액 증감</p>
          </div>
        </div>
        <span class="px-3 py-1 bg-amber-500 text-white text-xs font-semibold rounded-full">금액 변경</span>
      </div>
    </div>
    <div class="p-6">
      <div class="grid sm:grid-cols-2 gap-4 mb-5">
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">percent</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">물가변동 계산</div>
              <div class="text-sm text-slate-500 mt-1">물가지수 3% 이상 변동 시</div>
            </div>
          </div>
        </div>
        <a href="<%= design_change_path %>" class="group block p-4 bg-white border border-slate-200 rounded-xl hover:border-amber-300 hover:shadow-md transition-all">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-amber-500 text-2xl">edit</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900 group-hover:text-amber-500 transition-colors">설계변경 검토</div>
              <div class="text-sm text-slate-500 mt-1">사업 내용 변경 시 증감</div>
            </div>
          </div>
        </a>
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">calculate</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">계약금액 재산정</div>
              <div class="text-sm text-slate-500 mt-1">물가+설계변경 합산</div>
            </div>
          </div>
        </div>
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">description</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">계약변경 계약서</div>
              <div class="text-sm text-slate-500 mt-1">변경 사유 및 금액 명시</div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
        <div class="flex items-start gap-3">
          <span class="material-symbols-outlined text-blue-600 shrink-0">info</span>
          <p class="text-sm text-blue-900"><strong>체크포인트</strong>: 물가변동은 <strong>한국은행 생산자물가지수 3% 이상</strong> 변동 시 조정 가능합니다. 설계변경은 <strong>당초 계약 범위 내</strong>에서만 가능하며, 사업 목적이 달라지면 신규 계약이 필요합니다.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 4: 계약 갱신 -->
  <div class="card overflow-hidden" style="border-left: 4px solid #475569;">
    <div class="bg-slate-50 px-6 py-4 border-b border-slate-100">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="w-10 h-10 rounded-xl bg-slate-600 text-white flex items-center justify-center font-bold shadow-md">4</span>
          <div>
            <h4 class="font-bold text-slate-900">계약 갱신</h4>
            <p class="text-sm text-slate-600">연차별 계약 갱신, 계약보증금 재납부, 검사 및 대금 지급</p>
          </div>
        </div>
        <span class="px-3 py-1 bg-slate-600 text-white text-xs font-semibold rounded-full">계약 이행</span>
      </div>
    </div>
    <div class="p-6">
      <div class="grid sm:grid-cols-2 gap-4 mb-5">
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">refresh</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">연차별 계약 갱신</div>
              <div class="text-sm text-slate-500 mt-1">예산 확보 후 자동 갱신</div>
            </div>
          </div>
        </div>
        <a href="<%= contract_guarantee_path %>" class="group block p-4 bg-gradient-to-br from-slate-50 to-white border-2 border-slate-300 rounded-xl hover:border-slate-500 hover:shadow-lg transition-all">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">paid</span>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-slate-900 group-hover:text-slate-600 transition-colors flex items-center gap-2">
                계약보증금 재납부
                <span class="text-xs px-2 py-0.5 bg-slate-600 text-white rounded-full">중요</span>
              </div>
              <div class="text-sm text-slate-500 mt-1">매년 계약금액 10% 이상 ⭐</div>
            </div>
          </div>
        </a>
        <a href="<%= progress_inspection_path %>" class="group block p-4 bg-white border border-slate-200 rounded-xl hover:border-slate-300 hover:shadow-md transition-all">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">fact_check</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900 group-hover:text-slate-600 transition-colors">기성검사 실시</div>
              <div class="text-sm text-slate-500 mt-1">연차별 이행 내역 확인</div>
            </div>
          </div>
        </a>
        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="material-symbols-outlined text-slate-600 text-2xl">payments</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-slate-900">대금 지급</div>
              <div class="text-sm text-slate-500 mt-1">검사 합격 후 지급</div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-red-50 border border-red-200 rounded-xl p-4">
        <div class="flex items-start gap-3">
          <span class="material-symbols-outlined text-red-600 shrink-0">report</span>
          <p class="text-sm text-red-900"><strong>체크포인트</strong>: 계약보증금은 <strong>매년 재납부</strong>해야 하며, 기한 내 미납 시 계약 해지 사유가 됩니다. 최종 연도에는 <strong>하자보수보증금</strong>도 함께 납부해야 합니다.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 체크포인트 3컬럼 -->
  <div class="grid md:grid-cols-3 gap-4">
    <div class="card p-5 border-l-4 border-red-500">
      <h5 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-red-600">cancel</span>
        절대 금지
      </h5>
      <ul class="space-y-2 text-sm text-slate-700">
        <li class="flex items-start gap-2">
          <span class="text-red-600 mt-0.5">•</span>
          <span>예산 미확보 상태에서 차년도 계약 갱신</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-red-600 mt-0.5">•</span>
          <span>사업 목적 변경 후 설계변경으로 처리</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-red-600 mt-0.5">•</span>
          <span>계약보증금 기한 경과 후 재납부 요구</span>
        </li>
      </ul>
    </div>
    <div class="card p-5 border-l-4 border-emerald-500">
      <h5 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-emerald-600">verified</span>
        필수 서류
      </h5>
      <ul class="space-y-2 text-sm text-slate-700">
        <li class="flex items-start gap-2">
          <span class="text-emerald-600 mt-0.5">•</span>
          <span>최초 계약서 (총 계약금액·연차별 금액 명시)</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-emerald-600 mt-0.5">•</span>
          <span>예산 요구서 (7~8월 제출, 차년도 소요액)</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-emerald-600 mt-0.5">•</span>
          <span>계약보증금 납부 증명 (매년 재납부 필수)</span>
        </li>
      </ul>
    </div>
    <div class="card p-5 border-l-4 border-blue-500">
      <h5 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-blue-600">tips_and_updates</span>
        실무 팁
      </h5>
      <ul class="space-y-2 text-sm text-slate-700">
        <li class="flex items-start gap-2">
          <span class="text-blue-600 mt-0.5">•</span>
          <span>예산 요구 시 물가변동률 미리 반영</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-blue-600 mt-0.5">•</span>
          <span>계속비 신청으로 예산 확보 안정성 확보</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-blue-600 mt-0.5">•</span>
          <span>최종 연도 하자보수보증금 별도 준비</span>
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- 공문/양식 생성도구 팝업 -->
<div id="docPopup" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="hideDocPopup(event)">
  <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden" onclick="event.stopPropagation()">
    <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-emerald-600 text-white px-6 py-4 flex items-center justify-between z-10">
      <h3 class="text-xl font-bold" id="popupTitle">공문/양식 생성 도구</h3>
      <button onclick="hideDocPopup()" class="w-8 h-8 rounded-lg hover:bg-white/20 flex items-center justify-center transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="p-6 overflow-y-auto max-h-[calc(85vh-80px)]" id="popupContent">
      <!-- 동적 콘텐츠 -->
    </div>
  </div>
</div>

<style>
.doc-tool-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  color: white;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
}
.doc-tool-badge:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
}
</style>

<script>
var docPopupData = {
  step2: {
    title: '예산 확보 단계 공문/양식',
    groups: [
      {
        label: '필수 도구',
        icon: 'auto_awesome',
        color: '#4f46e5',
        items: [
          {
            name: '소요예산 추정기',
            desc: '차년도 소요예산 자동 계산 (물가변동 반영)',
            icon: 'savings',
            color: '#4f46e5',
            tool: '<%= budget_estimator_path %>',
            featured: true
          }
        ]
      },
      {
        label: '필수 서류',
        icon: 'verified',
        color: '#dc2626',
        items: [
          {
            name: '예산 요구서',
            desc: '차년도 소요예산 및 사업 내용 명시 (7~8월 제출)',
            icon: 'description',
            color: '#dc2626'
          },
          {
            name: '사업계획서',
            desc: '연차별 추진 계획 및 기대효과',
            icon: 'assignment',
            color: '#dc2626',
            tool: '<%= project_plan_path %>'
          },
          {
            name: '계속비 신청서',
            desc: '5년 이내 총 사업비 및 연차별 소요액',
            icon: 'calendar_today',
            color: '#dc2626'
          }
        ]
      },
      {
        label: '검토용',
        icon: 'fact_check',
        color: '#64748b',
        items: [
          {
            name: '계약서류 체크리스트',
            desc: '장기계속계약 특수조건 확인',
            icon: 'checklist',
            color: '#64748b',
            tool: '<%= contract_documents_path %>'
          }
        ]
      }
    ]
  }
};

function showDocPopup(step) {
  var data = docPopupData[step];
  if (!data) return;

  document.getElementById('popupTitle').textContent = data.title;

  var html = '';
  data.groups.forEach(function(group) {
    html += '<div class="mb-6 last:mb-0">';
    html += '<h4 class="font-bold text-slate-900 mb-3 flex items-center gap-2">';
    html += '<span class="material-symbols-outlined" style="color:' + group.color + '">' + group.icon + '</span>';
    html += group.label;
    html += '</h4>';
    html += '<div class="grid sm:grid-cols-2 gap-3">';

    group.items.forEach(function(item) {
      var tag = item.tool ? 'a' : 'div';
      var href = item.tool ? ' href="' + item.tool + '"' : '';
      var hoverClass = item.tool ? ' hover:shadow-lg hover:scale-[1.02]' : '';

      html += '<' + tag + href + ' class="block p-4 bg-white border-2 border-slate-200 rounded-xl transition-all' + hoverClass + '">';
      html += '<div class="flex items-start gap-3">';
      html += '<span class="material-symbols-outlined text-2xl" style="color:' + item.color + '">' + item.icon + '</span>';
      html += '<div class="flex-1 min-w-0">';
      html += '<div class="font-semibold text-slate-900 flex items-center gap-2">';
      html += item.name;
      if (item.featured) {
        html += '<span class="px-2 py-0.5 bg-indigo-600 text-white text-xs rounded-full">핵심</span>';
      }
      html += '</div>';
      html += '<div class="text-sm text-slate-500 mt-1">' + item.desc + '</div>';
      html += '</div>';
      html += '</div>';
      html += '</' + tag + '>';
    });

    html += '</div></div>';
  });

  document.getElementById('popupContent').innerHTML = html;
  document.getElementById('docPopup').classList.remove('hidden');
  document.getElementById('docPopup').classList.add('flex');
}

function hideDocPopup(event) {
  if (!event || event.target.id === 'docPopup' || event.currentTarget.tagName === 'BUTTON') {
    document.getElementById('docPopup').classList.add('hidden');
    document.getElementById('docPopup').classList.remove('flex');
  }
}
</script>
