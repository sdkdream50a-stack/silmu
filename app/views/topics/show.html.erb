<%# 주제 상세 페이지 - 프리미엄 디자인 시스템 %>

<%# JSON-LD 구조화 데이터 %>
<% content_for :head do %>
  <%= json_ld({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "#{@topic.name} — 법령·절차·실무 가이드",
    "description": @topic.summary,
    "author": { "@type": "Organization", "name": "실무.kr" },
    "publisher": { "@type": "Organization", "name": "실무.kr", "logo": { "@type": "ImageObject", "url": "https://silmu.kr/icon.png" } },
    "url": canonical_url,
    "image": "https://silmu.kr/og-image.png",
    "inLanguage": "ko",
    "dateModified": @topic.updated_at.iso8601,
    "mainEntityOfPage": canonical_url
  }) %>
  <%= json_ld({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "홈", "item": "https://silmu.kr" },
      { "@type": "ListItem", "position": 2, "name": @topic.category_name, "item": "https://silmu.kr/guides" },
      { "@type": "ListItem", "position": 3, "name": @topic.name, "item": canonical_url }
    ]
  }) %>
  <% if @topic.faq_list.present? %>
    <%= json_ld({
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": @topic.faq_list.map { |faq|
        { "@type": "Question", "name": faq["question"], "acceptedAnswer": { "@type": "Answer", "text": faq["answer"] } }
      }
    }) %>
  <% end %>
<% end %>

<!-- 페이지 헤더 -->
<section class="gradient-premium text-white py-12 lg:py-16">
  <div class="container-wide">
    <!-- 브레드크럼 -->
    <div class="flex items-center gap-2 text-slate-300 text-sm mb-6">
      <%= link_to root_path, class: "hover:text-white transition-colors flex items-center gap-1" do %>
        <span class="material-symbols-outlined text-sm">home</span>
        홈
      <% end %>
      <span class="material-symbols-outlined text-sm">chevron_right</span>
      <span><%= @topic.category_name %></span>
      <span class="material-symbols-outlined text-sm">chevron_right</span>
      <span class="text-white font-medium"><%= @topic.name %></span>
    </div>

    <div class="lg:flex lg:items-start lg:justify-between gap-8">
      <div class="flex-1">
        <div class="flex items-start gap-5 mb-4">
          <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
            <span class="material-symbols-outlined text-4xl text-white">gavel</span>
          </div>
          <div>
            <h1 class="text-3xl lg:text-4xl font-bold tracking-tight"><%= @topic.name %></h1>
            <p class="text-slate-200 mt-2 text-lg"><%= @topic.summary %></p>
          </div>
        </div>

        <!-- 키워드 태그 (서브토픽 링크) -->
        <div class="flex flex-wrap gap-2 mt-6">
          <% if @parent_topic.present? %>
            <%# 서브토픽인 경우: 부모 토픽과 형제 토픽들 표시 %>
            <%= link_to topic_path(@parent_topic.slug),
                class: "px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-full text-sm text-white font-medium transition-all duration-200 flex items-center gap-1.5 border border-white/20" do %>
              <span class="material-symbols-outlined text-sm">arrow_back</span>
              <%= @parent_topic.name %>
            <% end %>
            <% @sibling_topics.each do |sibling| %>
              <%= link_to topic_path(sibling.slug),
                  class: "px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full text-sm text-white transition-all duration-200 flex items-center gap-1.5 border border-white/10 hover:border-white/20" do %>
                <span class="material-symbols-outlined text-sm">tag</span>
                <%= sibling.name %>
              <% end %>
            <% end %>
          <% else %>
            <%# 부모 토픽인 경우: 서브토픽 또는 키워드 검색 링크 %>
            <% @keyword_topic_map.each do |keyword, matching_topic| %>
              <% if matching_topic %>
                <%= link_to topic_path(matching_topic.slug),
                    class: "px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full text-sm text-white transition-all duration-200 flex items-center gap-1.5 border border-white/10 hover:border-white/20" do %>
                  <span class="material-symbols-outlined text-sm">tag</span>
                  <%= keyword %>
                <% end %>
              <% else %>
                <span class="px-4 py-2 bg-white/5 rounded-full text-sm text-white/50 flex items-center gap-1.5 border border-white/5">
                  <span class="material-symbols-outlined text-sm">tag</span>
                  <%= keyword %>
                </span>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- 소셜 공유 버튼 -->
      <div class="mt-6 lg:mt-0">
        <%= render 'shared/social_share',
                   title: "#{@topic.name} — 실무.kr",
                   description: @topic.summary,
                   url: canonical_url,
                   class: "flex-wrap lg:flex-nowrap" %>
      </div>
    </div>
  </div>
</section>

<!-- 핵심 Q&A 미리보기 (QuickbackClick 개선) -->
<% if @topic.faq_list.any? %>
<section class="bg-amber-50 border-b border-amber-100">
  <div class="container-wide py-4">
    <div class="flex items-start gap-3">
      <span class="material-symbols-outlined text-amber-500 text-xl mt-0.5 shrink-0">help</span>
      <div class="flex-1 min-w-0">
        <p class="text-xs font-semibold text-amber-700 uppercase tracking-wide mb-2">이 페이지에서 알 수 있는 것</p>
        <div class="flex flex-wrap gap-x-6 gap-y-1">
          <% @topic.faq_list.first(4).each do |faq| %>
            <span class="text-sm text-amber-900 flex items-center gap-1">
              <span class="text-amber-500">✓</span>
              <%= faq['question'].truncate(35) %>
            </span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</section>
<% end %>

<!-- 탭 네비게이션 -->
<section class="bg-white/80 backdrop-blur-xl border-b border-gray-100 sticky top-16 z-40 shadow-soft">
  <div class="container-wide">
    <nav class="flex gap-1 overflow-x-auto py-3 -mx-4 px-4 scrollbar-hide" id="topic-tabs">
      <button onclick="showTab('flowchart')" data-tab="flowchart"
              class="tab-btn px-3 py-2 bg-slate-800 text-white rounded-lg text-sm font-semibold whitespace-nowrap flex items-center gap-1.5 transition-all duration-200 shadow-md">
        <span class="material-symbols-outlined" style="font-size:18px">account_tree</span>
        실무흐름도
      </button>
      <button onclick="showTab('law')" data-tab="law"
              class="tab-btn px-3 py-2 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-all duration-200">
        <span class="material-symbols-outlined" style="font-size:18px">balance</span>
        법령 3단 비교
      </button>
      <button onclick="showTab('regulation')" data-tab="regulation"
              class="tab-btn px-3 py-2 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-all duration-200">
        <span class="material-symbols-outlined" style="font-size:18px">description</span>
        예규/지침
      </button>
      <button onclick="showTab('interpretation')" data-tab="interpretation"
              class="tab-btn px-3 py-2 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-all duration-200">
        <span class="material-symbols-outlined" style="font-size:18px">policy</span>
        유권해석
      </button>
      <button onclick="showTab('audit')" data-tab="audit"
              class="tab-btn px-3 py-2 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-all duration-200">
        <span class="material-symbols-outlined" style="font-size:18px">search</span>
        감사사례
      </button>
      <button onclick="showTab('qa')" data-tab="qa"
              class="tab-btn px-3 py-2 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-all duration-200">
        <span class="material-symbols-outlined" style="font-size:18px">forum</span>
        질의답변
      </button>
      <button onclick="showTab('tips')" data-tab="tips"
              class="tab-btn px-3 py-2 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-all duration-200">
        <span class="material-symbols-outlined" style="font-size:18px">lightbulb</span>
        실무주의
      </button>
      <button onclick="showTab('forms')" data-tab="forms"
              class="tab-btn px-3 py-2 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-lg text-sm font-medium whitespace-nowrap flex items-center gap-1.5 transition-all duration-200">
        <span class="material-symbols-outlined" style="font-size:18px">draft</span>
        서식/양식
      </button>
    </nav>
  </div>
</section>

<!-- 메인 콘텐츠 -->
<section class="section py-10">
  <div class="container-wide">
        <div class="lg:flex lg:gap-10">
      <!-- 메인 콘텐츠 영역 -->
      <div class="flex-1 min-w-0">
        <!-- 실무흐름도 -->
        <div class="tab-panel active" data-tab="flowchart">
          <% if @topic.slug == 'price-negotiation' %>
            <%= render 'topics/flowcharts/price_negotiation', topic: @topic %>
          <% elsif @topic.slug == 'private-contract-limit' || @topic.slug == 'private-contract' || @topic.slug == 'private-contract-amount' %>
            <%= render 'topics/flowcharts/private_contract', topic: @topic %>
          <% elsif @topic.slug == 'emergency-contract' %>
            <%= render 'topics/flowcharts/emergency_contract', topic: @topic %>
          <% elsif @topic.slug == 'dual-quote' %>
            <%= render 'topics/flowcharts/dual_quote', topic: @topic %>
          <% elsif @topic.slug == 'single-quote' %>
            <%= render 'topics/flowcharts/single_quote', topic: @topic %>
          <% elsif @topic.slug == 'travel-expense' %>
            <%= render 'topics/flowcharts/travel_expense', topic: @topic %>
          <% elsif @topic.slug == 'year-end-settlement' %>
            <%= render 'topics/flowcharts/year_end_settlement', topic: @topic %>
          <% elsif @topic.slug == 'budget-carryover' %>
            <%= render 'topics/flowcharts/budget_carryover', topic: @topic %>
          <% elsif @topic.slug == 'late-penalty' %>
            <%= render 'topics/flowcharts/late_penalty', topic: @topic %>
          <% elsif @topic.slug == 'contract-guarantee-deposit' %>
            <%= render 'topics/flowcharts/contract_guarantee_deposit', topic: @topic %>
          <% elsif @topic.slug == 'subcontract' %>
            <%= render 'topics/flowcharts/subcontract', topic: @topic %>
          <% elsif @topic.slug == 'bid-announcement' %>
            <%= render 'topics/flowcharts/bid_announcement', topic: @topic %>
          <% elsif @topic.slug == 'bidding' %>
            <%= render 'topics/flowcharts/bidding', topic: @topic %>
          <% elsif @topic.slug == 'bid-qualification' %>
            <%= render 'topics/flowcharts/bid_qualification', topic: @topic %>
          <% elsif @topic.slug == 'long-term-contract' %>
            <%= render 'topics/flowcharts/long_term_contract', topic: @topic %>
          <% elsif @topic.slug == 'multiple-price' %>
            <%= render 'topics/flowcharts/multiple_price', topic: @topic %>
          <% elsif @topic.slug == 'spec-price-split-bid' %>
            <%= render 'topics/flowcharts/spec_price_split_bid', topic: @topic %>
          <% elsif @topic.slug == 'advance-payment' %>
            <%= render 'topics/flowcharts/advance_payment', topic: @topic %>
          <% elsif @topic.slug == 'unit-price-contract' %>
            <%= render 'topics/flowcharts/unit_price_contract', topic: @topic %>
          <% elsif @topic.slug == 'performance-guarantee' %>
            <%= render 'topics/flowcharts/performance_guarantee', topic: @topic %>
          <% elsif @topic.slug == 'e-bidding' %>
            <%= render 'topics/flowcharts/e_bidding', topic: @topic %>
          <% elsif @topic.slug == 'estimated-price' %>
            <%= render 'topics/flowcharts/estimated_price', topic: @topic %>
          <% elsif @topic.slug == 'contract-execution' %>
            <%= render 'topics/flowcharts/contract_execution', topic: @topic %>
          <% elsif @topic.slug == 'inspection' %>
            <%= render 'topics/flowcharts/inspection', topic: @topic %>
          <% elsif @topic.slug == 'payment' %>
            <%= render 'topics/flowcharts/payment', topic: @topic %>
          <% elsif @topic.slug == 'design-change' %>
            <%= render 'topics/flowcharts/design_change', topic: @topic %>
          <% elsif @topic.slug == 'price-escalation' %>
            <%= render 'topics/flowcharts/price_escalation', topic: @topic %>
          <% elsif @topic.slug == 'contract-termination' %>
            <%= render 'topics/flowcharts/contract_termination', topic: @topic %>
          <% elsif @topic.slug == 'joint-contract' %>
            <%= render 'topics/flowcharts/joint_contract', topic: @topic %>
          <% elsif @topic.slug == 'defect-warranty' %>
            <%= render 'topics/flowcharts/defect_warranty', topic: @topic %>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">account_tree</span>
              <p class="text-slate-500 text-lg">실무흐름도가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 법령 3단 비교 -->
        <% cache [@topic, "law_tabs", @topic.updated_at.to_i] do %>
        <div class="tab-panel" data-tab="law">
          <% if @topic.has_law_content? %>
            <!-- 캐스케이드 카드 레이아웃 -->
            <div class="law-cascade-container overflow-x-auto">
              <div class="flex items-start relative flex-nowrap" style="min-width: 600px; gap: 4px;">
                <!-- 법률 (제일 왼쪽) -->
                <div class="law-card-stack" style="flex: 1; min-width: 0;" data-card="law">
                  <div class="law-card group overflow-hidden rounded-2xl border-2 border-indigo-200 bg-white shadow-xl cursor-pointer transition-all duration-500 hover:shadow-2xl" onclick="expandLawCard('law')">
                    <!-- 헤더 -->
                    <div class="relative px-6 py-5 overflow-hidden" style="background-color: #6366f1;">
                      <div class="relative flex items-center justify-between">
                        <div class="flex items-center gap-4">
                          <div class="w-14 h-14 rounded-2xl flex items-center justify-center border shadow-lg group-hover:scale-110 transition-transform duration-300" style="background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3);">
                            <span class="text-white font-black text-2xl">법</span>
                          </div>
                          <div>
                            <h3 class="font-bold text-white text-xl tracking-tight">법률</h3>
                            <p class="text-sm font-medium" style="color: rgba(255,255,255,0.8);"><%= case @topic.slug
                              when 'travel-expense' then '지방공무원법'
                              when 'budget-carryover' then '지방재정법'
                              when 'year-end-settlement' then '소득세법'
                              else '국가계약법 / 지방계약법'
                            end %></p>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="px-3 py-1 rounded-full text-white text-xs font-semibold" style="background-color: rgba(255,255,255,0.2);">최상위</span>
                          <span class="material-symbols-outlined card-expand-icon transition-transform duration-300" style="color: rgba(255,255,255,0.8);">keyboard_arrow_down</span>
                        </div>
                      </div>
                    </div>
                    <!-- 콘텐츠 -->
                    <div class="p-6 law-card-content bg-white">
                      <div class="legal-content">
                        <%= render_legal_content(@topic.law_content) %>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 시행령 (중간) -->
                <div class="law-card-stack" style="flex-shrink: 0;" data-card="decree">
                  <div class="law-card group overflow-hidden rounded-2xl border-2 border-emerald-200 bg-white shadow-xl cursor-pointer transition-all duration-500 hover:shadow-2xl" onclick="expandLawCard('decree')">
                    <!-- 헤더 -->
                    <div class="relative px-6 py-5 overflow-hidden" style="background-color: #3f9142;">
                      <div class="relative flex items-center justify-between">
                        <div class="flex items-center gap-4">
                          <div class="w-14 h-14 rounded-2xl flex items-center justify-center border shadow-lg group-hover:scale-110 transition-transform duration-300" style="background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3);">
                            <span class="text-white font-black text-2xl">령</span>
                          </div>
                          <div>
                            <h3 class="font-bold text-white text-xl tracking-tight">시행령</h3>
                            <p class="text-sm font-medium" style="color: rgba(255,255,255,0.8);"><%= case @topic.slug
                              when 'travel-expense' then '지방공무원 여비 규정'
                              when 'budget-carryover' then '지방재정법 시행령'
                              when 'year-end-settlement' then '소득세법 시행령'
                              else '대통령령'
                            end %></p>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="px-3 py-1 rounded-full text-white text-xs font-semibold" style="background-color: rgba(255,255,255,0.2);">세부사항</span>
                          <span class="material-symbols-outlined card-expand-icon transition-transform duration-300" style="color: rgba(255,255,255,0.8);">keyboard_arrow_down</span>
                        </div>
                      </div>
                    </div>
                    <!-- 콘텐츠 -->
                    <div class="p-6 law-card-content bg-white">
                      <div class="legal-content">
                        <%= render_legal_content(@topic.decree_content) %>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 시행규칙 (제일 오른쪽) -->
                <div class="law-card-stack" style="flex-shrink: 0;" data-card="rule">
                  <div class="law-card group overflow-hidden rounded-2xl border-2 border-amber-200 bg-white shadow-xl cursor-pointer transition-all duration-500 hover:shadow-2xl" onclick="expandLawCard('rule')">
                    <!-- 헤더 -->
                    <div class="relative px-6 py-5 overflow-hidden" style="background-color: #f59e0b;">
                      <div class="relative flex items-center justify-between">
                        <div class="flex items-center gap-4">
                          <div class="w-14 h-14 rounded-2xl flex items-center justify-center border shadow-lg group-hover:scale-110 transition-transform duration-300" style="background-color: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3);">
                            <span class="text-white font-black text-2xl">칙</span>
                          </div>
                          <div>
                            <h3 class="font-bold text-white text-xl tracking-tight">시행규칙</h3>
                            <p class="text-sm font-medium" style="color: rgba(255,255,255,0.8);"><%= case @topic.slug
                              when 'travel-expense' then '여비 규정 별표'
                              when 'budget-carryover' then '예산편성 기준'
                              when 'year-end-settlement' then '연말정산 지침'
                              else '부령 / 예규'
                            end %></p>
                          </div>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="px-3 py-1 rounded-full text-white text-xs font-semibold" style="background-color: rgba(255,255,255,0.2);">실무기준</span>
                          <span class="material-symbols-outlined card-expand-icon transition-transform duration-300" style="color: rgba(255,255,255,0.8);">keyboard_arrow_down</span>
                        </div>
                      </div>
                    </div>
                    <!-- 콘텐츠 -->
                    <div class="p-6 law-card-content bg-white">
                      <div class="legal-content">
                        <%= render_legal_content(@topic.rule_content) %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 하단 안내 -->
              <div class="mt-6 flex items-center justify-center gap-2 text-sm text-slate-500">
                <span class="material-symbols-outlined text-lg">touch_app</span>
                카드를 클릭하면 전체 내용을 볼 수 있습니다
              </div>

            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">description</span>
              <p class="text-slate-500 text-lg">법령 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>
        <% end %>

        <!-- 예규/지침 -->
        <div class="tab-panel" data-tab="regulation" id="panel-regulation">
          <% if @topic.regulation_content.present? %>
            <div class="card p-6 lg:p-8">
              <div class="legal-content">
                <%= render_legal_content(@topic.regulation_content) %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">description</span>
              <p class="text-slate-500 text-lg">예규/지침 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 유권해석 -->
        <div class="tab-panel" data-tab="interpretation" id="panel-interpretation">
          <% if @topic.interpretation_content.present? %>
            <div class="card p-6 lg:p-8">
              <div class="legal-content">
                <%= render_legal_content(@topic.interpretation_content) %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">policy</span>
              <p class="text-slate-500 text-lg">유권해석 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 감사사례 -->
        <div class="tab-panel" data-tab="audit" id="panel-audit">
          <% if @related_audit_cases.any? %>
            <div class="space-y-4">
              <% @related_audit_cases.each do |ac| %>
                <%= link_to audit_case_path(slug: ac.slug), class: "block card card-hover p-5 lg:p-6 group" do %>
                  <div class="flex items-start justify-between mb-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-semibold bg-red-50 text-red-700"><%= ac.category %></span>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
                      <%= case ac.severity
                          when '경미' then 'bg-amber-50 text-amber-700'
                          when '보통' then 'bg-orange-50 text-orange-700'
                          when '중대' then 'bg-red-100 text-red-800'
                          else 'bg-gray-50 text-gray-600'
                          end %>">
                      <%= ac.severity %>
                    </span>
                  </div>
                  <h3 class="text-base font-bold text-slate-900 mb-2 group-hover:text-red-600 transition-colors"><%= ac.title %></h3>
                  <p class="text-slate-600 text-sm mb-3 leading-relaxed line-clamp-2"><%= ac.issue.truncate(150) %></p>
                  <div class="flex items-center justify-between">
                    <span class="text-xs text-slate-400 flex items-center gap-1">
                      <span class="material-symbols-outlined text-sm">gavel</span>
                      <%= ac.legal_basis %>
                    </span>
                    <span class="text-xs text-red-500 font-medium flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      상세 보기
                      <span class="material-symbols-outlined text-sm">arrow_forward</span>
                    </span>
                  </div>
                <% end %>
              <% end %>
            </div>
            <div class="mt-6 text-center">
              <%= link_to audit_cases_path, class: "inline-flex items-center gap-2 px-6 py-3 bg-red-50 text-red-700 rounded-xl font-semibold hover:bg-red-100 transition-colors" do %>
                <span class="material-symbols-outlined text-lg">folder_open</span>
                전체 감사사례 <%= @audit_case_total %>건 보기
              <% end %>
            </div>
          <% elsif @topic.audit_cases.present? %>
            <div class="card p-6 lg:p-8">
              <div class="legal-content">
                <%= render_legal_content(@topic.audit_cases) %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">search</span>
              <p class="text-slate-500 text-lg">감사사례 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 질의답변 -->
        <div class="tab-panel" data-tab="qa" id="panel-qa">
          <% if @topic.qa_content.present? %>
            <div class="card p-6 lg:p-8">
              <div class="legal-content">
                <%= render_legal_content(@topic.qa_content) %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">forum</span>
              <p class="text-slate-500 text-lg">질의답변 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 실무주의 -->
        <div class="tab-panel" data-tab="tips">
          <% if @topic.practical_tips.present? %>
            <div class="card p-6 lg:p-8">
              <div class="legal-content">
                <%= render_legal_content(@topic.practical_tips) %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">lightbulb</span>
              <p class="text-slate-500 text-lg">실무주의사항이 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 서식/양식 -->
        <div class="tab-panel" data-tab="forms">
          <% if @topic.slug == 'travel-expense' %>
            <!-- 여비 관련 서식 -->
            <div class="mb-10">
              <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                  <div class="icon-container icon-container-sm bg-indigo-100">
                    <span class="material-symbols-outlined text-indigo-600">folder_open</span>
                  </div>
                  여비 관련 서식
                </h3>
              </div>

              <div class="grid sm:grid-cols-2 gap-4">
                <% [
                  { title: "출장명령서", desc: "출장 전 결재용 필수 서류", badge: "출장 전 필수", color: "point" },
                  { title: "출장 복명서", desc: "출장 결과 보고 서류", badge: "출장 후 7일 이내", color: "forest" },
                  { title: "여비 정산서", desc: "여비 청구 및 정산 서류", badge: "증빙 첨부", color: "warm" },
                  { title: "여비 개산급 신청서", desc: "여비 선지급 신청 서류", badge: "선택사항", color: "navy" }
                ].each do |form| %>
                  <div class="group card card-interactive p-5">
                    <div class="flex items-start gap-4">
                      <div class="icon-container icon-container-md bg-<%= form[:color] %>-100">
                        <span class="material-symbols-outlined text-2xl text-<%= form[:color] %>-600">description</span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-slate-900"><%= form[:title] %></h4>
                        <p class="text-sm text-slate-500 mt-1"><%= form[:desc] %></p>
                        <span class="badge badge-<%= form[:color] %> mt-2"><%= form[:badge] %></span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- 실무 도구 -->
            <div class="mb-10">
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-indigo-100">
                  <span class="material-symbols-outlined text-indigo-600">construction</span>
                </div>
                실무 도구
              </h3>

              <%= link_to travel_calculator_path,
                   class: "group block bg-gradient-to-br from-indigo-50 to-slate-50 rounded-2xl border-2 border-indigo-200 p-6 hover:border-indigo-400 hover:shadow-strong transition-all duration-300" do %>
                <div class="flex items-start gap-5">
                  <div class="w-16 h-16 gradient-indigo rounded-2xl flex items-center justify-center shadow-lg shrink-0">
                    <span class="material-symbols-outlined text-3xl text-white">calculate</span>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <h4 class="text-xl font-bold text-slate-900">여비 계산기</h4>
                      <span class="badge badge-indigo">자동계산</span>
                    </div>
                    <p class="text-slate-600">출장 일정과 경로를 입력하면 일비, 숙박비, 식비를 자동으로 계산해 드립니다</p>
                    <div class="mt-3 flex flex-wrap gap-2">
                      <span class="badge badge-indigo">국내출장</span>
                      <span class="badge badge-slate">해외출장</span>
                      <span class="badge badge-emerald">2025년 기준 (현행)</span>
                    </div>
                  </div>
                  <span class="material-symbols-outlined text-2xl text-indigo-400 group-hover:translate-x-1 transition-transform">arrow_forward</span>
                </div>
              <% end %>
            </div>

            <!-- 공식 자료 -->
            <div class="mb-10">
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-slate-100">
                  <span class="material-symbols-outlined text-slate-600">link</span>
                </div>
                공식 자료
              </h3>

              <div class="bg-surface-100 rounded-2xl p-4 space-y-3">
                <% [
                  { title: "국가법령정보센터", desc: "지방공무원 여비 규정 전문", icon: "balance", color: "point", url: "https://www.law.go.kr/법령/지방공무원여비규정" },
                  { title: "행정안전부", desc: "공무원 여비 업무 처리 지침", icon: "apartment", color: "forest", url: "https://www.mois.go.kr" },
                  { title: "기획재정부", desc: "공무원 국외여비 지급 규정", icon: "public", color: "navy", url: "https://www.moef.go.kr" }
                ].each do |link| %>
                  <a href="<%= link[:url] %>" target="_blank" rel="noopener"
                     class="flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 hover:border-<%= link[:color] %>-300 hover:shadow-medium transition-all duration-200">
                    <div class="icon-container icon-container-sm bg-<%= link[:color] %>-600">
                      <span class="material-symbols-outlined text-white"><%= link[:icon] %></span>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold text-slate-900"><%= link[:title] %></div>
                      <div class="text-sm text-slate-500 truncate"><%= link[:desc] %></div>
                    </div>
                    <span class="material-symbols-outlined text-slate-300">open_in_new</span>
                  </a>
                <% end %>
              </div>
            </div>

            <!-- 여비 지급 기준 요약 -->
            <div>
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-indigo-100">
                  <span class="material-symbols-outlined text-indigo-600">payments</span>
                </div>
                여비 지급 기준 요약 <span class="text-sm font-normal text-slate-500">(2025년 개정, 현행)</span>
              </h3>

              <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-6">
                <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div class="bg-white rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-indigo-600">25,000원</div>
                    <div class="text-sm text-slate-600 mt-1">일비 (1일)</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-emerald-600">25,000원</div>
                    <div class="text-sm text-slate-600 mt-1">식비 (1일)</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-amber-600">100,000원</div>
                    <div class="text-sm text-slate-600 mt-1">숙박비 상한 (서울)</div>
                  </div>
                  <div class="bg-white rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-slate-600">실비</div>
                    <div class="text-sm text-slate-600 mt-1">교통비 (영수증)</div>
                  </div>
                </div>
              </div>
            </div>

          <% elsif @topic.slug == 'year-end-settlement' %>
            <!-- 연말정산 관련 서식 -->
            <div class="mb-10">
              <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                  <div class="icon-container icon-container-sm bg-indigo-100">
                    <span class="material-symbols-outlined text-indigo-600">folder_open</span>
                  </div>
                  연말정산 관련 서식
                </h3>
              </div>

              <div class="grid sm:grid-cols-2 gap-4">
                <% [
                  { title: "소득·세액공제 신고서", desc: "근로자가 작성하는 기본 신고서", badge: "필수", color: "point" },
                  { title: "부양가족 변동신고서", desc: "부양가족 추가/변경 시 제출", badge: "변동 시", color: "forest" },
                  { title: "주택자금 공제신청서", desc: "주택청약, 주택임차 공제 신청", badge: "해당자", color: "warm" },
                  { title: "원천징수영수증", desc: "연말정산 결과 확인서", badge: "결과", color: "navy" }
                ].each do |form| %>
                  <div class="group card card-interactive p-5">
                    <div class="flex items-start gap-4">
                      <div class="icon-container icon-container-md bg-<%= form[:color] %>-100">
                        <span class="material-symbols-outlined text-2xl text-<%= form[:color] %>-600">description</span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-slate-900"><%= form[:title] %></h4>
                        <p class="text-sm text-slate-500 mt-1"><%= form[:desc] %></p>
                        <span class="badge badge-<%= form[:color] %> mt-2"><%= form[:badge] %></span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- 공식 자료 -->
            <div class="mb-10">
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-slate-100">
                  <span class="material-symbols-outlined text-slate-600">link</span>
                </div>
                공식 자료
              </h3>

              <div class="bg-surface-100 rounded-2xl p-4 space-y-3">
                <% [
                  { title: "국세청 홈택스", desc: "연말정산 간소화 서비스", icon: "balance", color: "point", url: "https://www.hometax.go.kr" },
                  { title: "국세청 연말정산 안내", desc: "연말정산 종합 안내 페이지", icon: "info", color: "forest", url: "https://www.nts.go.kr/nts/cm/cntnts/cntntsView.do?mi=2304&cntntsId=238938" },
                  { title: "국가법령정보센터", desc: "소득세법 및 시행령", icon: "gavel", color: "navy", url: "https://www.law.go.kr/법령/소득세법" }
                ].each do |link| %>
                  <a href="<%= link[:url] %>" target="_blank" rel="noopener"
                     class="flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 hover:border-<%= link[:color] %>-300 hover:shadow-medium transition-all duration-200">
                    <div class="icon-container icon-container-sm bg-<%= link[:color] %>-600">
                      <span class="material-symbols-outlined text-white"><%= link[:icon] %></span>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold text-slate-900"><%= link[:title] %></div>
                      <div class="text-sm text-slate-500 truncate"><%= link[:desc] %></div>
                    </div>
                    <span class="material-symbols-outlined text-slate-300">open_in_new</span>
                  </a>
                <% end %>
              </div>
            </div>

          <% elsif @topic.slug == 'budget-carryover' %>
            <!-- 예산이월 관련 서식 -->
            <div class="mb-10">
              <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                  <div class="icon-container icon-container-sm bg-indigo-100">
                    <span class="material-symbols-outlined text-indigo-600">folder_open</span>
                  </div>
                  예산이월 관련 서식
                </h3>
              </div>

              <div class="grid sm:grid-cols-2 gap-4">
                <% [
                  { title: "이월 사유서", desc: "사고이월 사유 및 증빙 자료", badge: "사고이월 필수", color: "point" },
                  { title: "이월예산 조서", desc: "이월 금액 내역 및 산출 근거", badge: "금액 산출", color: "forest" },
                  { title: "이월예산 집행계획서", desc: "다음연도 집행 계획", badge: "계획", color: "warm" },
                  { title: "예산집행 현황표", desc: "당해연도 예산 집행 현황", badge: "현황", color: "navy" }
                ].each do |form| %>
                  <div class="group card card-interactive p-5">
                    <div class="flex items-start gap-4">
                      <div class="icon-container icon-container-md bg-<%= form[:color] %>-100">
                        <span class="material-symbols-outlined text-2xl text-<%= form[:color] %>-600">description</span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-slate-900"><%= form[:title] %></h4>
                        <p class="text-sm text-slate-500 mt-1"><%= form[:desc] %></p>
                        <span class="badge badge-<%= form[:color] %> mt-2"><%= form[:badge] %></span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- 공식 자료 -->
            <div class="mb-10">
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-slate-100">
                  <span class="material-symbols-outlined text-slate-600">link</span>
                </div>
                공식 자료
              </h3>

              <div class="bg-surface-100 rounded-2xl p-4 space-y-3">
                <% [
                  { title: "국가법령정보센터", desc: "지방재정법 및 시행령", icon: "balance", color: "point", url: "https://www.law.go.kr/법령/지방재정법" },
                  { title: "행정안전부", desc: "지방재정 운영 매뉴얼", icon: "apartment", color: "forest", url: "https://www.mois.go.kr" },
                  { title: "지방재정365", desc: "지방재정 통합공개시스템", icon: "public", color: "navy", url: "https://lofin.mois.go.kr" }
                ].each do |link| %>
                  <a href="<%= link[:url] %>" target="_blank" rel="noopener"
                     class="flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 hover:border-<%= link[:color] %>-300 hover:shadow-medium transition-all duration-200">
                    <div class="icon-container icon-container-sm bg-<%= link[:color] %>-600">
                      <span class="material-symbols-outlined text-white"><%= link[:icon] %></span>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold text-slate-900"><%= link[:title] %></div>
                      <div class="text-sm text-slate-500 truncate"><%= link[:desc] %></div>
                    </div>
                    <span class="material-symbols-outlined text-slate-300">open_in_new</span>
                  </a>
                <% end %>
              </div>
            </div>

          <% else %>
            <!-- 수의계약 관련 서식 (기본) -->
            <div class="mb-10">
              <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                  <div class="icon-container icon-container-sm bg-indigo-100">
                    <span class="material-symbols-outlined text-indigo-600">folder_open</span>
                  </div>
                  필수 서식
                </h3>
                <%= link_to templates_path, class: "text-sm text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1 transition-colors" do %>
                  전체보기
                  <span class="material-symbols-outlined text-sm">arrow_forward</span>
                <% end %>
              </div>

              <div class="grid sm:grid-cols-2 gap-4">
                <% [
                  { title: "수의계약 사유서", desc: "수의계약 체결 사유를 명시하는 필수 서류", badge: "별지 제5호 서식", color: "point", path: "/forms/수의계약사유서.html" },
                  { title: "견적서", desc: "업체로부터 징구하는 가격 견적서", badge: "1인/2인 이상 견적용", color: "forest", path: "/forms/견적서.html" },
                  { title: "예정가격 조서", desc: "예정가격 산출 근거 문서", badge: "거래실례가격/원가계산", color: "warm", path: "/forms/예정가격조서.html" },
                  { title: "검수조서", desc: "납품/용역 완료 검수 확인서", badge: "대금지급 전 필수", color: "navy", path: "/forms/검수조서.html" }
                ].each do |form| %>
                  <a href="<%= form[:path] %>" target="_blank"
                     class="group card card-interactive p-5">
                    <div class="flex items-start gap-4">
                      <div class="icon-container icon-container-md bg-<%= form[:color] %>-100 group-hover:bg-<%= form[:color] %>-600 transition-colors">
                        <span class="material-symbols-outlined text-2xl text-<%= form[:color] %>-600 group-hover:text-white transition-colors">description</span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-slate-900 group-hover:text-<%= form[:color] %>-600 transition-colors"><%= form[:title] %></h4>
                        <p class="text-sm text-slate-500 mt-1"><%= form[:desc] %></p>
                        <span class="badge badge-<%= form[:color] %> mt-2"><%= form[:badge] %></span>
                      </div>
                      <span class="material-symbols-outlined text-slate-300 group-hover:text-<%= form[:color] %>-600 transition-colors">open_in_new</span>
                    </div>
                  </a>
                <% end %>
              </div>
            </div>

            <!-- 실무 도구 -->
            <div class="mb-10">
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-indigo-100">
                  <span class="material-symbols-outlined text-indigo-600">construction</span>
                </div>
                실무 도구
              </h3>

              <a href="/tools/quote-review" target="_blank"
                 class="group block bg-gradient-to-br from-indigo-50 to-slate-50 rounded-2xl border-2 border-indigo-200 p-6 hover:border-indigo-400 hover:shadow-strong transition-all duration-300">
                <div class="flex items-start gap-5">
                  <div class="w-16 h-16 gradient-indigo rounded-2xl flex items-center justify-center shadow-lg shrink-0">
                    <span class="material-symbols-outlined text-3xl text-white">fact_check</span>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <h4 class="text-xl font-bold text-slate-900">견적서 검토 시스템</h4>
                      <span class="badge badge-indigo">AI</span>
                    </div>
                    <p class="text-slate-600">업체에서 받은 견적서를 분석하여 법규 적합성, 가격 적정성, 주의사항을 리포트로 제공</p>
                    <div class="mt-3 flex flex-wrap gap-2">
                      <span class="badge badge-indigo">자동 분석</span>
                      <span class="badge badge-slate">리포트 생성</span>
                      <span class="badge badge-emerald">법규 검토</span>
                    </div>
                  </div>
                  <span class="material-symbols-outlined text-2xl text-indigo-400 group-hover:translate-x-1 transition-transform">arrow_forward</span>
                </div>
              </a>
            </div>

            <!-- 공식 서식 다운로드 -->
            <div class="mb-10">
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-slate-100">
                  <span class="material-symbols-outlined text-slate-600">link</span>
                </div>
                공식 서식 다운로드
              </h3>

              <div class="bg-surface-100 rounded-2xl p-4 space-y-3">
                <% [
                  { title: "국가법령정보센터", desc: "지방자치단체 입찰 및 계약집행기준 (별지 서식 포함)", icon: "balance", color: "point", url: "https://www.law.go.kr/행정규칙/지방자치단체입찰및계약집행기준" },
                  { title: "행정안전부 지방계약 예규", desc: "계약일반조건, 입찰집행기준 등 HWP 다운로드", icon: "apartment", color: "forest", url: "https://www.mois.go.kr/frt/bbs/type001/commonSelectBoardList.do?bbsId=BBSMSTR_000000000061" },
                  { title: "나라장터 (G2B)", desc: "조달청 수의계약 매뉴얼 및 서식", icon: "public", color: "navy", url: "https://www.g2b.go.kr" }
                ].each do |link| %>
                  <a href="<%= link[:url] %>" target="_blank" rel="noopener"
                     class="flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 hover:border-<%= link[:color] %>-300 hover:shadow-medium transition-all duration-200">
                    <div class="icon-container icon-container-sm bg-<%= link[:color] %>-600">
                      <span class="material-symbols-outlined text-white"><%= link[:icon] %></span>
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold text-slate-900"><%= link[:title] %></div>
                      <div class="text-sm text-slate-500 truncate"><%= link[:desc] %></div>
                    </div>
                    <span class="material-symbols-outlined text-slate-300">open_in_new</span>
                  </a>
                <% end %>
              </div>
            </div>

            <!-- 작성 가이드 -->
            <div>
              <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2 mb-5">
                <div class="icon-container icon-container-sm bg-indigo-100">
                  <span class="material-symbols-outlined text-indigo-600">edit_note</span>
                </div>
                수의계약 사유서 작성 가이드
              </h3>

              <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-6">
                <div class="space-y-6">
                  <div>
                    <h4 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                      <span class="material-symbols-outlined text-indigo-600">checklist</span>
                      필수 기재 항목
                    </h4>
                    <div class="grid sm:grid-cols-2 gap-3">
                      <% [
                        { num: "1", title: "계약 건명", desc: "사업/물품/용역명 명확히 기재" },
                        { num: "2", title: "추정가격", desc: "예정가격 산출 근거 포함" },
                        { num: "3", title: "수의계약 사유", desc: "법적 근거 조항 명시" },
                        { num: "4", title: "계약상대자 선정 사유", desc: "특정 업체 선정 이유" }
                      ].each do |item| %>
                        <div class="flex items-start gap-3 bg-white rounded-xl p-4 shadow-soft">
                          <span class="w-7 h-7 gradient-indigo text-white rounded-full flex items-center justify-center text-sm font-bold shrink-0"><%= item[:num] %></span>
                          <div>
                            <div class="font-semibold text-slate-900"><%= item[:title] %></div>
                            <div class="text-sm text-slate-500"><%= item[:desc] %></div>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </div>

                  <div class="border-t border-indigo-200 pt-6">
                    <h4 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                      <span class="material-symbols-outlined text-indigo-600">code</span>
                      작성 예시
                    </h4>
                    <div class="bg-white rounded-xl p-5 text-sm text-slate-700 font-mono space-y-2 shadow-soft">
                      <p><span class="text-indigo-600 font-semibold">1. 계약건명:</span> 2026년도 사무용품 구매</p>
                      <p><span class="text-indigo-600 font-semibold">2. 추정가격:</span> 15,000,000원 (부가세 포함)</p>
                      <p><span class="text-indigo-600 font-semibold">3. 수의계약 사유:</span></p>
                      <p class="pl-4 text-slate-600">지방계약법 시행령 제25조 제1항 제1호에 따라 추정가격이 물품구매 수의계약 기준금액(2천만원) 이하이므로 수의계약 체결</p>
                      <p><span class="text-indigo-600 font-semibold">4. 계약상대자:</span> (주)OO상사</p>
                      <p class="pl-4 text-slate-600">- 선정사유: 최저가 견적 제출업체</p>
                    </div>
                  </div>

                  <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                      <span class="material-symbols-outlined text-amber-600">warning</span>
                      <div class="text-sm text-amber-800">
                        <strong>주의:</strong> 수의계약 사유서는 반드시 <u>계약 체결 전</u>에 작성하여 결재를 받아야 합니다. 사후 작성은 감사 지적 대상입니다.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- 실무자 해설 (탭 밖, 항상 표시) -->
        <% if @topic.commentary.present? %>
          <div class="mt-12" id="commentary">
            <!-- 섹션 구분선 + 타이틀 -->
            <div class="flex items-center gap-4 mb-6">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center shadow-md">
                  <span class="material-symbols-outlined text-white" style="font-size:20px">rate_review</span>
                </div>
                <div>
                  <h2 class="text-xl font-bold text-slate-900">실무자 해설</h2>
                  <p class="text-xs text-slate-500 mt-0.5">현장 경험 기반 실무 적용 포인트</p>
                </div>
              </div>
              <div class="flex-1 h-px bg-gradient-to-r from-indigo-200 to-transparent"></div>
              <span class="px-3 py-1 bg-indigo-50 text-indigo-600 text-xs font-semibold rounded-full border border-indigo-100">실무 가이드</span>
            </div>

            <!-- 본문 카드 -->
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
              <!-- 상단 강조 띠 -->
              <div class="h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-400"></div>

              <div class="px-6 py-8 commentary-body">
                <%= render_legal_content(@topic.commentary) %>
              </div>

              <!-- 면책 문구 -->
              <div class="mx-6 mb-6 p-4 bg-amber-50 rounded-xl border border-amber-200 flex items-start gap-3">
                <span class="material-symbols-outlined text-amber-500 text-lg mt-0.5 shrink-0">gavel</span>
                <p class="text-xs text-amber-800 leading-relaxed">
                  <strong>참고 정보 안내</strong> — 본 내용은 일반적인 참고 정보이며 법률적 조언이 아닙니다.
                  개별 사안의 적용은 담당 기관(조달청, 감사원) 또는 전문가 상담을 통해 확인하시기 바랍니다.
                </p>
              </div>
            </div>
          </div>
        <% end %>

        <!-- 자주 묻는 질문 -->
        <% if @topic.faq_list.any? %>
          <div class="card p-6 lg:p-8 mt-10">
            <h2 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-3">
              <div class="icon-container icon-container-sm bg-amber-100">
                <span class="material-symbols-outlined text-amber-600">help</span>
              </div>
              자주 묻는 질문
            </h2>
            <div class="space-y-3" id="faq-accordion">
              <% @topic.faq_list.each_with_index do |faq, index| %>
                <div class="border border-gray-100 rounded-xl overflow-hidden hover:border-indigo-200 transition-colors">
                  <button onclick="toggleFaq(<%= index %>)"
                          class="w-full px-5 py-4 text-left bg-surface-50 hover:bg-surface-100 flex items-center justify-between transition-colors">
                    <span class="font-medium text-slate-800 flex items-center gap-3">
                      <span class="w-7 h-7 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-sm font-bold">Q</span>
                      <%= faq['question'] %>
                    </span>
                    <span id="faq-icon-<%= index %>" class="material-symbols-outlined text-slate-400 transition-transform duration-200">expand_more</span>
                  </button>
                  <div id="faq-answer-<%= index %>" class="hidden px-5 py-4 bg-white border-t border-gray-100">
                    <div class="flex gap-3">
                      <span class="w-7 h-7 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center text-sm font-bold shrink-0">A</span>
                      <p class="text-slate-700 whitespace-pre-line leading-relaxed"><%= faq['answer'] %></p>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 사이드바 -->
      <div class="lg:w-[340px] shrink-0 mt-10 lg:mt-0">
        <div class="sticky top-36 space-y-6">
          <!-- 퀵 링크 -->
          <div class="card p-5">
            <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-indigo-600">bolt</span>
              빠른 이동
            </h3>
            <nav class="space-y-1">
              <% [
                { tab: "flowchart", icon: "account_tree", title: "실무흐름도" },
                { tab: "law", icon: "balance", title: "법령 3단 비교" },
                { tab: "tips", icon: "lightbulb", title: "실무주의" },
                { tab: "forms", icon: "draft", title: "서식/양식" }
              ].each do |item| %>
                <button onclick="showTab('<%= item[:tab] %>')"
                        class="w-full flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-surface-100 rounded-xl transition-all duration-200 text-left group">
                  <span class="material-symbols-outlined text-slate-400 group-hover:text-indigo-500 transition-colors"><%= item[:icon] %></span>
                  <span class="text-sm font-medium group-hover:text-slate-900 transition-colors"><%= item[:title] %></span>
                </button>
              <% end %>
            </nav>
          </div>

          <!-- 관련 실무 가이드 -->
          <% if @related_guide %>
          <div class="card p-5">
            <h3 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-emerald-600">menu_book</span>
              단계별 실무 가이드
            </h3>
            <%= link_to guide_path(@related_guide), class: "block p-4 bg-emerald-50 rounded-xl border border-emerald-100 hover:border-emerald-300 hover:shadow-medium transition-all duration-200 group" do %>
              <div class="font-semibold text-slate-900 text-sm group-hover:text-emerald-700 transition-colors"><%= @related_guide.title %></div>
              <div class="text-xs text-slate-500 mt-1"><%= @related_guide.summary.to_s.truncate(50) %></div>
              <div class="flex items-center gap-1 text-emerald-600 text-xs font-medium mt-2">
                단계별 가이드 보기 <span class="material-symbols-outlined text-sm">arrow_forward</span>
              </div>
            <% end %>
          </div>
          <% end %>

          <!-- 관련 도구 — 토픽별 맞춤 도구 (3단계) -->
          <% if @related_tools.any? %>
          <div class="card-glass bg-gradient-to-br from-emerald-50 to-indigo-50 border-emerald-200 p-5">
            <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-emerald-600">build</span>
              바로 사용하기
            </h3>
            <div class="space-y-3">
              <% @related_tools.each do |tool| %>
                <%= link_to send("#{tool[:key]}_path"),
                    class: "block p-4 bg-white rounded-xl border border-#{tool[:color]}-100 hover:border-#{tool[:color]}-300 hover:shadow-medium transition-all duration-200 group" do %>
                  <div class="flex items-center gap-3">
                    <div class="icon-container icon-container-sm bg-<%= tool[:color] %>-100 group-hover:bg-<%= tool[:color] %>-600 transition-colors">
                      <span class="material-symbols-outlined text-<%= tool[:color] %>-600 group-hover:text-white transition-colors"><%= tool[:icon] %></span>
                    </div>
                    <div>
                      <div class="font-semibold text-slate-900 text-sm"><%= tool[:title] %></div>
                      <div class="text-xs text-slate-500"><%= tool[:desc] %></div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
            <%= link_to tools_path, class: "mt-4 flex items-center justify-center gap-1 text-xs font-semibold text-slate-500 hover:text-emerald-600 transition-colors pt-3 border-t border-slate-100" do %>
              전체 <%= ApplicationHelper::ACTIVE_TOOL_COUNT %>개 도구 보기
              <span class="material-symbols-outlined text-sm">arrow_forward</span>
            <% end %>
          </div>
          <% end %>

          <!-- 문의하기 -->
          <div class="gradient-slate rounded-2xl p-6 text-white shadow-strong">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-white/10 backdrop-blur rounded-xl flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl">support_agent</span>
              </div>
              <div>
                <h3 class="font-bold text-lg">도움이 필요하신가요?</h3>
                <p class="text-slate-200 text-sm">궁금한 점을 물어보세요</p>
              </div>
            </div>
            <%= link_to chatbot_path,
                class: "block w-full py-3 bg-white text-slate-800 rounded-xl font-semibold text-center hover:bg-slate-50 transition-colors shadow-soft" do %>
              AI 상담 시작하기
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
/* 탭 패널 기본: 숨김 */
.tab-panel {
  display: none !important;
}
/* 활성 탭 패널: 표시 */
.tab-panel.active {
  display: block !important;
}

/* 캐스케이드 컨테이너 */
.law-cascade-container {
  position: relative;
  padding: 1rem;
  min-height: 500px;
}

/* 법령 카드 좌우 캐스케이드 스타일 */
.law-card-stack {
  position: relative;
  z-index: 30;
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
.law-card-stack[data-card="decree"] {
  z-index: 20;
}
.law-card-stack[data-card="rule"] {
  z-index: 10;
}

/* 카드 기본 스타일 */
.law-card {
  transform-origin: top left;
}

/* 카드가 펼쳐진 상태 — 띠지 공간 확보 */
.law-card-stack.expanded {
  z-index: 100 !important;
  flex: 1 1 auto !important;
  width: auto !important;
  min-width: 0 !important;
  margin-left: 0 !important;
  margin-top: 0 !important;
  position: relative;
}
.law-card-stack.expanded .law-card {
  transform: scale(1);
}
.law-card-stack.expanded .law-card-content {
  max-height: 2000px;
}
.law-card-stack.expanded .card-expand-icon {
  transform: rotate(180deg);
}

/* 카드가 접힌 상태 — 띠지(탭) 모양 */
.law-card-stack.collapsed {
  flex: 0 0 64px !important;
  width: 64px !important;
  min-width: 64px !important;
  margin-left: 0 !important;
  margin-top: 0 !important;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
.law-card-stack.collapsed .law-card {
  transform: none;
  transition: all 0.2s ease-in-out;
}
.law-card-stack.collapsed .law-card-content {
  display: none;
}

/* 접힌 카드 호버 효과 - 클릭 가능함을 명확히 표시 */
.law-card-stack.collapsed:hover {
  transform: translateX(6px);
}
.law-card-stack.collapsed:hover .law-card {
  box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
}
.law-card-stack.collapsed[data-card="law"]:hover .law-card {
  border-color: #4f46e5;
}
.law-card-stack.collapsed[data-card="decree"]:hover .law-card {
  border-color: #059669;
}
.law-card-stack.collapsed[data-card="rule"]:hover .law-card {
  border-color: #ea580c;
}

/* 모바일에서 터치 영역 확대 */
@media (max-width: 768px) {
  .law-card-stack.collapsed {
    flex: 0 0 80px !important;
    width: 80px !important;
    min-width: 80px !important;
  }
  .law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:first-child > div:first-child {
    width: 3rem;
    height: 3rem;
  }
  .law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:first-child > div:first-child span {
    font-size: 1.5rem;
  }
}

/* 초기 로드 시 힌트 애니메이션 - 접힌 카드가 클릭 가능함을 알림 */
@keyframes law-card-hint {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(3px); }
  75% { transform: translateX(-2px); }
}

.law-card-stack.collapsed.hint-animation {
  animation: law-card-hint 0.6s ease-in-out 2;
  animation-delay: 0.5s;
}

.law-card-stack.collapsed[data-card="decree"].hint-animation {
  animation-delay: 0.7s;
}

.law-card-stack.collapsed[data-card="rule"].hint-animation {
  animation-delay: 0.9s;
}
/* 헤더만 표시 — 법률 헤더 높이에 맞춤 */
.law-card-stack.collapsed .law-card > div:first-child {
  padding: 1.25rem 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* 헤더 내부: 아이콘만 세로 중앙 표시 */
.law-card-stack.collapsed .law-card > div:first-child > div:last-child {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:first-child {
  flex-direction: column;
  align-items: center;
  gap: 0;
}
/* 글자 아이콘(령/칙)만 표시 */
.law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:first-child > div:first-child {
  width: 2.5rem;
  height: 2.5rem;
}
.law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:first-child > div:first-child span {
  font-size: 1.25rem;
}
/* 나머지 텍스트, 뱃지, 화살표 숨기기 */
.law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:first-child > div:last-child,
.law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:last-child {
  display: none;
}

/* 기본 상태 - 모든 카드가 보이는 캐스케이드 뷰 */
.law-card-content {
  max-height: 300px;
  overflow-y: auto;
  transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 초기 상태에서 카드 크기 조정 */
.law-card-stack:not(.expanded):not(.collapsed) {
  /* 기본 캐스케이드 상태 유지 */
}

/* ───── 실무자 해설 섹션 ───── */
.commentary-body .legal-h3 {
  font-size: 1.05rem;
  font-weight: 700;
  color: #1e293b;
  margin: 1.75rem 0 0.75rem;
  padding: 0.6rem 1rem;
  background: linear-gradient(to right, #eef2ff, transparent);
  border-left: 4px solid #6366f1;
  border-radius: 0 8px 8px 0;
}
.commentary-body .legal-h3:first-child {
  margin-top: 0;
}
.commentary-body .legal-h4 {
  font-size: 0.95rem;
  font-weight: 700;
  color: #334155;
  margin: 1.25rem 0 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.commentary-body .legal-h4::before {
  content: '';
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #6366f1;
  flex-shrink: 0;
}
.commentary-body .legal-text {
  font-size: 0.9rem;
  color: #475569;
  line-height: 1.8;
  margin-bottom: 0.5rem;
}
.commentary-body .legal-list {
  list-style: none;
  padding: 0;
  margin: 0.5rem 0 1rem;
  space-y: 0.25rem;
}
.commentary-body .legal-list-item {
  font-size: 0.875rem;
  color: #475569;
  padding: 0.35rem 0 0.35rem 1.5rem;
  position: relative;
  line-height: 1.7;
}
.commentary-body .legal-list-item::before {
  content: '▸';
  position: absolute;
  left: 0.25rem;
  color: #6366f1;
  font-size: 0.75rem;
  top: 0.5rem;
}
.commentary-body .legal-blockquote {
  margin: 0.6rem 0;
  padding: 0.9rem 1rem 0.9rem 1.1rem;
  background: #fef9f0;
  border: 1px solid #fde68a;
  border-left: 4px solid #f59e0b;
  border-radius: 0 10px 10px 0;
  font-size: 0.875rem;
  color: #78350f;
  line-height: 1.7;
}
.commentary-body strong {
  color: #1e293b;
  font-weight: 700;
}

/* ───── 스크롤바 스타일 ───── */
.law-card-content::-webkit-scrollbar {
  width: 6px;
}
.law-card-content::-webkit-scrollbar-track {
  background: transparent;
}
.law-card-content::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.1);
  border-radius: 3px;
}
.law-card-content::-webkit-scrollbar-thumb:hover {
  background: rgba(0,0,0,0.2);
}

/* 카드 호버 효과 */
.law-card-stack:hover {
  z-index: 50;
}
.law-card-stack:hover .law-card {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}
.law-card-stack.expanded:hover .law-card,
.law-card-stack.collapsed:hover .law-card {
  transform: scale(1);
}

/* 모바일 반응형 */
@media (max-width: 1024px) {
  .law-cascade-container .flex {
    flex-direction: column;
    min-width: 0 !important;
  }
  .law-card-stack {
    width: 100% !important;
    min-width: 100% !important;
    margin-left: 0 !important;
  }
  .law-card-stack[data-card="decree"],
  .law-card-stack[data-card="rule"] {
    margin-top: -2rem !important;
  }
  .law-card-stack.collapsed {
    width: 100% !important;
    min-width: 100% !important;
    margin-left: 0 !important;
    margin-top: -2rem !important;
  }
  .law-card-stack.collapsed .law-card {
    min-height: auto !important;
    height: auto !important;
  }
  .law-card-stack.collapsed .law-card > div:first-child {
    min-height: auto !important;
    height: auto !important;
    padding: 0.75rem 1.5rem;
  }
  .law-card-stack.collapsed .law-card > div:first-child > div:last-child > div:first-child {
    flex-direction: row;
  }
  .law-card-stack.expanded {
    width: 100% !important;
  }
}
</style>

<script>
var expandedCard = null;

// 초기화: 법률 펼침, 시행령·시행규칙은 띠지(탭)로 접기
function initLawCards() {
  const allCards = document.querySelectorAll('.law-card-stack');
  if (allCards.length === 0) return;

  allCards.forEach(card => {
    if (card.dataset.card === 'law') {
      card.classList.add('expanded');
      card.classList.remove('collapsed', 'hint-animation');
    } else {
      card.classList.add('collapsed');
      card.classList.remove('expanded');

      // 초기 로드 시 힌트 애니메이션 추가 (한 번만)
      if (!sessionStorage.getItem('law-cards-seen')) {
        card.classList.add('hint-animation');

        // 애니메이션 완료 후 클래스 제거
        setTimeout(() => {
          card.classList.remove('hint-animation');
        }, 2500);
      }
    }
  });

  // 세션 중 한 번만 힌트 표시
  if (!sessionStorage.getItem('law-cards-seen')) {
    sessionStorage.setItem('law-cards-seen', 'true');
  }

  expandedCard = 'law';
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', initLawCards);

// Turbo 페이지 전환 시에도 초기화
document.addEventListener('turbo:load', initLawCards);
document.addEventListener('turbo:render', initLawCards);

function expandLawCard(cardType) {
  // 이미 펼쳐진 카드를 다시 클릭하면 무시
  if (expandedCard === cardType) return;

  const allCards = document.querySelectorAll('.law-card-stack');
  allCards.forEach(card => {
    if (card.dataset.card === cardType) {
      card.classList.add('expanded');
      card.classList.remove('collapsed');
    } else {
      card.classList.add('collapsed');
      card.classList.remove('expanded');
    }
  });
  expandedCard = cardType;
}

function toggleFaq(index) {
  const answer = document.getElementById(`faq-answer-${index}`);
  const icon = document.getElementById(`faq-icon-${index}`);

  if (answer.classList.contains('hidden')) {
    answer.classList.remove('hidden');
    if (icon) {
      icon.setAttribute('data-icon', 'material-symbols:expand-less');
      if (typeof Iconify !== 'undefined') Iconify.scan();
    }
    icon.style.transform = 'rotate(180deg)';
  } else {
    answer.classList.add('hidden');
    if (icon) {
      icon.setAttribute('data-icon', 'material-symbols:expand-more');
      if (typeof Iconify !== 'undefined') Iconify.scan();
    }
    icon.style.transform = 'rotate(0deg)';
  }
}

function showTab(tabName) {
  // 모든 탭 패널 찾기
  var allPanels = document.querySelectorAll('.tab-panel');

  // 모든 패널에서 active 클래스 제거, 선택된 탭에만 추가
  for (var i = 0; i < allPanels.length; i++) {
    var panel = allPanels[i];
    var panelTab = panel.getAttribute('data-tab');
    if (panelTab === tabName) {
      panel.classList.add('active');
    } else {
      panel.classList.remove('active');
    }
  }

  // 모든 탭 버튼 스타일 초기화
  var allBtns = document.querySelectorAll('.tab-btn');
  for (var j = 0; j < allBtns.length; j++) {
    allBtns[j].classList.remove('bg-slate-800', 'text-white', 'shadow-md');
    allBtns[j].classList.add('bg-surface-100', 'text-slate-600', 'hover:bg-surface-200');
  }

  // 선택된 탭 버튼 스타일 적용
  var activeBtn = document.querySelector('.tab-btn[data-tab="' + tabName + '"]');
  if (activeBtn) {
    activeBtn.classList.remove('bg-surface-100', 'text-slate-600', 'hover:bg-surface-200');
    activeBtn.classList.add('bg-slate-800', 'text-white', 'shadow-md');
  }
}

// 탭 초기화
function initTabs() {
  // 탭 버튼에 이미 onclick이 있으므로 추가 설정 불필요
  // 초기 상태는 CSS와 HTML의 active 클래스로 처리됨
}

// 즉시 실행
initTabs();

// Turbo 지원
document.addEventListener('turbo:load', initTabs);
document.addEventListener('turbo:render', initTabs);
</script>
