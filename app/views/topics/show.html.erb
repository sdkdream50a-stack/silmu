<%# 주제 상세 페이지 - 프리미엄 디자인 시스템 %>

<!-- 페이지 헤더 -->
<section class="gradient-premium text-white py-12 lg:py-16">
  <div class="container-wide">
    <!-- 브레드크럼 -->
    <div class="flex items-center gap-2 text-navy-300 text-sm mb-6">
      <%= link_to root_path, class: "hover:text-white transition-colors flex items-center gap-1" do %>
        <span class="material-symbols-outlined text-sm">home</span>
        홈
      <% end %>
      <span class="material-symbols-outlined text-sm">chevron_right</span>
      <span><%= @topic.category_name %></span>
      <span class="material-symbols-outlined text-sm">chevron_right</span>
      <span class="text-white font-medium"><%= @topic.name %></span>
    </div>

    <div class="lg:flex lg:items-start lg:justify-between gap-8">
      <div class="flex-1">
        <div class="flex items-start gap-5 mb-4">
          <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
            <span class="material-symbols-outlined text-4xl text-white">gavel</span>
          </div>
          <div>
            <h1 class="text-3xl lg:text-4xl font-bold tracking-tight"><%= @topic.name %></h1>
            <p class="text-navy-200 mt-2 text-lg"><%= @topic.summary %></p>
          </div>
        </div>

        <!-- 키워드 태그 (서브토픽 링크) -->
        <div class="flex flex-wrap gap-2 mt-6">
          <% if @topic.parent.present? %>
            <%# 서브토픽인 경우: 부모 토픽과 형제 토픽들 표시 %>
            <%= link_to topic_path(@topic.parent.slug),
                class: "px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-full text-sm text-white font-medium transition-all duration-200 flex items-center gap-1.5 border border-white/20" do %>
              <span class="material-symbols-outlined text-sm">arrow_back</span>
              <%= @topic.parent.name %>
            <% end %>
            <% @topic.parent.subtopics.published.where.not(id: @topic.id).each do |sibling| %>
              <%= link_to topic_path(sibling.slug),
                  class: "px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full text-sm text-white transition-all duration-200 flex items-center gap-1.5 border border-white/10 hover:border-white/20" do %>
                <span class="material-symbols-outlined text-sm">tag</span>
                <%= sibling.name %>
              <% end %>
            <% end %>
          <% else %>
            <%# 부모 토픽인 경우: 서브토픽 또는 키워드 검색 링크 %>
            <% @topic.keyword_list.first(8).each do |keyword| %>
              <% subtopic = @topic.subtopics.published.find_by("name ILIKE ?", keyword) ||
                           Topic.published.find_by("name ILIKE ?", keyword) %>
              <% if subtopic %>
                <%= link_to topic_path(subtopic.slug),
                    class: "px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full text-sm text-white transition-all duration-200 flex items-center gap-1.5 border border-white/10 hover:border-white/20" do %>
                  <span class="material-symbols-outlined text-sm">tag</span>
                  <%= keyword %>
                <% end %>
              <% else %>
                <%= link_to chatbot_search_path(q: keyword),
                    class: "px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full text-sm text-white transition-all duration-200 flex items-center gap-1.5 border border-white/10 hover:border-white/20" do %>
                  <span class="material-symbols-outlined text-sm">tag</span>
                  <%= keyword %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- 액션 버튼 -->
      <div class="mt-6 lg:mt-0 flex gap-3">
        <button class="btn btn-glass btn-sm">
          <span class="material-symbols-outlined text-lg">bookmark_border</span>
          저장
        </button>
        <button class="btn btn-glass btn-sm">
          <span class="material-symbols-outlined text-lg">share</span>
          공유
        </button>
      </div>
    </div>
  </div>
</section>

<!-- 탭 네비게이션 -->
<section class="bg-white/80 backdrop-blur-xl border-b border-gray-100 sticky top-16 z-40 shadow-soft">
  <div class="container-wide">
    <nav class="flex gap-2 overflow-x-auto py-3 -mx-4 px-4 scrollbar-hide" id="topic-tabs">
      <button onclick="showTab('law')" data-tab="law"
              class="tab-btn px-5 py-2.5 bg-navy-800 text-white rounded-xl text-sm font-semibold whitespace-nowrap flex items-center gap-2 transition-all duration-200 shadow-md">
        <span class="material-symbols-outlined text-lg">balance</span>
        법령 3단 비교
      </button>
      <button onclick="showTab('regulation')" data-tab="regulation"
              class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium whitespace-nowrap flex items-center gap-2 transition-all duration-200">
        <span class="material-symbols-outlined text-lg">description</span>
        예규/지침
      </button>
      <button onclick="showTab('interpretation')" data-tab="interpretation"
              class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium whitespace-nowrap flex items-center gap-2 transition-all duration-200">
        <span class="material-symbols-outlined text-lg">policy</span>
        유권해석
      </button>
      <button onclick="showTab('audit')" data-tab="audit"
              class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium whitespace-nowrap flex items-center gap-2 transition-all duration-200">
        <span class="material-symbols-outlined text-lg">search</span>
        감사사례
      </button>
      <button onclick="showTab('qa')" data-tab="qa"
              class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium whitespace-nowrap flex items-center gap-2 transition-all duration-200">
        <span class="material-symbols-outlined text-lg">forum</span>
        질의답변
      </button>
      <button onclick="showTab('tips')" data-tab="tips"
              class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium whitespace-nowrap flex items-center gap-2 transition-all duration-200">
        <span class="material-symbols-outlined text-lg">lightbulb</span>
        실무주의
      </button>
      <button onclick="showTab('forms')" data-tab="forms"
              class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium whitespace-nowrap flex items-center gap-2 transition-all duration-200">
        <span class="material-symbols-outlined text-lg">draft</span>
        서식/양식
      </button>
      <button onclick="showTab('flowchart')" data-tab="flowchart"
              class="tab-btn px-5 py-2.5 bg-surface-100 text-navy-600 hover:bg-surface-200 rounded-xl text-sm font-medium whitespace-nowrap flex items-center gap-2 transition-all duration-200">
        <span class="material-symbols-outlined text-lg">account_tree</span>
        흐름도
      </button>
    </nav>
  </div>
</section>

<!-- 메인 콘텐츠 -->
<section class="section py-10">
  <div class="container-wide">
    <div class="lg:flex lg:gap-10">
      <!-- 메인 콘텐츠 영역 -->
      <div class="flex-1 min-w-0">
        <!-- 법령 3단 비교 -->
        <div class="tab-panel" data-tab="law">
          <% if @topic.has_law_content? %>
            <div class="grid lg:grid-cols-3 gap-6">
              <!-- 법률 -->
              <div class="card card-hover overflow-hidden border-point-200">
                <div class="bg-gradient-to-r from-point-500 to-point-600 px-5 py-4">
                  <div class="flex items-center gap-3">
                    <div class="w-11 h-11 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                      <span class="text-white font-bold text-xl">법</span>
                    </div>
                    <div>
                      <h3 class="font-bold text-white text-lg">법률</h3>
                      <p class="text-point-100 text-sm">국가계약법/지방계약법</p>
                    </div>
                  </div>
                </div>
                <div class="p-5">
                  <div class="prose-premium">
                    <%= raw @topic.law_content %>
                  </div>
                </div>
              </div>

              <!-- 시행령 -->
              <div class="card card-hover overflow-hidden border-forest-200">
                <div class="bg-gradient-to-r from-forest-500 to-forest-600 px-5 py-4">
                  <div class="flex items-center gap-3">
                    <div class="w-11 h-11 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                      <span class="text-white font-bold text-xl">령</span>
                    </div>
                    <div>
                      <h3 class="font-bold text-white text-lg">시행령</h3>
                      <p class="text-forest-100 text-sm">대통령령</p>
                    </div>
                  </div>
                </div>
                <div class="p-5">
                  <div class="prose-premium">
                    <%= raw @topic.decree_content %>
                  </div>
                </div>
              </div>

              <!-- 시행규칙 -->
              <div class="card card-hover overflow-hidden border-warm-200">
                <div class="bg-gradient-to-r from-warm-500 to-warm-600 px-5 py-4">
                  <div class="flex items-center gap-3">
                    <div class="w-11 h-11 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                      <span class="text-white font-bold text-xl">칙</span>
                    </div>
                    <div>
                      <h3 class="font-bold text-white text-lg">시행규칙</h3>
                      <p class="text-warm-100 text-sm">부령</p>
                    </div>
                  </div>
                </div>
                <div class="p-5">
                  <div class="prose-premium">
                    <%= raw @topic.rule_content %>
                  </div>
                </div>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-navy-200 mb-4">description</span>
              <p class="text-navy-500 text-lg">법령 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 예규/지침 -->
        <div class="tab-panel hidden" data-tab="regulation">
          <% if @topic.regulation_content.present? %>
            <div class="card p-6 lg:p-8">
              <div class="prose-premium">
                <%= raw @topic.regulation_content %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-navy-200 mb-4">description</span>
              <p class="text-navy-500 text-lg">예규/지침 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 유권해석 -->
        <div class="tab-panel hidden" data-tab="interpretation">
          <% if @topic.interpretation_content.present? %>
            <div class="card p-6 lg:p-8">
              <div class="prose-premium">
                <%= raw @topic.interpretation_content %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-navy-200 mb-4">policy</span>
              <p class="text-navy-500 text-lg">유권해석 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 감사사례 -->
        <div class="tab-panel hidden" data-tab="audit">
          <% if @topic.audit_cases.present? %>
            <div class="card p-6 lg:p-8">
              <div class="prose-premium">
                <%= raw @topic.audit_cases %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-navy-200 mb-4">search</span>
              <p class="text-navy-500 text-lg">감사사례 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 질의답변 -->
        <div class="tab-panel hidden" data-tab="qa">
          <% if @topic.qa_content.present? %>
            <div class="card p-6 lg:p-8">
              <div class="prose-premium">
                <%= raw @topic.qa_content %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-navy-200 mb-4">forum</span>
              <p class="text-navy-500 text-lg">질의답변 정보가 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 실무주의 -->
        <div class="tab-panel hidden" data-tab="tips">
          <% if @topic.practical_tips.present? %>
            <div class="card p-6 lg:p-8">
              <div class="prose-premium">
                <%= raw @topic.practical_tips %>
              </div>
            </div>
          <% else %>
            <div class="card p-16 text-center">
              <span class="material-symbols-outlined text-6xl text-navy-200 mb-4">lightbulb</span>
              <p class="text-navy-500 text-lg">실무주의사항이 준비 중입니다.</p>
            </div>
          <% end %>
        </div>

        <!-- 서식/양식 -->
        <div class="tab-panel hidden" data-tab="forms">
          <!-- 필수 서식 -->
          <div class="mb-10">
            <div class="flex items-center justify-between mb-5">
              <h3 class="text-xl font-bold text-navy-900 flex items-center gap-2">
                <div class="icon-container icon-container-sm bg-point-100">
                  <span class="material-symbols-outlined text-point-600">folder_open</span>
                </div>
                필수 서식
              </h3>
              <%= link_to templates_path, class: "text-sm text-point-600 hover:text-point-700 font-medium flex items-center gap-1 transition-colors" do %>
                전체보기
                <span class="material-symbols-outlined text-sm">arrow_forward</span>
              <% end %>
            </div>

            <div class="grid sm:grid-cols-2 gap-4">
              <% [
                { title: "수의계약 사유서", desc: "수의계약 체결 사유를 명시하는 필수 서류", badge: "별지 제5호 서식", color: "point", path: "/forms/수의계약사유서.html" },
                { title: "견적서", desc: "업체로부터 징구하는 가격 견적서", badge: "1인/2인 견적용", color: "forest", path: "/forms/견적서.html" },
                { title: "예정가격 조서", desc: "예정가격 산출 근거 문서", badge: "거래실례가격/원가계산", color: "warm", path: "/forms/예정가격조서.html" },
                { title: "검수조서", desc: "납품/용역 완료 검수 확인서", badge: "대금지급 전 필수", color: "navy", path: "/forms/검수조서.html" }
              ].each do |form| %>
                <a href="<%= form[:path] %>" target="_blank"
                   class="group card card-interactive p-5">
                  <div class="flex items-start gap-4">
                    <div class="icon-container icon-container-md bg-<%= form[:color] %>-100 group-hover:bg-<%= form[:color] %>-600 transition-colors">
                      <span class="material-symbols-outlined text-2xl text-<%= form[:color] %>-600 group-hover:text-white transition-colors">description</span>
                    </div>
                    <div class="flex-1 min-w-0">
                      <h4 class="font-semibold text-navy-900 group-hover:text-<%= form[:color] %>-600 transition-colors"><%= form[:title] %></h4>
                      <p class="text-sm text-navy-500 mt-1"><%= form[:desc] %></p>
                      <span class="badge badge-<%= form[:color] %> mt-2"><%= form[:badge] %></span>
                    </div>
                    <span class="material-symbols-outlined text-navy-300 group-hover:text-<%= form[:color] %>-600 transition-colors">open_in_new</span>
                  </div>
                </a>
              <% end %>
            </div>
          </div>

          <!-- 실무 도구 -->
          <div class="mb-10">
            <h3 class="text-xl font-bold text-navy-900 flex items-center gap-2 mb-5">
              <div class="icon-container icon-container-sm bg-point-100">
                <span class="material-symbols-outlined text-point-600">construction</span>
              </div>
              실무 도구
            </h3>

            <a href="/forms/견적서검토.html" target="_blank"
               class="group block bg-gradient-to-br from-point-50 to-navy-50 rounded-2xl border-2 border-point-200 p-6 hover:border-point-400 hover:shadow-strong transition-all duration-300">
              <div class="flex items-start gap-5">
                <div class="w-16 h-16 gradient-point rounded-2xl flex items-center justify-center shadow-lg shrink-0">
                  <span class="material-symbols-outlined text-3xl text-white">fact_check</span>
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h4 class="text-xl font-bold text-navy-900">견적서 검토 시스템</h4>
                    <span class="badge badge-point">AI</span>
                  </div>
                  <p class="text-navy-600">업체에서 받은 견적서를 분석하여 법규 적합성, 가격 적정성, 주의사항을 리포트로 제공</p>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <span class="badge badge-point">자동 분석</span>
                    <span class="badge badge-navy">리포트 생성</span>
                    <span class="badge badge-forest">법규 검토</span>
                  </div>
                </div>
                <span class="material-symbols-outlined text-2xl text-point-400 group-hover:translate-x-1 transition-transform">arrow_forward</span>
              </div>
            </a>
          </div>

          <!-- 공식 서식 다운로드 -->
          <div class="mb-10">
            <h3 class="text-xl font-bold text-navy-900 flex items-center gap-2 mb-5">
              <div class="icon-container icon-container-sm bg-navy-100">
                <span class="material-symbols-outlined text-navy-600">link</span>
              </div>
              공식 서식 다운로드
            </h3>

            <div class="bg-surface-100 rounded-2xl p-4 space-y-3">
              <% [
                { title: "국가법령정보센터", desc: "지방자치단체 입찰 및 계약집행기준 (별지 서식 포함)", icon: "balance", color: "point", url: "https://www.law.go.kr/행정규칙/지방자치단체입찰및계약집행기준" },
                { title: "행정안전부 지방계약 예규", desc: "계약일반조건, 입찰집행기준 등 HWP 다운로드", icon: "apartment", color: "forest", url: "https://www.mois.go.kr/frt/bbs/type001/commonSelectBoardList.do?bbsId=BBSMSTR_000000000061" },
                { title: "나라장터 (G2B)", desc: "조달청 수의계약 매뉴얼 및 서식", icon: "public", color: "navy", url: "https://www.g2b.go.kr" }
              ].each do |link| %>
                <a href="<%= link[:url] %>" target="_blank" rel="noopener"
                   class="flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 hover:border-<%= link[:color] %>-300 hover:shadow-medium transition-all duration-200">
                  <div class="icon-container icon-container-sm bg-<%= link[:color] %>-600">
                    <span class="material-symbols-outlined text-white"><%= link[:icon] %></span>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-navy-900"><%= link[:title] %></div>
                    <div class="text-sm text-navy-500 truncate"><%= link[:desc] %></div>
                  </div>
                  <span class="material-symbols-outlined text-navy-300">open_in_new</span>
                </a>
              <% end %>
            </div>
          </div>

          <!-- 작성 가이드 -->
          <div>
            <h3 class="text-xl font-bold text-navy-900 flex items-center gap-2 mb-5">
              <div class="icon-container icon-container-sm bg-point-100">
                <span class="material-symbols-outlined text-point-600">edit_note</span>
              </div>
              수의계약 사유서 작성 가이드
            </h3>

            <div class="bg-point-50 border border-point-200 rounded-2xl p-6">
              <div class="space-y-6">
                <div>
                  <h4 class="font-semibold text-navy-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-point-600">checklist</span>
                    필수 기재 항목
                  </h4>
                  <div class="grid sm:grid-cols-2 gap-3">
                    <% [
                      { num: "1", title: "계약 건명", desc: "사업/물품/용역명 명확히 기재" },
                      { num: "2", title: "추정가격", desc: "예정가격 산출 근거 포함" },
                      { num: "3", title: "수의계약 사유", desc: "법적 근거 조항 명시" },
                      { num: "4", title: "계약상대자 선정 사유", desc: "특정 업체 선정 이유" }
                    ].each do |item| %>
                      <div class="flex items-start gap-3 bg-white rounded-xl p-4 shadow-soft">
                        <span class="w-7 h-7 gradient-point text-white rounded-full flex items-center justify-center text-sm font-bold shrink-0"><%= item[:num] %></span>
                        <div>
                          <div class="font-semibold text-navy-900"><%= item[:title] %></div>
                          <div class="text-sm text-navy-500"><%= item[:desc] %></div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>

                <div class="border-t border-point-200 pt-6">
                  <h4 class="font-semibold text-navy-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-point-600">code</span>
                    작성 예시
                  </h4>
                  <div class="bg-white rounded-xl p-5 text-sm text-navy-700 font-mono space-y-2 shadow-soft">
                    <p><span class="text-point-600 font-semibold">1. 계약건명:</span> 2026년도 사무용품 구매</p>
                    <p><span class="text-point-600 font-semibold">2. 추정가격:</span> 15,000,000원 (부가세 포함)</p>
                    <p><span class="text-point-600 font-semibold">3. 수의계약 사유:</span></p>
                    <p class="pl-4 text-navy-600">지방계약법 시행령 제25조 제1항 제1호에 따라 추정가격이 물품구매 수의계약 기준금액(2,200만원) 이하이므로 수의계약 체결</p>
                    <p><span class="text-point-600 font-semibold">4. 계약상대자:</span> (주)OO상사</p>
                    <p class="pl-4 text-navy-600">- 선정사유: 최저가 견적 제출업체</p>
                  </div>
                </div>

                <div class="bg-warm-50 border border-warm-200 rounded-xl p-4">
                  <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-warm-600">warning</span>
                    <div class="text-sm text-warm-800">
                      <strong>주의:</strong> 수의계약 사유서는 반드시 <u>계약 체결 전</u>에 작성하여 결재를 받아야 합니다. 사후 작성은 감사 지적 대상입니다.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 흐름도 -->
        <div class="tab-panel hidden" data-tab="flowchart">
          <div class="card p-6 lg:p-8">
            <h3 class="text-xl font-bold text-navy-900 text-center mb-8 flex items-center justify-center gap-2">
              <div class="icon-container icon-container-sm bg-navy-100">
                <span class="material-symbols-outlined text-navy-600">account_tree</span>
              </div>
              수의계약 업무 흐름도
            </h3>

            <!-- 프로세스 개요 -->
            <div class="flex flex-wrap justify-center items-center gap-3 mb-10">
              <% [
                { step: "1", title: "사전준비", color: "point" },
                { step: "2", title: "견적징구", color: "forest" },
                { step: "3", title: "계약체결", color: "navy" },
                { step: "4", title: "이행/검수", color: "warm" },
                { step: "5", title: "대금지급", color: "rose" }
              ].each_with_index do |item, index| %>
                <div class="flex items-center gap-2 px-4 py-2.5 bg-<%= item[:color] %>-100 text-<%= item[:color] %>-700 rounded-xl font-semibold text-sm shadow-soft">
                  <span class="w-6 h-6 bg-<%= item[:color] %>-600 text-white rounded-full flex items-center justify-center text-xs font-bold"><%= item[:step] %></span>
                  <%= item[:title] %>
                </div>
                <% unless index == 4 %>
                  <span class="material-symbols-outlined text-navy-300">arrow_forward</span>
                <% end %>
              <% end %>
            </div>

            <!-- 상세 흐름도 -->
            <div class="space-y-8">
              <!-- STEP 1 -->
              <div class="bg-point-50 rounded-2xl p-6 border-l-4 border-point-500">
                <div class="flex items-center gap-4 mb-6">
                  <div class="w-14 h-14 gradient-point text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg">1</div>
                  <div>
                    <h4 class="text-xl font-bold text-navy-900">사전준비</h4>
                    <p class="text-point-600 font-medium">사업부서</p>
                  </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <% [
                    { icon: "assignment", title: "사업계획 수립", desc: "필요성 검토" },
                    { icon: "payments", title: "예산확보", desc: "예산과목 확인" },
                    { icon: "calculate", title: "예정가격 작성", desc: "거래실례가격 조사" },
                    { icon: "edit_document", title: "수의계약 사유서", desc: "법적 근거 명시" }
                  ].each do |item| %>
                    <div class="bg-white rounded-xl p-4 text-center shadow-soft hover-lift">
                      <span class="material-symbols-outlined text-3xl text-point-500 mb-2"><%= item[:icon] %></span>
                      <div class="text-sm font-semibold text-navy-800"><%= item[:title] %></div>
                      <div class="text-xs text-navy-500 mt-1"><%= item[:desc] %></div>
                    </div>
                  <% end %>
                </div>
                <div class="mt-5 p-4 bg-point-100 rounded-xl text-sm text-point-800 flex items-center gap-2">
                  <span class="material-symbols-outlined">lightbulb</span>
                  <strong>체크포인트:</strong> 추정가격이 수의계약 기준금액 이내인지 확인 (물품/용역: 5천만원, 공사: 2억원)
                </div>
              </div>

              <!-- 금액 기준 분기 -->
              <div class="flex justify-center">
                <div class="bg-surface-100 rounded-2xl p-6 inline-block shadow-soft">
                  <div class="text-center mb-5">
                    <span class="text-sm font-bold text-navy-700">금액에 따른 견적 방법 결정</span>
                  </div>
                  <div class="flex flex-wrap justify-center gap-5">
                    <% [
                      { type: "물품/용역", amount: "2,200만원 이하", method: "1인 견적", color: "forest" },
                      { type: "물품/용역", amount: "5천만원 이하", method: "2인 이상 견적", color: "point" },
                      { type: "공사", amount: "5천만원 이하", method: "1인 견적", color: "warm" },
                      { type: "공사", amount: "2억원 이하", method: "2인 이상 견적", color: "navy" }
                    ].each do |item| %>
                      <div class="text-center">
                        <div class="w-24 h-24 bg-<%= item[:color] %>-100 rounded-full flex items-center justify-center border-2 border-<%= item[:color] %>-400 hover:scale-105 transition-transform">
                          <div>
                            <div class="text-xs text-<%= item[:color] %>-600 font-medium"><%= item[:type] %></div>
                            <div class="text-sm font-bold text-<%= item[:color] %>-700"><%= item[:amount] %></div>
                          </div>
                        </div>
                        <div class="text-xs font-semibold text-<%= item[:color] %>-700 mt-2"><%= item[:method] %></div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>

              <!-- STEP 2 -->
              <div class="bg-forest-50 rounded-2xl p-6 border-l-4 border-forest-500">
                <div class="flex items-center gap-4 mb-6">
                  <div class="w-14 h-14 gradient-forest text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg">2</div>
                  <div>
                    <h4 class="text-xl font-bold text-navy-900">견적징구</h4>
                    <p class="text-forest-600 font-medium">사업부서/계약부서</p>
                  </div>
                </div>
                <div class="grid md:grid-cols-3 gap-5">
                  <% [
                    { icon: "outgoing_mail", title: "견적요청", items: ["동일 규격/조건 제시", "견적 마감일시 명시", "제출방법 안내"] },
                    { icon: "inbox", title: "견적서 접수", items: ["1인 또는 2인 이상", "사업자등록증 확인", "마감일시 준수 확인"] },
                    { icon: "how_to_reg", title: "계약상대자 선정", items: ["예정가격 이하 확인", "최저가 업체 선정", "적격성 검토"] }
                  ].each do |item| %>
                    <div class="bg-white rounded-xl p-5 shadow-soft hover-lift">
                      <div class="flex items-center justify-center mb-4">
                        <span class="material-symbols-outlined text-3xl text-forest-500"><%= item[:icon] %></span>
                      </div>
                      <div class="text-sm font-semibold text-navy-800 text-center mb-3"><%= item[:title] %></div>
                      <ul class="text-xs text-navy-600 space-y-1.5">
                        <% item[:items].each do |i| %>
                          <li class="flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-xs text-forest-500">check</span>
                            <%= i %>
                          </li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>
                </div>
                <div class="mt-5 p-4 bg-warm-100 rounded-xl text-sm text-warm-800 flex items-center gap-2">
                  <span class="material-symbols-outlined">warning</span>
                  <strong>주의:</strong> 견적서는 반드시 계약 체결 <u>전</u>에 징구해야 합니다. 사후 징구는 감사 지적!
                </div>
              </div>

              <!-- STEP 3 -->
              <div class="bg-navy-50 rounded-2xl p-6 border-l-4 border-navy-500">
                <div class="flex items-center gap-4 mb-6">
                  <div class="w-14 h-14 gradient-navy text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg">3</div>
                  <div>
                    <h4 class="text-xl font-bold text-navy-900">계약체결</h4>
                    <p class="text-navy-600 font-medium">계약부서</p>
                  </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <% [
                    { icon: "article", title: "계약서 작성", desc: "계약조건 명시" },
                    { icon: "verified", title: "계약 날인", desc: "쌍방 서명/날인" },
                    { icon: "account_balance_wallet", title: "보증금", desc: "5천만원 이하 면제가능" },
                    { icon: "send", title: "계약통지", desc: "계약상대자 통보" }
                  ].each do |item| %>
                    <div class="bg-white rounded-xl p-4 text-center shadow-soft hover-lift">
                      <span class="material-symbols-outlined text-3xl text-navy-500 mb-2"><%= item[:icon] %></span>
                      <div class="text-sm font-semibold text-navy-800"><%= item[:title] %></div>
                      <div class="text-xs text-navy-500 mt-1"><%= item[:desc] %></div>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- STEP 4 -->
              <div class="bg-warm-50 rounded-2xl p-6 border-l-4 border-warm-500">
                <div class="flex items-center gap-4 mb-6">
                  <div class="w-14 h-14 gradient-warm text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg">4</div>
                  <div>
                    <h4 class="text-xl font-bold text-navy-900">이행 및 검수</h4>
                    <p class="text-warm-600 font-medium">사업부서</p>
                  </div>
                </div>
                <div class="grid md:grid-cols-3 gap-5">
                  <% [
                    { icon: "local_shipping", title: "계약이행", items: ["납품/용역 수행", "이행기간 준수", "진행상황 관리"] },
                    { icon: "search", title: "검수", items: ["규격/수량 확인", "품질 검사", "하자 여부 점검"] },
                    { icon: "task", title: "검수조서 작성", items: ["검수일자 기록", "검수자 서명", "합격/불합격 판정"] }
                  ].each do |item| %>
                    <div class="bg-white rounded-xl p-5 shadow-soft hover-lift">
                      <div class="flex items-center justify-center mb-4">
                        <span class="material-symbols-outlined text-3xl text-warm-500"><%= item[:icon] %></span>
                      </div>
                      <div class="text-sm font-semibold text-navy-800 text-center mb-3"><%= item[:title] %></div>
                      <ul class="text-xs text-navy-600 space-y-1.5">
                        <% item[:items].each do |i| %>
                          <li class="flex items-center gap-1.5">
                            <span class="material-symbols-outlined text-xs text-warm-500">check</span>
                            <%= i %>
                          </li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- STEP 5 -->
              <div class="bg-rose-50 rounded-2xl p-6 border-l-4 border-rose-500">
                <div class="flex items-center gap-4 mb-6">
                  <div class="w-14 h-14 bg-gradient-to-br from-rose-500 to-rose-600 text-white rounded-2xl flex items-center justify-center font-bold text-2xl shadow-lg">5</div>
                  <div>
                    <h4 class="text-xl font-bold text-navy-900">대금지급</h4>
                    <p class="text-rose-600 font-medium">회계부서</p>
                  </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <% [
                    { icon: "receipt", title: "세금계산서", desc: "적격 여부 확인" },
                    { icon: "request_quote", title: "지출결의", desc: "지출원인행위" },
                    { icon: "account_balance", title: "대금이체", desc: "5일 이내 지급" },
                    { icon: "folder", title: "서류보관", desc: "5년간 보존" }
                  ].each do |item| %>
                    <div class="bg-white rounded-xl p-4 text-center shadow-soft hover-lift">
                      <span class="material-symbols-outlined text-3xl text-rose-500 mb-2"><%= item[:icon] %></span>
                      <div class="text-sm font-semibold text-navy-800"><%= item[:title] %></div>
                      <div class="text-xs text-navy-500 mt-1"><%= item[:desc] %></div>
                    </div>
                  <% end %>
                </div>
                <div class="mt-5 p-4 bg-rose-100 rounded-xl text-sm text-rose-800 flex items-center gap-2">
                  <span class="material-symbols-outlined">gavel</span>
                  <strong>법적근거:</strong> 지방계약법 시행령 제108조 - 검사완료 후 5일 이내 대금 지급
                </div>
              </div>
            </div>

            <!-- 핵심 체크포인트 -->
            <div class="mt-10 gradient-premium text-white rounded-2xl p-8">
              <h4 class="font-bold text-xl mb-6 text-center flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">push_pin</span>
                수의계약 핵심 체크포인트
              </h4>
              <div class="grid md:grid-cols-3 gap-5">
                <div class="bg-white/10 backdrop-blur rounded-xl p-5">
                  <div class="text-rose-300 font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">block</span>
                    절대 금지
                  </div>
                  <ul class="space-y-2.5 text-navy-100 text-sm">
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-rose-400">close</span>
                      분할계약 (감사 1순위)
                    </li>
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-rose-400">close</span>
                      사후 견적서 징구
                    </li>
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-rose-400">close</span>
                      예정가격 미작성
                    </li>
                  </ul>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-xl p-5">
                  <div class="text-forest-300 font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    필수 서류
                  </div>
                  <ul class="space-y-2.5 text-navy-100 text-sm">
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-forest-400">check</span>
                      수의계약 사유서
                    </li>
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-forest-400">check</span>
                      견적서 (1인/2인)
                    </li>
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-forest-400">check</span>
                      예정가격 조서
                    </li>
                  </ul>
                </div>
                <div class="bg-white/10 backdrop-blur rounded-xl p-5">
                  <div class="text-point-300 font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">tips_and_updates</span>
                    실무 팁
                  </div>
                  <ul class="space-y-2.5 text-navy-100 text-sm">
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-point-400">star</span>
                      견적 마감일시 명확히
                    </li>
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-point-400">star</span>
                      동일 조건으로 요청
                    </li>
                    <li class="flex items-center gap-2">
                      <span class="material-symbols-outlined text-sm text-point-400">star</span>
                      서류는 시간순 정리
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 자주 묻는 질문 -->
        <% if @topic.faq_list.any? %>
          <div class="card p-6 lg:p-8 mt-10">
            <h2 class="text-xl font-bold text-navy-900 mb-6 flex items-center gap-3">
              <div class="icon-container icon-container-sm bg-warm-100">
                <span class="material-symbols-outlined text-warm-600">help</span>
              </div>
              자주 묻는 질문
            </h2>
            <div class="space-y-3" id="faq-accordion">
              <% @topic.faq_list.each_with_index do |faq, index| %>
                <div class="border border-gray-100 rounded-xl overflow-hidden hover:border-point-200 transition-colors">
                  <button onclick="toggleFaq(<%= index %>)"
                          class="w-full px-5 py-4 text-left bg-surface-50 hover:bg-surface-100 flex items-center justify-between transition-colors">
                    <span class="font-medium text-navy-800 flex items-center gap-3">
                      <span class="w-7 h-7 bg-warm-100 text-warm-600 rounded-full flex items-center justify-center text-sm font-bold">Q</span>
                      <%= faq['question'] %>
                    </span>
                    <span id="faq-icon-<%= index %>" class="material-symbols-outlined text-navy-400 transition-transform duration-200">expand_more</span>
                  </button>
                  <div id="faq-answer-<%= index %>" class="hidden px-5 py-4 bg-white border-t border-gray-100">
                    <div class="flex gap-3">
                      <span class="w-7 h-7 bg-navy-100 text-navy-600 rounded-full flex items-center justify-center text-sm font-bold shrink-0">A</span>
                      <p class="text-navy-700 whitespace-pre-line leading-relaxed"><%= faq['answer'] %></p>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 사이드바 -->
      <div class="lg:w-[340px] shrink-0 mt-10 lg:mt-0">
        <div class="sticky top-36 space-y-6">
          <!-- 퀵 링크 -->
          <div class="card p-5">
            <h3 class="font-bold text-navy-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-point-600">bolt</span>
              빠른 이동
            </h3>
            <nav class="space-y-1">
              <% [
                { tab: "law", icon: "balance", title: "법령 3단 비교" },
                { tab: "forms", icon: "draft", title: "서식/양식" },
                { tab: "flowchart", icon: "account_tree", title: "흐름도" },
                { tab: "tips", icon: "lightbulb", title: "실무주의" }
              ].each do |item| %>
                <button onclick="showTab('<%= item[:tab] %>')"
                        class="w-full flex items-center gap-3 px-4 py-3 text-navy-600 hover:bg-surface-100 rounded-xl transition-all duration-200 text-left group">
                  <span class="material-symbols-outlined text-navy-400 group-hover:text-point-500 transition-colors"><%= item[:icon] %></span>
                  <span class="text-sm font-medium group-hover:text-navy-900 transition-colors"><%= item[:title] %></span>
                </button>
              <% end %>
            </nav>
          </div>

          <!-- 관련 도구 -->
          <div class="card-glass bg-gradient-to-br from-point-50 to-navy-50 border-point-200 p-5">
            <h3 class="font-bold text-navy-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-point-600">build</span>
              관련 도구
            </h3>
            <div class="space-y-3">
              <a href="/forms/견적서검토.html" target="_blank"
                 class="block p-4 bg-white rounded-xl border border-point-100 hover:border-point-300 hover:shadow-medium transition-all duration-200">
                <div class="flex items-center gap-3">
                  <div class="icon-container icon-container-sm bg-point-100">
                    <span class="material-symbols-outlined text-point-600">fact_check</span>
                  </div>
                  <div>
                    <div class="font-semibold text-navy-900 text-sm">견적서 검토</div>
                    <div class="text-xs text-navy-500">AI 자동 분석</div>
                  </div>
                </div>
              </a>
              <%= link_to travel_calculator_path,
                  class: "block p-4 bg-white rounded-xl border border-point-100 hover:border-point-300 hover:shadow-medium transition-all duration-200" do %>
                <div class="flex items-center gap-3">
                  <div class="icon-container icon-container-sm bg-navy-100">
                    <span class="material-symbols-outlined text-navy-600">calculate</span>
                  </div>
                  <div>
                    <div class="font-semibold text-navy-900 text-sm">여비계산기</div>
                    <div class="text-xs text-navy-500">출장 여비 계산</div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- 문의하기 -->
          <div class="gradient-navy rounded-2xl p-6 text-white shadow-strong">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-white/10 backdrop-blur rounded-xl flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl">support_agent</span>
              </div>
              <div>
                <h3 class="font-bold text-lg">도움이 필요하신가요?</h3>
                <p class="text-navy-200 text-sm">궁금한 점을 물어보세요</p>
              </div>
            </div>
            <%= link_to chatbot_path,
                class: "block w-full py-3 bg-white text-navy-800 rounded-xl font-semibold text-center hover:bg-navy-50 transition-colors shadow-soft" do %>
              AI 상담 시작하기
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
function toggleFaq(index) {
  const answer = document.getElementById(`faq-answer-${index}`);
  const icon = document.getElementById(`faq-icon-${index}`);

  if (answer.classList.contains('hidden')) {
    answer.classList.remove('hidden');
    icon.textContent = 'expand_less';
    icon.style.transform = 'rotate(180deg)';
  } else {
    answer.classList.add('hidden');
    icon.textContent = 'expand_more';
    icon.style.transform = 'rotate(0deg)';
  }
}

function showTab(tabName) {
  // 모든 탭 버튼 스타일 초기화
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('bg-navy-800', 'text-white', 'shadow-md');
    btn.classList.add('bg-surface-100', 'text-navy-600', 'hover:bg-surface-200');
  });

  // 선택된 탭 버튼 스타일 적용
  const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
  if (activeBtn) {
    activeBtn.classList.remove('bg-surface-100', 'text-navy-600', 'hover:bg-surface-200');
    activeBtn.classList.add('bg-navy-800', 'text-white', 'shadow-md');
  }

  // 모든 패널 숨기기
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.add('hidden');
  });

  // 선택된 패널 보이기
  const activePanel = document.querySelector(`.tab-panel[data-tab="${tabName}"]`);
  if (activePanel) {
    activePanel.classList.remove('hidden');
  }

  // 스크롤 위치 조정 (모바일에서 탭 클릭 시)
  window.scrollTo({ top: document.querySelector('#topic-tabs').offsetTop - 80, behavior: 'smooth' });
}
</script>
