<%# PDF 도구 - 분할, 합치기, 쪽번호 %>

<!-- 페이지 헤더 -->
<section class="gradient-navy text-white py-12 lg:py-16">
  <div class="container-wide">
    <div class="flex items-start gap-5">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
        <span class="material-symbols-outlined text-4xl text-white">picture_as_pdf</span>
      </div>
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">PDF 도구</h1>
        <p class="text-navy-100 text-lg">PDF 분할, 합치기, 쪽번호 매기기</p>
      </div>
    </div>
  </div>
</section>

<!-- 탭 네비게이션 -->
<section class="bg-white border-b border-gray-200 sticky top-16 z-40">
  <div class="container-wide">
    <div class="flex gap-2 py-4" id="tool-tabs">
      <button class="tab-btn active px-6 py-3 rounded-xl font-semibold transition-all" data-tool="split">
        <span class="material-symbols-outlined align-middle mr-2">content_cut</span>
        PDF 분할
      </button>
      <button class="tab-btn px-6 py-3 rounded-xl font-semibold transition-all" data-tool="merge">
        <span class="material-symbols-outlined align-middle mr-2">merge</span>
        PDF 합치기
      </button>
      <button class="tab-btn px-6 py-3 rounded-xl font-semibold transition-all" data-tool="numbering">
        <span class="material-symbols-outlined align-middle mr-2">format_list_numbered</span>
        쪽번호 매기기
      </button>
    </div>
  </div>
</section>

<section class="section py-10">
  <div class="container-wide max-w-4xl">

    <!-- PDF 분할 도구 -->
    <div class="tool-panel" id="split-panel">
      <div class="card p-8">
        <h2 class="text-xl font-bold text-navy-900 mb-2 flex items-center gap-2">
          <span class="material-symbols-outlined text-forest-600">content_cut</span>
          PDF 분할
        </h2>
        <p class="text-navy-600 mb-6">PDF 파일에서 원하는 페이지만 추출하세요</p>

        <!-- 업로드 영역 -->
        <div class="upload-zone" id="split-upload-zone" data-target="split">
          <input type="file" id="split-file" accept=".pdf" class="hidden">
          <span class="material-symbols-outlined text-5xl text-navy-300 mb-4">upload_file</span>
          <p class="font-semibold text-navy-700 mb-1">PDF 파일을 드래그하거나 클릭하여 업로드</p>
          <p class="text-sm text-navy-500">최대 50MB</p>
        </div>

        <!-- 파일 정보 -->
        <div class="file-info hidden" id="split-file-info">
          <div class="flex items-center gap-4 p-4 bg-forest-50 rounded-xl mb-4">
            <span class="material-symbols-outlined text-3xl text-forest-600">description</span>
            <div class="flex-1">
              <p class="font-semibold text-navy-900" id="split-filename">-</p>
              <p class="text-sm text-navy-600"><span id="split-pagecount">0</span> 페이지</p>
            </div>
            <button class="text-navy-400 hover:text-red-500" onclick="clearFile('split')">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>

          <!-- 페이지 범위 입력 -->
          <div class="form-group mb-6">
            <label class="block font-semibold text-navy-900 mb-2">추출할 페이지 범위</label>
            <input type="text" id="split-ranges" class="input" placeholder="예: 1-3, 5, 7-10 (비우면 전체)">
            <p class="text-sm text-navy-500 mt-2">쉼표로 구분하여 여러 범위 지정 가능</p>
          </div>

          <button class="btn btn-lg btn-forest w-full" onclick="processSplit()">
            <span class="material-symbols-outlined">content_cut</span>
            PDF 분할하기
          </button>
        </div>
      </div>
    </div>

    <!-- PDF 합치기 도구 -->
    <div class="tool-panel hidden" id="merge-panel">
      <div class="card p-8">
        <h2 class="text-xl font-bold text-navy-900 mb-2 flex items-center gap-2">
          <span class="material-symbols-outlined text-forest-600">merge</span>
          PDF 합치기
        </h2>
        <p class="text-navy-600 mb-6">여러 PDF 파일을 하나로 합치세요</p>

        <!-- 업로드 영역 -->
        <div class="upload-zone" id="merge-upload-zone" data-target="merge">
          <input type="file" id="merge-files" accept=".pdf" multiple class="hidden">
          <span class="material-symbols-outlined text-5xl text-navy-300 mb-4">upload_file</span>
          <p class="font-semibold text-navy-700 mb-1">PDF 파일들을 드래그하거나 클릭하여 업로드</p>
          <p class="text-sm text-navy-500">여러 파일 선택 가능 (최대 20개)</p>
        </div>

        <!-- 파일 목록 -->
        <div class="file-list hidden" id="merge-file-list">
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-semibold text-navy-900">업로드된 파일 (<span id="merge-count">0</span>개)</h4>
            <button class="text-sm text-navy-500 hover:text-red-500" onclick="clearAllMergeFiles()">전체 삭제</button>
          </div>
          <ul class="space-y-2 mb-6" id="merge-items"></ul>
          <p class="text-sm text-navy-500 mb-4">
            <span class="material-symbols-outlined align-middle text-sm">info</span>
            드래그하여 순서 변경 가능
          </p>
          <button class="btn btn-lg btn-forest w-full" onclick="processMerge()">
            <span class="material-symbols-outlined">merge</span>
            PDF 합치기
          </button>
        </div>
      </div>
    </div>

    <!-- 쪽번호 매기기 도구 -->
    <div class="tool-panel hidden" id="numbering-panel">
      <div class="card p-8">
        <h2 class="text-xl font-bold text-navy-900 mb-2 flex items-center gap-2">
          <span class="material-symbols-outlined text-forest-600">format_list_numbered</span>
          쪽번호 매기기
        </h2>
        <p class="text-navy-600 mb-6">PDF에 페이지 번호를 자동으로 추가하세요</p>

        <!-- 업로드 영역 -->
        <div class="upload-zone" id="numbering-upload-zone" data-target="numbering">
          <input type="file" id="numbering-file" accept=".pdf" class="hidden">
          <span class="material-symbols-outlined text-5xl text-navy-300 mb-4">upload_file</span>
          <p class="font-semibold text-navy-700 mb-1">PDF 파일을 드래그하거나 클릭하여 업로드</p>
          <p class="text-sm text-navy-500">최대 50MB</p>
        </div>

        <!-- 옵션 -->
        <div class="numbering-options hidden" id="numbering-options">
          <div class="flex items-center gap-4 p-4 bg-forest-50 rounded-xl mb-6">
            <span class="material-symbols-outlined text-3xl text-forest-600">description</span>
            <div class="flex-1">
              <p class="font-semibold text-navy-900" id="numbering-filename">-</p>
              <p class="text-sm text-navy-600"><span id="numbering-pagecount">0</span> 페이지</p>
            </div>
            <button class="text-navy-400 hover:text-red-500" onclick="clearFile('numbering')">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 위치 선택 -->
            <div class="form-group">
              <label class="block font-semibold text-navy-900 mb-2">번호 위치</label>
              <select id="numbering-position" class="input">
                <option value="bottom_center">하단 중앙</option>
                <option value="bottom_left">하단 왼쪽</option>
                <option value="bottom_right">하단 오른쪽</option>
                <option value="top_center">상단 중앙</option>
                <option value="top_left">상단 왼쪽</option>
                <option value="top_right">상단 오른쪽</option>
              </select>
            </div>

            <!-- 시작 번호 -->
            <div class="form-group">
              <label class="block font-semibold text-navy-900 mb-2">시작 번호</label>
              <input type="number" id="numbering-start" class="input" value="1" min="1">
            </div>

            <!-- 번호 형식 -->
            <div class="form-group">
              <label class="block font-semibold text-navy-900 mb-2">번호 형식</label>
              <select id="numbering-format" class="input">
                <option value="number">1, 2, 3...</option>
                <option value="dash">- 1 -, - 2 -...</option>
                <option value="parenthesis">(1), (2)...</option>
                <option value="of_total">1 / 10, 2 / 10...</option>
                <option value="page_of">1페이지 / 10페이지...</option>
              </select>
            </div>

            <!-- 글자 크기 -->
            <div class="form-group">
              <label class="block font-semibold text-navy-900 mb-2">글자 크기</label>
              <select id="numbering-fontsize" class="input">
                <option value="8">8pt</option>
                <option value="10" selected>10pt</option>
                <option value="12">12pt</option>
                <option value="14">14pt</option>
              </select>
            </div>
          </div>

          <!-- 첫 페이지 건너뛰기 -->
          <label class="flex items-center gap-3 mb-6 cursor-pointer">
            <input type="checkbox" id="numbering-skip-first" class="w-5 h-5 rounded accent-forest-600">
            <span class="text-navy-700">첫 페이지 번호 생략 (표지 등)</span>
          </label>

          <button class="btn btn-lg btn-forest w-full" onclick="processNumbering()">
            <span class="material-symbols-outlined">format_list_numbered</span>
            쪽번호 추가하기
          </button>
        </div>
      </div>
    </div>

    <!-- 처리 중 표시 -->
    <div class="processing-overlay hidden" id="processing-overlay">
      <div class="bg-white rounded-2xl p-8 text-center shadow-xl max-w-sm mx-auto">
        <div class="animate-spin w-12 h-12 border-4 border-forest-200 border-t-forest-600 rounded-full mx-auto mb-4"></div>
        <p class="font-semibold text-navy-900 mb-2">처리 중...</p>
        <p class="text-sm text-navy-600" id="processing-status">PDF를 처리하고 있습니다</p>
      </div>
    </div>

  </div>
</section>

<style>
  .gradient-navy {
    background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
  }

  .tab-btn {
    background: #f1f5f9;
    color: #475569;
  }
  .tab-btn:hover {
    background: #e2e8f0;
  }
  .tab-btn.active {
    background: #2e7d32;
    color: white;
  }

  .upload-zone {
    border: 3px dashed #cbd5e1;
    border-radius: 16px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #f8fafc;
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: #2e7d32;
    background: #f0fdf4;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #f1f5f9;
    border-radius: 10px;
    cursor: grab;
  }
  .file-item:active {
    cursor: grabbing;
  }
  .file-item.dragging {
    opacity: 0.5;
    background: #e2e8f0;
  }

  .processing-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .processing-overlay.hidden {
    display: none;
  }

  .input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    transition: border-color 0.2s;
  }
  .input:focus {
    outline: none;
    border-color: #2e7d32;
  }

  .btn-forest {
    background: linear-gradient(135deg, #2e7d32, #4caf50);
    color: white;
    padding: 14px 24px;
    border-radius: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-forest:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(46, 125, 50, 0.3);
  }
</style>

<script>
document.addEventListener('turbo:load', function() {
  // 탭 전환
  const tabs = document.querySelectorAll('.tab-btn');
  const panels = document.querySelectorAll('.tool-panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      const tool = tab.dataset.tool;
      panels.forEach(panel => {
        panel.classList.toggle('hidden', !panel.id.startsWith(tool));
      });
    });
  });

  // 드래그 앤 드롭 설정
  setupDropZone('split-upload-zone', 'split-file', handleSplitFile);
  setupDropZone('merge-upload-zone', 'merge-files', handleMergeFiles);
  setupDropZone('numbering-upload-zone', 'numbering-file', handleNumberingFile);
});

// 드롭존 설정
function setupDropZone(zoneId, inputId, handler) {
  const zone = document.getElementById(zoneId);
  const input = document.getElementById(inputId);

  zone.addEventListener('click', () => input.click());
  input.addEventListener('change', (e) => handler(e.target.files));

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
    zone.addEventListener(event, (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  ['dragenter', 'dragover'].forEach(event => {
    zone.addEventListener(event, () => zone.classList.add('dragover'));
  });

  ['dragleave', 'drop'].forEach(event => {
    zone.addEventListener(event, () => zone.classList.remove('dragover'));
  });

  zone.addEventListener('drop', (e) => {
    handler(e.dataTransfer.files);
  });
}

// 파일 상태
let splitFile = null;
let mergeFiles = [];
let numberingFile = null;

// 분할 파일 처리
async function handleSplitFile(files) {
  if (files.length === 0) return;
  const file = files[0];

  if (!file.type.includes('pdf')) {
    showToast('PDF 파일만 업로드 가능합니다.', true);
    return;
  }

  splitFile = file;

  // 파일 정보 조회
  const formData = new FormData();
  formData.append('file', file);

  try {
    const response = await fetch('/pdf_tools/info', {
      method: 'POST',
      headers: { 'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || '' },
      body: formData
    });
    const info = await response.json();

    document.getElementById('split-filename').textContent = info.file_name;
    document.getElementById('split-pagecount').textContent = info.page_count;
    document.getElementById('split-upload-zone').classList.add('hidden');
    document.getElementById('split-file-info').classList.remove('hidden');
  } catch (error) {
    document.getElementById('split-filename').textContent = file.name;
    document.getElementById('split-pagecount').textContent = '?';
    document.getElementById('split-upload-zone').classList.add('hidden');
    document.getElementById('split-file-info').classList.remove('hidden');
  }
}

// 합치기 파일 처리
function handleMergeFiles(files) {
  const pdfFiles = Array.from(files).filter(f => f.type.includes('pdf'));

  if (pdfFiles.length === 0) {
    showToast('PDF 파일만 업로드 가능합니다.', true);
    return;
  }

  mergeFiles = mergeFiles.concat(pdfFiles);
  updateMergeList();
}

function updateMergeList() {
  const list = document.getElementById('merge-items');
  const count = document.getElementById('merge-count');

  if (mergeFiles.length === 0) {
    document.getElementById('merge-upload-zone').classList.remove('hidden');
    document.getElementById('merge-file-list').classList.add('hidden');
    return;
  }

  document.getElementById('merge-upload-zone').classList.add('hidden');
  document.getElementById('merge-file-list').classList.remove('hidden');

  count.textContent = mergeFiles.length;
  list.innerHTML = mergeFiles.map((file, index) => `
    <li class="file-item" draggable="true" data-index="${index}">
      <span class="material-symbols-outlined text-navy-400">drag_indicator</span>
      <span class="material-symbols-outlined text-red-500">picture_as_pdf</span>
      <span class="flex-1 text-navy-900 truncate">${file.name}</span>
      <button class="text-navy-400 hover:text-red-500" onclick="removeMergeFile(${index})">
        <span class="material-symbols-outlined">close</span>
      </button>
    </li>
  `).join('');

  // 드래그 정렬
  setupDragSort();
}

function setupDragSort() {
  const items = document.querySelectorAll('.file-item');
  let draggedItem = null;

  items.forEach(item => {
    item.addEventListener('dragstart', () => {
      draggedItem = item;
      item.classList.add('dragging');
    });

    item.addEventListener('dragend', () => {
      item.classList.remove('dragging');
      draggedItem = null;
    });

    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      if (draggedItem && draggedItem !== item) {
        const list = item.parentNode;
        const items = [...list.querySelectorAll('.file-item')];
        const draggedIdx = items.indexOf(draggedItem);
        const targetIdx = items.indexOf(item);

        if (draggedIdx < targetIdx) {
          item.after(draggedItem);
        } else {
          item.before(draggedItem);
        }

        // 배열 순서 업데이트
        const newOrder = [...list.querySelectorAll('.file-item')].map(i => parseInt(i.dataset.index));
        const newFiles = newOrder.map(idx => mergeFiles[idx]);
        mergeFiles = newFiles;
      }
    });
  });
}

function removeMergeFile(index) {
  mergeFiles.splice(index, 1);
  updateMergeList();
}

function clearAllMergeFiles() {
  mergeFiles = [];
  updateMergeList();
}

// 쪽번호 파일 처리
async function handleNumberingFile(files) {
  if (files.length === 0) return;
  const file = files[0];

  if (!file.type.includes('pdf')) {
    showToast('PDF 파일만 업로드 가능합니다.', true);
    return;
  }

  numberingFile = file;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const response = await fetch('/pdf_tools/info', {
      method: 'POST',
      headers: { 'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || '' },
      body: formData
    });
    const info = await response.json();

    document.getElementById('numbering-filename').textContent = info.file_name;
    document.getElementById('numbering-pagecount').textContent = info.page_count;
  } catch (error) {
    document.getElementById('numbering-filename').textContent = file.name;
    document.getElementById('numbering-pagecount').textContent = '?';
  }

  document.getElementById('numbering-upload-zone').classList.add('hidden');
  document.getElementById('numbering-options').classList.remove('hidden');
}

// 파일 초기화
function clearFile(tool) {
  if (tool === 'split') {
    splitFile = null;
    document.getElementById('split-file').value = '';
    document.getElementById('split-upload-zone').classList.remove('hidden');
    document.getElementById('split-file-info').classList.add('hidden');
  } else if (tool === 'numbering') {
    numberingFile = null;
    document.getElementById('numbering-file').value = '';
    document.getElementById('numbering-upload-zone').classList.remove('hidden');
    document.getElementById('numbering-options').classList.add('hidden');
  }
}

// 처리 함수들
function showProcessing(message) {
  document.getElementById('processing-status').textContent = message;
  document.getElementById('processing-overlay').classList.remove('hidden');
}

function hideProcessing() {
  document.getElementById('processing-overlay').classList.add('hidden');
}

async function processSplit() {
  if (!splitFile) {
    showToast('PDF 파일을 먼저 업로드해주세요.', true);
    return;
  }

  showProcessing('PDF를 분할하고 있습니다...');

  const formData = new FormData();
  formData.append('file', splitFile);
  formData.append('ranges', document.getElementById('split-ranges').value);

  try {
    const response = await fetch('/pdf_tools/split', {
      method: 'POST',
      headers: { 'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || '' },
      body: formData
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error);
    }

    const blob = await response.blob();
    const contentType = response.headers.get('content-type');
    const filename = contentType.includes('zip') ? 'split_pdfs.zip' : 'split.pdf';

    downloadBlob(blob, filename);
    hideProcessing();
  } catch (error) {
    hideProcessing();
    showToast('오류: ' + error.message, true);
  }
}

async function processMerge() {
  if (mergeFiles.length < 2) {
    showToast('2개 이상의 PDF 파일을 업로드해주세요.', true);
    return;
  }

  showProcessing('PDF를 합치고 있습니다...');

  const formData = new FormData();
  mergeFiles.forEach(file => {
    formData.append('files[]', file);
  });

  try {
    const response = await fetch('/pdf_tools/merge', {
      method: 'POST',
      headers: { 'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || '' },
      body: formData
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error);
    }

    const blob = await response.blob();
    downloadBlob(blob, 'merged.pdf');
    hideProcessing();
  } catch (error) {
    hideProcessing();
    showToast('오류: ' + error.message, true);
  }
}

async function processNumbering() {
  if (!numberingFile) {
    showToast('PDF 파일을 먼저 업로드해주세요.', true);
    return;
  }

  showProcessing('쪽번호를 추가하고 있습니다...');

  const formData = new FormData();
  formData.append('file', numberingFile);
  formData.append('position', document.getElementById('numbering-position').value);
  formData.append('start_number', document.getElementById('numbering-start').value);
  formData.append('format', document.getElementById('numbering-format').value);
  formData.append('font_size', document.getElementById('numbering-fontsize').value);
  formData.append('skip_first', document.getElementById('numbering-skip-first').checked);

  try {
    const response = await fetch('/pdf_tools/add_page_numbers', {
      method: 'POST',
      headers: { 'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || '' },
      body: formData
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error);
    }

    const blob = await response.blob();
    downloadBlob(blob, 'numbered.pdf');
    hideProcessing();
  } catch (error) {
    hideProcessing();
    showToast('오류: ' + error.message, true);
  }
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function showToast(message, isError = false) {
  const existing = document.querySelector('.pdf-toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.className = 'pdf-toast';
  toast.style.cssText = `position:fixed;bottom:24px;right:24px;padding:16px 24px;border-radius:12px;color:white;font-weight:500;background:${isError ? '#dc2626' : '#1e3a5f'};box-shadow:0 8px 24px rgba(0,0,0,0.2);z-index:1000;animation:fadeIn 0.3s ease;`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}
</script>
