<%# ë¬¼ëŸ‰ë‚´ì—­ì„œ + ì‹œë°©ì„œ ìƒì„±ê¸° %>

<style>
.ce-step-card { background:#fff; border-radius:16px; border:1px solid #e5e7eb; padding:32px; margin-bottom:24px; display:none; }
.ce-step-card.active { display:block; }
.ce-type-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:16px; }
.ce-type-btn { background:#fff; border:2px solid #e5e7eb; border-radius:14px; padding:24px 16px; text-align:center; cursor:pointer; transition:all .2s; }
.ce-type-btn:hover { border-color:#6366f1; background:#eef2ff; }
.ce-type-btn.selected { border-color:#4f46e5; background:#eef2ff; box-shadow:0 0 0 3px rgba(79,70,229,.15); position:relative; }
.ce-type-btn .ce-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin:0 auto 12px; background:#f1f5f9; }
.ce-type-btn.selected .ce-icon { background:#4f46e5; color:#fff; }
.ce-type-btn.selected .ce-icon .material-symbols-outlined { color:#fff; }
.ce-type-btn .ce-check { position:absolute; top:8px; right:8px; width:24px; height:24px; border-radius:50%; background:#4f46e5; color:#fff; display:none; align-items:center; justify-content:center; font-size:16px; }
.ce-type-btn.selected .ce-check { display:flex; }
.ce-type-btn .ce-type-name { font-weight:700; color:#1e293b; font-size:15px; }
.ce-type-btn .ce-type-desc { font-size:13px; color:#64748b; margin-top:4px; }

.ce-form-group { margin-bottom:18px; }
.ce-form-group label { display:block; font-weight:600; font-size:14px; color:#334155; margin-bottom:6px; }
.ce-form-group input, .ce-form-group textarea { width:100%; border:1px solid #d1d5db; border-radius:10px; padding:10px 14px; font-size:14px; }
.ce-form-group input:focus, .ce-form-group textarea:focus { outline:none; border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79,70,229,.1); }
.ce-form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }

.ce-table-wrap { overflow-x:auto; margin:16px 0; }
.ce-table { width:100%; border-collapse:collapse; font-size:14px; }
.ce-table th { background:#f8fafc; padding:10px 12px; text-align:center; border-bottom:2px solid #e2e8f0; color:#475569; font-weight:600; font-size:13px; white-space:nowrap; }
.ce-table td { padding:8px 10px; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
.ce-table td input { width:100%; border:1px solid #e5e7eb; border-radius:8px; padding:7px 10px; font-size:13px; text-align:right; }
.ce-table td input.text-left { text-align:left; }
.ce-table td input:focus { outline:none; border-color:#4f46e5; }
.ce-table .row-num { text-align:center; color:#94a3b8; font-weight:600; width:40px; }
.ce-table .row-del { text-align:center; width:40px; }
.ce-table .row-del button { background:none; border:none; color:#ef4444; cursor:pointer; font-size:18px; padding:4px; border-radius:6px; }
.ce-table .row-del button:hover { background:#fef2f2; }
.ce-table .amount-cell { text-align:right; font-weight:600; color:#1e293b; padding-right:14px; min-width:100px; }
.ce-add-row { display:flex; align-items:center; gap:6px; color:#4f46e5; font-weight:600; font-size:14px; cursor:pointer; padding:8px 12px; border-radius:8px; border:1px dashed #c7d2fe; background:#fafafe; margin-top:8px; }
.ce-add-row:hover { background:#eef2ff; }

.ce-summary { background:#f8fafc; border-radius:12px; padding:20px 24px; margin-top:20px; }
.ce-summary-row { display:flex; justify-content:space-between; padding:6px 0; font-size:14px; }
.ce-summary-row.total { border-top:2px solid #cbd5e1; margin-top:8px; padding-top:12px; font-size:16px; font-weight:700; color:#1e293b; }
.ce-summary-label { color:#64748b; }
.ce-summary-value { font-weight:600; color:#334155; }

.ce-btn { display:inline-flex; align-items:center; gap:6px; padding:12px 28px; border-radius:12px; font-weight:600; font-size:15px; border:none; cursor:pointer; transition:all .2s; }
.ce-btn-primary { background:#4f46e5; color:#fff; }
.ce-btn-primary:hover { background:#4338ca; }
.ce-btn-secondary { background:#f1f5f9; color:#475569; }
.ce-btn-secondary:hover { background:#e2e8f0; }
.ce-btn-success { background:#059669; color:#fff; }
.ce-btn-success:hover { background:#047857; }
.ce-btn-info { background:#0ea5e9; color:#fff; }
.ce-btn-info:hover { background:#0284c7; }
.ce-btn:disabled { opacity:.5; cursor:not-allowed; }

.ce-step-indicator { display:flex; gap:8px; margin-bottom:28px; }
.ce-step-dot { width:10px; height:10px; border-radius:50%; background:#e2e8f0; transition:all .2s; }
.ce-step-dot.active { background:#4f46e5; width:28px; border-radius:5px; }
.ce-step-dot.done { background:#059669; }

.ce-section-title { font-size:22px; font-weight:700; color:#1e293b; margin-bottom:6px; }
.ce-section-desc { font-size:14px; color:#64748b; margin-bottom:24px; }

.ce-instruction-box { background:#fffbeb; border:1px solid #fde68a; border-radius:12px; padding:20px; margin:16px 0; }
.ce-instruction-box h4 { font-weight:700; color:#92400e; margin-bottom:8px; }
.ce-instruction-box pre { white-space:pre-wrap; font-family:inherit; font-size:14px; color:#78350f; line-height:1.7; }

/* ì¸ì‡„ìš© ì¶œë ¥ */
.ce-print-area { display:none; }

.ce-result-section { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:28px; margin-bottom:20px; }
.ce-result-title { font-size:18px; font-weight:700; color:#1e293b; margin-bottom:16px; padding-bottom:12px; border-bottom:2px solid #e2e8f0; display:flex; align-items:center; gap:8px; }

@media print {
  body * { visibility:hidden; }
  .ce-print-area, .ce-print-area * { visibility:visible; }
  .ce-print-area { display:block !important; position:absolute; left:0; top:0; width:100%; padding:20px; }
  .ce-print-table { width:100%; border-collapse:collapse; font-size:12px; }
  .ce-print-table th, .ce-print-table td { border:1px solid #333; padding:6px 8px; }
  .ce-print-table th { background:#f0f0f0; font-weight:bold; }
  .print-header { text-align:center; margin-bottom:20px; }
  .print-header h2 { font-size:20px; margin-bottom:4px; }
  .print-info { margin:12px 0; font-size:13px; }
  .print-info td { padding:4px 12px; }
  .print-sign { margin-top:30px; text-align:right; }
  .print-sign table { margin-left:auto; border-collapse:collapse; }
  .print-sign td { border:1px solid #333; padding:8px 20px; text-align:center; min-width:70px; }
  .no-print { display:none !important; }
}

@keyframes ceSpin { to { transform:rotate(360deg); } }
.ce-ai-filled { background:#f0fdf4 !important; border-color:#86efac !important; }

.ce-contract-type-btn { padding:16px; border:2px solid #e5e7eb; border-radius:12px; cursor:pointer; transition:all .2s; background:#fff; }
.ce-contract-type-btn:hover { border-color:#6366f1; background:#f8fafc; }
.ce-contract-type-btn.selected { border-color:#4f46e5; background:#eef2ff; box-shadow:0 0 0 3px rgba(79,70,229,.1); }

@media (max-width:640px) {
  .ce-type-grid { grid-template-columns:repeat(2, 1fr); gap:10px; }
  .ce-type-btn { padding:16px 10px; }
  .ce-form-row { grid-template-columns:1fr; }
  .ce-table td input { padding:5px 6px; font-size:12px; }
}
</style>

<!-- í—¤ë” -->
<section class="gradient-premium text-white py-12 lg:py-16">
  <div class="container-wide">
    <div class="flex items-start gap-5">
      <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
        <span class="material-symbols-outlined text-4xl text-white">receipt_long</span>
      </div>
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">ë¬¼ëŸ‰ë‚´ì—­ì„œ + ì‹œë°©ì„œ ìƒì„±ê¸°</h1>
        <p class="text-slate-200 text-lg">ì†Œì•¡ê³µì‚¬ ê°„ì´ ë¬¼ëŸ‰ë‚´ì—­ì„œì™€ ì‹œë°©ì„œë¥¼ ê°„í¸í•˜ê²Œ ì‘ì„±</p>
      </div>
    </div>
  </div>
</section>

<!-- ë„êµ¬ ì„¤ëª… ì„¹ì…˜ -->
<section class="py-8 bg-gradient-to-b from-purple-50 to-white">
  <div class="container-wide max-w-4xl">
    <div class="bg-white rounded-2xl shadow-sm border border-purple-100 p-8">
      <h2 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-purple-600">info</span>
        ì´ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 
      </h2>
      <div class="text-slate-700 leading-relaxed space-y-4 mb-6">
        <p>
          ê³µì‚¬ê³„ì•½ì—ì„œ ë¬¼ëŸ‰ë‚´ì—­ì„œì™€ ì‹œë°©ì„œëŠ” ê³„ì•½ê¸ˆì•¡ ì‚°ì •ê³¼ ì‹œê³µí’ˆì§ˆ í™•ë³´ë¥¼ ìœ„í•´ í•„ìˆ˜ì ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•˜ëŠ” ì„œë¥˜ì…ë‹ˆë‹¤.
          ì§€ë°©ê³„ì•½ë²• ì‹œí–‰ë ¹ ì œ15ì¡°ì— ë”°ë¼ ê³µì‚¬ê³„ì•½ ì²´ê²° ì‹œ ë°˜ë“œì‹œ ì²¨ë¶€í•´ì•¼ í•˜ë©°, ì´ë¥¼ ëˆ„ë½í•˜ë©´ ê°ì‚¬ ì§€ì ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          íŠ¹íˆ 5ì²œë§Œì› ë¯¸ë§Œ ì†Œì•¡ê³µì‚¬ì˜ ê²½ìš°ì—ë„ ê°„ì´ í˜•íƒœë¡œë¼ë„ ë¬¼ëŸ‰ë‚´ì—­ì„œì™€ ì‹œë°©ì„œë¥¼ ê°–ì¶°ì•¼ í•˜ëŠ”ë°,
          ì‹¤ë¬´ì—ì„œëŠ” ë§¤ë²ˆ ìƒˆë¡œ ì‘ì„±í•˜ê¸° ë²ˆê±°ë¡­ê³  í•­ëª© ëˆ„ë½ì´ ìì£¼ ë°œìƒí•©ë‹ˆë‹¤.
          ì´ ë„êµ¬ëŠ” ê³µì‚¬ ìœ í˜•ê³¼ ê·œëª¨ë¥¼ ì„ íƒí•˜ë©´ í‘œì¤€í’ˆì…ˆì— ê¸°ë°˜í•œ ë¬¼ëŸ‰ë‚´ì—­ì„œ ì–‘ì‹ê³¼ ê³µì‚¬ì‹œë°©ì„œ ì£¼ìš” í•­ëª©ì„ ìë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì–´,
          ë‹´ë‹¹ìê°€ ì„¸ë¶€ ë‚´ìš©ë§Œ ìˆ˜ì •í•˜ë©´ ê³„ì•½ì„œë¥˜ë¥¼ ë¹ ë¥´ê²Œ ì™„ì„±í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•©ë‹ˆë‹¤.
        </p>
      </div>

      <h3 class="text-lg font-semibold text-slate-900 mb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-purple-600">check_circle</span>
        ì£¼ìš” ê¸°ëŠ¥
      </h3>
      <ul class="space-y-2 mb-6 text-slate-700">
        <li class="flex items-start gap-2">
          <span class="material-symbols-outlined text-purple-500 text-xl mt-0.5">arrow_right</span>
          <span>ê³µì‚¬ ìœ í˜•ë³„(í† ëª©, ê±´ì¶•, ì „ê¸°, í†µì‹ , ì¡°ê²½) ë¬¼ëŸ‰ë‚´ì—­ì„œ ì–‘ì‹ ìë™ ìƒì„±</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="material-symbols-outlined text-purple-500 text-xl mt-0.5">arrow_right</span>
          <span>í‘œì¤€í’ˆì…ˆ ê¸°ë°˜ ê³µì¢…ë³„ ì„¸ë¶€ í•­ëª© ë° ë‹¨ìœ„ ìë™ êµ¬ì„±</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="material-symbols-outlined text-purple-500 text-xl mt-0.5">arrow_right</span>
          <span>ì‹œë°©ì„œ í•„ìˆ˜ í•­ëª©(ê³µì‚¬ê°œìš”, ì¬ë£Œ ê·œê²©, ì‹œê³µë°©ë²•, í’ˆì§ˆê´€ë¦¬) í…œí”Œë¦¿ ì œê³µ</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="material-symbols-outlined text-purple-500 text-xl mt-0.5">arrow_right</span>
          <span>ì†Œì•¡ê³µì‚¬ìš© ê°„ì´ì–‘ì‹ê³¼ ì¼ë°˜ê³µì‚¬ìš© ìƒì„¸ì–‘ì‹ ì„ íƒ ê°€ëŠ¥</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="material-symbols-outlined text-purple-500 text-xl mt-0.5">arrow_right</span>
          <span>ì—‘ì…€ íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸° â†’ ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í¸ì§‘ ê°€ëŠ¥</span>
        </li>
      </ul>

      <h3 class="text-lg font-semibold text-slate-900 mb-3 flex items-center gap-2">
        <span class="material-symbols-outlined text-amber-600">warning</span>
        ì£¼ì˜ì‚¬í•­
      </h3>
      <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded">
        <p class="text-sm text-slate-700 leading-relaxed">
          ë³¸ ë„êµ¬ëŠ” ê³„ì•½ì„œë¥˜ ì‘ì„± ì‹œê°„ì„ ë‹¨ì¶•í•˜ê¸° ìœ„í•œ í…œí”Œë¦¿ ìƒì„± ë„êµ¬ì…ë‹ˆë‹¤.
          ìƒì„±ëœ ë¬¼ëŸ‰ë‚´ì—­ì„œì™€ ì‹œë°©ì„œëŠ” ë°˜ë“œì‹œ í•´ë‹¹ ê³µì‚¬ì˜ ì„¤ê³„ë„ì„œ ë° í˜„ì¥ ì—¬ê±´ì„ ë°˜ì˜í•˜ì—¬ ìˆ˜ì •Â·ë³´ì™„í•´ì•¼ í•˜ë©°,
          ìˆ˜ëŸ‰ ë° ë‹¨ê°€ëŠ” ì‹¤ì œ ê²¬ì  ë˜ëŠ” ì›ê°€ê³„ì‚°ì„ í†µí•´ ê²€ì¦ëœ ê°’ìœ¼ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
          ì§€ë°©ê³„ì•½ë²• ì‹œí–‰ë ¹ ì œ15ì¡° ë° ì…ì°° ë° ê³„ì•½ì§‘í–‰ê¸°ì¤€ì— ë”°ë¥¸ ì„œë¥˜ ìš”ê±´ ì¶©ì¡± ì—¬ë¶€ëŠ” ë‹´ë‹¹ìê°€ ìµœì¢… í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
        </p>
      </div>
    </div>
  </div>
</section>

<section class="py-10">
  <div class="container-wide max-w-4xl">

    <!-- Step Indicator -->
    <div class="ce-step-indicator" id="ce-steps">
      <div class="ce-step-dot active"></div>
      <div class="ce-step-dot"></div>
      <div class="ce-step-dot"></div>
      <div class="ce-step-dot"></div>
    </div>

    <!-- Step 1: ê³µì‚¬ìœ í˜• ì„ íƒ -->
    <div class="ce-step-card active" id="ce-step1">
      <h2 class="ce-section-title">ê³µì‚¬ìœ í˜• ì„ íƒ</h2>
      <p class="ce-section-desc">ë¬¼ëŸ‰ë‚´ì—­ì„œë¥¼ ì‘ì„±í•  ê³µì‚¬ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥). ìœ í˜•ë³„ ê¸°ë³¸ í•­ëª©ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>

      <div class="ce-type-grid" id="ce-type-grid">
        <% @construction_types.each do |type| %>
          <div class="ce-type-btn" data-type="<%= type[:id] %>" onclick="ceSelectType(this)">
            <div class="ce-check">
              <span class="material-symbols-outlined" style="font-size:16px;">check</span>
            </div>
            <div class="ce-icon">
              <span class="material-symbols-outlined text-2xl text-indigo-500"><%= type[:icon] %></span>
            </div>
            <div class="ce-type-name"><%= type[:name] %></div>
            <div class="ce-type-desc"><%= type[:desc] %></div>
          </div>
        <% end %>
      </div>

      <!-- AI ë¬¸ì„œ ë¶„ì„ (ì„ íƒì‚¬í•­) -->
      <div id="ce-ai-upload" style="display:none; margin-top:24px; padding-top:20px; border-top:1px solid #e5e7eb;">
        <%= render 'shared/quote_upload_zone', tool_id: 'ce' %>
      </div>

      <div style="margin-top:24px; text-align:right;">
        <button class="ce-btn ce-btn-primary" id="ce-btn-step1" disabled onclick="ceGoStep(2)">
          ë‹¤ìŒ <span class="material-symbols-outlined text-lg">arrow_forward</span>
        </button>
      </div>
    </div>

    <!-- Step 2: ê¸°ë³¸ì •ë³´ ì…ë ¥ -->
    <div class="ce-step-card" id="ce-step2">
      <h2 class="ce-section-title">ê¸°ë³¸ì •ë³´ ì…ë ¥</h2>
      <p class="ce-section-desc">ê³µì‚¬ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>

      <!-- ê³„ì•½ ë°©ì‹ ì„ íƒ -->
      <div class="ce-form-group" style="margin-bottom:24px; padding:16px; background:#f8fafc; border-radius:12px; border:1px solid #e5e7eb;">
        <label style="margin-bottom:12px;">ê³„ì•½ ë°©ì‹ *</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="ce-contract-type-btn selected" data-type="private" onclick="ceSelectContractType(this)">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
              <span class="material-symbols-outlined text-lg text-indigo-600">handshake</span>
              <strong>ìˆ˜ì˜ê³„ì•½</strong>
            </div>
            <div style="font-size:12px; color:#64748b;">ê°„ì†Œí™” (ì‹œë°©ì„œ + í’ˆëª© ë¦¬ìŠ¤íŠ¸)</div>
          </div>
          <div class="ce-contract-type-btn" data-type="bidding" onclick="ceSelectContractType(this)">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
              <span class="material-symbols-outlined text-lg text-indigo-600">gavel</span>
              <strong>ê²½ìŸì…ì°°</strong>
            </div>
            <div style="font-size:12px; color:#64748b;">ìƒì„¸ ë‚´ì—­ (ê°„ì ‘ë¹„ í¬í•¨)</div>
          </div>
        </div>
        <p style="font-size:13px; color:#64748b; margin-top:8px; line-height:1.5;">
          ğŸ’¡ ìˆ˜ì˜ê³„ì•½: ê°„ì ‘ë¹„ ê³„ì‚° ì—†ì´ í’ˆëª©ê³¼ ì‹œë°©ì„œë§Œ ìƒì„± (ì¼ë°˜ì )<br>
          ğŸ’¡ ê²½ìŸì…ì°°: ì¼ë°˜ê´€ë¦¬ë¹„Â·ì´ìœ¤ ë“± ê°„ì ‘ë¹„ í¬í•¨ ìƒì„¸ ë‚´ì—­ ìƒì„±
        </p>
      </div>

      <div class="ce-form-group">
        <label>ê³µì‚¬ëª… *</label>
        <input type="text" id="ce-project-name" placeholder="ì˜ˆ: ë³¸ê´€ 2ì¸µ í™”ì¥ì‹¤ ë°©ìˆ˜ê³µì‚¬">
      </div>
      <div class="ce-form-row">
        <div class="ce-form-group">
          <label>ê³µì‚¬ ì¥ì†Œ</label>
          <input type="text" id="ce-location" placeholder="ì˜ˆ: ë³¸ê´€ 2ì¸µ">
        </div>
        <div class="ce-form-group">
          <label>ê³µì‚¬ ê¸°ê°„</label>
          <input type="text" id="ce-duration" placeholder="ì˜ˆ: 2026.3.1 ~ 2026.3.15">
        </div>
      </div>
      <div class="ce-form-row">
        <div class="ce-form-group">
          <label>ë‹´ë‹¹ ë¶€ì„œ</label>
          <input type="text" id="ce-department" placeholder="ì˜ˆ: ì´ë¬´ê³¼">
        </div>
        <div class="ce-form-group">
          <label>ë‹´ë‹¹ì</label>
          <input type="text" id="ce-manager" placeholder="ì˜ˆ: í™ê¸¸ë™">
        </div>
      </div>

      <!-- ê²°ì¬ë¼ì¸ ì…ë ¥ -->
      <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
        <div style="margin-bottom:12px;">
          <label style="display:block; font-weight:600; font-size:14px; color:#334155; margin-bottom:8px;">ê²°ì¬ë¼ì¸ (ì„ íƒ)</label>
          <p style="font-size:13px; color:#64748b; margin-bottom:12px;">ì¶œë ¥ë¬¼ì— í¬í•¨ë  ê²°ì¬ ì§ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ë¹ˆì¹¸ìœ¼ë¡œ ë‘ë©´ í•´ë‹¹ ì¹¸ì´ ìƒëµë©ë‹ˆë‹¤.</p>
        </div>
        <div class="ce-form-row">
          <div class="ce-form-group">
            <label>ë‹´ë‹¹</label>
            <input type="text" id="ce-approval-staff" placeholder="ì˜ˆ: ì£¼ë¬´ê´€">
          </div>
          <div class="ce-form-group">
            <label>íŒ€ì¥/ê³„ì¥</label>
            <input type="text" id="ce-approval-team" placeholder="ì˜ˆ: íŒ€ì¥">
          </div>
        </div>
        <div class="ce-form-row">
          <div class="ce-form-group">
            <label>ê³¼ì¥</label>
            <input type="text" id="ce-approval-section" placeholder="ì˜ˆ: ê³¼ì¥">
          </div>
          <div class="ce-form-group">
            <label>êµ­ì¥/ë¶€ì¥</label>
            <input type="text" id="ce-approval-director" placeholder="ì˜ˆ: êµ­ì¥">
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:24px;">
        <button class="ce-btn ce-btn-secondary" onclick="ceGoStep(1)">
          <span class="material-symbols-outlined text-lg">arrow_back</span> ì´ì „
        </button>
        <button class="ce-btn ce-btn-primary" id="ce-btn-step2" onclick="ceGoStep(3)">
          ë‹¤ìŒ: ë‚´ì—­ ì…ë ¥ <span class="material-symbols-outlined text-lg">arrow_forward</span>
        </button>
      </div>
    </div>

    <!-- Step 3: ë‚´ì—­ ì…ë ¥ -->
    <div class="ce-step-card" id="ce-step3">
      <h2 class="ce-section-title">ë‚´ì—­ ì…ë ¥</h2>
      <p class="ce-section-desc">ê³µì¢…ë³„ í•­ëª©, ìˆ˜ëŸ‰, ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. í•©ê³„ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>

      <div class="ce-table-wrap">
        <table class="ce-table" id="ce-item-table">
          <thead>
            <tr>
              <th style="width:40px">No</th>
              <th style="min-width:140px">ê³µì¢…/í’ˆëª…</th>
              <th style="min-width:120px">ê·œê²©</th>
              <th style="width:70px">ë‹¨ìœ„</th>
              <th style="width:80px">ìˆ˜ëŸ‰</th>
              <th style="width:100px">ë‹¨ê°€(ì›)</th>
              <th style="width:110px">ê¸ˆì•¡(ì›)</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody id="ce-item-tbody">
          </tbody>
        </table>
      </div>

      <div class="ce-add-row" onclick="ceAddRow()">
        <span class="material-symbols-outlined">add_circle</span> í•­ëª© ì¶”ê°€
      </div>

      <!-- í•©ê³„ -->
      <div class="ce-summary" id="ce-summary">
        <div class="ce-summary-row">
          <span class="ce-summary-label">ì§ì ‘ê³µì‚¬ë¹„ (ì¬ë£Œë¹„+ë…¸ë¬´ë¹„)</span>
          <span class="ce-summary-value" id="ce-direct-cost">0 ì›</span>
        </div>
        <div id="ce-indirect-rows"></div>
        <div class="ce-summary-row">
          <span class="ce-summary-label">ì†Œê³„ (ê³µê¸‰ê°€ì•¡)</span>
          <span class="ce-summary-value" id="ce-subtotal">0 ì›</span>
        </div>
        <div class="ce-summary-row">
          <span class="ce-summary-label">ë¶€ê°€ê°€ì¹˜ì„¸ (10%)</span>
          <span class="ce-summary-value" id="ce-vat">0 ì›</span>
        </div>
        <div class="ce-summary-row total">
          <span>í•©ê³„</span>
          <span id="ce-total">0 ì›</span>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:24px;">
        <button class="ce-btn ce-btn-secondary" onclick="ceGoStep(2)">
          <span class="material-symbols-outlined text-lg">arrow_back</span> ì´ì „
        </button>
        <button class="ce-btn ce-btn-primary" onclick="ceGoStep(4)">
          ë‹¤ìŒ: ì‹œë°©ì„œ <span class="material-symbols-outlined text-lg">arrow_forward</span>
        </button>
      </div>
    </div>

    <!-- Step 4: ì‹œë°©ì„œ + ì¶œë ¥ -->
    <div class="ce-step-card" id="ce-step4">
      <h2 class="ce-section-title">ì‹œë°©ì„œ ë° ì¶œë ¥</h2>
      <p class="ce-section-desc">ì‹œë°© ë‚´ìš©ì„ í™•ì¸Â·ìˆ˜ì •í•˜ê³  ë¬¸ì„œë¥¼ ì¶œë ¥í•˜ì„¸ìš”.</p>

      <div class="ce-instruction-box">
        <h4><span class="material-symbols-outlined" style="vertical-align:middle;font-size:18px;">engineering</span> ì‹œë°© ì‚¬í•­ (ê¸°ë³¸ í…œí”Œë¦¿)</h4>
        <pre id="ce-instruction-template"></pre>
      </div>

      <div class="ce-form-group">
        <label>ì¶”ê°€ ì‹œë°© ì‚¬í•­ (ì„ íƒ)</label>
        <textarea id="ce-custom-instructions" rows="3" placeholder="ì¶”ê°€ ì‹œë°© ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>

      <!-- ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
      <div id="ce-result-area" style="display:none;">
        <div class="ce-result-section">
          <div class="ce-result-title">
            <span class="material-symbols-outlined text-indigo-500">description</span> ë¬¼ëŸ‰ë‚´ì—­ì„œ ë¯¸ë¦¬ë³´ê¸°
          </div>
          <div id="ce-result-estimate"></div>
        </div>

        <div class="ce-result-section">
          <div class="ce-result-title">
            <span class="material-symbols-outlined text-amber-600">engineering</span> ì‹œë°©ì„œ ë¯¸ë¦¬ë³´ê¸°
          </div>
          <div id="ce-result-instruction"></div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-top:24px;">
        <button class="ce-btn ce-btn-secondary" onclick="ceGoStep(3)">
          <span class="material-symbols-outlined text-lg">arrow_back</span> ì´ì „
        </button>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button class="ce-btn ce-btn-primary" onclick="ceGenerate()">
            <span class="material-symbols-outlined text-lg">auto_awesome</span> ë¬¸ì„œ ìƒì„±
          </button>
          <button class="ce-btn ce-btn-success" id="ce-btn-print" style="display:none;" onclick="cePrint('estimate')">
            <span class="material-symbols-outlined text-lg">print</span> ë¬¼ëŸ‰ë‚´ì—­ì„œ ì¸ì‡„
          </button>
          <button class="ce-btn ce-btn-info" id="ce-btn-download" style="display:none;" onclick="ceDownload('estimate')">
            <span class="material-symbols-outlined text-lg">download</span> ë¬¼ëŸ‰ë‚´ì—­ì„œ ë‹¤ìš´ë¡œë“œ
          </button>
          <button class="ce-btn ce-btn-success" id="ce-btn-print2" style="display:none;" onclick="cePrint('instruction')">
            <span class="material-symbols-outlined text-lg">print</span> ì‹œë°©ì„œ ì¸ì‡„
          </button>
          <button class="ce-btn ce-btn-info" id="ce-btn-download2" style="display:none;" onclick="ceDownload('instruction')">
            <span class="material-symbols-outlined text-lg">download</span> ì‹œë°©ì„œ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- ì¸ì‡„ìš© ì˜ì—­ -->
<div class="ce-print-area" id="ce-print-area"></div>

<script>
// ê²¬ì ì„œ ìë™ì…ë ¥ ë§¤í•‘ í•¨ìˆ˜ (ë¬¼ëŸ‰ë‚´ì—­ì„œ+ì‹œë°©ì„œìš©)
// AI íŒŒì¼ ë¶„ì„ í›„ í•„ë“œ ë§¤í•‘ í•¨ìˆ˜
window.ceNextId = window.ceNextId || 0;
window.quMapFields_ce = function(fields) {
  // ê¸°ë³¸ì •ë³´ ì…ë ¥ (Step 2)
  if (fields.project_name) quSetField('ce-project-name', fields.project_name);
  if (fields.location) quSetField('ce-location', fields.location);
  if (fields.duration) quSetField('ce-duration', fields.duration);
  if (fields.department) quSetField('ce-department', fields.department);
  if (fields.manager) quSetField('ce-manager', fields.manager);

  // í•­ëª© ìë™ì…ë ¥ (Step 3)
  if (fields.items && Array.isArray(fields.items)) {
    // ë¶„ì„ëœ í•­ëª©ìœ¼ë¡œ êµì²´
    window.ceItems = fields.items.map(function(item, idx) {
      return {
        id: ++window.ceNextId,
        name: item.name || '',
        spec: item.spec || '',
        unit: item.unit || 'ì‹',
        qty: parseFloat(item.qty) || 0,
        unit_price: parseFloat(item.unit_price) || 0,
        amount: (parseFloat(item.qty) || 0) * (parseFloat(item.unit_price) || 0)
      };
    });
    if (typeof ceRenderItems === 'function') ceRenderItems();
  }
};

document.addEventListener('turbo:load', function() {
  var ceStepCard = document.getElementById('ce-step1');
  if (!ceStepCard) return;

  var ceSelectedTypes = [];
  var ceContractType = 'private'; // ê¸°ë³¸ê°’: ìˆ˜ì˜ê³„ì•½
  window.ceItems = window.ceItems || [];
  var ceRowId = 0;
  var ceResult = null;

  var ceUploadedFile = null;
  var ceAnalyzedData = null;

  // ê³„ì•½ ë°©ì‹ ì„ íƒ
  window.ceSelectContractType = function(el) {
    var btns = document.querySelectorAll('.ce-contract-type-btn');
    for (var i = 0; i < btns.length; i++) { btns[i].classList.remove('selected'); }
    el.classList.add('selected');
    ceContractType = el.dataset.type;
  };

  // ê³µì‚¬ìœ í˜• ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ)
  window.ceSelectType = function(el) {
    var type = el.dataset.type;

    // í† ê¸€ ë°©ì‹
    if (el.classList.contains('selected')) {
      el.classList.remove('selected');
      var idx = ceSelectedTypes.indexOf(type);
      if (idx > -1) ceSelectedTypes.splice(idx, 1);
    } else {
      el.classList.add('selected');
      ceSelectedTypes.push(type);
    }

    // ìµœì†Œ 1ê°œ ì„ íƒë˜ì–´ì•¼ ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
    document.getElementById('ce-btn-step1').disabled = ceSelectedTypes.length === 0;

    // AI ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
    document.getElementById('ce-ai-upload').style.display = ceSelectedTypes.length > 0 ? 'block' : 'none';

    // ì„ íƒëœ ëª¨ë“  ìœ í˜•ì˜ ê¸°ë³¸ í•­ëª© ë¡œë“œ ë° ë³‘í•©
    ceLoadAllSelectedItems();
  };

  // ì„ íƒëœ ëª¨ë“  ê³µì‚¬ ìœ í˜•ì˜ í•­ëª©ì„ ë³‘í•©
  function ceLoadAllSelectedItems() {
    if (ceSelectedTypes.length === 0) {
      ceItems = [];
      ceRenderTable();
      return;
    }

    var allItems = [];
    var promises = ceSelectedTypes.map(function(type) {
      return fetch('/cost-estimates/default-items/' + type, {
        headers: { 'Accept': 'application/json', 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content }
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          return data.items;
        }
        return [];
      });
    });

    Promise.all(promises).then(function(itemsArrays) {
      allItems = [];
      itemsArrays.forEach(function(items) {
        allItems = allItems.concat(items);
      });
      ceItems = allItems;
      ceRenderTable();
    });
  }

  // ìŠ¤í… ì´ë™
  window.ceGoStep = function(step) {
    // Step 2 ì§„ì… ì‹œ AI ë¶„ì„ ë°ì´í„° ì ìš©
    if (step === 2 && ceAnalyzedData) {
      ceApplyAnalyzedData();
    }
    if (step === 3 && !document.getElementById('ce-project-name').value.trim()) {
      document.getElementById('ce-project-name').focus();
      document.getElementById('ce-project-name').style.borderColor = '#ef4444';
      return;
    }
    // Step 3 ì§„ì… ì‹œ AI ë¶„ì„ëœ í•­ëª© ì ìš©
    if (step === 3 && ceAnalyzedData && ceAnalyzedData.items) {
      ceApplyAnalyzedItems();
    }
    if (step === 4) {
      // ì‹œë°©ì„œ ë‚´ìš© ì„¸íŒ… (ì„ íƒëœ ëª¨ë“  ìœ í˜•ì˜ ì‹œë°©ì„œ ë³‘í•©)
      var templates = <%= raw CostEstimateGeneratorService::INSTRUCTION_TEMPLATES.to_json %>;
      var combinedTemplates = [];
      ceSelectedTypes.forEach(function(type) {
        if (templates[type]) {
          combinedTemplates.push(templates[type]);
        }
      });
      var tmpl = combinedTemplates.join('\n\n---\n\n');
      document.getElementById('ce-instruction-template').textContent = tmpl;
    }

    for (var i = 1; i <= 4; i++) {
      var card = document.getElementById('ce-step' + i);
      if (card) card.classList.remove('active');
    }
    document.getElementById('ce-step' + step).classList.add('active');

    var dots = document.querySelectorAll('.ce-step-dot');
    for (var d = 0; d < dots.length; d++) {
      dots[d].classList.remove('active', 'done');
      if (d < step - 1) dots[d].classList.add('done');
      if (d === step - 1) dots[d].classList.add('active');
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // í…Œì´ë¸” ë Œë”ë§
  function ceRenderTable() {
    var tbody = document.getElementById('ce-item-tbody');
    tbody.innerHTML = '';
    for (var i = 0; i < ceItems.length; i++) {
      var item = ceItems[i];
      item.id = item.id || (++ceRowId);
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td class="row-num">' + (i + 1) + '</td>' +
        '<td><input class="text-left" data-field="name" data-idx="' + i + '" value="' + ceEsc(item.name) + '" oninput="ceUpdateField(this)"></td>' +
        '<td><input class="text-left" data-field="spec" data-idx="' + i + '" value="' + ceEsc(item.spec) + '" oninput="ceUpdateField(this)"></td>' +
        '<td><input class="text-left" style="text-align:center" data-field="unit" data-idx="' + i + '" value="' + ceEsc(item.unit) + '" oninput="ceUpdateField(this)"></td>' +
        '<td><input type="number" data-field="qty" data-idx="' + i + '" value="' + (item.qty || 0) + '" oninput="ceUpdateField(this)" min="0" step="0.1"></td>' +
        '<td><input type="number" data-field="unit_price" data-idx="' + i + '" value="' + (item.unit_price || 0) + '" oninput="ceUpdateField(this)" min="0"></td>' +
        '<td class="amount-cell" id="ce-amt-' + i + '">' + ceComma(item.amount || 0) + '</td>' +
        '<td class="row-del"><button onclick="ceDeleteRow(' + i + ')"><span class="material-symbols-outlined">close</span></button></td>';
      tbody.appendChild(tr);
    }
    ceCalcTotal();
  }

  window.ceUpdateField = function(el) {
    var idx = parseInt(el.dataset.idx);
    var field = el.dataset.field;
    if (field === 'qty' || field === 'unit_price') {
      ceItems[idx][field] = parseFloat(el.value) || 0;
      ceItems[idx].amount = Math.round(ceItems[idx].qty * ceItems[idx].unit_price);
      var amtCell = document.getElementById('ce-amt-' + idx);
      if (amtCell) amtCell.textContent = ceComma(ceItems[idx].amount);
      ceCalcTotal();
    } else {
      ceItems[idx][field] = el.value;
    }
  };

  window.ceAddRow = function() {
    ceItems.push({ id: ++ceRowId, name: '', spec: '', unit: 'ì‹', qty: 1, unit_price: 0, amount: 0 });
    ceRenderTable();
  };

  window.ceDeleteRow = function(idx) {
    if (ceItems.length <= 1) return;
    ceItems.splice(idx, 1);
    ceRenderTable();
  };

  function ceCalcTotal() {
    var directCost = 0;
    for (var i = 0; i < ceItems.length; i++) { directCost += (ceItems[i].amount || 0); }

    document.getElementById('ce-direct-cost').textContent = ceComma(directCost) + ' ì›';

    // ìˆ˜ì˜ê³„ì•½: ê°„ì ‘ë¹„ ê³„ì‚° ì•ˆ í•¨
    if (ceContractType === 'private') {
      var vat = Math.round(directCost * 0.10);
      var total = directCost + vat;

      document.getElementById('ce-indirect-rows').innerHTML = '<div style="text-align:center; padding:12px; color:#64748b; font-size:13px;">ìˆ˜ì˜ê³„ì•½ ë°©ì‹: ê°„ì ‘ë¹„ ê³„ì‚° ìƒëµ</div>';
      document.getElementById('ce-subtotal').textContent = ceComma(directCost) + ' ì›';
      document.getElementById('ce-vat').textContent = ceComma(vat) + ' ì›';
      document.getElementById('ce-total').textContent = ceComma(total) + ' ì›';
      return;
    }

    // ê²½ìŸì…ì°°: ê°„ì ‘ë¹„ ê³„ì‚°
    var laborRatio = 0.4;
    var laborCost = Math.round(directCost * laborRatio);
    var materialOnly = directCost - laborCost;

    // ì¼ë°˜ê´€ë¦¬ë¹„
    var general = Math.round((materialOnly + laborCost) * 0.06);
    // ì´ìœ¤
    var profit = Math.round((laborCost + general) * 0.15);
    // ë³´í—˜ë£Œ
    var insurance = Math.round(laborCost * (0.036 + 0.009 + 0.089));
    // ì‚°ì—…ì•ˆì „ë³´ê±´ê´€ë¦¬ë¹„
    var safety = directCost >= 4000000 ? Math.round((materialOnly + laborCost) * 0.018) : 0;

    var subtotal = directCost + general + profit + insurance + safety;
    var vat = Math.round(subtotal * 0.10);
    var total = subtotal + vat;

    var indirectHtml = '';
    indirectHtml += '<div class="ce-summary-row"><span class="ce-summary-label">ì¼ë°˜ê´€ë¦¬ë¹„ (6%)</span><span class="ce-summary-value">' + ceComma(general) + ' ì›</span></div>';
    indirectHtml += '<div class="ce-summary-row"><span class="ce-summary-label">ì´ìœ¤ (15%)</span><span class="ce-summary-value">' + ceComma(profit) + ' ì›</span></div>';
    indirectHtml += '<div class="ce-summary-row"><span class="ce-summary-label">ë³´í—˜ë£Œ (ì‚°ì¬Â·ê³ ìš©Â·ê±´ê°•Â·ì—°ê¸ˆ)</span><span class="ce-summary-value">' + ceComma(insurance) + ' ì›</span></div>';
    if (safety > 0) {
      indirectHtml += '<div class="ce-summary-row"><span class="ce-summary-label">ì‚°ì—…ì•ˆì „ë³´ê±´ê´€ë¦¬ë¹„ (1.8%)</span><span class="ce-summary-value">' + ceComma(safety) + ' ì›</span></div>';
    }
    document.getElementById('ce-indirect-rows').innerHTML = indirectHtml;
    document.getElementById('ce-subtotal').textContent = ceComma(subtotal) + ' ì›';
    document.getElementById('ce-vat').textContent = ceComma(vat) + ' ì›';
    document.getElementById('ce-total').textContent = ceComma(total) + ' ì›';
  }

  // ë¬¸ì„œ ìƒì„±
  window.ceGenerate = function() {
    var info = {
      project_name: document.getElementById('ce-project-name').value,
      location: document.getElementById('ce-location').value,
      duration: document.getElementById('ce-duration').value,
      department: document.getElementById('ce-department').value,
      manager: document.getElementById('ce-manager').value,
      approval_staff: document.getElementById('ce-approval-staff').value,
      approval_team: document.getElementById('ce-approval-team').value,
      approval_section: document.getElementById('ce-approval-section').value,
      approval_director: document.getElementById('ce-approval-director').value
    };

    var body = {
      construction_types: ceSelectedTypes,
      contract_type: ceContractType,
      items: ceItems,
      project_name: info.project_name,
      location: info.location,
      duration: info.duration,
      department: info.department,
      manager: info.manager,
      approval_staff: info.approval_staff,
      approval_team: info.approval_team,
      approval_section: info.approval_section,
      approval_director: info.approval_director,
      custom_instructions: document.getElementById('ce-custom-instructions').value
    };

    fetch('/cost-estimates/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
      },
      body: JSON.stringify(body)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        ceResult = data;
        ceRenderResult(data);
        document.getElementById('ce-result-area').style.display = 'block';
        document.getElementById('ce-btn-print').style.display = '';
        document.getElementById('ce-btn-print2').style.display = '';
        document.getElementById('ce-btn-download').style.display = '';
        document.getElementById('ce-btn-download2').style.display = '';
      }
    });
  };

  function ceRenderResult(data) {
    var est = data.estimate;
    var ins = data.instruction;
    var isPrivate = est.contract_type === 'private';

    // ë¬¼ëŸ‰ë‚´ì—­ì„œ ë¯¸ë¦¬ë³´ê¸°
    var contractLabel = isPrivate ? ' (ìˆ˜ì˜ê³„ì•½ìš©)' : ' (ê²½ìŸì…ì°°ìš©)';
    var html = '<div style="text-align:center;margin-bottom:16px;"><strong style="font-size:17px;">' + ceEsc(est.type_name) + ' ë¬¼ëŸ‰ë‚´ì—­ì„œ' + contractLabel + '</strong></div>';
    html += '<table style="width:100%;font-size:13px;margin-bottom:12px;"><tr><td><strong>ê³µì‚¬ëª…:</strong> ' + ceEsc(est.info.project_name) + '</td><td><strong>ì¥ì†Œ:</strong> ' + ceEsc(est.info.location || '-') + '</td></tr>';
    html += '<tr><td><strong>ê¸°ê°„:</strong> ' + ceEsc(est.info.duration || '-') + '</td><td><strong>ë‹´ë‹¹:</strong> ' + ceEsc(est.info.department || '') + ' ' + ceEsc(est.info.manager || '') + '</td></tr></table>';

    html += '<table class="ce-table"><thead><tr><th>No</th><th>ê³µì¢…/í’ˆëª…</th><th>ê·œê²©</th><th>ë‹¨ìœ„</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ê¸ˆì•¡</th></tr></thead><tbody>';
    for (var i = 0; i < est.items.length; i++) {
      var item = est.items[i];
      html += '<tr><td style="text-align:center">' + (i + 1) + '</td><td>' + ceEsc(item.name) + '</td><td>' + ceEsc(item.spec) + '</td><td style="text-align:center">' + ceEsc(item.unit) + '</td><td style="text-align:right">' + item.qty + '</td><td style="text-align:right">' + ceComma(item.unit_price) + '</td><td style="text-align:right">' + ceComma(item.amount) + '</td></tr>';
    }
    html += '</tbody></table>';

    html += '<div class="ce-summary" style="margin-top:12px;">';
    var costLabel = isPrivate ? 'ê³µì‚¬ë¹„ í•©ê³„' : 'ì§ì ‘ê³µì‚¬ë¹„';
    html += '<div class="ce-summary-row"><span class="ce-summary-label">' + costLabel + '</span><span class="ce-summary-value">' + ceComma(est.material_cost) + ' ì›</span></div>';

    // ê²½ìŸì…ì°°ì¸ ê²½ìš°ë§Œ ê°„ì ‘ë¹„ í‘œì‹œ
    if (!isPrivate) {
      for (var j = 0; j < est.indirect_costs.length; j++) {
        var ic = est.indirect_costs[j];
        html += '<div class="ce-summary-row"><span class="ce-summary-label">' + ceEsc(ic.name) + ' (' + ceEsc(ic.note) + ')</span><span class="ce-summary-value">' + ceComma(ic.amount) + ' ì›</span></div>';
      }
      html += '<div class="ce-summary-row"><span class="ce-summary-label">ì†Œê³„</span><span class="ce-summary-value">' + ceComma(est.subtotal) + ' ì›</span></div>';
    }

    html += '<div class="ce-summary-row"><span class="ce-summary-label">ë¶€ê°€ê°€ì¹˜ì„¸</span><span class="ce-summary-value">' + ceComma(est.vat) + ' ì›</span></div>';
    html += '<div class="ce-summary-row total"><span>í•©ê³„</span><span>' + ceComma(est.total) + ' ì›</span></div>';

    // ìˆ˜ì˜ê³„ì•½ ì•ˆë‚´ë¬¸
    if (isPrivate) {
      html += '<div style="margin-top:12px;padding:12px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:6px;font-size:12px;color:#92400e;line-height:1.6;">';
      html += '<strong>â€» ê°„ì ‘ë¹„ ë¯¸í¬í•¨ ì•ˆë‚´:</strong> ë³¸ ê¸ˆì•¡ì€ ì§ì ‘ê³µì‚¬ë¹„ì´ë©°, ì¼ë°˜ê´€ë¦¬ë¹„Â·ì´ìœ¤Â·ë³´í—˜ë£ŒÂ·ì‚°ì—…ì•ˆì „ë³´ê±´ê´€ë¦¬ë¹„ ë“± ê°„ì ‘ë¹„ëŠ” í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì•½ì—…ì²´ê°€ ìì²´ì ìœ¼ë¡œ ì‚°ì •í•©ë‹ˆë‹¤.';
      html += '</div>';
    }

    html += '</div>';
    document.getElementById('ce-result-estimate').innerHTML = html;

    // ì‹œë°©ì„œ ë¯¸ë¦¬ë³´ê¸°
    var iHtml = '<div style="text-align:center;margin-bottom:16px;"><strong style="font-size:17px;">' + ceEsc(ins.type_name) + ' ì‹œë°©ì„œ</strong></div>';

    iHtml += '<table style="width:100%;font-size:13px;margin-bottom:16px;border-collapse:collapse;">';
    iHtml += '<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb;"><strong>ê³µì‚¬ëª…</strong></td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + ceEsc(ins.info.project_name) + '</td></tr>';
    iHtml += '<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb;"><strong>ê³µì‚¬ê¸ˆì•¡</strong></td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + ceComma(ins.total) + ' ì› (VAT í¬í•¨)</td></tr>';
    iHtml += '<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb;"><strong>ê³µì‚¬ê¸°ê°„</strong></td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + ceEsc(ins.info.duration || '-') + '</td></tr>';
    iHtml += '<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb;"><strong>ê³µì‚¬ì¥ì†Œ</strong></td><td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + ceEsc(ins.info.location || '-') + '</td></tr>';
    iHtml += '</table>';

    // ìˆ˜ì˜ê³„ì•½ ì•ˆë‚´ë¬¸
    if (isPrivate) {
      iHtml += '<div style="margin-bottom:16px;padding:12px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:6px;font-size:12px;color:#92400e;line-height:1.6;">';
      iHtml += '<strong>â€» ê°„ì ‘ë¹„ ë¯¸í¬í•¨ ì•ˆë‚´:</strong> ë³¸ ê¸ˆì•¡ì€ ì§ì ‘ê³µì‚¬ë¹„ì´ë©°, ì¼ë°˜ê´€ë¦¬ë¹„Â·ì´ìœ¤Â·ë³´í—˜ë£ŒÂ·ì‚°ì—…ì•ˆì „ë³´ê±´ê´€ë¦¬ë¹„ ë“± ê°„ì ‘ë¹„ëŠ” í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì•½ì—…ì²´ê°€ ìì²´ì ìœ¼ë¡œ ì‚°ì •í•©ë‹ˆë‹¤.';
      iHtml += '</div>';
    }

    iHtml += '<div style="margin-bottom:16px;"><strong style="color:#92400e;">ì‹œë°© ì‚¬í•­</strong><pre style="white-space:pre-wrap;font-family:inherit;font-size:14px;line-height:1.8;background:#fffbeb;padding:16px;border-radius:10px;margin-top:8px;">' + ceEsc(ins.template) + '</pre></div>';

    if (ins.custom) {
      iHtml += '<div style="margin-bottom:16px;"><strong style="color:#1e40af;">ì¶”ê°€ ì‹œë°© ì‚¬í•­</strong><pre style="white-space:pre-wrap;font-family:inherit;font-size:14px;line-height:1.8;background:#eff6ff;padding:16px;border-radius:10px;margin-top:8px;">' + ceEsc(ins.custom) + '</pre></div>';
    }

    iHtml += '<div style="margin-top:24px;text-align:right;font-size:14px;"><p>ìœ„ ë‚´ìš©ì— ë”°ë¼ ì‹œê³µí•˜ì—¬ì•¼ í•œë‹¤.</p><br>' + buildApprovalLine(ins.info, false) + '</div>';

    document.getElementById('ce-result-instruction').innerHTML = iHtml;
  }

  // ì¸ì‡„
  window.cePrint = function(docType) {
    if (!ceResult) return;
    var printArea = document.getElementById('ce-print-area');
    if (docType === 'estimate') {
      printArea.innerHTML = buildEstimatePrint(ceResult.estimate);
    } else {
      printArea.innerHTML = buildInstructionPrint(ceResult.instruction);
    }
    window.print();
  };

  // ë‹¤ìš´ë¡œë“œ (í•œê¸€íŒŒì¼ í˜¸í™˜ HTML)
  window.ceDownload = function(docType) {
    if (!ceResult) return;

    var content, filename;
    if (docType === 'estimate') {
      content = buildEstimatePrint(ceResult.estimate);
      filename = (ceResult.estimate.info.project_name || 'ë¬¼ëŸ‰ë‚´ì—­ì„œ') + '_ë¬¼ëŸ‰ë‚´ì—­ì„œ.html';
    } else {
      content = buildInstructionPrint(ceResult.instruction);
      filename = (ceResult.instruction.info.project_name || 'ì‹œë°©ì„œ') + '_ì‹œë°©ì„œ.html';
    }

    var htmlContent = '<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8">';
    htmlContent += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
    htmlContent += '<title>' + filename.replace('.html', '') + '</title>';
    htmlContent += '<style>';
    htmlContent += 'body { font-family: "ë§‘ì€ ê³ ë”•", "Malgun Gothic", sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; }';
    htmlContent += 'table { width: 100%; border-collapse: collapse; margin: 20px 0; }';
    htmlContent += 'th, td { border: 1px solid #333; padding: 8px 12px; }';
    htmlContent += 'th { background: #f0f0f0; font-weight: bold; text-align: center; }';
    htmlContent += 'td { vertical-align: middle; }';
    htmlContent += '.print-header { text-align: center; margin-bottom: 30px; }';
    htmlContent += '.print-header h2 { font-size: 24px; margin-bottom: 10px; }';
    htmlContent += '.print-info { border: none; margin: 20px 0; }';
    htmlContent += '.print-info td { border: none; padding: 6px 12px; }';
    htmlContent += '.print-sign { margin-top: 40px; text-align: right; }';
    htmlContent += '.print-sign table { margin-left: auto; border-collapse: collapse; }';
    htmlContent += '.print-sign td { border: 1px solid #333; padding: 12px 24px; text-align: center; min-width: 80px; height: 60px; }';
    htmlContent += 'pre { white-space: pre-wrap; font-family: inherit; line-height: 1.8; }';
    htmlContent += '</style>';
    htmlContent += '</head><body>';
    htmlContent += content;
    htmlContent += '</body></html>';

    var blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  };

  function buildEstimatePrint(est) {
    var isPrivate = est.contract_type === 'private';
    var contractLabel = isPrivate ? ' (ìˆ˜ì˜ê³„ì•½ìš©)' : ' (ê²½ìŸì…ì°°ìš©)';

    var h = '<div class="print-header"><h2>' + ceEsc(est.type_name) + ' ë¬¼ëŸ‰ë‚´ì—­ì„œ' + contractLabel + '</h2></div>';
    h += '<table class="print-info"><tr><td><strong>ê³µì‚¬ëª…:</strong></td><td>' + ceEsc(est.info.project_name) + '</td><td><strong>ì¥ì†Œ:</strong></td><td>' + ceEsc(est.info.location || '-') + '</td></tr>';
    h += '<tr><td><strong>ê¸°ê°„:</strong></td><td>' + ceEsc(est.info.duration || '-') + '</td><td><strong>ë‹´ë‹¹:</strong></td><td>' + ceEsc(est.info.department || '') + ' ' + ceEsc(est.info.manager || '') + '</td></tr></table>';
    h += '<table class="ce-print-table"><thead><tr><th>No</th><th>ê³µì¢…/í’ˆëª…</th><th>ê·œê²©</th><th>ë‹¨ìœ„</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€(ì›)</th><th>ê¸ˆì•¡(ì›)</th></tr></thead><tbody>';
    for (var i = 0; i < est.items.length; i++) {
      var item = est.items[i];
      h += '<tr><td style="text-align:center">' + (i+1) + '</td><td>' + ceEsc(item.name) + '</td><td>' + ceEsc(item.spec) + '</td><td style="text-align:center">' + ceEsc(item.unit) + '</td><td style="text-align:right">' + item.qty + '</td><td style="text-align:right">' + ceComma(item.unit_price) + '</td><td style="text-align:right">' + ceComma(item.amount) + '</td></tr>';
    }

    // ìˆ˜ì˜ê³„ì•½: ê°„ì ‘ë¹„ ìƒëµ
    if (isPrivate) {
      h += '<tr style="font-weight:bold;background:#f0f0f0;"><td colspan="6" style="text-align:center">ê³µì‚¬ë¹„ í•©ê³„</td><td style="text-align:right">' + ceComma(est.material_cost) + '</td></tr>';
      h += '<tr><td colspan="6" style="text-align:center">ë¶€ê°€ê°€ì¹˜ì„¸</td><td style="text-align:right">' + ceComma(est.vat) + '</td></tr>';
      h += '<tr style="font-weight:bold;background:#f0f0f0;"><td colspan="6" style="text-align:center">í•©ê³„</td><td style="text-align:right">' + ceComma(est.total) + '</td></tr>';
    } else {
      // ê²½ìŸì…ì°°: ê°„ì ‘ë¹„ í¬í•¨
      h += '<tr style="font-weight:bold;background:#f0f0f0;"><td colspan="6" style="text-align:center">ì§ì ‘ê³µì‚¬ë¹„ ì†Œê³„</td><td style="text-align:right">' + ceComma(est.material_cost) + '</td></tr>';
      for (var j = 0; j < est.indirect_costs.length; j++) {
        var ic = est.indirect_costs[j];
        h += '<tr><td colspan="6" style="text-align:center">' + ceEsc(ic.name) + '</td><td style="text-align:right">' + ceComma(ic.amount) + '</td></tr>';
      }
      h += '<tr><td colspan="6" style="text-align:center">ì†Œê³„ (ê³µê¸‰ê°€ì•¡)</td><td style="text-align:right">' + ceComma(est.subtotal) + '</td></tr>';
      h += '<tr><td colspan="6" style="text-align:center">ë¶€ê°€ê°€ì¹˜ì„¸</td><td style="text-align:right">' + ceComma(est.vat) + '</td></tr>';
      h += '<tr style="font-weight:bold;background:#f0f0f0;"><td colspan="6" style="text-align:center">í•©ê³„</td><td style="text-align:right">' + ceComma(est.total) + '</td></tr>';
    }

    h += '</tbody></table>';

    // ìˆ˜ì˜ê³„ì•½ ì•ˆë‚´ë¬¸
    if (isPrivate) {
      h += '<div style="margin:20px 0;padding:12px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:6px;font-size:13px;color:#92400e;line-height:1.6;">';
      h += '<strong>â€» ê°„ì ‘ë¹„ ë¯¸í¬í•¨ ì•ˆë‚´:</strong> ë³¸ ê¸ˆì•¡ì€ ì§ì ‘ê³µì‚¬ë¹„ì´ë©°, ì¼ë°˜ê´€ë¦¬ë¹„Â·ì´ìœ¤Â·ë³´í—˜ë£ŒÂ·ì‚°ì—…ì•ˆì „ë³´ê±´ê´€ë¦¬ë¹„ ë“± ê°„ì ‘ë¹„ëŠ” í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì•½ì—…ì²´ê°€ ìì²´ì ìœ¼ë¡œ ì‚°ì •í•©ë‹ˆë‹¤.';
      h += '</div>';
    }

    h += buildApprovalLine(est.info, true);
    return h;
  }

  function buildInstructionPrint(ins) {
    var isPrivate = ins.contract_type === 'private';

    var h = '<div class="print-header"><h2>' + ceEsc(ins.type_name) + ' ì‹œë°©ì„œ</h2></div>';
    h += '<table class="ce-print-table" style="margin-bottom:20px;"><tbody>';
    h += '<tr><td style="width:100px;background:#f0f0f0;font-weight:bold;">ê³µì‚¬ëª…</td><td>' + ceEsc(ins.info.project_name) + '</td></tr>';
    h += '<tr><td style="background:#f0f0f0;font-weight:bold;">ê³µì‚¬ê¸ˆì•¡</td><td>' + ceComma(ins.total) + ' ì› (VAT í¬í•¨)</td></tr>';
    h += '<tr><td style="background:#f0f0f0;font-weight:bold;">ê³µì‚¬ê¸°ê°„</td><td>' + ceEsc(ins.info.duration || '-') + '</td></tr>';
    h += '<tr><td style="background:#f0f0f0;font-weight:bold;">ê³µì‚¬ì¥ì†Œ</td><td>' + ceEsc(ins.info.location || '-') + '</td></tr>';
    h += '</tbody></table>';

    // ìˆ˜ì˜ê³„ì•½ ì•ˆë‚´ë¬¸
    if (isPrivate) {
      h += '<div style="margin-bottom:20px;padding:12px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:6px;font-size:13px;color:#92400e;line-height:1.6;">';
      h += '<strong>â€» ê°„ì ‘ë¹„ ë¯¸í¬í•¨ ì•ˆë‚´:</strong> ë³¸ ê¸ˆì•¡ì€ ì§ì ‘ê³µì‚¬ë¹„ì´ë©°, ì¼ë°˜ê´€ë¦¬ë¹„Â·ì´ìœ¤Â·ë³´í—˜ë£ŒÂ·ì‚°ì—…ì•ˆì „ë³´ê±´ê´€ë¦¬ë¹„ ë“± ê°„ì ‘ë¹„ëŠ” í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì•½ì—…ì²´ê°€ ìì²´ì ìœ¼ë¡œ ì‚°ì •í•©ë‹ˆë‹¤.';
      h += '</div>';
    }

    h += '<div style="margin-bottom:16px;"><strong>ì‹œë°© ì‚¬í•­</strong><pre style="white-space:pre-wrap;font-family:serif;line-height:1.8;margin-top:8px;">' + ceEsc(ins.template) + '</pre></div>';
    if (ins.custom) {
      h += '<div style="margin-bottom:16px;"><strong>ì¶”ê°€ ì‹œë°© ì‚¬í•­</strong><pre style="white-space:pre-wrap;font-family:serif;line-height:1.8;margin-top:8px;">' + ceEsc(ins.custom) + '</pre></div>';
    }
    h += '<div style="margin-top:30px;text-align:center;"><p>ìœ„ ë‚´ìš©ì— ë”°ë¼ ì‹œê³µí•˜ì—¬ì•¼ í•œë‹¤.</p><br><p>20    ë…„    ì›”    ì¼</p></div>';
    h += buildApprovalLine(ins.info, true);
    return h;
  }

  // ìœ í‹¸
  function ceComma(n) { return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
  window.ceComma = ceComma;

  function ceEsc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  window.ceEsc = ceEsc;

  // ê²°ì¬ë¼ì¸ í…Œì´ë¸” ìƒì„± (ì…ë ¥ëœ ì§ìœ„ë§Œ í¬í•¨)
  function buildApprovalLine(info, isPrint) {
    var positions = [];
    if (info.approval_staff && info.approval_staff.trim()) positions.push(info.approval_staff.trim());
    if (info.approval_team && info.approval_team.trim()) positions.push(info.approval_team.trim());
    if (info.approval_section && info.approval_section.trim()) positions.push(info.approval_section.trim());
    if (info.approval_director && info.approval_director.trim()) positions.push(info.approval_director.trim());

    // ì…ë ¥ëœ ì§ìœ„ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
    if (positions.length === 0) {
      positions = ['ë‹´ë‹¹', 'íŒ€ì¥', 'ê³¼ì¥'];
    }

    var headerRow = positions.map(function(p) {
      return '<td>' + ceEsc(p) + '</td>';
    }).join('');

    var signRow = positions.map(function() {
      return '<td style="height:50px;"></td>';
    }).join('');

    if (isPrint) {
      return '<div class="print-sign"><table><tr>' + headerRow + '</tr><tr>' + signRow + '</tr></table></div>';
    } else {
      return '<table style="margin-left:auto;border-collapse:collapse;"><tr>' +
             positions.map(function(p) { return '<td style="border:1px solid #d1d5db;padding:8px 24px;background:#f8fafc;">' + ceEsc(p) + '</td>'; }).join('') +
             '</tr><tr>' +
             positions.map(function() { return '<td style="border:1px solid #d1d5db;padding:20px 24px;"></td>'; }).join('') +
             '</tr></table>';
    }
  }

  // === AI ë¬¸ì„œ ë¶„ì„ ê¸°ëŠ¥ ===

  window.ceHandleDragOver = function(e) {
    e.preventDefault(); e.stopPropagation();
    e.currentTarget.style.borderColor = '#6366f1';
    e.currentTarget.style.background = '#eef2ff';
  };
  window.ceHandleDragLeave = function(e) {
    e.preventDefault(); e.stopPropagation();
    e.currentTarget.style.borderColor = '#c7d2fe';
    e.currentTarget.style.background = '#fafafe';
  };
  window.ceHandleDrop = function(e) {
    e.preventDefault(); e.stopPropagation();
    e.currentTarget.style.borderColor = '#c7d2fe';
    e.currentTarget.style.background = '#fafafe';
    if (e.dataTransfer.files.length > 0) ceProcessFile(e.dataTransfer.files[0]);
  };
  window.ceFileSelect = function(e) {
    if (e.target.files.length > 0) ceProcessFile(e.target.files[0]);
  };

  function ceProcessFile(file) {
    var allowed = ['application/pdf', 'image/jpeg', 'image/png'];
    if (allowed.indexOf(file.type) === -1) { alert('PDF, JPG, PNG íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
    if (file.size > 20 * 1024 * 1024) { alert('íŒŒì¼ í¬ê¸°ëŠ” 20MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }

    ceUploadedFile = file;
    document.getElementById('ce-file-name').textContent = file.name;
    document.getElementById('ce-file-size').textContent = (file.size / (1024 * 1024)).toFixed(1) + 'MB';
    document.getElementById('ce-file-info').style.display = 'flex';
    document.getElementById('ce-upload-zone').style.display = 'none';
    document.getElementById('ce-btn-analyze').style.display = 'flex';
    ceHideAnalysisStatus();
    ceAnalyzedData = null;
  }

  window.ceClearFile = function() {
    ceUploadedFile = null;
    ceAnalyzedData = null;
    document.getElementById('ce-file-input').value = '';
    document.getElementById('ce-file-info').style.display = 'none';
    document.getElementById('ce-upload-zone').style.display = '';
    document.getElementById('ce-btn-analyze').style.display = 'none';
    ceHideAnalysisStatus();
  };

  function ceShowAnalysisStatus(type, msg) {
    var el = document.getElementById('ce-analysis-status');
    var spinner = document.getElementById('ce-analysis-spinner');
    var msgEl = document.getElementById('ce-analysis-msg');
    el.style.display = 'flex';
    spinner.style.display = type === 'loading' ? 'block' : 'none';
    msgEl.textContent = msg;
    if (type === 'loading') { el.style.background = '#eff6ff'; el.style.color = '#1d4ed8'; el.style.border = '1px solid #bfdbfe'; }
    else if (type === 'success') { el.style.background = '#f0fdf4'; el.style.color = '#059669'; el.style.border = '1px solid #bbf7d0'; }
    else { el.style.background = '#fef2f2'; el.style.color = '#dc2626'; el.style.border = '1px solid #fecaca'; }
  }

  function ceHideAnalysisStatus() {
    document.getElementById('ce-analysis-status').style.display = 'none';
  }

  window.ceAnalyzeDocument = function() {
    if (!ceUploadedFile) return;
    var btn = document.getElementById('ce-btn-analyze');
    btn.disabled = true;
    ceShowAnalysisStatus('loading', 'AIê°€ ê²¬ì ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (5~15ì´ˆ ì†Œìš”)');

    var formData = new FormData();
    formData.append('file', ceUploadedFile);
    formData.append('document_type', 'cost_estimate');

    fetch('/document-analysis/analyze', {
      method: 'POST',
      headers: { 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content },
      body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
      if (window.checkAiLoginRequired && window.checkAiLoginRequired(result)) { btn.disabled = false; return; }
      if (result.success && result.fields) {
        ceAnalyzedData = result.fields;
        var itemCount = (result.fields.items || []).length;
        var infoFields = ['project_name','location','duration','department','manager'].filter(function(k) { return result.fields[k]; }).length;
        ceShowAnalysisStatus('success', 'ë¶„ì„ ì™„ë£Œ! ê¸°ë³¸ì •ë³´ ' + infoFields + 'ê°œ, ë‚´ì—­ í•­ëª© ' + itemCount + 'ê°œë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.');
      } else {
        ceShowAnalysisStatus('error', result.error || 'ë¬¸ì„œ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    })
    .catch(function(err) {
      console.error('ë¶„ì„ ì˜¤ë¥˜:', err);
      ceShowAnalysisStatus('error', 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    })
    .finally(function() {
      btn.disabled = false;
    });
  };

  function ceApplyAnalyzedData() {
    if (!ceAnalyzedData) return;
    var fieldMap = {
      project_name: 'ce-project-name',
      location: 'ce-location',
      duration: 'ce-duration',
      department: 'ce-department',
      manager: 'ce-manager'
    };

    Object.keys(fieldMap).forEach(function(key) {
      if (ceAnalyzedData[key]) {
        var el = document.getElementById(fieldMap[key]);
        if (el) {
          el.value = ceAnalyzedData[key];
          el.classList.add('ce-ai-filled');
        }
      }
    });
  }

  function ceApplyAnalyzedItems() {
    if (!ceAnalyzedData || !ceAnalyzedData.items || ceAnalyzedData.items.length === 0) return;

    ceItems = ceAnalyzedData.items.map(function(item, i) {
      var qty = parseFloat(item.qty) || 0;
      var unitPrice = parseFloat(item.unit_price) || 0;
      return {
        id: i + 1,
        name: item.name || '',
        spec: item.spec || '',
        unit: item.unit || 'ì‹',
        qty: qty,
        unit_price: unitPrice,
        amount: Math.round(qty * unitPrice)
      };
    });

    ceRenderTable();
    ceAnalyzedData = null; // ì¤‘ë³µ ì ìš© ë°©ì§€
  }
});
</script>
