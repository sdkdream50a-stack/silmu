<%# 실무 가이드 목록 페이지 - 프리미엄 디자인 시스템 %>

<!-- 페이지 헤더 -->
<section class="gradient-emerald text-white py-12 lg:py-16 relative overflow-hidden">
  <div class="absolute top-0 right-0 w-96 h-96 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/3"></div>
  <div class="absolute bottom-0 left-0 w-64 h-64 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/4"></div>
  <div class="container-wide relative z-10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
      <div class="flex items-start gap-5">
        <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
          <span class="material-symbols-outlined text-4xl text-white">menu_book</span>
        </div>
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">실무 가이드</h1>
          <p class="text-emerald-100 text-lg">공무원 업무 처리에 필요한 단계별 가이드</p>
        </div>
      </div>
      <div class="flex gap-4 lg:gap-6">
        <div class="text-center px-4 py-2 bg-white/10 backdrop-blur-md rounded-xl border border-white/15">
          <div class="text-2xl font-bold"><%= @guides.count %></div>
          <div class="text-xs text-emerald-100 mt-0.5">전체 가이드</div>
        </div>
        <div class="text-center px-4 py-2 bg-white/10 backdrop-blur-md rounded-xl border border-white/15">
          <div class="text-2xl font-bold"><%= @guides.count { |g| g.category == "계약" } %></div>
          <div class="text-xs text-emerald-100 mt-0.5">계약 분야</div>
        </div>
        <div class="text-center px-4 py-2 bg-white/10 backdrop-blur-md rounded-xl border border-white/15">
          <div class="text-2xl font-bold"><%= @guides.map(&:category).uniq.count %></div>
          <div class="text-xs text-emerald-100 mt-0.5">분야</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 검색 및 필터 -->
<section class="bg-white/80 backdrop-blur-xl border-b border-gray-100 sticky top-16 z-40 shadow-soft">
  <div class="container-wide py-4">
    <!-- 검색바 -->
    <div class="flex items-center bg-surface-100 rounded-xl overflow-hidden mb-4">
      <div class="flex items-center justify-center pl-4 text-slate-400">
        <span class="material-symbols-outlined">search</span>
      </div>
      <input type="text" id="search-input" placeholder="가이드 검색" class="w-full border-none focus:ring-0 bg-transparent py-3 px-3 text-slate-800 placeholder:text-slate-400">
    </div>

    <!-- 카테고리 필터 -->
    <div class="flex flex-wrap gap-2" id="category-tabs">
      <button data-category="전체" class="tab-btn active px-5 py-2.5 bg-emerald-600 text-white rounded-xl text-sm font-semibold shadow-md transition-all">전체</button>
      <button data-category="계약" class="tab-btn px-5 py-2.5 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">계약</button>
      <button data-category="예산" class="tab-btn px-5 py-2.5 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">예산</button>
      <button data-category="인사" class="tab-btn px-5 py-2.5 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">인사</button>
      <button data-category="복무" class="tab-btn px-5 py-2.5 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">복무</button>
      <button data-category="민원" class="tab-btn px-5 py-2.5 bg-surface-100 text-slate-600 hover:bg-surface-200 rounded-xl text-sm font-medium transition-all">민원</button>
    </div>
  </div>
</section>

<section class="section py-10">
  <div class="container-wide">
    <div class="lg:flex lg:gap-10">
      <!-- 메인 콘텐츠 -->
      <div class="lg:w-[70%]">
        <div class="flex items-center justify-between mb-6">
          <p class="text-slate-600">총 <span class="font-bold text-slate-900" id="item-count"><%= @guides.count %></span>개의 가이드</p>
          <select class="border-gray-200 rounded-xl text-sm focus:ring-emerald-500 focus:border-emerald-500 px-4 py-2">
            <option>최신순</option>
            <option>인기순</option>
          </select>
        </div>

        <div class="space-y-4" id="items-list">
          <% @guides.each do |guide| %>
            <% guide_link = guide.external_link.present? ? guide.external_link : guide_path(guide) %>
            <%= link_to guide_link, class: "block card card-hover p-6 group item-card", data: { category: guide.category, title: guide.title } do %>
              <div class="flex items-start justify-between mb-3">
                <span class="badge badge-emerald"><%= guide.category %></span>
                <% if guide.tag.present? %>
                  <span class="badge <%= guide.tag == '인기' ? 'badge-amber' : guide.tag == '업데이트' ? 'badge-indigo' : 'badge-slate' %>"><%= guide.tag %></span>
                <% end %>
              </div>
              <h3 class="text-lg font-bold text-slate-900 mb-2 group-hover:text-emerald-600 transition-colors"><%= guide.title %></h3>
              <p class="text-slate-600 text-sm mb-4 leading-relaxed"><%= guide.summary %></p>
              <div class="flex items-center gap-4 text-xs text-slate-400">
                <span class="flex items-center gap-1">
                  <span class="material-symbols-outlined text-sm">category</span>
                  <%= guide.category %>
                </span>
              </div>
            <% end %>
          <% end %>
        </div>

        <!-- 페이지네이션 -->
        <div class="flex justify-center mt-12" id="pagination-container">
          <nav class="flex items-center gap-2" id="pagination-nav">
            <!-- JavaScript로 동적 생성 -->
          </nav>
        </div>
      </div>

      <!-- 사이드바 -->
      <div class="lg:w-[30%] mt-10 lg:mt-0">
        <div class="sticky top-36 space-y-6">
          <!-- 사전 체크리스트 배너 -->
          <%= link_to pre_contract_checklist_path, class: "block card card-interactive overflow-hidden group" do %>
            <div class="gradient-emerald p-5 text-white">
              <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-2xl">checklist_rtl</span>
                <span class="font-bold">사전 체크리스트</span>
              </div>
              <p class="text-white/80 text-sm">계약 전 필수 확인사항을 단계별로 점검</p>
              <div class="mt-3 text-xs text-white/60 flex items-center gap-1 group-hover:text-white transition-colors">
                바로가기
                <span class="material-symbols-outlined text-sm group-hover:translate-x-1 transition-transform">arrow_forward</span>
              </div>
            </div>
          <% end %>

          <!-- 계약 흐름도 배너 -->
          <%= link_to contract_flow_path, class: "block card card-interactive overflow-hidden group" do %>
            <div class="gradient-slate p-5 text-white">
              <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-2xl">account_tree</span>
                <span class="font-bold">계약 흐름도</span>
              </div>
              <p class="text-white/80 text-sm">물품/용역/공사 계약 전체 프로세스를 한눈에</p>
              <div class="mt-3 text-xs text-white/60 flex items-center gap-1 group-hover:text-white transition-colors">
                자세히 보기
                <span class="material-symbols-outlined text-sm group-hover:translate-x-1 transition-transform">arrow_forward</span>
              </div>
            </div>
          <% end %>

          <!-- 자료실 배너 -->
          <%= link_to guide_resources_path, class: "block card card-interactive overflow-hidden group" do %>
            <div class="gradient-indigo p-5 text-white">
              <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-2xl">library_books</span>
                <span class="font-bold">자료실 / FAQ</span>
              </div>
              <p class="text-white/80 text-sm">판례해설, 유권해석, 자주 묻는 질문</p>
              <div class="mt-3 text-xs text-white/60 flex items-center gap-1 group-hover:text-white transition-colors">
                자세히 보기
                <span class="material-symbols-outlined text-sm group-hover:translate-x-1 transition-transform">arrow_forward</span>
              </div>
            </div>
          <% end %>

          <!-- 감사사례 배너 -->
          <%= link_to audit_cases_path, class: "block card card-interactive overflow-hidden group" do %>
            <div class="bg-gradient-to-br from-red-700 to-red-900 p-5 text-white">
              <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-2xl">gavel</span>
                <span class="font-bold">감사사례 <%= @audit_case_count %>건</span>
              </div>
              <p class="text-red-100 text-sm">감사 지적 사례와 실무 체크포인트 확인</p>
              <div class="mt-3 text-xs text-white/60 flex items-center gap-1 group-hover:text-white transition-colors">
                바로가기
                <span class="material-symbols-outlined text-sm group-hover:translate-x-1 transition-transform">arrow_forward</span>
              </div>
            </div>
          <% end %>

          <!-- 인기 가이드 -->
          <div class="card p-6">
            <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-amber-500">local_fire_department</span>
              인기 가이드 TOP 5
            </h3>
            <ol class="space-y-3">
              <% @popular_guides.each_with_index do |guide, i| %>
                <li class="flex items-center gap-3 group">
                  <span class="w-7 h-7 flex items-center justify-center rounded-full text-xs font-bold <%= i < 3 ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500' %>"><%= i + 1 %></span>
                  <%= link_to guide.title, guide_path(guide), class: "text-sm text-slate-700 group-hover:text-emerald-600 transition-colors truncate" %>
                </li>
              <% end %>
            </ol>
          </div>

          <!-- 최근 본 가이드 -->
          <div class="card p-6">
            <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-slate-400">history</span>
              최근 본 가이드
            </h3>
            <ul class="space-y-3">
              <% [
                { title: "수의계약 체결 실무", link: "/topics/private-contract" },
                { title: "출장 여비 청구", link: "/topics/travel-expense" },
                { title: "예산 이월 실무", link: "/topics/budget-carryover" }
              ].each do |guide| %>
                <li>
                  <%= link_to guide[:title], guide[:link], class: "text-sm text-slate-700 hover:text-emerald-600 transition-colors" %>
                </li>
              <% end %>
            </ul>
          </div>

          <!-- AI 상담 CTA -->
          <div class="gradient-emerald rounded-2xl p-6 text-white shadow-strong">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-white/10 backdrop-blur rounded-xl flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl">support_agent</span>
              </div>
              <div>
                <h3 class="font-bold text-lg">가이드가 어려우신가요?</h3>
                <p class="text-emerald-100 text-sm">AI에게 물어보세요</p>
              </div>
            </div>
            <%= link_to chatbot_path, class: "block w-full py-3 bg-white text-emerald-700 rounded-xl font-semibold text-center hover:bg-emerald-50 transition-colors shadow-soft" do %>
              AI 상담 시작하기
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('turbo:load', function() {
  const itemCount = document.getElementById('item-count');
  if (!itemCount) return;
  const tabs = document.querySelectorAll('#category-tabs .tab-btn');
  const items = document.querySelectorAll('.item-card');
  const searchInput = document.getElementById('search-input');
  const paginationNav = document.getElementById('pagination-nav');

  // 페이지네이션 설정
  const ITEMS_PER_PAGE = 6;
  let currentPage = 1;
  let filteredItems = [];

  // URL 파라미터에서 카테고리 읽기
  const urlParams = new URLSearchParams(window.location.search);
  const initialCategory = urlParams.get('category');

  // 초기 카테고리가 있으면 해당 탭 활성화
  if (initialCategory) {
    tabs.forEach(tab => {
      if (tab.dataset.category === initialCategory) {
        tabs.forEach(t => {
          t.classList.remove('active', 'bg-emerald-600', 'text-white', 'shadow-md');
          t.classList.add('bg-surface-100', 'text-slate-600');
        });
        tab.classList.add('active', 'bg-emerald-600', 'text-white', 'shadow-md');
        tab.classList.remove('bg-surface-100', 'text-slate-600');
      }
    });
  }

  function getFilteredItems() {
    const activeTab = document.querySelector('#category-tabs .tab-btn.active');
    const category = activeTab ? activeTab.dataset.category : '전체';
    const searchTerm = searchInput.value.toLowerCase();

    return Array.from(items).filter(item => {
      const itemCategory = item.dataset.category;
      const itemTitle = item.dataset.title.toLowerCase();
      const matchesCategory = category === '전체' || itemCategory === category;
      const matchesSearch = itemTitle.includes(searchTerm);
      return matchesCategory && matchesSearch;
    });
  }

  function displayPage(page) {
    currentPage = page;
    const startIndex = (page - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;

    // 모든 아이템 숨기기
    items.forEach(item => item.style.display = 'none');

    // 현재 페이지 아이템만 표시
    filteredItems.slice(startIndex, endIndex).forEach(item => {
      item.style.display = '';
    });

    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);

    if (totalPages <= 1) {
      paginationNav.innerHTML = '';
      return;
    }

    let html = '';

    // 이전 버튼
    html += `
      <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
        class="w-10 h-10 flex items-center justify-center rounded-xl ${currentPage === 1 ? 'text-slate-300 cursor-not-allowed' : 'text-slate-500 hover:bg-surface-100'} transition-colors">
        <span class="material-symbols-outlined">chevron_left</span>
      </button>
    `;

    // 페이지 번호들
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    // startPage 조정
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // 첫 페이지와 ... 표시
    if (startPage > 1) {
      html += `
        <button onclick="goToPage(1)" class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-600 hover:bg-surface-100 font-medium transition-colors">1</button>
      `;
      if (startPage > 2) {
        html += `<span class="w-10 h-10 flex items-center justify-center text-slate-400">...</span>`;
      }
    }

    // 페이지 번호 버튼
    for (let i = startPage; i <= endPage; i++) {
      if (i === currentPage) {
        html += `
          <button class="w-10 h-10 flex items-center justify-center rounded-xl bg-emerald-600 text-white font-semibold shadow-md cursor-default">${i}</button>
        `;
      } else {
        html += `
          <button onclick="goToPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-600 hover:bg-surface-100 font-medium transition-colors">${i}</button>
        `;
      }
    }

    // 마지막 페이지와 ... 표시
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="w-10 h-10 flex items-center justify-center text-slate-400">...</span>`;
      }
      html += `
        <button onclick="goToPage(${totalPages})" class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-600 hover:bg-surface-100 font-medium transition-colors">${totalPages}</button>
      `;
    }

    // 다음 버튼
    html += `
      <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
        class="w-10 h-10 flex items-center justify-center rounded-xl ${currentPage === totalPages ? 'text-slate-300 cursor-not-allowed' : 'text-slate-500 hover:bg-surface-100'} transition-colors">
        <span class="material-symbols-outlined">chevron_right</span>
      </button>
    `;

    paginationNav.innerHTML = html;
  }

  // 전역 함수로 노출
  window.goToPage = function(page) {
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
    if (page < 1 || page > totalPages) return;
    displayPage(page);
    // 스크롤 이동
    document.getElementById('items-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  function filterAndPaginate() {
    filteredItems = getFilteredItems();
    itemCount.textContent = filteredItems.length;
    currentPage = 1;
    displayPage(1);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      // 모든 탭 비활성화
      tabs.forEach(t => {
        t.classList.remove('active', 'bg-emerald-600', 'text-white', 'shadow-md');
        t.classList.add('bg-surface-100', 'text-slate-600');
      });

      // 클릭된 탭 활성화
      this.classList.add('active', 'bg-emerald-600', 'text-white', 'shadow-md');
      this.classList.remove('bg-surface-100', 'text-slate-600');

      filterAndPaginate();
    });
  });

  searchInput.addEventListener('input', filterAndPaginate);

  // 초기 필터링 및 페이지네이션 실행
  filterAndPaginate();
});
</script>
