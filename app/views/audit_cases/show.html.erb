<%# 감사사례 상세 페이지 %>

<%= content_for :head do %>
  <%= json_ld({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": @audit_case.title,
    "description": @audit_case.issue.truncate(200),
    "author": { "@type": "Organization", "name": "실무.kr" },
    "publisher": { "@type": "Organization", "name": "실무.kr", "logo": { "@type": "ImageObject", "url": "https://silmu.kr/icon.png" } },
    "datePublished": @audit_case.created_at.iso8601,
    "dateModified": @audit_case.updated_at.iso8601,
    "mainEntityOfPage": canonical_url,
    "url": canonical_url,
    "image": "https://silmu.kr/og-image.png",
    "inLanguage": "ko"
  }) %>
  <%= json_ld({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "홈", "item": "https://silmu.kr" },
      { "@type": "ListItem", "position": 2, "name": "감사사례", "item": "https://silmu.kr/audit-cases" },
      { "@type": "ListItem", "position": 3, "name": @audit_case.title, "item": canonical_url }
    ]
  }) %>
<% end %>

<!-- 브레드크럼 -->
<div class="bg-surface-50 border-b border-gray-100">
  <div class="container-wide py-3">
    <nav class="flex items-center gap-2 text-sm text-slate-500">
      <%= link_to "홈", root_path, class: "hover:text-slate-800 transition-colors" %>
      <span class="material-symbols-outlined text-sm">chevron_right</span>
      <%= link_to "감사사례", audit_cases_path, class: "hover:text-slate-800 transition-colors" %>
      <span class="material-symbols-outlined text-sm">chevron_right</span>
      <span class="text-slate-800 font-medium truncate"><%= @audit_case.title %></span>
    </nav>
  </div>
</div>

<section class="section py-10">
  <div class="container-wide">
    <div class="lg:flex lg:gap-10">
      <!-- 메인 콘텐츠 -->
      <div class="lg:w-[70%]">
        <!-- 헤더 -->
        <div class="mb-8">
          <div class="flex items-center gap-3 mb-4">
            <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-semibold bg-red-50 text-red-700"><%= @audit_case.category %></span>
            <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
              <%= case @audit_case.severity
                  when '경미' then 'bg-amber-50 text-amber-700'
                  when '보통' then 'bg-orange-50 text-orange-700'
                  when '중대' then 'bg-red-100 text-red-800'
                  else 'bg-gray-50 text-gray-600'
                  end %>">
              <%= @audit_case.severity %>
            </span>
          </div>
          <h1 class="text-2xl lg:text-3xl font-bold text-slate-900 mb-2"><%= @audit_case.title %></h1>
        </div>

        <!-- 핵심 정보 카드 -->
        <div class="space-y-5 mb-8">
          <!-- 지적사항 -->
          <div class="card p-5 lg:p-6 border-l-4 border-red-500">
            <h2 class="text-base font-bold text-red-800 flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-lg">report</span>
              지적사항
            </h2>
            <div class="text-sm text-slate-700 leading-relaxed"><%= simple_format(@audit_case.issue) %></div>
            <div class="mt-3 flex items-center gap-2 px-3 py-2 bg-red-50 rounded-lg text-xs text-red-700">
              <span class="material-symbols-outlined text-sm">warning</span>
              <span>심각도: <strong><%= @audit_case.severity %></strong></span>
              <span class="mx-1 text-red-300">|</span>
              <span>분야: <strong><%= @audit_case.category %></strong></span>
            </div>
          </div>

          <!-- 관련근거 -->
          <div class="card p-5 lg:p-6 border-l-4 border-blue-500">
            <h2 class="text-base font-bold text-blue-800 flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-lg">menu_book</span>
              관련근거
            </h2>
            <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-xl">
              <span class="material-symbols-outlined text-blue-500 mt-0.5 flex-shrink-0">gavel</span>
              <div>
                <p class="text-sm font-semibold text-blue-900"><%= @audit_case.legal_basis %></p>
                <% if @audit_case.topic_slug.present? && @related_topic %>
                  <%= link_to topic_path(@related_topic.slug), class: "inline-flex items-center gap-1 mt-2 text-xs text-blue-600 hover:text-blue-800 font-medium" do %>
                    <span class="material-symbols-outlined text-xs">open_in_new</span>
                    해당 법령 가이드 보기
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>

          <!-- 조치내용 -->
          <div class="card p-5 lg:p-6 border-l-4 border-orange-500">
            <h2 class="text-base font-bold text-orange-800 flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-lg">assignment_turned_in</span>
              조치내용
            </h2>
            <div class="text-sm text-slate-700 leading-relaxed">
              <% @audit_case.action_taken.split(',').map(&:strip).each do |action| %>
                <div class="flex items-start gap-2 mb-2">
                  <span class="material-symbols-outlined text-orange-500 text-sm mt-0.5 flex-shrink-0">check_circle</span>
                  <span><%= action %></span>
                </div>
              <% end %>
            </div>
          </div>

          <!-- 교훈/시사점 -->
          <div class="card p-5 lg:p-6 border-l-4 border-green-500 bg-green-50/30">
            <h2 class="text-base font-bold text-green-800 flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-lg">lightbulb</span>
              교훈 및 시사점
            </h2>
            <div class="text-sm text-slate-700 leading-relaxed audit-content"><%= simple_markdown(@audit_case.lesson) %></div>
          </div>

          <!-- 실무 체크포인트 -->
          <% checkpoints = @audit_case.checkpoint_list %>
          <% if checkpoints.any? %>
            <div class="card p-5 lg:p-6 bg-indigo-50/50 border border-indigo-100">
              <h2 class="text-base font-bold text-indigo-800 flex items-center gap-2 mb-3">
                <span class="material-symbols-outlined text-lg">checklist</span>
                실무 체크포인트
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <% checkpoints.each do |cp| %>
                  <% if cp.is_a?(Hash) %>
                    <div class="flex items-start gap-2 p-3 bg-white rounded-xl text-sm">
                      <span class="material-symbols-outlined text-indigo-500 text-lg flex-shrink-0"><%= cp["icon"] %></span>
                      <div>
                        <span class="font-semibold text-slate-800"><%= cp["title"] %></span>
                        <p class="text-xs text-slate-500 mt-0.5"><%= cp["desc"] %></p>
                      </div>
                    </div>
                  <% else %>
                    <div class="flex items-start gap-2 p-3 bg-white rounded-xl text-sm">
                      <span class="material-symbols-outlined text-indigo-500 text-lg flex-shrink-0">check_circle</span>
                      <span class="text-slate-700"><%= cp %></span>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 상세 내용 (있을 경우) -->
          <% if @audit_case.detail.present? %>
            <div class="card p-5 lg:p-6">
              <h2 class="text-base font-bold text-slate-900 flex items-center gap-2 mb-4">
                <span class="material-symbols-outlined text-lg">description</span>
                상세 분석
              </h2>
              <div class="text-sm text-slate-700 leading-relaxed audit-content">
                <%= simple_markdown(@audit_case.detail) %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- 관련 토픽 -->
        <% if @related_topic %>
          <div class="card p-6 bg-blue-50/50 border-blue-100 mb-8">
            <h3 class="font-bold text-slate-900 flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-blue-600">link</span>
              관련 법령 가이드
            </h3>
            <%= link_to topic_path(@related_topic.slug), class: "flex items-center gap-3 p-4 bg-white rounded-xl hover:shadow-md transition-all group" do %>
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="material-symbols-outlined text-blue-600">article</span>
              </div>
              <div>
                <span class="font-semibold text-slate-900 group-hover:text-blue-600 transition-colors"><%= @related_topic.name %></span>
                <p class="text-sm text-slate-500"><%= @related_topic.summary.truncate(80) %></p>
              </div>
              <span class="material-symbols-outlined text-slate-300 ml-auto group-hover:translate-x-1 transition-transform">arrow_forward</span>
            <% end %>
          </div>
        <% end %>

        <!-- 같은 카테고리 사례 -->
        <% if @related_cases.any? %>
          <div>
            <h3 class="font-bold text-slate-900 text-lg mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-red-500">folder_open</span>
              같은 분야 감사사례
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <% @related_cases.each do |related| %>
                <%= link_to audit_case_path(slug: related.slug), class: "card card-hover p-5 group" do %>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                      <%= case related.severity
                          when '경미' then 'bg-amber-50 text-amber-700'
                          when '보통' then 'bg-orange-50 text-orange-700'
                          when '중대' then 'bg-red-100 text-red-800'
                          else 'bg-gray-50 text-gray-600'
                          end %>">
                      <%= related.severity %>
                    </span>
                  </div>
                  <h4 class="font-semibold text-slate-900 text-sm group-hover:text-red-600 transition-colors"><%= related.title %></h4>
                  <p class="text-xs text-slate-500 mt-1"><%= related.legal_basis %></p>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 사이드바 -->
      <div class="lg:w-[30%] mt-10 lg:mt-0">
        <div class="sticky top-20 space-y-6">
          <!-- 돌아가기 -->
          <%= link_to audit_cases_path, class: "flex items-center gap-2 text-slate-600 hover:text-slate-900 font-medium transition-colors mb-4" do %>
            <span class="material-symbols-outlined text-lg">arrow_back</span>
            감사사례 목록으로
          <% end %>

          <!-- 이 사례 요약 -->
          <div class="card p-6">
            <h3 class="font-bold text-slate-900 mb-4">사례 요약</h3>
            <dl class="space-y-3 text-sm">
              <div class="flex justify-between">
                <dt class="text-slate-500">분야</dt>
                <dd class="font-semibold text-slate-800"><%= @audit_case.category %></dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-slate-500">심각도</dt>
                <dd class="font-semibold text-<%= @audit_case.severity_color %>-700"><%= @audit_case.severity %></dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-slate-500">관련근거</dt>
                <dd class="font-semibold text-slate-800 text-right max-w-[60%]"><%= @audit_case.legal_basis %></dd>
              </div>
            </dl>
          </div>

          <!-- AI 상담 -->
          <div class="bg-gradient-to-br from-red-700 to-red-900 rounded-2xl p-6 text-white shadow-strong">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-white/10 backdrop-blur rounded-xl flex items-center justify-center">
                <span class="material-symbols-outlined text-2xl">support_agent</span>
              </div>
              <div>
                <h3 class="font-bold text-lg">감사 대비 상담</h3>
                <p class="text-red-100 text-sm">AI에게 물어보세요</p>
              </div>
            </div>
            <%= link_to chatbot_path, class: "block w-full py-3 bg-white text-red-700 rounded-xl font-semibold text-center hover:bg-red-50 transition-colors shadow-soft" do %>
              AI 상담 시작하기
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
