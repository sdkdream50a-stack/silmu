<%# 감사사례 목록 페이지 %>

<%= content_for :head do %>
  <%= json_ld({
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "감사사례 모음",
    "description": "공공계약 감사에서 자주 지적되는 사례를 카테고리별로 정리",
    "url": request.original_url,
    "publisher": { "@type": "Organization", "name": "실무" }
  }) %>
<% end %>

<!-- 페이지 헤더 -->
<section class="bg-gradient-to-br from-red-700 via-red-800 to-red-900 text-white py-12 lg:py-16 relative overflow-hidden">
  <div class="absolute top-0 right-0 w-96 h-96 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/3"></div>
  <div class="absolute bottom-0 left-0 w-64 h-64 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/4"></div>
  <div class="container-wide relative z-10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
      <div class="flex items-start gap-5">
        <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-lg">
          <span class="material-symbols-outlined text-4xl text-white">gavel</span>
        </div>
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-2">감사사례</h1>
          <p class="text-red-100 text-lg">계약 실무에서 자주 지적되는 감사 사례와 대응 방법</p>
        </div>
      </div>
      <div class="flex gap-4 lg:gap-6">
        <div class="text-center px-4 py-2 bg-white/10 backdrop-blur-md rounded-xl border border-white/15">
          <div class="text-2xl font-bold"><%= @total_count %></div>
          <div class="text-xs text-red-100 mt-0.5">전체 사례</div>
        </div>
        <div class="text-center px-4 py-2 bg-white/10 backdrop-blur-md rounded-xl border border-white/15">
          <div class="text-2xl font-bold"><%= @categories.size %></div>
          <div class="text-xs text-red-100 mt-0.5">분야</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 카테고리 필터 및 검색 -->
<section class="bg-white/80 backdrop-blur-xl border-b border-gray-100 sticky top-16 z-40 shadow-soft">
  <div class="container-wide py-4">
    <!-- 검색창 -->
    <div class="mb-4">
      <div class="relative max-w-md">
        <input
          type="text"
          id="case-search"
          placeholder="사례 제목 또는 내용 검색..."
          class="w-full px-5 py-3 pl-12 pr-4 bg-white border-2 border-gray-200 rounded-xl text-sm focus:border-red-500 focus:ring-0 transition-colors"
          oninput="filterCases()"
        >
        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none" data-icon="material-symbols:search">search</span>
      </div>
    </div>

    <!-- 카테고리 탭 & 심각도 필터 -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
      <div class="flex flex-wrap gap-2" id="category-tabs">
        <%= link_to "전체", audit_cases_path, class: "tab-btn px-5 py-2.5 rounded-xl text-sm font-semibold transition-all #{@category.blank? ? 'bg-red-600 text-white shadow-md' : 'bg-surface-100 text-slate-600 hover:bg-surface-200'}" %>
        <% @categories.each do |cat| %>
          <%= link_to cat, audit_cases_path(category: cat), class: "tab-btn px-5 py-2.5 rounded-xl text-sm font-medium transition-all #{@category == cat ? 'bg-red-600 text-white shadow-md' : 'bg-surface-100 text-slate-600 hover:bg-surface-200'}" %>
        <% end %>
      </div>

      <!-- 심각도 필터 -->
      <div class="flex gap-2">
        <button onclick="filterBySeverity('')" class="severity-filter active px-4 py-2 rounded-lg text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all" data-severity="">
          전체
        </button>
        <button onclick="filterBySeverity('중대')" class="severity-filter px-4 py-2 rounded-lg text-xs font-semibold bg-red-50 text-red-700 hover:bg-red-100 transition-all" data-severity="중대">
          중대
        </button>
        <button onclick="filterBySeverity('보통')" class="severity-filter px-4 py-2 rounded-lg text-xs font-semibold bg-orange-50 text-orange-700 hover:bg-orange-100 transition-all" data-severity="보통">
          보통
        </button>
        <button onclick="filterBySeverity('경미')" class="severity-filter px-4 py-2 rounded-lg text-xs font-semibold bg-amber-50 text-amber-700 hover:amber-100 transition-all" data-severity="경미">
          경미
        </button>
      </div>
    </div>
  </div>
</section>

<section class="section py-10">
  <div class="container-wide">
    <div class="lg:flex lg:gap-10">
      <!-- 메인 콘텐츠 -->
      <div class="lg:w-[70%]">
        <div class="flex items-center justify-between mb-6">
          <p class="text-slate-600">
            <% if @category.present? %>
              <span class="font-bold text-slate-900"><%= @category %></span> 분야
            <% end %>
            총 <span class="font-bold text-slate-900" id="case-count"><%= @audit_cases.count %></span>개 사례
            <span id="filtered-info" class="text-sm text-red-600 ml-2" style="display:none;"></span>
          </p>
        </div>

        <% if @audit_cases.any? %>
          <% if @category.present? || @severity.present? %>
          <div class="space-y-4" id="cases-container">
            <% @audit_cases.each do |audit_case| %>
              <%= link_to audit_case_path(slug: audit_case.slug), class: "block card card-hover p-6 group case-item", data: { title: audit_case.title.downcase, issue: audit_case.issue.truncate(200).downcase, severity: audit_case.severity } do %>
                <div class="flex items-start justify-between mb-3">
                  <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-semibold bg-red-50 text-red-700"><%= audit_case.category %></span>
                  <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
                    <%= case audit_case.severity
                        when '경미' then 'bg-amber-50 text-amber-700'
                        when '보통' then 'bg-orange-50 text-orange-700'
                        when '중대' then 'bg-red-100 text-red-800'
                        else 'bg-gray-50 text-gray-600'
                        end %>">
                    <%= audit_case.severity %>
                  </span>
                </div>

                <h3 class="text-lg font-bold text-slate-900 mb-2 group-hover:text-red-600 transition-colors"><%= audit_case.title %></h3>

                <p class="text-slate-600 text-sm mb-3 leading-relaxed line-clamp-2"><%= audit_case.issue.truncate(120) %></p>

                <div class="flex items-center gap-4 text-xs text-slate-400">
                  <span class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">menu_book</span>
                    <%= audit_case.legal_basis %>
                  </span>
                  <% if audit_case.topic_slug.present? %>
                    <span class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-sm">link</span>
                      관련 토픽
                    </span>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
          <% else %>
          <% cache ["audit_cases/cards/v1", @audit_cases.size, @audit_cases.map(&:updated_at).max], expires_in: 30.minutes do %>
          <div class="space-y-4" id="cases-container">
            <% @audit_cases.each do |audit_case| %>
              <%= link_to audit_case_path(slug: audit_case.slug), class: "block card card-hover p-6 group case-item", data: { title: audit_case.title.downcase, issue: audit_case.issue.truncate(200).downcase, severity: audit_case.severity } do %>
                <div class="flex items-start justify-between mb-3">
                  <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-semibold bg-red-50 text-red-700"><%= audit_case.category %></span>
                  <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium
                    <%= case audit_case.severity
                        when '경미' then 'bg-amber-50 text-amber-700'
                        when '보통' then 'bg-orange-50 text-orange-700'
                        when '중대' then 'bg-red-100 text-red-800'
                        else 'bg-gray-50 text-gray-600'
                        end %>">
                    <%= audit_case.severity %>
                  </span>
                </div>
                <h3 class="text-lg font-bold text-slate-900 mb-2 group-hover:text-red-600 transition-colors"><%= audit_case.title %></h3>
                <p class="text-slate-600 text-sm mb-3 leading-relaxed line-clamp-2"><%= audit_case.issue.truncate(120) %></p>
                <div class="flex items-center gap-4 text-xs text-slate-400">
                  <span class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">menu_book</span>
                    <%= audit_case.legal_basis %>
                  </span>
                  <% if audit_case.topic_slug.present? %>
                    <span class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-sm">link</span>
                      관련 토픽
                    </span>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
          <% end %>
          <% end %>

          <!-- 검색 결과 없음 메시지 -->
          <div id="no-results" class="text-center py-16" style="display:none;">
            <span class="material-symbols-outlined text-6xl text-slate-200 mb-4" data-icon="material-symbols:search-off">search_off</span>
            <p class="text-slate-500 text-lg font-semibold mb-2">검색 결과가 없습니다</p>
            <p class="text-slate-400 text-sm">다른 검색어나 필터를 시도해보세요</p>
            <button onclick="clearFilters()" class="inline-block mt-4 px-5 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold">
              필터 초기화
            </button>
          </div>
        <% else %>
          <div class="text-center py-16">
            <span class="material-symbols-outlined text-6xl text-slate-200 mb-4">search_off</span>
            <p class="text-slate-500 text-lg">해당 조건의 감사사례가 없습니다.</p>
            <%= link_to "전체 보기", audit_cases_path, class: "inline-block mt-4 text-red-600 hover:text-red-700 font-semibold" %>
          </div>
        <% end %>
      </div>

      <!-- 사이드바 -->
      <div class="lg:w-[30%] mt-10 lg:mt-0">
        <div class="sticky top-36 space-y-6">
          <!-- 심각도 필터 -->
          <div class="card p-6">
            <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-red-500">warning</span>
              심각도별 보기
            </h3>
            <div class="space-y-2">
              <% [["중대", "red", "해임·파면·계약취소 등"], ["보통", "orange", "경고·주의·시정 등"], ["경미", "amber", "주의·개선권고 등"]].each do |sev, color, desc| %>
                <%= link_to audit_cases_path(severity: sev, category: @category), class: "flex items-center gap-3 p-3 rounded-xl hover:bg-#{color}-50 transition-colors group #{@severity == sev ? "bg-#{color}-50" : ''}" do %>
                  <span class="w-3 h-3 rounded-full bg-<%= color %>-500"></span>
                  <div>
                    <span class="text-sm font-semibold text-slate-800 group-hover:text-<%= color %>-700"><%= sev %></span>
                    <p class="text-xs text-slate-400"><%= desc %></p>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- 감사 대비 팁 -->
          <div class="card p-6 bg-red-50 border-red-100">
            <h3 class="font-bold text-red-900 mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined">shield</span>
              감사 대비 핵심
            </h3>
            <ul class="text-sm text-red-800 space-y-2">
              <li class="flex items-start gap-2">
                <span class="material-symbols-outlined text-sm mt-0.5 text-red-500">check_circle</span>
                <span>근거 법령과 조항 번호를 정확히 기재</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="material-symbols-outlined text-sm mt-0.5 text-red-500">check_circle</span>
                <span>결재 과정에서 검토 의견 반드시 첨부</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="material-symbols-outlined text-sm mt-0.5 text-red-500">check_circle</span>
                <span>금액 기준은 부가세 포함/미포함 구분</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="material-symbols-outlined text-sm mt-0.5 text-red-500">check_circle</span>
                <span>기한 준수 여부 사전 점검</span>
              </li>
            </ul>
          </div>

          <!-- 관련 도구 -->
          <div class="card p-6">
            <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-emerald-500">build</span>
              관련 실무 도구
            </h3>
            <ul class="space-y-3">
              <li>
                <%= link_to contract_method_path, class: "text-sm text-slate-700 hover:text-emerald-600 transition-colors flex items-center gap-2" do %>
                  <span class="material-symbols-outlined text-base text-slate-400">chevron_right</span>
                  계약방식 결정 도우미
                <% end %>
              </li>
              <li>
                <%= link_to contract_guarantee_path, class: "text-sm text-slate-700 hover:text-emerald-600 transition-colors flex items-center gap-2" do %>
                  <span class="material-symbols-outlined text-base text-slate-400">chevron_right</span>
                  계약보증금 계산기
                <% end %>
              </li>
              <li>
                <%= link_to estimated_price_path, class: "text-sm text-slate-700 hover:text-emerald-600 transition-colors flex items-center gap-2" do %>
                  <span class="material-symbols-outlined text-base text-slate-400">chevron_right</span>
                  추정가격 계산기
                <% end %>
              </li>
              <li>
                <%= link_to legal_period_path, class: "text-sm text-slate-700 hover:text-emerald-600 transition-colors flex items-center gap-2" do %>
                  <span class="material-symbols-outlined text-base text-slate-400">chevron_right</span>
                  법정기간 계산기
                <% end %>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
// 현재 선택된 심각도 필터
let currentSeverity = '';

// 검색 필터링
function filterCases() {
  const searchTerm = document.getElementById('case-search').value.toLowerCase().trim();
  const cases = document.querySelectorAll('.case-item');
  let visibleCount = 0;

  cases.forEach(caseItem => {
    const title = caseItem.dataset.title || '';
    const issue = caseItem.dataset.issue || '';
    const severity = caseItem.dataset.severity || '';

    // 검색어 매칭
    const matchesSearch = searchTerm === '' || title.includes(searchTerm) || issue.includes(searchTerm);

    // 심각도 필터 매칭
    const matchesSeverity = currentSeverity === '' || severity === currentSeverity;

    // 두 조건 모두 만족하면 표시
    if (matchesSearch && matchesSeverity) {
      caseItem.style.display = 'block';
      visibleCount++;
    } else {
      caseItem.style.display = 'none';
    }
  });

  updateCaseCount(visibleCount, cases.length);
}

// 심각도 필터링
function filterBySeverity(severity) {
  currentSeverity = severity;

  // 버튼 활성화 상태 변경
  document.querySelectorAll('.severity-filter').forEach(btn => {
    if (btn.dataset.severity === severity) {
      btn.classList.add('active');
      btn.style.fontWeight = '700';
    } else {
      btn.classList.remove('active');
      btn.style.fontWeight = '600';
    }
  });

  // 필터 적용
  filterCases();
}

// 사례 개수 업데이트
function updateCaseCount(visible, total) {
  const countEl = document.getElementById('case-count');
  const filteredInfoEl = document.getElementById('filtered-info');
  const noResultsEl = document.getElementById('no-results');
  const casesContainer = document.getElementById('cases-container');

  if (visible === 0) {
    // 검색 결과 없음
    casesContainer.style.display = 'none';
    noResultsEl.style.display = 'block';
  } else {
    // 검색 결과 있음
    casesContainer.style.display = 'block';
    noResultsEl.style.display = 'none';

    if (visible < total) {
      countEl.textContent = visible;
      filteredInfoEl.textContent = `(전체 ${total}개 중)`;
      filteredInfoEl.style.display = 'inline';
    } else {
      countEl.textContent = total;
      filteredInfoEl.style.display = 'none';
    }
  }
}

// 필터 초기화
function clearFilters() {
  // 검색어 초기화
  document.getElementById('case-search').value = '';

  // 심각도 필터 초기화
  currentSeverity = '';
  document.querySelectorAll('.severity-filter').forEach(btn => {
    if (btn.dataset.severity === '') {
      btn.classList.add('active');
      btn.style.fontWeight = '700';
    } else {
      btn.classList.remove('active');
      btn.style.fontWeight = '600';
    }
  });

  // 필터 재적용
  filterCases();
}

// Iconify 스캔
if (typeof Iconify !== 'undefined') {
  Iconify.scan();
}
</script>
